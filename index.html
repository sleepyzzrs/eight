<html lang="zh-CN" style="--weibo-card-opacity: 1;"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Phone Chat</title>

    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Phone Chat">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="msapplication-TileColor" content="#000000">

    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9IiMwMDAwMDAiLz4KPHN2ZyB4PSI0MCIgeT0iNDAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgZmlsbD0ibm9uZSI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iMjAiIGZpbGw9IiNmZmZmZmYiLz4KPHN2ZyB4PSIxNSIgeT0iMTUiIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIiBmaWxsPSJub25lIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyNSIgcj0iOCIgZmlsbD0iIzAwMDAwMCIvPgo8Y2lyY2xlIGN4PSI1MCIgY3k9IjI1IiByPSI4IiBmaWxsPSIjMDAwMDAwIi8+CjxwYXRoIGQ9Ik0yMCA0NUw1MCA0NSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjMiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8L3N2Zz4KPC9zdmc+Cjwvc3ZnPg==">
    <link rel="apple-touch-icon" sizes="152x152" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUyIiBoZWlnaHQ9IjE1MiIgdmlld0JveD0iMCAwIDE1MiAxNTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTIiIGhlaWdodD0iMTUyIiByeD0iMzQiIGZpbGw9IiMwMDAwMDAiLz4KPHN2ZyB4PSIzNCIgeT0iMzQiIHdpZHRoPSI4NCIgaGVpZ2h0PSI4NCIgdmlld0JveD0iMCAwIDg0IDg0IiBmaWxsPSJub25lIj4KPHJlY3Qgd2lkdGg9Ijg0IiBoZWlnaHQ9Ijg0IiByeD0iMTciIGZpbGw9IiNmZmZmZmYiLz4KPHN2ZyB4PSIxMiIgeT0iMTIiIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDYwIDYwIiBmaWxsPSJub25lIj4KPGNpcmNsZSBjeD0iMTciIGN5PSIyMSIgcj0iNyIgZmlsbD0iIzAwMDAwMCIvPgo8Y2lyY2xlIGN4PSI0MyIgY3k9IjIxIiByPSI3IiBmaWxsPSIjMDAwMDAwIi8+CjxwYXRoIGQ9Ik0xNyAzOEw0MyAzOCIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjIuNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4KPC9zdmc+">
    <link rel="apple-touch-icon" sizes="120x120" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiByeD0iMjciIGZpbGw9IiMwMDAwMDAiLz4KPHN2ZyB4PSIyNyIgeT0iMjciIHdpZHRoPSI2NiIgaGVpZ2h0PSI2NiIgdmlld0JveD0iMCAwIDY2IDY2IiBmaWxsPSJub25lIj4KPHJlY3Qgd2lkdGg9IjY2IiBoZWlnaHQ9IjY2IiByeD0iMTMiIGZpbGw9IiNmZmZmZmYiLz4KPHN2ZyB4PSIxMCIgeT0iMTAiIHdpZHRoPSI0NiIgaGVpZ2h0PSI0NiIgdmlld0JveD0iMCAwIDQ2IDQ2IiBmaWxsPSJub25lIj4KPGNpcmNsZSBjeD0iMTMiIGN5PSIxNiIgcj0iNSIgZmlsbD0iIzAwMDAwMCIvPgo8Y2lyY2xlIGN4PSIzMyIgY3k9IjE2IiByPSI1IiBmaWxsPSIjMDAwMDAwIi8+CjxwYXRoIGQ9Ik0xMyAzMEwzMyAzMCIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8L3N2Zz4KPC9zdmc+Cjwvc3ZnPg==">

    <!-- Standard favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNyIgZmlsbD0iIzAwMDAwMCIvPgo8c3ZnIHg9IjciIHk9IjciIHdpZHRoPSIxOCIgaGVpZ2h0PSIxOCIgdmlld0JveD0iMCAwIDE4IDE4IiBmaWxsPSJub25lIj4KPHJlY3Qgd2lkdGg9IjE4IiBoZWlnaHQ9IjE4IiByeD0iNCIgZmlsbD0iI2ZmZmZmZiIvPgo8c3ZnIHg9IjMiIHk9IjMiIHdpZHRoPSIxMiIgaGVpZ2h0PSIxMiIgdmlld0JveD0iMCAwIDEyIDEyIiBmaWxsPSJub25lIj4KPGNpcmNsZSBjeD0iMyIgY3k9IjQiIHI9IjEuNSIgZmlsbD0iIzAwMDAwMCIvPgo8Y2lyY2xlIGN4PSI5IiBjeT0iNCIgcj0iMS41IiBmaWxsPSIjMDAwMDAwIi8+CjxwYXRoIGQ9Ik0zIDhMOSA4IiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iMC44IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+Cjwvc3ZnPgo8L3N2Zz4=">

    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&amp;family=Varela+Round&amp;display=swap" rel="stylesheet">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root { 
    /* åŸºç¡€å˜é‡ */
    --screen-width: 350px; 
    --screen-height: 740px; 
    --secondary-bg: #ffffff; 
    --border-color: #e0e0e0; 
    --text-primary: #1f1f1f; 
    --text-secondary: #8a8a8a; 
    --accent-color: rgb(74, 132, 193); 
    
    /* å¾®åšç›¸å…³å˜é‡ */
    --weibo-bg: #fff; 
    --weibo-main: #222; 
    --weibo-accent: #ff69b4; 
    --weibo-card-bg: #fff; 
    --weibo-card-border: #eee; 
    --weibo-content-color: #222; 
    --weibo-secondary: #888; 
    --weibo-card-opacity: 1.0;
    
    /* ä¸»é¢˜ç›¸å…³å˜é‡ - ç®€çº¦é£æ ¼ (é»˜è®¤) */
    --theme-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    --theme-button-bg: rgba(245, 245, 247, 0.8);
    --theme-button-color: #333;
    --theme-button-border: 1px solid rgba(0,0,0,0.1);
    --theme-header-bg: rgba(247, 247, 247, 0.8);
    --theme-form-bg: #ffffff;
    --theme-input-border: 1px solid #e0e0e0;
    --theme-input-radius: 12px;
    --theme-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* å¯çˆ±é£æ ¼ä¸»é¢˜ */
body[data-theme="cute"] {
    --theme-font-family: 'Varela Round', 'Quicksand', sans-serif;
    --theme-button-bg: rgba(255, 182, 193, 0.8);
    --theme-button-color: #d44d5c;
    --theme-button-border: 1px solid rgba(255, 182, 193, 0.5);
    --theme-header-bg: rgba(255, 230, 240, 0.85);
    --theme-form-bg: #fff9fc;
    --theme-input-border: 1px solid #ffccd5;
    --theme-input-radius: 20px;
    --theme-shadow: 0 4px 10px rgba(255, 105, 180, 0.15);
}
        html { height: 100%; overflow: hidden; }
        body {
    height: 100%;
    overflow: hidden;
    margin: 0;
    padding: 20px;
    font-family: var(--theme-font-family);
    font-weight: normal;
    background-color: #dcdcdc;
    display: flex;
    justify-content: center;
    align-items: center;
    box-sizing: border-box;
    transition: all 0.3s ease;
}

        /* æ— è¾¹æ¡†æ¨¡å¼æ ·å¼ */
        body.borderless-mode {
            padding: 0;
            background-color: #000;
        }

        body.borderless-mode #phone-frame {
            padding: 0;
            background-color: transparent;
            border-radius: 0;
            box-shadow: none;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        body.borderless-mode #phone-screen {
            width: 100vw;
            height: 100vh;
            border-radius: 0;
            border: none;
            max-width: none;
            max-height: none;
        }

        /* PWAæ¨¡å¼æ ·å¼ - ä»ä¸»å±å¹•å¯åŠ¨æ—¶çš„å…¨å±ä½“éªŒ */
        body.pwa-mode {
            padding: 0;
            background-color: #f0f2f5; /* æ”¹ä¸ºæµ…ç°è‰²èƒŒæ™¯ï¼Œä¸èŠå¤©ç•Œé¢ä¸€è‡´ */
            /* ä½¿ç”¨æœ€å°é«˜åº¦è€Œä¸æ˜¯å›ºå®šé«˜åº¦ */
            min-height: 100vh;
            /* é˜²æ­¢iOS Safariçš„å¼¹æ€§æ»šåŠ¨ï¼Œä½†ä¸ä½¿ç”¨fixed */
            overflow-x: hidden;
        }

        body.pwa-mode #phone-frame {
            padding: 0;
            background-color: transparent;
            border-radius: 0;
            box-shadow: none;
            width: 100vw;
            height: 100vh;
            /* ç§»é™¤flexå¸ƒå±€ï¼Œè®©å†…å®¹è‡ªç„¶æµåŠ¨ */
        }

        body.pwa-mode #phone-screen {
            width: 100vw;
            min-height: 100vh;
            border-radius: 0;
            border: none;
            max-width: none;
            max-height: none;
            /* è‡ªç„¶é“ºæ»¡å±å¹•ï¼Œä¸å¼ºåˆ¶å±…ä¸­ */
            position: relative;
            background-color: #f0f2f5;
            /* ä½¿ç”¨è‡ªç„¶çš„æ–‡æ¡£æµå¸ƒå±€ */
            display: flex;
            flex-direction: column;
        }

        /* PWAæ¨¡å¼ä¸‹çš„çŠ¶æ€æ æ ·å¼è°ƒæ•´ */
        body.pwa-mode #status-bar {
            /* åœ¨PWAæ¨¡å¼ä¸‹éšè—æ¨¡æ‹ŸçŠ¶æ€æ ï¼Œä½¿ç”¨çœŸå®çŠ¶æ€æ  */
            display: none;
        }

        body.pwa-mode .header {
            /* è‡ªç„¶é€‚åº”é¡¶éƒ¨å®‰å…¨åŒºåŸŸ */
            padding-top: calc(15px + env(safe-area-inset-top));
            /* ç¡®ä¿å¤´éƒ¨åœ¨å®‰å…¨åŒºåŸŸå†… */
            margin-top: 0;
        }

        body.pwa-mode #home-screen {
            /* è‡ªç„¶é€‚åº”å±å¹•ï¼Œä»å¤´éƒ¨ä¸‹æ–¹å¼€å§‹ */
            padding-top: 80px;
            /* åº•éƒ¨ç•™å‡ºå®‰å…¨åŒºåŸŸ */
            padding-bottom: calc(50px + env(safe-area-inset-bottom));
            /* ç¡®ä¿å†…å®¹èƒ½å¤Ÿæ»šåŠ¨åˆ°åº•éƒ¨ */
            min-height: calc(100vh - 80px);
            box-sizing: border-box;
        }

        /* PWAæ¨¡å¼ä¸‹çš„èŠå¤©è¾“å…¥åŒºåŸŸé€‚é… */
        body.pwa-mode #chat-input-area {
            /* è‡ªç„¶è´´åˆåº•éƒ¨ï¼Œç•™å‡ºå®‰å…¨åŒºåŸŸ */
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            /* ç¡®ä¿è¾“å…¥åŒºåŸŸåœ¨å±å¹•åº•éƒ¨ */
            position: relative;
        }

        /* PWAæ¨¡å¼ä¸‹çš„èŠå¤©ç•Œé¢é€‚é… */
        body.pwa-mode #chat-interface-screen {
            /* ç¡®ä¿èŠå¤©ç•Œé¢å¡«æ»¡æ•´ä¸ªå±å¹• */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        body.pwa-mode #chat-messages {
            /* æ¶ˆæ¯åŒºåŸŸå æ®å‰©ä½™ç©ºé—´ */
            flex: 1;
            overflow-y: auto;
            /* ç¡®ä¿æ¶ˆæ¯åŒºåŸŸèƒ½å¤Ÿæ­£ç¡®æ»šåŠ¨åˆ°åº•éƒ¨ */
            padding-bottom: 20px;
        }

        body.pwa-mode #chat-input-area {
            /* è¾“å…¥åŒºåŸŸå›ºå®šåœ¨åº•éƒ¨ */
            flex-shrink: 0;
        }

        /* PWAæ¨¡å¼ä¸‹çš„æ¨¡æ€æ¡†é€‚é… */
        body.pwa-mode .modal {
            /* ç¡®ä¿æ¨¡æ€æ¡†ä¸è¢«å®‰å…¨åŒºåŸŸé®æŒ¡ */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        body.pwa-mode .modal-content {
            /* æ¨¡æ€æ¡†å†…å®¹åŒºåŸŸçš„é¢å¤–è°ƒæ•´ */
            margin-top: env(safe-area-inset-top);
            margin-bottom: env(safe-area-inset-bottom);
            max-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 40px);
        }

        /* PWAæ¨¡å¼ä¸‹çš„åº•éƒ¨é¢æ¿é€‚é… */
        body.pwa-mode #sticker-panel {
            /* è¡¨æƒ…åŒ…é¢æ¿åº•éƒ¨é€‚é… */
            padding-bottom: env(safe-area-inset-bottom);
        }

        body.pwa-mode #music-playlist-panel {
            /* éŸ³ä¹æ’­æ”¾åˆ—è¡¨é¢æ¿åº•éƒ¨é€‚é… */
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* PWAæ¨¡å¼ä¸‹çš„å¾®åšå¯¼èˆªæ é€‚é… */
        body.pwa-mode .weibo-nav {
            /* å¾®åšåº•éƒ¨å¯¼èˆªæ é€‚é… */
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }

        body.pwa-mode .weibo-selection-toolbar {
            /* å¾®åšé€‰æ‹©å·¥å…·æ é€‚é… */
            bottom: calc(70px + env(safe-area-inset-bottom));
        }

        /* PWAæ¨¡å¼ä¸‹çš„å…¶ä»–åº•éƒ¨å…ƒç´ é€‚é… */
        body.pwa-mode .weibo-content {
            /* å¾®åšå†…å®¹åŒºåŸŸåº•éƒ¨é€‚é… */
            padding-bottom: calc(70px + env(safe-area-inset-bottom));
        }

        body.pwa-mode .weibo-timeline {
            /* å¾®åšæ—¶é—´çº¿åº•éƒ¨é€‚é… */
            padding-bottom: calc(70px + env(safe-area-inset-bottom));
        }

        /* æ”¯æŒiOSçš„å®‰å…¨åŒºåŸŸ */
        @supports (padding: max(0px)) {
            body.pwa-mode {
                padding-top: max(0px, env(safe-area-inset-top));
                padding-bottom: max(0px, env(safe-area-inset-bottom));
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
            }
        }

        /* æ— è¾¹æ¡†æ¨¡å¼å¼€å…³æ ·å¼ç¾åŒ– */
        .borderless-mode-label {
            transition: all 0.3s ease;
        }

        .borderless-mode-label:hover {
            border-color: var(--accent-color) !important;
            box-shadow: 0 4px 12px rgba(74, 132, 193, 0.15);
            transform: translateY(-2px);
        }

        .borderless-mode-label input[type="checkbox"]:checked + div {
            color: var(--accent-color);
        }

        .borderless-mode-label input[type="checkbox"]:checked {
            accent-color: var(--accent-color);
        }


        body[data-weibo-theme="white"] { --weibo-bg: #fff; --weibo-main: #222; --weibo-accent: #ff69b4; --weibo-card-bg: #fff; --weibo-card-border: #eee; --weibo-content-color: #222; }
        body[data-weibo-theme="pink"] { --weibo-bg: #ffe4ec; --weibo-main: #c2185b; --weibo-accent: #e91e63; --weibo-card-bg: #fff0f6; --weibo-card-border: #f8bbd0; --weibo-content-color: #c2185b; }
        body[data-weibo-theme="blue"] { --weibo-bg: #e3f0ff; --weibo-main: #1565c0; --weibo-accent: #2196f3; --weibo-card-bg: #f0f8ff; --weibo-card-border: #b3e5fc; --weibo-content-color: #1565c0; }
        body[data-weibo-theme="purple"] { --weibo-bg: #f3e8ff; --weibo-main: #6a1b9a; --weibo-accent: #ab47bc; --weibo-card-bg: #f8f0ff; --weibo-card-border: #e1bee7; --weibo-content-color: #6a1b9a; }
        body[data-weibo-theme="green"] { --weibo-bg: #eaffea; --weibo-main: #388e3c; --weibo-accent: #43a047; --weibo-card-bg: #f0fff0; --weibo-card-border: #b2dfdb; --weibo-content-color: #388e3c; }
        body[data-weibo-theme="yellow"] { --weibo-bg: #fffbe4; --weibo-main: #bfa100; --weibo-accent: #ffd600; --weibo-card-bg: #fffde7; --weibo-card-border: #fff9c4; --weibo-content-color: #bfa100; }
        #phone-frame { padding: 12px; background-color: #fff; border-radius: 50px; box-shadow: 0 20px 50px rgba(0,0,0,0.25), inset 0 2px 4px rgba(0,0,0,0.1); position: relative; }
        /* .notch { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 130px; height: 28px; background-color: #1f1f1f; border-radius: 0 0 15px 15px; z-index: 20; } */
        #phone-screen { width: var(--screen-width); height: var(--screen-height); background-color: #000; border-radius: 40px; position: relative; overflow: hidden; display: flex; flex-direction: column; border: 2px solid #333; }
        #status-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; color: white; z-index: 10; font-size: 14px; box-sizing: border-box; pointer-events: none; }
        #status-bar-time { font-weight: 600; display: flex; align-items: center; }
        #status-bar-time::after { content: "ğŸ¾"; margin-left: 4px; font-size: 12px; }
        #concurrent-status { position: absolute; top: 35px; left: 50%; transform: translateX(-50%); z-index: 15; background: transparent; color: #999; padding: 0; border-radius: 0; font-size: 11px; display: none; font-weight: normal; }
        #ai-heartrate-display {
            position: absolute;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px; 
            color: #ff6b6b; 
            display: none; 
            z-index: 15;
            font-weight: normal;
            transition: all 0.3s ease;
        }
        #ai-heartrate-display .heartrate-number {
            color: #000;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        #ai-heartrate-display .heartrate-unit {
            color: #888;
            font-weight: normal;
        }
        
        /* å¿ƒç‡è¿‡é«˜æ—¶çš„ç‰¹æ®Šæ•ˆæœ */
        #ai-heartrate-display.high-heartrate {
            animation: heartbeat-pulse 1s infinite;
        }
        #ai-heartrate-display.high-heartrate .heartrate-number {
            color: #ff3366;
        }
        #ai-heartrate-display.very-high-heartrate {
            animation: heartbeat-intense 0.6s infinite;
        }
        #ai-heartrate-display.very-high-heartrate .heartrate-number {
            color: #ff1144;
            font-weight: 900;
        }
        
        @keyframes heartbeat-pulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }
        
        @keyframes heartbeat-intense {
            0%, 100% { transform: translateX(-50%) scale(1); }
            25% { transform: translateX(-50%) scale(1.08); }
            75% { transform: translateX(-50%) scale(1.03); }
        }
        .battery-container { display: flex; align-items: center; gap: 4px; font-size: 14px; }
        .battery-icon { width: 20px; height: 10px; border: 1px solid white; border-radius: 4px; position: relative; padding: 1px; }
        .battery-icon::after { content: ''; position: absolute; right: -2px; top: 2px; width: 1.5px; height: 4px; background-color: white; border-radius: 0 1px 1px 0; }
        .battery-level { height: 100%; background-color: white; border-radius: 2px; transition: width 0.5s ease; }
        .battery-container.charging .battery-level { background-color: #4cd964; animation: charge-breath 2s infinite; }
        .battery-container.charging .battery-text { color: #4cd964; }
        @keyframes charge-breath { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .screen.active { opacity: 1; visibility: visible; z-index: 1; }
        .header { 
    position: relative; 
    z-index: 15; 
    flex-shrink: 0; 
    padding: 15px 60px; 
    padding-top: 45px; 
    background-color: var(--theme-header-bg); 
    backdrop-filter: blur(10px); 
    -webkit-backdrop-filter: blur(10px); 
    border-bottom: 1px solid var(--border-color); 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    font-size: 18px; 
    font-weight: 600; 
    transition: all 0.3s ease;
}
        .header .header-actions { display: flex; align-items: center; gap: 8px; position: absolute; right: 20px; }
        .header .back-btn, .header .action-btn { font-size: 24px; cursor: pointer; width: 30px; text-align: center; color: #000000; display: flex; align-items: center; justify-content: center; }
        .header .back-btn { position: absolute; left: 20px; }
        .header .header-title { text-align: center; flex: 1; color: #000000; }
        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: #000000; font-weight: 600; cursor: pointer; position: absolute; right: 20px; }
        #home-screen { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 20px; padding-top: 80px; padding-bottom: 50px; box-sizing: border-box; background-size: cover; background-position: center; height: 100%; }
        #clock-container { text-align: center; color: white; text-shadow: 0 3px 8px rgba(0,0,0,0.4); margin-bottom: 20px; flex-shrink: 0; }
        #main-time { font-size: 80px; font-weight: 200; }
        #main-date { font-size: 18px; font-weight: 500; }
        #app-grid { margin-top: auto; margin-bottom: auto; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; padding: 20px; transition: margin 0.3s ease; }
        .app-row { display: flex; justify-content: center; gap: 25px; width: 100%; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; text-align: center; }
        .app-icon .icon-bg { width: 65px; height: 65px; border-radius: 18px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 32px; margin-bottom: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; overflow: hidden; }
        .app-icon:active .icon-bg { transform: scale(0.9); }
        .app-icon .icon-bg img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon .label { color: white; }
        .form-container, .list-container { padding: 20px; overflow-y: auto; flex-grow: 1; display:flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { 
    width: 100%; 
    padding: 12px; 
    border: var(--theme-input-border); 
    border-radius: var(--theme-input-radius); 
    font-size: 16px; 
    box-sizing: border-box; 
    background-color: var(--theme-form-bg); 
    color: #333; 
    transition: all 0.2s ease;
    font-family: var(--theme-font-family);
}
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #c0c0c0; outline: none; box-shadow: 0 0 0 2px rgba(0,0,0,0.05); }
        .form-group textarea { min-height: 80px; resize: vertical; }
        #world-book-content-input { height: calc(100% - 120px); }
        .form-button { 
    width: 100%; 
    padding: 15px; 
    background-color: var(--theme-button-bg); 
    color: var(--theme-button-color); 
    border: var(--theme-button-border); 
    border-radius: var(--theme-input-radius); 
    font-size: 16px; 
    font-weight: 600; 
    cursor: pointer; 
    margin-top: 10px; 
    backdrop-filter: blur(10px); 
    -webkit-backdrop-filter: blur(10px); 
    box-shadow: var(--theme-shadow); 
    transition: all 0.2s ease;
    font-family: var(--theme-font-family);
}
        .form-button:hover { background-color: rgba(245, 245, 247, 0.9); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .form-button-secondary { background-color: rgba(240, 240, 240, 0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); }
        #wallpaper-screen .form-container { align-items: center; }
        #wallpaper-preview { width: 180px; height: 320px; border: 2px dashed var(--border-color); background-color: #f0f2f5; margin-bottom: 20px; background-size: cover; background-position: center; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        #wallpaper-upload-input { display: none; }
        #chat-list, #world-book-list { flex-grow: 1; overflow-y: auto; background-color: var(--secondary-bg); padding-top: 80px; margin-top: -80px; }
        .list-item { display: flex; flex-direction: column; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item .item-title { font-weight: 500; font-size: 16px; margin-bottom: 5px; }
        .list-item .item-content { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; }
        .chat-list-item:hover { background-color: #f5f5f5; }
        .chat-list-item .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: #ccc; }
        .chat-list-item .info { flex-grow: 1; overflow: hidden; }
        .chat-list-item .name-line { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .chat-list-item .name { font-weight: 500; color: var(--text-primary); }
        .chat-list-item .group-tag { font-size: 10px; color: var(--accent-color); background-color: #e7f3ff; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }
        .chat-list-item .last-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        .chat-status-indicator { position: absolute; top: 8px; right: 8px; font-size: 12px; display: none; }
        #chat-interface-screen { background-size: cover; background-position: center; position: relative; }

        /* çŠ¶æ€æ°”æ³¡æ ·å¼ */
        #status-bubble {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 4px 8px;
            font-size: 11px;
            color: #666;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 600;
            max-width: 150px;
            word-break: break-all;
            display: none;
            animation: statusBubbleIn 0.3s ease-out;
            white-space: nowrap;
        }

        #status-bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(255, 255, 255, 0.95);
        }

        @keyframes statusBubbleIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* çŠ¶æ€ç”Ÿæˆä¸­çš„åŠ¨æ€æŒ‡ç¤ºå™¨ */
        .status-generating {
            display: inline-block;
        }

        .status-generating::after {
            content: 'Â·Â·Â·';
            animation: statusDots 2s ease-in-out infinite;
        }

        @keyframes statusDots {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-2px); }
        }
        #chat-interface-screen .header .default-controls, #chat-interface-screen .header .selection-controls { display: contents; }
        #chat-interface-screen.selection-mode .default-controls { display: none; }
        #chat-interface-screen:not(.selection-mode) .selection-controls { display: none; }
        #selection-cancel-btn, #selection-delete-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; padding: 5px; }
        #selection-delete-btn { color: #ff3b30; }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; padding-top: 80px; margin-top: -80px; display: flex; flex-direction: column; gap: 12px; }
        #load-more-btn { text-align: center; padding: 10px; color: var(--accent-color); font-size: 14px; cursor: pointer; background-color: transparent; border: none; width: 100%; }
        #load-more-btn:hover { text-decoration: underline; }
        .message-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .message-wrapper.user { align-self: flex-end; align-items: flex-end; }
        .message-wrapper.ai { align-self: flex-start; align-items: flex-start; }
        .sender-name { font-size: 11px; color: #666; margin-bottom: 3px; }
        .message-wrapper.ai .sender-name { margin-left: 37px; }
        .message-bubble { display: flex; align-items: flex-start; gap: 5px; position: relative; width: -webkit-fit-content; width: -moz-fit-content; width: fit-content; max-width: 100%; }
        .message-bubble.selected::after { content: 'âœ”'; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background-color: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .message-bubble.user.selected::after { left: auto; right: -10px; }
        .avatar-group { display: flex; flex-direction: column; align-items: center; gap: 4px; flex-shrink: 0; width: 32px; }
        .message-bubble .avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        .timestamp { font-size: 10px; color: #b0b0b0; display: none; }
        
        /* æ—¶é—´åˆ†éš”ç¬¦æ ·å¼ */
        .time-separator {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin: 15px 0 8px 0;
            padding: 5px 0;
        }
        .message-bubble .content { padding: 8px 12px; word-break: break-word; line-height: 1.5; font-size: 15px; position: relative; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.6), 0 3px 6px rgba(0,0,0,0.15); border: 1px solid rgba(255, 255, 255, 0.2); transition: background-color 0.3s, color 0.3s; }
        
        /* å­—å·å¤§å°è®¾ç½® */
        body[data-font-size="xsmall"] .message-bubble .content { font-size: 10px; }
        body[data-font-size="tiny"] .message-bubble .content { font-size: 12px; }
        body[data-font-size="small"] .message-bubble .content { font-size: 14px; }
        body[data-font-size="medium"] .message-bubble .content { font-size: 15px; }
        body[data-font-size="large"] .message-bubble .content { font-size: 16px; }
        body[data-font-size="xlarge"] .message-bubble .content { font-size: 18px; }
        
        /* èŠå¤©æ¨¡å¼åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .chat-mode-switch {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 4px;
            margin: 10px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .chat-mode-option {
            flex: 1;
            position: relative;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .chat-mode-option input[type="radio"] {
            display: none;
        }
        
        .chat-mode-option label {
            display: block;
            padding: 12px 16px;
            text-align: center;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: transparent;
            color: rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
        }
        
        .chat-mode-option input[type="radio"]:checked + label {
            background: rgba(255, 255, 255, 0.9);
            color: rgb(74, 132, 193);
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(74, 132, 193, 0.2);
            transform: translateY(-1px);
        }
        
        .chat-mode-option label:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .chat-mode-option input[type="radio"]:checked + label:hover {
            background: rgba(255, 255, 255, 0.95);
            color: rgb(74, 132, 193);
        }
        
        /* å­—æ•°é™åˆ¶è¾“å…¥æ¡†æ ·å¼ */
        .offline-length-control {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .offline-length-control input[type="number"] {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .offline-length-control input[type="number"]:focus {
            outline: none;
            border-color: rgb(74, 132, 193);
            box-shadow: 0 0 0 2px rgba(74, 132, 193, 0.2);
        }
        
        /* æ¨¡æ€æ¡†æŒ‰é’®ç¾åŒ– */
        .modal-footer button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .modal-footer .cancel {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
            border: 1px solid rgba(108, 117, 125, 0.3);
        }
        
        .modal-footer .cancel:hover {
            background: rgba(108, 117, 125, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.2);
        }
        
        .modal-footer .save {
            background: rgba(74, 132, 193, 0.9);
            color: white;
            border: 1px solid rgba(74, 132, 193, 0.3);
        }
        
        .modal-footer .save:hover {
            background: rgba(74, 132, 193, 1);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 132, 193, 0.3);
        }
        
        /* å¯çˆ±é£ä¸»é¢˜æ ·å¼ */
        body.cute-theme .chat-mode-switch {
            background: linear-gradient(135deg, rgba(240, 170, 180, 0.3), rgba(245, 200, 175, 0.3));
            border: 1px solid rgba(235, 180, 185, 0.4);
        }
        
        body.cute-theme .chat-mode-option input[type="radio"]:checked + label {
            background: linear-gradient(135deg, #e585a3, #e5a3d6);
            color: white;
            box-shadow: 0 4px 12px rgba(235, 155, 175, 0.3);
        }
        
        body.cute-theme .offline-length-control {
            background: linear-gradient(135deg, rgba(240, 170, 180, 0.2), rgba(245, 200, 175, 0.2));
            border: 1px solid rgba(235, 180, 185, 0.3);
        }
        
        body.cute-theme .modal-footer .cancel {
            background: linear-gradient(135deg, rgba(240, 170, 180, 0.3), rgba(245, 200, 175, 0.3));
            color: #c55579;
            border: 1px solid rgba(240, 170, 180, 0.5);
        }
        
        body.cute-theme .modal-footer .cancel:hover {
            background: linear-gradient(135deg, rgba(240, 170, 180, 0.5), rgba(245, 200, 175, 0.5));
            box-shadow: 0 4px 12px rgba(240, 170, 180, 0.4);
        }
        
        body.cute-theme .modal-footer .save {
            background: linear-gradient(135deg, #e585a3, #e5a3d6);
            color: white;
            border: 1px solid rgba(235, 155, 175, 0.3);
        }
        
        body.cute-theme .modal-footer .save:hover {
            background: linear-gradient(135deg, #d6758f, #e585a3);
            box-shadow: 0 4px 16px rgba(235, 155, 175, 0.4);
        }
        
        /* å¾®åšå‘å¸ƒæŒ‰é’®æ ·å¼ */
        .weibo-publish-btn:hover {
            background: rgba(74, 132, 193, 1) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 132, 193, 0.3);
        }
        
        body.cute-theme .weibo-publish-btn {
            background: linear-gradient(135deg, #e585a3, #e5a3d6) !important;
        }
        
        body.cute-theme .weibo-publish-btn:hover {
            background: linear-gradient(135deg, #d6758f, #e585a3) !important;
            box-shadow: 0 4px 16px rgba(235, 155, 175, 0.4);
        }
        .message-bubble.user { flex-direction: row-reverse; }
        #typing-indicator { align-self: flex-start; display: none; margin: 0 10px 10px; color: var(--text-secondary); }
        #chat-input-area { flex-shrink: 0; padding: 8px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 5px; }
        #chat-input-main-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; }
        #chat-input { flex-grow: 1; border: none; padding: 10px 15px; border-radius: 20px; background-color: var(--secondary-bg); font-size: 16px; max-height: 100px; resize: none; }
        
        /* @åŠŸèƒ½æ ·å¼ */
        .mention-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: var(--secondary-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .mention-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .mention-item:hover,
        .mention-item.selected {
            background-color: var(--hover-bg);
        }
        
        /* ä¸ºä¸åŒä¸»é¢˜é€‚é…@ä¸‹æ‹‰æ¡†èƒŒæ™¯ */
        body[data-theme="dark"] .mention-dropdown {
            background: rgba(45, 45, 45, 0.95);
        }
        
        body[data-theme="cute"] .mention-dropdown {
            background: rgba(255, 240, 245, 0.95);
        }
        
        body[data-theme="tech"] .mention-dropdown {
            background: rgba(15, 23, 42, 0.95);
        }
        
        .mention-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        
        .mention-name {
            font-size: 14px;
            color: var(--text-color);
        }
        
        .mention-tag {
            color: #4a84c1;
            font-weight: 500;
        }
        
        #chat-input-container {
            position: relative;
            flex-grow: 1;
        }
        .action-button { border: none; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        #send-btn { 
    background-color: rgb(74, 132, 193); /* é™ä½é¥±å’Œåº¦ä½†æé«˜ä¸é€æ˜åº¦ */
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    height: 40px; 
    padding: 0 15px;
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    color: white;
    font-weight: 600; /* åŠ ç²—å­—ä½“ */
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); /* æ·»åŠ æ–‡å­—é˜´å½±æé«˜å¯è¯»æ€§ */
    letter-spacing: 0.5px; /* å¢åŠ å­—é—´è· */
    transition: all 0.2s ease;
}

#send-btn:hover {
    background-color: rgba(72, 125, 178, 0.95);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
        .modal-footer button { width: 45%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-color); cursor: pointer; font-size: 16px; }
        .modal-footer .save { background-color: var(--accent-color); color: white; }
        .modal-footer .cancel { background-color: white; color: var(--accent-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .avatar-upload button { padding: 8px 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; }
        #open-persona-library-btn { font-size: 14px; padding: 6px 10px; margin-left: auto; }
        .avatar-upload input[type="file"] { display: none; }
        .theme-selector label { display: inline-flex; align-items: center; margin-right: 15px; margin-bottom: 5px; cursor: pointer; }
        #reset-theme-btn { background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #group-members-settings { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 15px; }
        .member-editor { text-align: center; cursor: pointer; }
        .member-editor img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; margin-bottom: 5px; }
        .member-editor .member-name { font-size: 12px; }
        .member-action-btn { 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.2s ease;
        }
        .member-action-btn .btn-avatar { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            background: rgba(240, 240, 240, 0.8); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 24px; 
            color: #666; 
            margin-bottom: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .member-action-btn .btn-label { 
            font-size: 12px; 
            color: #666;
        }
        .member-action-btn:hover .btn-avatar { 
            background: rgba(220, 220, 220, 0.9); 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        #notification-bar { position: absolute; top: 40px; left: 5%; width: 90%; z-index: 500; background-color: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; cursor: pointer; transform: translateY(-150%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); visibility: hidden; }
        #notification-bar.visible { transform: translateY(0); visibility: visible; }
        #notification-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        #notification-content .name { font-weight: 600; font-size: 15px; color: #000; }
        #notification-content .message { font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .sticker-image { max-width: 100px; max-height: 100px; display: block; object-fit: contain; }
        .message-bubble.is-sticker .content, .message-bubble.is-voice-message .content { padding: 0; background-color: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        
        /* è¯­éŸ³æ¶ˆæ¯å®¹å™¨ */
        .voice-message-container {
            width: 100%;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        /* ç”¨æˆ·è¯­éŸ³æ¶ˆæ¯å®¹å™¨å³å¯¹é½ */
        .voice-message-container.user {
            align-self: flex-end;
            align-items: flex-end;
        }
        
        /* AIè¯­éŸ³æ¶ˆæ¯å®¹å™¨å·¦å¯¹é½ */
        .voice-message-container.ai {
            align-self: flex-start;
            align-items: flex-start;
        }
        
        /* AIè¯­éŸ³æ–‡æœ¬æ¡†ä¸AIè¯­éŸ³æ¡å·¦è¾¹ç¼˜å¯¹é½ */
        .voice-message-container.ai .voice-text-content {
            margin-left: 44px; /* å¤´åƒ(32px) + é—´è·(12px) */
        }
        
        /* ç”¨æˆ·è¯­éŸ³æ–‡æœ¬æ¡†ä¸ç”¨æˆ·è¯­éŸ³æ¡å³è¾¹ç¼˜å¯¹é½ */
        .voice-message-container.user .voice-text-content {
            margin-right: 44px; /* å¤´åƒ(32px) + é—´è·(12px) */
            align-self: flex-end;
        }
        #chat-input-actions-top { display: flex; gap: 8px; padding: 0 5px; }
        .chat-action-icon-btn { font-size: 24px; padding: 0; width: 38px; height: 38px; line-height: 38px; text-align: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); color: var(--text-primary); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; display:flex; justify-content:center; align-items:center; }
        #sticker-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-panel-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #sticker-panel-header .title { font-weight: 600; }
        #sticker-panel-header .panel-btn { font-size: 16px; padding: 5px 10px; cursor: pointer; color: var(--accent-color); }
        #sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .sticker-item { position: relative; aspect-ratio: 1 / 1; background-color: white; border-radius: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sticker-item .delete-btn { display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; border: 2px solid white; }
        #input-actions-wrapper { position: static; display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        #wait-reply-btn { position: static; bottom: auto; right: auto; width: auto; height: 40px; padding: 0 10px; border-radius: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: opacity 0.2s, transform 0.1s; cursor: pointer;}
        #wait-reply-btn:hover { opacity: 0.8; }
        #wait-reply-btn:active { transform: scale(0.9); }
        #wait-reply-btn img { height: 22px; display: block; margin: auto; }
        
        /* ç­‰å¾…å›å¤æŒ‰é’®çš„ä¸»é¢˜åˆ‡æ¢ */
        body[data-theme="cute"] #wait-reply-btn img {
            content: url('https://i.postimg.cc/HxmLGLfk/IMG-5103.png');
        }
        
        /* å‘é€æŒ‰é’®åœ¨å¯çˆ±é£ä¸»é¢˜ä¸‹çš„æ ·å¼ */
        body[data-theme="cute"] #send-btn {
            background-color: rgb(248, 187, 208) !important; /* æ·¡ç²‰è‰² */
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        body[data-theme="cute"] #send-btn:hover {
            background-color: rgba(246, 173, 198, 0.95) !important;
        }
        .chat-image { max-width: 100%; border-radius: 10px; display: block; }
        .message-bubble.has-image .content { padding: 5px; }
        
        /* ç”¨æˆ·å‘é€çš„å›¾ç‰‡ç¼©ç•¥å›¾æ ·å¼ */
        .message-bubble.user .chat-image {
            max-width: 120px;
            max-height: 120px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .message-bubble.user .chat-image:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        /* AIå‘é€çš„å›¾ç‰‡ä¿æŒåŸæ · */
        .message-bubble.ai .chat-image {
            max-width: 100%;
            border-radius: 10px;
        }
        
        /* å›¾ç‰‡æŸ¥çœ‹å™¨æ¨¡æ€æ¡† */
        #image-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #image-viewer-modal.visible {
            display: flex;
            opacity: 1;
        }
        
        .image-viewer-content {
            position: relative;
            max-width: 85vw;
            max-height: 85vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #viewer-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        
        .image-viewer-close {
            position: absolute;
            top: -45px;
            right: -5px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            transition: all 0.2s ease;
            z-index: 2001;
        }
        
        .image-viewer-close:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s ease-in-out; }
        #custom-modal-overlay.visible { display: flex; opacity: 1; }
        #custom-modal { background-color: #fff; width: 280px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        #custom-modal-overlay.visible #custom-modal { transform: scale(1); }
        .custom-modal-header { padding: 16px; font-size: 17px; font-weight: 600; text-align: center; }
        .custom-modal-body { padding: 0 16px 16px; text-align: center; font-size: 14px; color: #333; line-height: 1.5; }
        .custom-modal-body p { margin: 0; margin-bottom: 12px; }
        .custom-modal-body input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        .custom-modal-footer { border-top: 1px solid #dbdbdb; display: flex; }
        .custom-modal-footer button { flex: 1; background: none; border: none; padding: 12px; font-size: 17px; cursor: pointer; color: var(--accent-color); }
        .custom-modal-footer button:first-child { border-right: 1px solid #dbdbdb; }
        .custom-modal-footer .confirm-btn { font-weight: 600; }
        .custom-modal-footer .confirm-btn.btn-danger { color: #ff3b30; }
        #preset-actions-modal .custom-modal-footer { flex-direction: column; }
        #preset-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #preset-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        .custom-multiselect { position: relative; user-select: none; }
        .select-box { display: flex; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fff; cursor: pointer; }
        .select-box .selected-options-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
        .select-box .arrow-down { margin-left: auto; font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .select-box.expanded .arrow-down { transform: rotate(180deg); }
        .checkboxes-container { display: none; position: absolute; top: 105%; left: 0; right: 0; max-height: 150px; overflow-y: auto; background-color: #fff; border: 1px solid var(--border-color); border-radius: 8px; z-index: 101; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .checkboxes-container.visible { display: block; }
        .checkboxes-container label { display: block; padding: 10px 12px; cursor: pointer; font-weight: normal; color: var(--text-primary); }
        .checkboxes-container label:hover { background-color: #f5f5f5; }
        .checkboxes-container input { margin-right: 10px; vertical-align: middle; }
        .bg-upload-container { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .bg-preview-img { max-width: 120px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-color); object-fit: cover; display: none; }
        #remove-bg-btn { padding: 8px 12px; border: 1px solid #ff3b30; color: #ff3b30; background-color: #fff; border-radius: 5px; cursor: pointer; font-size: 14px; display: none; }
        .message-bubble.is-ai-image .content { padding: 5px; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        .ai-generated-image { max-width: 180px; border-radius: 12px; display: block; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .ai-generated-image:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .voice-message-body { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; min-width: 80px; max-width: 200px; }
        .message-bubble.user .voice-message-body { color: #1a3d00; flex-direction: row-reverse; }
        .message-bubble.ai .voice-message-body { color: var(--text-primary); }
        .voice-waveform { display: flex; align-items: center; height: 20px; gap: 2px; flex-grow: 1; margin: 0 10px; }
        .voice-waveform div { width: 3px; background-color: currentColor; border-radius: 2px; animation: wave-quiet 1.5s ease-in-out infinite; }
        @keyframes wave-quiet { 0%, 100% { height: 2px; } 50% { height: 10px; } }
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
        .voice-duration { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
        .message-bubble.user .voice-duration { color: #3e6224; }
        
        /* è¯­éŸ³å†…å®¹å±•å¼€æ ·å¼ */
        .voice-text-content {
            display: none;
            margin-top: 12px;
            padding: 10px 15px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            word-break: break-word;
            width: fit-content;
            max-width: 200px;
            animation: voiceTextFadeIn 0.3s ease-in-out;
            border: 1px solid rgba(0,0,0,0.08);
        }
        
        .voice-text-content.visible {
            display: block;
        }
        
        @keyframes voiceTextFadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* æˆ³ä¸€æˆ³æ¶ˆæ¯æ ·å¼ */
        .poke-message {
            text-align: center;
            color: #999;
            font-size: 13px;
            margin: 0;
            padding: 5px 15px;
            background: rgba(0,0,0,0.05);
            border-radius: 15px;
            max-width: 200px;
            align-self: center;
            animation: pokeShake 0.5s ease-in-out;
        }
        
        /* æ’¤å›æ¶ˆæ¯æ ·å¼ */
        .recalled-message {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin: 5px 0;
            padding: 5px 0;
            width: 100%;
            animation: recallFadeIn 0.5s ease-in-out;
        }
        
        .message-wrapper.system {
            display: flex;
            justify-content: center;
            width: 100%;
            margin: 5px 0;
        }
        
        @keyframes recallFadeIn {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pokeShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        /* === æ°”æ³¡ä¸»é¢˜æ ·å¼ === */
        .message-bubble.user .content { background-color: rgba(160, 233, 86, 0.75); color: #1a3d00; border-radius: 20px 8px 20px 20px; }
        .message-bubble.ai .content { background-color: rgba(255, 255, 255, 0.7); color: var(--text-primary); border-radius: 8px 20px 20px 20px; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.user .content { background-color: #FADADD; color: #5D3A3A; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { background-color: #D6EAF8; color: #283747; }
        #chat-messages[data-theme="blue_white"] .message-bubble.user .content { background-color: #cce5ff; color: #004085; }
        #chat-messages[data-theme="blue_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { background-color: #E6E6FA; color: #4B0082; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { background-color: #FFFACD; color: #5C4033; }
        #chat-messages[data-theme="black_white"] .message-bubble.user .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="black_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #343a40; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.user .content { background-color: #FFEB3B; color: #5D4037; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="red_black"] .message-bubble.user .content { background-color: #C62828; color: #FFFFFF; }
        #chat-messages[data-theme="red_black"] .message-bubble.ai .content { background-color: #212121; color: #FFFFFF; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { background-color: #A0D2EB; color: #153243; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { background-color: #E6E6FA; color: #4B0082; }
        #chat-messages[data-theme="gray_white"] .message-bubble.user .content { background-color: #e9ecef; color: #495057; }
        #chat-messages[data-theme="gray_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="blue_green"] .message-bubble.user .content { background-color: #d1ecf1; color: #0c5460; }
        #chat-messages[data-theme="blue_green"] .message-bubble.ai .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="pink_white"] .message-bubble.user .content { background-color: #fce4ec; color: #880e4f; }
        #chat-messages[data-theme="pink_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="pink_black"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="pink_green"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_green"] .message-bubble.ai .content { background-color: #C8E6C9; color: #1B5E20; }
        #chat-messages[data-theme="green_black"] .message-bubble.user .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="green_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }

        /* è‡ªå®šä¹‰æ ·å¼å®¹å™¨ - ç”¨æˆ·è‡ªå®šä¹‰çš„CSSæ ·å¼å°†é€šè¿‡JavaScriptåŠ¨æ€æ³¨å…¥ */

        /* æ¶ˆæ¯ç¼–è¾‘ç›¸å…³æ ·å¼ */
        .message-bubble.editing {
            position: relative;
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
            border-radius: 12px;
        }

        .message-bubble.editing::after {
            content: 'ç¼–è¾‘ä¸­...';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
            z-index: 10;
        }

        /* æ¶ˆæ¯ç¼–è¾‘æ¨¡æ€æ¡†æ ·å¼ */
        #message-edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #message-edit-modal.visible {
            display: flex;
            opacity: 1;
        }

        .message-edit-content {
            background-color: white;
            border-radius: 15px;
            width: 90%;
            max-width: 350px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        #message-edit-modal.visible .message-edit-content {
            transform: scale(1);
        }

        .message-edit-header {
            padding: 20px 20px 10px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            position: relative;
        }

        .message-edit-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-edit-close {
            position: absolute;
            right: 15px;
            top: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .message-edit-close:hover {
            background-color: #f0f0f0;
            color: #666;
        }

        .message-edit-body {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .message-edit-form-group {
            margin-bottom: 15px;
        }

        .message-edit-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .message-edit-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }

        .message-edit-textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(74, 132, 193, 0.2);
        }

        .message-edit-role-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .message-edit-role-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(74, 132, 193, 0.2);
        }

        .message-edit-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .message-edit-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
        }

        .message-edit-btn-cancel {
            background-color: #f5f5f5;
            color: #666;
        }

        .message-edit-btn-cancel:hover {
            background-color: #e8e8e8;
        }

        .message-edit-btn-save {
            background-color: var(--accent-color);
            color: white;
        }

        .message-edit-btn-save:hover {
            background-color: rgba(74, 132, 193, 0.9);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 132, 193, 0.3);
        }

        .message-edit-btn-save:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* å¯çˆ±é£æ ¼ä¸»é¢˜é€‚é… */
        body[data-theme="cute"] .message-edit-content {
            background: linear-gradient(135deg, #fff9fc 0%, #fff0f6 100%);
        }

        body[data-theme="cute"] .message-edit-btn-save {
            background: linear-gradient(135deg, #e585a3, #e5a3d6);
        }

        body[data-theme="cute"] .message-edit-btn-save:hover {
            background: linear-gradient(135deg, #d6758f, #e585a3);
        }

        #transfer-btn { font-weight: bold; }
        #transfer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
        #transfer-modal.visible { display: flex; }
        .transfer-content { background-color: #fff0f5; border-radius: 20px; width: 290px; padding: 20px; box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); text-align: center; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); background-repeat: no-repeat; background-position: top right; background-size: 80px; }
        .transfer-header { font-size: 20px; font-weight: bold; color: #a35c7b; margin-bottom: 20px; }
        .transfer-input-group { margin-bottom: 15px; text-align: left; }
        .transfer-input-group label { display: block; font-size: 14px; color: #ff85b3; margin-bottom: 5px; font-weight: 500; }
        .transfer-input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ffcce0; background-color: #fff; font-size: 16px; box-sizing: border-box; }
        .transfer-input-group input:focus { border-color: #ff85b3; outline: none; }
        .transfer-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-actions button:active { transform: scale(0.95); }
        #transfer-cancel-btn { background-color: #ffdde9; color: #a35c7b; }
        #transfer-confirm-btn { background-color: #ff85b3; color: white; }
        .message-bubble.is-transfer .content { padding: 0; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; cursor: pointer; }
        .transfer-card { width: 200px; border-radius: 12px; padding: 12px; color: white; position: relative; overflow: hidden; transition: opacity 0.3s ease; }
        .transfer-card::before { content: 'ğŸ¾'; position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .message-bubble.user .transfer-card { background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); }
        .message-bubble.ai .transfer-card { background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); }
        .transfer-card.accepted { opacity: 0.6; }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        .transfer-status { font-size: 12px; text-align: right; margin-top: 8px; font-weight: 500; }
        
        /* è½¬è´¦ç¡®è®¤å¼¹çª— */
        #transfer-confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1002; }
        #transfer-confirm-modal.visible { display: flex; }
        .transfer-confirm-content { background-color: #fff; border-radius: 20px; width: 280px; padding: 20px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2); text-align: center; }
        .transfer-confirm-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; }
        .transfer-confirm-info { margin-bottom: 20px; }
        .transfer-confirm-amount { font-size: 24px; font-weight: bold; color: #ff85b3; margin: 10px 0; }
        .transfer-confirm-note { font-size: 14px; color: #666; margin-bottom: 10px; }
        .transfer-confirm-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-confirm-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-confirm-actions button:active { transform: scale(0.95); }
        #transfer-reject-btn { background-color: #f0f0f0; color: #666; }
        #transfer-accept-btn { background-color: #ff85b3; color: white; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #listen-together-btn img.rotating { animation: spin 2s linear infinite; }
        #listen-together-btn img.paused { animation-play-state: paused; }
        #music-player-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); }
        #music-player-overlay.visible { display: flex; }
        .music-player-window { width: 90%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); padding: 25px; display: flex; flex-direction: column; align-items: center; color: #1f1f1f; position: relative; }
        #music-playlist-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }
        #music-time-counter { font-size: 12px; color: #555; margin-bottom: 20px; }
        #music-player-song-title { font-size: 20px; font-weight: 600; margin-bottom: 5px; text-align: center; }
        #music-player-artist { font-size: 14px; color: #666; margin-bottom: 25px; }
        .music-controls { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 30px; }
        .music-controls button { background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #333; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .music-controls button:active { transform: scale(0.9); }
        .music-controls .play-pause-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 50%; background-color: rgba(0,0,0,0.05); }
        .music-bottom-actions { display: flex; justify-content: space-between; width: 100%; }
        .music-bottom-actions button { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; }
        #music-exit-btn { background-color: rgba(255, 100, 100, 0.7); color: white; margin-right: 5px; }
        #music-return-btn { background-color: rgba(0, 123, 255, 0.7); color: white; margin-left: 5px; }
        
        #music-playlist-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background-color: rgba(242, 242, 247, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 210; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #music-playlist-panel.visible { transform: translateY(0); visibility: visible; }
        .playlist-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .playlist-header .panel-btn { font-size: 16px; cursor: pointer; color: var(--accent-color); }
        .playlist-body { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        .playlist-item { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .playlist-item.playing { background-color: rgba(0, 123, 255, 0.1); }
        .playlist-item-info .title { font-weight: 500; font-size: 15px; }
        .playlist-item-info .artist { font-size: 12px; color: #666; }
        .playlist-item .delete-track-btn { color: #ff3b30; font-size: 20px; padding: 5px; }

        /* APIé…ç½®å¡ç‰‡æ ·å¼ */
        .config-card {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            position: relative;
            overflow: hidden;
        }
        .config-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
        }
        .config-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }
        .config-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .config-card.active::before {
            opacity: 1;
        }
        .config-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .config-name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .config-actions {
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .config-card:hover .config-actions {
            opacity: 1;
        }
        .config-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .config-action-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        .config-details {
            display: grid;
            gap: 8px;
            font-size: 13px;
        }
        .config-detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 6px;
        }
        .config-detail-label {
            color: #666;
            font-weight: 500;
            min-width: 40px;
        }
        .config-detail-value {
            color: #333;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .config-use-btn {
            width: 100%;
            padding: 10px;
            margin-top: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        .config-use-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .config-use-btn:active {
            transform: translateY(0);
        }

        /* Persona Library Styles */
        #persona-library-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .persona-preset-item { aspect-ratio: 1 / 1; border-radius: 12px; background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.1); }
        .persona-preset-item:hover { transform: scale(1.08); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-header .action-button { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; background: none; border: none; padding: 5px; }
        
        /* Battery Alert Modal Styles */
        #battery-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        #battery-alert-modal.visible { display: flex; opacity: 1; }
        .battery-alert-content { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); width: 280px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; padding: 20px; cursor: pointer; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #battery-alert-modal.visible .battery-alert-content { transform: scale(1); }
        #battery-alert-image { max-width: 100px; max-height: 100px; margin-bottom: 15px; }
        #battery-alert-text { font-size: 16px; font-weight: 500; color: #333; margin: 0; line-height: 1.4; }

        /* ç¤¾äº¤ä¸»é¡µæ¨¡æ€å¼¹çª—æ ·å¼ */
        .social-profile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .social-profile-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #f5f5f5;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }



        .social-profile-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            max-height: 80vh; /* ç¡®ä¿ä¸è¶…å‡ºæ¨¡æ€å¼¹çª— */
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .social-profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        .social-profile-back {
            background: none;
            border: none;
            font-size: 24px;
            color: #333;
            cursor: pointer;
            padding: 5px;
        }

        .social-profile-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .social-profile-edit-btn {
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: #7b9faf; /* é»˜è®¤é›¾éœ¾è“èƒŒæ™¯ */
        }

        /* æ ¹æ®ä¸»é¢˜è®¾ç½®ç¼–è¾‘æŒ‰é’®é¢œè‰² */
        [data-weibo-theme="white"] .social-profile-edit-btn {
            background: #7b9faf; /* é›¾éœ¾è“ */
        }

        [data-weibo-theme="white"] .social-profile-edit-btn:hover {
            background: #6a96ab;
            transform: translateY(-1px);
        }

        [data-weibo-theme="pink"] .social-profile-edit-btn {
            background: #d4a5a5; /* é›¾éœ¾ç²‰ */
        }

        [data-weibo-theme="pink"] .social-profile-edit-btn:hover {
            background: #c99494;
            transform: translateY(-1px);
        }

        [data-weibo-theme="dark"] .social-profile-edit-btn {
            background: #7b9faf; /* é›¾éœ¾è“ */
        }

        [data-weibo-theme="dark"] .social-profile-edit-btn:hover {
            background: #6a96ab;
            transform: translateY(-1px);
        }

        /* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */
        .social-profile-user-section {
            flex-shrink: 0;
            margin-bottom: -10px; /* è®©ç”¨æˆ·ä¿¡æ¯åŒºåŸŸæ›´è´´è¿‘æ ‡ç­¾é¡µ */
        }

        .social-profile-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: cover;
            background-position: center;
            padding: 30px 20px 50px; /* ä¸Šè¾¹è·å°ä¸€äº›ï¼Œä¸‹è¾¹è·å¤§ä¸€äº›ï¼Œè®©å†…å®¹åä¸‹ */
            display: flex;
            align-items: flex-end; /* è®©å†…å®¹é è¿‘åº•éƒ¨ */
            gap: 20px;
            min-height: 160px; /* ä¿æŒåŸæ¥çš„é«˜åº¦ */
        }

        .social-profile-avatar {
            width: 90px; /* æ¢å¤åŸæ¥çš„å¤´åƒå¤§å° */
            height: 90px;
            border-radius: 50%;
            border: 4px solid rgba(255,255,255,0.8);
            object-fit: cover;
            flex-shrink: 0;
        }

        .social-profile-user-info {
            flex: 1;
            color: white;
        }

        .social-profile-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 5px;
            color: white;
        }

        .social-profile-signature {
            font-size: 14px;
            color: rgba(255,255,255,0.9);
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .social-profile-stats {
            display: flex;
            gap: 15px;
        }

        .social-profile-stat {
            font-size: 13px;
            color: rgba(255,255,255,0.9);
        }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .social-profile-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        .social-profile-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .social-profile-tab.active {
            color: #ff6b6b;
            border-bottom-color: #ff6b6b;
        }

        /* å†…å®¹åŒºåŸŸ */
        .social-profile-tab-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            background: white;
            min-height: 0; /* ç¡®ä¿flexå­å…ƒç´ å¯ä»¥ç¼©å° */
            -webkit-overflow-scrolling: touch; /* iOSå¹³æ»‘æ»šåŠ¨ */
            height: 0; /* å¼ºåˆ¶flexå­å…ƒç´ è®¡ç®—é«˜åº¦ */
        }

        .social-profile-posts-list {
            padding: 20px;
            min-height: 100%; /* ç¡®ä¿æœ‰è¶³å¤Ÿé«˜åº¦è§¦å‘æ»šåŠ¨ */
        }

        .social-profile-post-item {
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .social-profile-post-content {
            font-size: 14px;
            color: #333;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .social-profile-post-time {
            font-size: 12px;
            color: #999;
        }


        .retry-btn {
          display: inline-flex;
          align-items: center;
          gap: 4px;
          background: #f0f0f0;
          color: rgb(74, 132, 193);
          border: none;
          border-radius: 16px;
          padding: 4px 12px;
          font-size: 14px;
          cursor: pointer;
          margin-left: 6px;
          transition: background 0.2s;
        }
        .retry-btn[disabled] {
          opacity: 0.5;
          cursor: not-allowed;
        }
        .retry-btn:hover:not([disabled]) {
          background: #e0eaff;
        }
        .retry-icon {
          width: 18px;
          height: 18px;
          display: inline-block;
          vertical-align: middle;
        }
        
        /* è‡ªå®šä¹‰å›¾æ ‡å¼¹çª—æ ·å¼ */
        #custom-icon-modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.4); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
        }
        #custom-icon-modal.visible { 
            display: flex; 
        }
        #custom-icon-modal .modal-content { 
            width: 320px; 
            max-width: 90%; 
            background-color: white; 
            border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transform: scale(0.95);
            transition: transform 0.2s ease-in-out;
        }
        #custom-icon-modal.visible .modal-content { 
            transform: scale(1); 
        }

        /* é€šè¯åŠŸèƒ½æ ·å¼ */
        #call-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .call-window {
            background: linear-gradient(135deg, #f8e6e6 0%, #f0d0d0 50%, #e8c4c4 100%);
            width: 90%;
            max-width: 320px;
            border-radius: 20px;
            padding: 25px 15px;
            color: #333333;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 8px 32px rgba(167, 163, 163, 0.3);
            display: flex;
            flex-direction: column;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        #call-overlay.visible {
            display: flex;
            opacity: 1;
        }
        
        #call-overlay.visible .call-window {
            transform: scale(1);
        }
        
        .call-header {
            text-align: center;
            margin-bottom: 15px;
            margin-top: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .call-contact-name {
            font-size: 20px;
            font-weight: 600;
            color: #333333;
            margin: 10px 0 8px 0;
        }
        
        .call-contact-name::before {
            content: "âœ¨ ";
        }
        
        .call-contact-name::after {
            content: " âœ¨";
        }
        
        .call-avatar {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            border: 3px solid rgba(255,255,255,0.8);
            object-fit: cover;
            display: block;
            animation: breathing 2s ease-in-out infinite;
        }
        
        @keyframes breathing {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(255,255,255,0.5);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(255,255,255,0.8);
            }
        }
        
        .call-timer {
            font-size: 14px;
            margin-bottom: 15px;
            color: #333333;
            text-align: center;
            background: rgba(255,255,255,0.6);
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-block;
            width: fit-content;
            margin: auto;
        }
        
        .call-messages {
            width: calc(100% - 10px);
            height: 150px;
            overflow-y: auto;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 8px 10px;
            margin-bottom: 10px;
            margin-left: 1px;
            margin-right: 40px;
            display: flex;
            flex-direction: column;
        }
        
        .call-message {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.4;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .call-message.user {
            background: rgba(245, 229, 229, 0.5);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: #222222;
            border: 1px solid rgba(255,255,255,0.6);
            align-self: flex-end;
            border-radius: 15px 5px 15px 15px;
        }
        
        .call-message.ai {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: #222222;
            border: 1px solid rgba(255,255,255,0.5);
            align-self: flex-start;
            border-radius: 5px 15px 15px 15px;
        }
        
        .call-message.description {
            background: transparent;
            color: #555555;
            font-style: italic;
            font-size: 13px;
            align-self: center;
            text-align: center;
            padding: 4px 8px;
            max-width: 90%;
        }
        
        .call-input-area {
            width: 100%;
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .call-input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.6);
            color: #333333;
            font-size: 15px;
        }
        
        .call-input::placeholder {
            color: #888888;
        }
        
        .call-send-btn {
            background: rgba(255,255,255,0.6);
            border: none;
            color: #333333;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }
        
        .call-controls {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .call-control-btn {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: transform 0.2s;
        }
        
        .call-control-btn:active {
            transform: scale(0.9);
        }
        
        .call-hangup-btn {
            background: #e8a8a8;
            color: white;
        }
        
        /* é€šè¯é€‰æ‹©å¼¹çª— */
        #call-type-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        #call-type-modal.visible {
            display: flex;
        }
        
        .call-type-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            width: 280px;
        }
        
        .call-type-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }
        
        .call-type-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .call-type-btn {
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .call-type-btn:active {
            transform: scale(0.95);
        }
        
        .call-voice-btn {
            background: rgba(255, 182, 193, 0.8);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: #ff1493;
            border: 1px solid rgba(255, 182, 193, 0.3);
            box-shadow: 0 4px 15px rgba(255, 182, 193, 0.4);
            transition: all 0.3s ease;
        }
        
        .call-voice-btn:hover {
            background: rgba(255, 182, 193, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 182, 193, 0.5);
        }
        
        .call-video-btn {
            background: rgba(173, 216, 230, 0.8);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: #4169e1;
            border: 1px solid rgba(173, 216, 230, 0.3);
            box-shadow: 0 4px 15px rgba(173, 216, 230, 0.4);
            transition: all 0.3s ease;
        }
        
        .call-video-btn:hover {
            background: rgba(173, 216, 230, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(173, 216, 230, 0.5);
        }
        
        .call-cancel-btn {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: #666;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .call-cancel-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        /* é€šè¯åŠ è½½æŒ‡ç¤ºå™¨ */
        .call-typing-indicator {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: #222222;
            border: 1px solid rgba(255,255,255,0.5);
            align-self: flex-start;
            border-radius: 5px 15px 15px 15px;
            font-size: 14px;
            max-width: 80%;
        }

        .call-typing-dots {
            display: flex;
            gap: 4px;
            margin-left: 8px;
        }

        .call-typing-dot {
            width: 6px;
            height: 6px;
            background-color: #666;
            border-radius: 50%;
            animation: callTypingBounce 1.4s infinite ease-in-out;
        }

        .call-typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .call-typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .call-typing-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes callTypingBounce {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* ä¸»é¢˜é€‰æ‹©å™¨æ ·å¼ */
        .theme-style-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .theme-style-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-style-option:hover {
            transform: translateY(-5px);
        }

        .theme-style-option.active {
            position: relative;
        }

        .theme-style-option.active::after {
            content: "âœ“";
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .theme-preview {
            width: 100px;
            height: 160px;
            border-radius: 15px;
            border: 2px solid #ddd;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .theme-preview::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 30px;
            background-color: rgba(247, 247, 247, 0.8);
        }

        .theme-preview::after {
            content: "";
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background-color: #000;
            border-radius: 2px;
            opacity: 0.2;
        }

        .simple-theme {
            background-color: #f7f7f7;
        }

        .simple-theme::before {
            background-color: rgba(247, 247, 247, 0.8);
        }

        .cute-theme {
            background-color: #fff9fc;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 50 L80 80 L50 100 L20 80 Z' fill='%23ffccd5' fill-opacity='0.2'/%3E%3Cpath d='M0 0 L50 0 L50 50 L0 50 Z' fill='%23ffb6c1' fill-opacity='0.1'/%3E%3Cpath d='M50 0 L100 0 L100 50 L50 50 Z' fill='%23ffb6c1' fill-opacity='0.1'/%3E%3C/svg%3E");
        }

        .cute-theme::before {
            background-color: rgba(255, 230, 240, 0.85);
        }

        /* å¯çˆ±é£æ ¼ç‰¹æœ‰å…ƒç´  */
        body[data-theme="cute"] .form-button {
            border-radius: 30px;
            background-image: linear-gradient(to right, rgba(255, 182, 193, 0.8), rgba(255, 192, 203, 0.8));
            letter-spacing: 0.5px;
        }

        body[data-theme="cute"] .form-button:hover {
            background-image: linear-gradient(to right, rgba(255, 182, 193, 0.9), rgba(255, 192, 203, 0.9));
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 5px 15px rgba(255, 105, 180, 0.3);
        }

        body[data-theme="cute"] .header {
            border-bottom: 1px solid #ffccd5;
        }

        body[data-theme="cute"] .header-title {
            letter-spacing: 0.5px;
        }

        body[data-theme="cute"] #phone-frame {
            box-shadow: 0 20px 50px rgba(255, 105, 180, 0.25), inset 0 2px 4px rgba(0,0,0,0.1);
        }

        body[data-theme="cute"] #app-grid .app-icon .icon-bg {
            border-radius: 25px;
            box-shadow: 0 4px 8px rgba(255, 105, 180, 0.2);
        }

        body[data-theme="cute"] .app-icon .label {
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        
        /* å¯çˆ±é£æ ¼çš„è¾“å…¥æ¡†æ ·å¼ */
        body[data-theme="cute"] input, 
        body[data-theme="cute"] textarea, 
        body[data-theme="cute"] select {
            font-family: 'Quicksand', sans-serif;
            font-weight: 500;
        }
        
        /* å¯çˆ±é£æ ¼çš„èŠå¤©è¾“å…¥æ¡† */
        body[data-theme="cute"] #chat-input {
            font-family: 'Quicksand', sans-serif;
            font-weight: 500;
            border-radius: 20px;
            border: 1px solid #ffccd5;
            background-color: rgba(255, 250, 250, 0.9);
        }
        
        /* å¯çˆ±é£æ ¼çš„å¾®åšå¡ç‰‡ */
        body[data-theme="cute"] .weibo-post {
            border-radius: 20px;
            border: 1.5px solid #ffccd5;
            box-shadow: 0 3px 10px rgba(255, 105, 180, 0.1);
        }

        /* å¯çˆ±é£æ ¼çš„èŠå¤©å’Œå¾®åšæ­£æ–‡æ ·å¼ */
        body[data-theme="cute"] .message-bubble .content {
            font-family: 'Quicksand', sans-serif;
            font-weight: 500;
            letter-spacing: 0.3px;
            line-height: 1.6;
        }
        
        body[data-theme="cute"] .post-content {
            font-family: 'Quicksand', sans-serif;
            font-weight: 500;
            letter-spacing: 0.3px;
            line-height: 1.6;
        }
        
        /* å¯çˆ±é£æ ¼çš„æ ‡é¢˜æ ·å¼ */
        body[data-theme="cute"] .header-title {
            font-family: 'Varela Round', sans-serif;
            font-weight: 600;
        }
        
        /* å¯çˆ±é£æ ¼çš„æŒ‰é’®æ–‡å­— */
        body[data-theme="cute"] .form-button {
            font-family: 'Varela Round', sans-serif;
            font-weight: 600;
        }

        /* AIæ¥ç”µå¼¹çª— */
        #incoming-call-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #incoming-call-modal.visible {
            display: flex;
            opacity: 1;
        }
        
        .incoming-call-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 85%;
            max-width: 280px;
            border-radius: 20px;
            padding: 25px 20px;
            text-align: center;
            color: white;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation: callRing 2s infinite;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        #incoming-call-modal.visible .incoming-call-content {
            transform: scale(1);
        }
        
        @keyframes callRing {
            0%, 100% { box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
            50% { box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4); }
        }
        
        .incoming-call-type {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 8px;
        }
        
        .incoming-call-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .incoming-call-avatar {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            margin-bottom: 20px;
            object-fit: cover;
            animation: avatarPulse 2s infinite;
        }
        
        @keyframes avatarPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .incoming-call-controls {
            display: flex;
            gap: 40px;
            align-items: center;
            justify-content: center;
        }
        
        .incoming-call-btn {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: transform 0.2s;
        }
        
        .incoming-call-btn:active {
            transform: scale(0.9);
        }
        
        .call-answer-btn {
            background: #4cd964;
            color: white;
        }
        
        .call-decline-btn {
            background: #ff3b30;
            color: white;
        }

.weibo-nav {
    position: fixed;  /* æ”¹ä¸ºç›¸å¯¹å®šä½ */
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0; 
    display: flex;
    padding: 12px 0;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    border-top: 1px solid #eee;
    z-index: 10;
}

/* æ›´æ–°å¾®åšå†…å®¹åŒºåŸŸçš„å†…è¾¹è·ï¼Œç¡®ä¿å†…å®¹ä¸è¢«å¯¼èˆªæ é®æŒ¡ */
.weibo-container {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    padding-bottom: 80px; /* å¢åŠ åº•éƒ¨å†…è¾¹è·ï¼Œä¸ºå¯¼èˆªæ ç•™å‡ºç©ºé—´ */
}

.weibo-nav .nav-item {
    flex: 1;
    text-align: center;
    font-size: 16px;
    color: #666;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    padding: 8px 4px;
    transition: all 0.2s;
}

/* ç§»é™¤åŸæ¥çš„å›¾æ ‡æ ·å¼ */

.weibo-nav .nav-item.active {
    color: #ff6b81;
}

.weibo-container {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    padding-bottom: 70px;
}

.weibo-post {
    background: var(--weibo-card-bg);
    border-radius: 16px;
    border: 1.5px solid var(--weibo-card-border);
    color: var(--weibo-content-color);
    margin-bottom: 18px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding: 18px 40px 12px 18px;
    font-size: 16px;
    position: relative;
    opacity: var(--weibo-card-opacity);
    transition: opacity 0.3s ease;
}

.post-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
}

.post-info {
    flex: 1;
}

.post-name {
    font-weight: 500;
    font-size: 15px;
}

.post-time {
    font-size: 12px;
    color: #999;
}

.post-visibility {
    font-size: 12px;
    color: #666;
    margin-left: 5px;
}

        .post-content {
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.5;
        }

.post-actions {
    display: flex;
    justify-content: space-around;
    color: #666;
    font-size: 14px;
    border-top: 1px solid #eee;
    padding-top: 10px;
    margin-top: 10px;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 4px;
}
.posting-times {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.time-input-group {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    gap: 8px;
}

.posting-time-input {
    width: 120px;
    padding: 6px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.add-time-btn {
    color: rgb(74, 132, 193);
    background: none;
    border: none;
    padding: 4px 0;
    cursor: pointer;
    font-size: 14px;
}

.remove-time-btn {
    background: #ff3b30;
    color: white;
    border: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

        /* å¾®åšä¸»é¢˜é€‰æ‹©å™¨æ ·å¼ */
        #weibo-theme-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px 0;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }

        .theme-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            display: inline-block;
        }

        .theme-dot:hover {
            transform: scale(1.1);
            border-color: var(--accent-color);
        }

        .theme-dot.active {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
        }

        /* å¾®åšå¤šé€‰åˆ é™¤æ ·å¼ */
        .weibo-selection-mode .weibo-post {
            position: relative;
        }
        
        .weibo-selection-mode .weibo-post.selected {
            background-color: rgba(0, 123, 255, 0.1);
            border-color: var(--accent-color);
        }
        
        .weibo-selection-mode .weibo-post.selected::before {
            content: 'âœ“';
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--accent-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
        }
        
        .weibo-selection-toolbar {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 10px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 100;
        }
        
        .weibo-selection-toolbar.visible {
            display: flex;
        }
        
        .weibo-selection-toolbar .selection-count {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .weibo-selection-toolbar .selection-btn {
            background: none;
            border: none;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .weibo-selection-toolbar .selection-cancel-btn {
            color: var(--text-secondary);
            background: rgba(0,0,0,0.05);
        }
        
        .weibo-selection-toolbar .selection-delete-btn {
            color: #ff3b30;
            background: rgba(255,59,48,0.1);
        }
        
        .weibo-selection-toolbar .selection-btn:hover {
            transform: scale(1.05);
        }
    </style>
<style>
            @keyframes fadeOut {
                0% { opacity: 1; transform: translateY(0); }
                100% { opacity: 0; transform: translateY(10px); }
            }
        </style></head>
<body data-font-size="medium" data-weibo-theme="white" data-theme="simple">
    <div id="phone-frame">
        <!-- <div class="notch"></div> -->
        <div id="phone-screen">
            <div id="status-bar">
                <span id="status-bar-time">18:44</span>
                <div id="ai-heartrate-display" style="display: none;">â™¥ï¸ 72 bpm</div>
                <div id="status-bar-battery" class="battery-container charging">
                    <span class="battery-text">97%</span>
                    <div class="battery-icon">
                        <div class="battery-level" style="width: 97%;"></div>
                    </div>
                </div>
            </div>
            <div id="notification-bar"><img id="notification-avatar" src=""><div id="notification-content"><div class="name"></div><div class="message"></div></div></div>
            
            <div id="home-screen" class="screen" style="background-image: linear-gradient(135deg, rgb(137, 247, 254), rgb(102, 166, 255));">
                <div id="clock-container"><div id="main-time">18:44</div><div id="main-date">8æœˆ18æ—¥æ˜ŸæœŸä¸€</div></div>
                                <div id="app-grid" style="margin-top: auto; margin-bottom: auto;">
                    <div class="app-row">
                        <div class="app-icon" onclick="showScreen('world-book-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/Xqz3zPz7/IMG-3080.jpg" alt="ä¸–ç•Œä¹¦"></div><span class="label">ä¸–ç•Œä¹¦</span></div>
                         <div class="app-icon" onclick="showScreen('weibo-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/8cHffTcX/IMG-3064.jpg" alt="å¾®åš"></div><span class="label">å¾®åš</span></div>
                    </div>
                    <div class="app-row">
                        <div class="app-icon" onclick="showScreen('chat-list-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/dVSd9QBz/IMG-3063.jpg" alt="QQ"></div><span class="label">QQ</span></div>
                        <div class="app-icon" onclick="showScreen('api-settings-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/764L3jpF/IMG-3079.jpg" alt="APIè®¾ç½®"></div><span class="label">APIè®¾ç½®</span></div>
                        <div class="app-icon" onclick="showScreen('wallpaper-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/DyS7X2SW/IMG-3081.jpg" alt="å£çº¸"></div><span class="label">å£çº¸</span></div>
                    </div>
                </div>
            </div>

            <div id="world-book-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">â€¹</span><span class="header-title">ä¸–ç•Œä¹¦</span><div class="header-actions"><span class="action-btn" id="add-world-book-btn">+</span></div></div><div id="world-book-list"></div></div>
            <div id="world-book-editor-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('world-book-screen')">â€¹</span>
                    <span id="world-book-editor-title" class="header-title">ç¼–è¾‘ä¸–ç•Œä¹¦</span>
                    <span class="save-btn" id="save-world-book-btn">ä¿å­˜</span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="world-book-name-input">ä¹¦å</label>
                        <input type="text" id="world-book-name-input" placeholder="è¯·è¾“å…¥ä¸–ç•Œä¹¦çš„åç§°...">
                    </div>
                    <div class="form-group" style="height: 100%;">
                        <label for="world-book-content-input">å†…å®¹</label>
                        <textarea id="world-book-content-input" placeholder="åœ¨æ­¤å¤„è¾“å…¥è¯¦ç»†çš„ä¸–ç•Œè§‚è®¾å®š..."></textarea>
                    </div>
                </div>
            </div>

            <div id="weibo-screen" class="screen" style="background-color: var(--weibo-bg);">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span class="header-title">å¾®åš</span>
        <div class="header-actions">
            <span class="action-btn" id="weibo-theme-btn" title="ä¸»é¢˜è®¾ç½®">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </span>
            <span class="action-btn" id="post-weibo-btn">+</span>
        </div>
    </div>
    
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="weibo-nav">
        <div class="nav-item active">â‰½^ â¦ â©Š â¦ ^â‰¼</div>
        <div class="nav-item">â‚^Ë¶ â•¸ğ–¥¦  â•¸Ëµ^â‚âŸ†</div>
    </div>
    
    <!-- å¾®åšåŠ¨æ€åˆ—è¡¨å®¹å™¨ -->
    <div id="weibo-timeline" class="weibo-container"></div>
    
    <!-- å¾®åšå¤šé€‰åˆ é™¤å·¥å…·æ  -->
    <div id="weibo-selection-toolbar" class="weibo-selection-toolbar">
        <span class="selection-count">å·²é€‰æ‹© 0 æ¡åŠ¨æ€</span>
        <button class="selection-btn selection-cancel-btn" id="weibo-selection-cancel">å–æ¶ˆ</button>
        <button class="selection-btn selection-delete-btn" id="weibo-selection-delete">åˆ é™¤</button>
    </div>
</div>
<!-- å‘å¸ƒå¾®åšçš„å¼¹çª— -->
<div id="post-weibo-modal" class="modal">
    <div class="modal-content" style="border-radius: 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2);">
        <div class="modal-header" style="padding: 20px 20px 0; border-bottom: none;">
            <span style="font-size: 18px; font-weight: 600;">å‘å¸ƒåŠ¨æ€</span>
            <select id="post-visibility" style="background: rgba(255,255,255,0.8); border: 1px solid rgba(0,0,0,0.1); border-radius: 15px; padding: 5px 10px; font-size: 12px;">
                <option value="public">å…¬å¼€</option>
                <option value="friends">ä»…å¥½å‹</option>
                <option value="private">ç§å¯†</option>
            </select>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <textarea id="weibo-content" placeholder="åˆ†äº«æ–°é²œäº‹..." style="width: 100%; min-height: 120px; border: none; background: rgba(255,255,255,0.6); border-radius: 15px; padding: 15px; font-size: 16px; resize: none; box-sizing: border-box; outline: none; transition: all 0.3s ease;" onfocus="this.style.background='rgba(255,255,255,0.8)'; this.style.boxShadow='0 0 15px rgba(102,126,234,0.3)'" onblur="this.style.background='rgba(255,255,255,0.6)'; this.style.boxShadow='none'"></textarea>
            <div class="post-media-btns" style="margin-top: 15px; display: flex; gap: 10px;">
                <button id="add-weibo-photo" style="background: rgba(100,200,255,0.2); backdrop-filter: blur(10px); border: none; color: rgb(74, 132, 193); padding: 8px 16px; border-radius: 20px; font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 5px;" onmouseover="this.style.background='rgba(100,200,255,0.3)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='rgba(100,200,255,0.2)'; this.style.transform='scale(1)'">ğŸ“· æ·»åŠ å›¾ç‰‡</button>
            </div>
            <input type="file" id="weibo-image-input" accept="image/*" style="display: none;">
            <div id="weibo-image-preview" style="margin-top: 10px; display: none;">
                <img id="weibo-preview-img" style="max-width: 100%; max-height: 200px; border-radius: 10px; object-fit: cover;">
                <button id="remove-weibo-image" style="margin-top: 5px; background: rgba(255,0,0,0.1); color: #ff4757; border: none; padding: 5px 10px; border-radius: 10px; font-size: 12px; cursor: pointer;">ç§»é™¤å›¾ç‰‡</button>
            </div>
        </div>
        <div class="modal-footer" style="padding: 0 20px 20px; border-top: none; display: flex; gap: 10px;">
            <button class="cancel" style="flex: 1; background: rgba(0,0,0,0.05); backdrop-filter: blur(10px); border: none; color: #666; padding: 12px; border-radius: 20px; font-size: 16px; cursor: pointer; transition: all 0.2s;">å–æ¶ˆ</button>
            <button class="save weibo-publish-btn" style="flex: 1; background: rgba(74, 132, 193, 0.9); border: none; color: white; padding: 12px; border-radius: 20px; font-size: 16px; cursor: pointer; transition: all 0.2s; font-weight: 600;">å‘å¸ƒ</button>
        </div>
    </div>
</div>

<!-- å¾®åšä¸»é¢˜è®¾ç½®å¼¹çª— -->
<div id="weibo-theme-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>å¾®åšä¸»é¢˜è®¾ç½®</span>
            <span class="action-btn" onclick="document.getElementById('weibo-theme-modal').classList.remove('visible')">Ã—</span>
        </div>
        <div class="modal-body">
            <div id="weibo-theme-selector" style="display: flex; justify-content: center; gap: 15px; margin: 15px 0;">
                <div class="theme-dot" data-theme="white" style="width: 30px; height: 30px; border-radius: 50%; background: #fff; border: 2px solid #ddd; cursor: pointer;"></div>
                <div class="theme-dot" data-theme="pink" style="width: 30px; height: 30px; border-radius: 50%; background: #ffe4ec; border: 2px solid #f8bbd0; cursor: pointer;"></div>
                <div class="theme-dot" data-theme="blue" style="width: 30px; height: 30px; border-radius: 50%; background: #e3f0ff; border: 2px solid #b3e5fc; cursor: pointer;"></div>
                <div class="theme-dot" data-theme="purple" style="width: 30px; height: 30px; border-radius: 50%; background: #f3e8ff; border: 2px solid #e1bee7; cursor: pointer;"></div>
                <div class="theme-dot" data-theme="green" style="width: 30px; height: 30px; border-radius: 50%; background: #eaffea; border: 2px solid #b2dfdb; cursor: pointer;"></div>
                <div class="theme-dot" data-theme="yellow" style="width: 30px; height: 30px; border-radius: 50%; background: #fffbe4; border: 2px solid #fff9c4; cursor: pointer;"></div>
            </div>
            <div id="weibo-bg-preview" style="width: 100%; height: 120px; border: 2px dashed #ccc; border-radius: 8px; margin: 10px 0; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; color: #999;">ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡</div>
            <button class="form-button form-button-secondary" onclick="document.getElementById('weibo-bg-upload-input').click();">ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡</button>
            <input type="file" id="weibo-bg-upload-input" accept="image/*" style="display: none;">
            <button class="form-button form-button-secondary" id="remove-weibo-bg-btn" style="display: none;">ç§»é™¤èƒŒæ™¯</button>
            
            <div style="margin-top: 20px;">
                <label for="card-opacity-slider" style="display: block; margin-bottom: 10px; font-weight: 500;">åŠ¨æ€å¡ç‰‡é€æ˜åº¦: <span id="card-opacity-value">1.0</span></label>
                <input type="range" id="card-opacity-slider" min="0.1" max="1.0" step="0.05" value="1.0" style="width: 100%;">
                <p style="font-size: 12px; color: #777; margin-top: 5px;">
                    é€æ˜åº¦è¶Šä½ï¼ŒåŠ¨æ€å¡ç‰‡è¶Šé€æ˜ï¼›é€æ˜åº¦è¶Šé«˜ï¼ŒåŠ¨æ€å¡ç‰‡è¶Šä¸é€æ˜ã€‚
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel">å–æ¶ˆ</button>
            <button class="save">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- ç”¨æˆ·èµ„æ–™å¡å¼¹çª— -->
<div id="weibo-profile-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>ç¼–è¾‘ä¸ªäººèµ„æ–™</span>
            <span class="action-btn" onclick="document.getElementById('weibo-profile-modal').classList.remove('visible')">Ã—</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>å¤´åƒ</label>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img id="profile-avatar-preview" src="https://i.postimg.cc/PxZrFFFL/o-o-1.jpg" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--weibo-accent);">
                    <button class="form-button form-button-secondary" onclick="document.getElementById('profile-avatar-input').click();">æ›´æ¢å¤´åƒ</button>
                    <input type="file" id="profile-avatar-input" accept="image/*" style="display: none;">
                </div>
            </div>
            <div class="form-group">
                <label for="profile-name-input">æ˜µç§°</label>
                <input type="text" id="profile-name-input" placeholder="è¯·è¾“å…¥æ˜µç§°" value="æˆ‘çš„å¾®åš">
            </div>
            <div class="form-group">
                <label for="profile-signature-input">ä¸ªæ€§ç­¾å</label>
                <textarea id="profile-signature-input" placeholder="è¯·è¾“å…¥ä¸ªæ€§ç­¾å" rows="3">åˆ†äº«ç”Ÿæ´»ä¸­çš„ç¾å¥½ç¬é—´</textarea>
            </div>
            <div class="form-group">
                <label for="profile-email-input">é‚®ç®±</label>
                <input type="email" id="profile-email-input" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€">
            </div>
            <div class="form-group">
                <label>ç¤¾äº¤ä¸»é¡µèƒŒæ™¯</label>
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div id="user-profile-bg-preview" style="width: 120px; height: 80px; border: 2px dashed #ccc; border-radius: 8px; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">é»˜è®¤æ¸å˜èƒŒæ™¯</div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button type="button" class="form-button form-button-secondary" onclick="document.getElementById('user-profile-bg-input').click();" style="width: auto; padding: 8px 12px; margin: 0; font-size: 14px;">ä¸Šä¼ èƒŒæ™¯</button>
                        <button type="button" id="remove-user-profile-bg-btn" style="width: auto; padding: 8px 12px; background: rgba(255,0,0,0.1); color: #ff4757; border: none; border-radius: 5px; font-size: 14px; cursor: pointer; display: none;">ç§»é™¤èƒŒæ™¯</button>
                    </div>
                    <input type="file" id="user-profile-bg-input" accept="image/*" style="display: none;">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel">å–æ¶ˆ</button>
            <button class="save">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- AIèµ„æ–™å¡å¼¹çª— -->
<div id="ai-profile-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="ai-profile-title">AIèµ„æ–™å¡</span>
            <span class="action-btn" onclick="document.getElementById('ai-profile-modal').classList.remove('visible')">Ã—</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>å¤´åƒ</label>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img id="ai-profile-avatar-preview" src="https://i.postimg.cc/PxZrFFFL/o-o-1.jpg" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--weibo-accent);">
                    <button class="form-button form-button-secondary" onclick="document.getElementById('ai-profile-avatar-input').click();">æ›´æ¢å¤´åƒ</button>
                    <input type="file" id="ai-profile-avatar-input" accept="image/*" style="display: none;">
                </div>
            </div>
            <div class="form-group">
                <label for="ai-profile-name-input">æ˜µç§°</label>
                <input type="text" id="ai-profile-name-input" placeholder="è¯·è¾“å…¥æ˜µç§°">
            </div>
            <div class="form-group">
                <label for="ai-profile-signature-input">ä¸ªæ€§ç­¾å</label>
                <textarea id="ai-profile-signature-input" placeholder="è¯·è¾“å…¥ä¸ªæ€§ç­¾å" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="ai-profile-persona-input">è§’è‰²è®¾å®š</label>
                <textarea id="ai-profile-persona-input" placeholder="è¯·è¾“å…¥è§’è‰²è®¾å®š" rows="5"></textarea>
            </div>
            <div class="form-group">
                <label>ç¤¾äº¤ä¸»é¡µèƒŒæ™¯</label>
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div id="ai-profile-bg-preview" style="width: 120px; height: 80px; border: 2px dashed #ccc; border-radius: 8px; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">é»˜è®¤æ¸å˜èƒŒæ™¯</div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button type="button" class="form-button form-button-secondary" onclick="document.getElementById('ai-profile-bg-input').click();" style="width: auto; padding: 8px 12px; margin: 0; font-size: 14px;">ä¸Šä¼ èƒŒæ™¯</button>
                        <button type="button" id="remove-ai-profile-bg-btn" style="width: auto; padding: 8px 12px; background: rgba(255,0,0,0.1); color: #ff4757; border: none; border-radius: 5px; font-size: 14px; cursor: pointer; display: none;">ç§»é™¤èƒŒæ™¯</button>
                    </div>
                    <input type="file" id="ai-profile-bg-input" accept="image/*" style="display: none;">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel">å–æ¶ˆ</button>
            <button class="save">ä¿å­˜</button>
        </div>
    </div>
</div>

            <div id="api-settings-screen" class="screen" style="background-color: #ffffff;"><div class="header" style="background-color: rgba(255, 255, 255, 0.9); border-bottom: 1px solid #eaeaea;"><span class="back-btn" onclick="showScreen('home-screen')" style="color: #000000;">â€¹</span><span class="header-title" style="color: #000000;">API è®¾ç½®</span><span style="width: 30px;"></span></div><div class="form-container" style="color: #000000;"><p style="font-size: 14px; color: #555; background-color: #f9f9f9; padding: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">æç¤º: è‹¥è¦ä½¿ç”¨"å‘é€å›¾ç‰‡"åŠŸèƒ½, è¯·åŠ¡å¿…é€‰æ‹©æ”¯æŒVision(è§†è§‰)çš„æ¨¡å‹, å¦‚<code style="background-color: #f0f0f0; padding: 2px 4px; border-radius: 4px; color: #333;">gpt-4o</code>æˆ–<code style="background-color: #f0f0f0; padding: 2px 4px; border-radius: 4px; color: #333;">gpt-4-vision-preview</code>ã€‚</p><div class="form-group"><label for="proxy-url" style="color: #333;">åä»£åœ°å€ (ä¸éœ€è¦æ·»åŠ /v1å™¢~)</label><input type="text" id="proxy-url" placeholder="ä¾‹å¦‚: https://api.openai.com" style="border: 1px solid #e0e0e0; background-color: #ffffff; color: #333;">
<div style="margin-top: 10px; padding: 12px; background-color: #f0f8ff; border-radius: 8px; border: 1px solid #e1f0ff;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
        <span style="font-size: 14px; font-weight: 500; color: #333;">å¿«é€Ÿè®¾ç½® Gemini ç›´è¿</span>
        <button type="button" id="set-gemini-direct-btn" style="padding: 6px 12px; background-color: #4285f4; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; transition: background-color 0.2s;">
            ä½¿ç”¨ Gemini
        </button>
    </div>
    <div style="font-size: 12px; color: #666; line-height: 1.4;">
        ç‚¹å‡»"ä½¿ç”¨ Gemini"å°†è‡ªåŠ¨å¡«å†™ï¼šhttps://generativelanguage.googleapis.com/v1beta<br>
        <strong>æ³¨æ„ï¼š</strong>ä½¿ç”¨Geminiæ—¶ï¼Œå¯†é’¥åº”å¡«å†™Google AI Studioçš„API Key<br>
        <span style="color: #ff6b6b;">âš ï¸ CORSé—®é¢˜è§£å†³ï¼šå¦‚æœä½¿ç”¨Geminiå®˜æ–¹APIé‡åˆ°è·¨åŸŸé”™è¯¯ï¼Œè¯·é€šè¿‡æœ¬åœ°HTTPæœåŠ¡å™¨è¿è¡Œæ­¤HTMLæ–‡ä»¶ï¼Œæˆ–ä½¿ç”¨ä»£ç†APIæœåŠ¡ã€‚</span>
    </div>
</div>
</div><div class="form-group"><label for="api-key" style="color: #333;">å¯†é’¥ (API Key)</label><input type="password" id="api-key" placeholder="sk-... æˆ– Google AI Studio API Key" style="border: 1px solid #e0e0e0; background-color: #ffffff; color: #333;"></div><div class="form-group"><label for="model-select" style="color: #333;">æ¨¡å‹</label><select id="model-select" style="border: 1px solid #e0e0e0; background-color: #ffffff; color: #333;"></select></div>
<div class="form-group">
    <label for="temperature-slider" style="color: #333;">æ¸©åº¦ (<span id="temperature-value">0.75</span>)</label>
    <input type="range" id="temperature-slider" min="0" max="2" step="0.05" value="0.75" style="width: 100%;">
    <p style="font-size: 12px; color: #777; margin-top: 5px;">
        æ¸©åº¦è¶Šä½ï¼Œå›ç­”è¶Šä¿å®ˆç¨³å®šï¼›æ¸©åº¦è¶Šé«˜ï¼Œå›ç­”è¶Šæœ‰åˆ›æ„å¤šæ ·ã€‚
    </p>
</div>
<button class="form-button" id="fetch-models-btn" style="background-color: rgba(245, 245, 247, 0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0,0,0,0.05);">æ‹‰å–æ¨¡å‹</button>
<button class="form-button form-button-secondary" id="test-api-connection-btn" style="background-color: rgba(245, 245, 247, 0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0,0,0,0.05);">æµ‹è¯•è¿æ¥</button>
<button class="form-button" id="save-api-settings-btn" style="background-color: rgba(245, 245, 247, 0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0,0,0,0.05);">ä¿å­˜è®¾ç½®</button>

<!-- APIé…ç½®ä¿å­˜å¡ç‰‡åŠŸèƒ½ -->
<hr style="margin: 20px 0; border: none; border-top: 1px solid #eaeaea;">
<div class="api-config-manager" style="background: rgba(248, 249, 250, 0.8); border-radius: 16px; padding: 20px; margin: 15px 0; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.05);">
    <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
        <span>ğŸ’¾</span> APIé…ç½®ç®¡ç†
    </h4>
    <p style="font-size: 13px; color: #666; margin: 0 0 15px 0; line-height: 1.5;">ä¿å­˜å½“å‰é…ç½®ä¸ºé¢„è®¾ï¼Œæ–¹ä¾¿å¿«é€Ÿåˆ‡æ¢ä¸åŒçš„APIæœåŠ¡</p>
    
    <div class="save-config-section" style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.6); border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
        <div style="display: flex; gap: 10px; margin-bottom: 12px;">
            <input type="text" id="config-name-input" placeholder="è¾“å…¥é…ç½®åç§° (å¦‚: OpenAIã€Geminiã€Claudeç­‰)" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.9);">
            <button id="save-current-config-btn" class="config-action-btn" style="padding: 10px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                ğŸ’¾ ä¿å­˜é…ç½®
            </button>
        </div>
        <div style="font-size: 12px; color: #888;">å½“å‰é…ç½®å°†ä¿å­˜ä¸º: <span style="color: #333; font-weight: 500;">URL + æ¨¡å‹ + æ¸©åº¦è®¾ç½®</span></div>
    </div>
    
    <div class="saved-configs-section">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <label style="font-size: 14px; font-weight: 500; color: #333;">å·²ä¿å­˜çš„é…ç½®</label>
            <button id="clear-all-configs-btn" class="config-action-btn" style="padding: 6px 12px; background: rgba(255, 107, 107, 0.1); color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s ease;">
                ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨
            </button>
        </div>
        <div id="saved-configs-container" style="display: grid; gap: 10px; max-height: 300px; overflow-y: auto;"></div>
        <div id="no-configs-message" style="text-align: center; color: rgb(153, 153, 153); padding: 30px 20px; font-size: 14px; display: block;">
            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“</div>
            <div>è¿˜æ²¡æœ‰ä¿å­˜ä»»ä½•é…ç½®</div>
            <div style="font-size: 12px; margin-top: 4px;">åœ¨ä¸Šæ–¹è¾“å…¥é…ç½®åç§°å¹¶ç‚¹å‡»"ä¿å­˜é…ç½®"</div>
        </div>
    </div>
</div>

<!-- âœ… æ–°å¢çš„å®Œæ•´å¤‡ä»½åŠŸèƒ½å¼€å§‹ -->
<hr style="margin: 20px 0; border: none; border-top: 1px solid #eaeaea;">
                <h4 style="margin-bottom: 10px; color: #333;">æ•°æ®å¤‡ä»½</h4>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px; line-height: 1.4;">å¤‡ä»½åŒ…å«ï¼šèŠå¤©è®°å½•ã€AIäººè®¾ã€ä¸–ç•Œä¹¦ã€èŠå¤©å£çº¸ã€æ‰‹æœºå£çº¸ã€å¾®åšåŠ¨æ€åŠè¯„è®ºã€ç”¨æˆ·è¡¨æƒ…åŒ…ã€éŸ³ä¹åº“ä»¥åŠAPIè®¾ç½®ç­‰æ‰€æœ‰æ•°æ®</p>
                <button class="form-button form-button-secondary" id="export-full-backup-btn" style="background-color: rgba(245, 245, 247, 0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0,0,0,0.05);">å¯¼å‡ºæ‰€æœ‰æ•°æ®</button>
<button class="form-button form-button-secondary" id="import-full-backup-btn" style="background-color: rgba(245, 245, 247, 0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0,0,0,0.05);">å¯¼å…¥æ‰€æœ‰æ•°æ®</button>
<input type="file" id="import-full-backup-input" accept=".json" style="display: none;">

<div id="import-confirm-modal" class="modal">
  <div class="modal-content" style="background-color: #ffffff; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
    <div class="modal-header" style="border-bottom: 1px solid #eaeaea;"><span style="color: #333;">ç¡®è®¤å¯¼å…¥</span></div>
    <div class="modal-body">
                      <p style="font-size: 14px; color: #333;">å¯¼å…¥å¤‡ä»½å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬èŠå¤©è®°å½•ã€AIäººè®¾ã€ä¸–ç•Œä¹¦ã€èŠå¤©å£çº¸ã€æ‰‹æœºå£çº¸ã€å¾®åšåŠ¨æ€ã€ç”¨æˆ·è¡¨æƒ…åŒ…ä»¥åŠAPIè®¾ç½®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ</p>
    </div>
    <div class="modal-footer" style="border-top: 1px solid #eaeaea;">
      <button class="cancel" id="cancel-import-btn" style="background-color: rgba(245, 245, 247, 0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">å–æ¶ˆ</button>
      <button class="save" id="confirm-import-btn" style="background-color: rgba(245, 245, 247, 0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">ç¡®è®¤å¯¼å…¥</button>
    </div>
  </div>
</div>
<!-- âœ… æ–°å¢å¤‡ä»½åŠŸèƒ½ç»“æŸ -->

</div>
</div>
            <div id="chat-list-screen" class="screen active"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">â€¹</span><span class="header-title">æ¶ˆæ¯</span><div class="header-actions"><span class="action-btn" id="add-group-chat-btn" title="åˆ›å»ºç¾¤èŠ"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></span><span class="action-btn" id="add-chat-btn">+</span></div></div><div id="chat-list"><p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" æˆ–ç¾¤ç»„å›¾æ ‡æ·»åŠ èŠå¤©</p></div></div>
            
            <div id="chat-interface-screen" class="screen">
                <div class="header">
                    <div class="default-controls">
                        <span class="back-btn" id="back-to-list-btn">â€¹</span>
                        <span id="chat-header-title" class="header-title">èŠå¤©å¯¹è±¡</span>
                        <div class="header-actions">
                            <span class="action-btn" id="listen-together-btn" title="ä¸€èµ·å¬"><img src="https://i.postimg.cc/8kYShvrJ/90-UI-2.png" alt="ä¸€èµ·å¬"></span>
                            <span class="action-btn" id="chat-settings-btn" title="èŠå¤©è®¾ç½®"><img src="https://i.postimg.cc/wRDhh491/image.png" alt="è®¾ç½®"></span>
                        </div>
                    </div>
                    <div class="selection-controls">
                        <span id="selection-cancel-btn">å–æ¶ˆ</span>
                        <span id="selection-count"></span>
                        <span id="selection-delete-btn">åˆ é™¤</span>
                    </div>
                </div>

                <!-- çŠ¶æ€æ°”æ³¡ -->
                <div id="status-bubble" style="display: none;"></div>
                <div id="chat-messages"><div id="typing-indicator">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</div></div>
            
                <div id="chat-input-area">
                    <div id="chat-input-actions-top">
                        <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="è¡¨æƒ…é¢æ¿">+</button>
                        <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="å‘é€ç…§ç‰‡"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg></button>
                        <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="ä¸Šä¼ å›¾ç‰‡"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--text-primary);"><path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></button>
                        <button id="transfer-btn" class="chat-action-icon-btn action-button" title="è½¬è´¦">ï¿¥</button>
                        <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="å‘é€è¯­éŸ³"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><path d="M12 19v4"></path><path d="M8 23h8"></path></svg></button>
                        <button id="regenerate-btn" class="chat-action-icon-btn action-button" title="é‡æ–°ç”Ÿæˆ">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M21 2v6h-6"></path>
    <path d="M3 12a9 9 0 0 1 15-7.7L21 8"></path>
  </svg>
</button>
                        <button id="call-btn" class="chat-action-icon-btn action-button" title="é€šè¯">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
  </svg>
</button>
                    </div>
                                    <div id="chat-input-main-row">
                    <div id="chat-input-container">
                        <textarea id="chat-input" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
                        <div id="mention-dropdown" class="mention-dropdown" style="display: none;"></div>
                    </div>
                        <div id="input-actions-wrapper">
                            <button id="wait-reply-btn" title="ç­‰å¾…å›å¤"><img src="https://i.postimg.cc/qzdckrGy/image.png" alt="ç­‰å¾…å›å¤"></button>
                            <button id="retry-btn" class="retry-btn" style="display:none;" title="é‡è¯•æœ¬è½®AIå›å¤">
                              <span class="retry-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                  <path d="M21 2v6h-6"></path>
                                  <path d="M3 12a9 9 0 0 1 15-7.7L21 8"></path>
                                </svg>
                              </span>é‡è¯•
                            </button>
                            <button id="send-btn" class="action-button">å‘é€</button>
                        </div>
                    </div>
                </div>

                <div id="sticker-panel">
                    <div id="sticker-panel-header">
                        <span class="panel-btn" id="close-sticker-panel-btn">å–æ¶ˆ</span>
                        <span class="title">æˆ‘çš„è¡¨æƒ…</span>
                        <div style="display: flex; gap: 10px;">
                          <span class="panel-btn" id="add-sticker-btn">æ·»åŠ </span>
                          <span class="panel-btn" id="upload-sticker-btn">ä¸Šä¼ </span>
                        </div>
                    </div>
                    <div id="sticker-grid"></div>
                </div>
                <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;">
                <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
                
                <div id="music-player-overlay">
                    <div class="music-player-window">
                        <span id="music-playlist-btn">â˜°</span>
                        <div id="music-time-counter">å·²ç»ä¸€èµ·å¬äº†0.0å°æ—¶</div>
                        <div id="music-player-song-title">è¯·æ·»åŠ æ­Œæ›²</div>
                        <div id="music-player-artist">...</div>
                        <div class="music-controls">
                            <button id="music-prev-btn">â—€</button>
                            <button id="music-play-pause-btn" class="play-pause-btn">â–¶</button>
                            <button id="music-next-btn">â–¶</button>
                            <button id="music-mode-btn">é¡ºåº</button>
                        </div>
                        <div class="music-bottom-actions">
                            <button id="music-exit-btn">é€€å‡ºä¸€èµ·å¬</button>
                            <button id="music-return-btn">è¿”å›èŠå¤©</button>
                        </div>
                    </div>
                </div>
                
                <div id="music-playlist-panel">
                    <div class="playlist-header">
                        <span class="panel-btn" id="close-playlist-btn">è¿”å›</span>
                        <span>æ’­æ”¾åˆ—è¡¨</span>
                        <div>
                            <span class="panel-btn" id="add-song-local-btn">æœ¬åœ°</span>
                            <span class="panel-btn" id="add-song-url-btn">URL</span>
                        </div>
                    </div>
                    <div class="playlist-body" id="playlist-body"></div>
                </div>
                <input type="file" id="local-song-upload-input" accept="audio/*" multiple="" style="display: none;">

            </div>

            <div id="wallpaper-screen" class="screen" style="background-color: white;">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span class="header-title">å£çº¸ä¸ä¸»é¢˜</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="form-container">
        <div class="theme-selector-container" style="background-color: #f9f9f9; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h3 style="text-align: center; margin-bottom: 15px;">é€‰æ‹©ä¸»é¢˜é£æ ¼</h3>
            <div class="theme-style-selector">
                <div class="theme-style-option active" data-theme="simple" onclick="selectThemeStyle('simple')">
                    <div class="theme-preview simple-theme"></div>
                    <span>ç®€çº¦é£</span>
                </div>
                <div class="theme-style-option" data-theme="cute" onclick="selectThemeStyle('cute')">
                    <div class="theme-preview cute-theme"></div>
                    <span>å¯çˆ±é£</span>
                </div>
            </div>
            
            <div style="margin-top: 15px; text-align: center;">
                <button class="form-button" style="width: 80%; background-color: var(--accent-color); color: white;" onclick="applySelectedTheme()">ç¡®è®¤åº”ç”¨ä¸»é¢˜</button>
            </div>
        </div>
        
        <div style="margin-top: 30px; background-color: #f9f9f9; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h3 style="text-align: center; margin-bottom: 15px;">æ˜¾ç¤ºæ¨¡å¼è®¾ç½®</h3>
            <div class="form-group">
                <label class="borderless-mode-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 15px; background-color: white; border-radius: 10px; border: 2px solid #e0e0e0; transition: all 0.3s ease;">
                    <input type="checkbox" id="borderless-mode-toggle" style="width: 20px; height: 20px; cursor: pointer;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 16px; color: #333; margin-bottom: 5px;">æ— è¾¹æ¡†æ¨¡å¼</div>
                        <div style="font-size: 14px; color: #666; line-height: 1.4;">å¼€å¯åæ‰‹æœºå°†å»æ‰å¤–å£³æ¡†æ¶ï¼Œå±å¹•å¤§å°è·Ÿéšæµè§ˆå™¨çª—å£è‡ªé€‚åº”ï¼Œé€‚åˆä¸åŒè®¾å¤‡å’Œå±å¹•å°ºå¯¸</div>
                    </div>
                </label>
            </div>
        </div>

        <div style="margin-top: 30px; background-color: #f9f9f9; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h3 style="text-align: center; margin-bottom: 15px;">è‡ªå®šä¹‰å£çº¸</h3>
            <div id="wallpaper-preview" style="border: 2px dashed #ddd;">ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ </div>
            <button class="form-button" onclick="document.getElementById('wallpaper-upload-input').click();">ä¸Šä¼ å£çº¸</button>
            <input type="file" id="wallpaper-upload-input" accept="image/*">
            <button class="form-button" id="save-wallpaper-btn">ä¿å­˜å¹¶åº”ç”¨</button>
        </div>
        
        <div style="margin-top: 30px; background-color: #f9f9f9; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h3 style="text-align: center; margin-bottom: 15px;">è‡ªå®šä¹‰AIå›¾æ ‡</h3>
            <div class="form-group">
                <label>è‡ªå®šä¹‰å„ä¸ªåº”ç”¨çš„AIå›¾æ ‡ï¼š</label>
                <div id="custom-icons-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 15px 0;">
                    <!-- å›¾æ ‡è‡ªå®šä¹‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button class="form-button" id="reset-all-icons-btn" style="background-color: #ff6b6b; color: white;">é‡ç½®æ‰€æœ‰å›¾æ ‡</button>
                </div>
            </div>
        </div>

        <div style="margin-top: 30px; background-color: #f9f9f9; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h3 style="text-align: center; margin-bottom: 15px;">è‡ªå®šä¹‰èŠå¤©æ°”æ³¡æ ·å¼</h3>
            <div class="form-group">
                <label>è‡ªå®šä¹‰CSSæ ·å¼ä»£ç </label>
                <textarea id="custom-bubble-css" placeholder="è¾“å…¥CSSä»£ç æ¥è‡ªå®šä¹‰èŠå¤©æ°”æ³¡æ ·å¼ï¼Œå¯ä»¥ä¿®æ”¹é¢œè‰²ã€å¤§å°ã€å½¢çŠ¶ã€é˜´å½±ç­‰ï¼Œä¾‹å¦‚ï¼š

/* ç”¨æˆ·æ°”æ³¡ - å¯è‡ªå®šä¹‰å¤§å°ã€å½¢çŠ¶ã€é˜´å½± */
.message-bubble.user .content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 25px 25px 8px 25px;
    font-size: 16px;
    padding: 15px 20px;
    min-width: 60px;
    max-width: 250px;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.2);
    transform: scale(1.02);
    backdrop-filter: none;
}

/* AIæ°”æ³¡ - ä¸åŒçš„é€ å‹è®¾è®¡ */
.message-bubble.ai .content {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    color: white;
    border-radius: 25px 25px 25px 8px;
    font-size: 16px;
    padding: 15px 20px;
    min-width: 60px;
    max-width: 250px;
    box-shadow: 0 8px 25px rgba(116, 185, 255, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.2);
    transform: scale(1.02);
    backdrop-filter: none;
}" style="width: 100%; height: 280px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; resize: vertical;"></textarea>
            </div>
            <div class="form-group">
                <label>è‡ªå®šä¹‰å­—ä½“URLé“¾æ¥</label>
                <input type="text" id="custom-font-url" placeholder="æ”¯æŒCSSé“¾æ¥æˆ–TTFé“¾æ¥ï¼Œä¾‹å¦‚ï¼š
https://fontsapi.zeoseven.com/5/main/result.css
https://files.catbox.moe/fp15b6.ttf" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                <div style="margin-top: 8px; font-size: 12px; color: #666; line-height: 1.4;">
                    <strong>æ”¯æŒæ ¼å¼ï¼š</strong><br>
                    â€¢ CSSé“¾æ¥ï¼šç›´æ¥åŠ è½½å­—ä½“æ ·å¼æ–‡ä»¶<br>
                    â€¢ TTFé“¾æ¥ï¼šç›´æ¥åŠ è½½å­—ä½“æ–‡ä»¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆå­—ä½“æ—åç§°
                </div>
            </div>
            <button class="form-button" id="apply-custom-styles-btn">åº”ç”¨è‡ªå®šä¹‰å­—ä½“å’Œæ ·å¼</button>
            <button class="form-button form-button-secondary" id="reset-custom-styles-btn">é‡ç½®ä¸ºé»˜è®¤æ ·å¼</button>
            <button class="form-button form-button-secondary" id="preview-custom-styles-btn">é¢„è§ˆæ•ˆæœ</button>

            <!-- é¢„è§ˆåŒºåŸŸ -->
            <div id="bubble-preview-container" style="margin-top: 20px; padding: 20px; background-color: #f0f2f5; border-radius: 12px; border: 2px dashed #ddd; display: none;">
                <h4 style="text-align: center; margin-bottom: 15px; color: #666;">æ ·å¼é¢„è§ˆ</h4>
                <div id="preview-chat-area" style="display: flex; flex-direction: column; gap: 12px; max-width: 280px; margin: 0 auto;">
                    <!-- AIæ¶ˆæ¯ -->
                    <div class="message-wrapper ai" style="align-self: flex-start; align-items: flex-start; max-width: 85%;">
                        <div class="message-bubble ai" style="display: flex; align-items: flex-start; gap: 5px;">
                            <div class="avatar-group" style="display: flex; flex-direction: column; align-items: center; gap: 4px; flex-shrink: 0; width: 32px;">
                                <img class="avatar" src="https://i.postimg.cc/dVSd9QBz/IMG-3063.jpg" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" alt="AIå¤´åƒ">
                            </div>
                            <div class="content preview-ai-bubble" style="padding: 8px 12px; word-break: break-word; line-height: 1.5; font-size: 15px; background-color: rgba(255, 255, 255, 0.7); color: var(--text-primary); border-radius: 8px 20px 20px 20px;">
                                ä½ å¥½ï¼è¿™æ˜¯AIçš„æ¶ˆæ¯æ°”æ³¡é¢„è§ˆæ•ˆæœ
                            </div>
                        </div>
                    </div>

                    <!-- ç”¨æˆ·æ¶ˆæ¯ -->
                    <div class="message-wrapper user" style="align-self: flex-end; align-items: flex-end; max-width: 85%;">
                        <div class="message-bubble user" style="display: flex; align-items: flex-start; gap: 5px; flex-direction: row-reverse;">
                            <div class="avatar-group" style="display: flex; flex-direction: column; align-items: center; gap: 4px; flex-shrink: 0; width: 32px;">
                                <img class="avatar" src="https://i.postimg.cc/dVSd9QBz/IMG-3063.jpg" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" alt="ç”¨æˆ·å¤´åƒ">
                            </div>
                            <div class="content preview-user-bubble" style="padding: 8px 12px; word-break: break-word; line-height: 1.5; font-size: 15px; background-color: rgba(160, 233, 86, 0.75); color: #1a3d00; border-radius: 20px 8px 20px 20px;">
                                è¿™æ˜¯æˆ‘å‘é€çš„æ¶ˆæ¯æ°”æ³¡é¢„è§ˆ
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top: 30px; background-color: #f9f9f9; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h3 style="text-align: center; margin-bottom: 15px;">å›¾æ ‡æ‘†æ”¾ä½ç½®</h3>
            <div class="form-group">
                <label for="icon-position">é€‰æ‹©å›¾æ ‡æ‘†æ”¾ä½ç½®ï¼š</label>
                <select id="icon-position" class="form-control">
                    <option value="top">é ä¸Š</option>
                    <option value="center" selected="">å±…ä¸­</option>
                    <option value="bottom">é ä¸‹</option>
                </select>
                <div style="margin-top: 15px; text-align: center;">
                    <button class="form-button" id="save-icon-position-btn">ä¿å­˜å¹¶åº”ç”¨</button>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 30px; background-color: #f9f9f9; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h3 style="text-align: center; margin-bottom: 15px;">å­—å·å¤§å°è®¾ç½®</h3>
            <div class="form-group">
                <label for="font-size-select">é€‰æ‹©å­—å·å¤§å°ï¼š</label>
                <select id="font-size-select" class="form-control">
                    <option value="xsmall">è¶…å°å­—å· (10px)</option>
                    <option value="tiny">æå°å­—å· (12px)</option>
                    <option value="small">å°å­—å· (14px)</option>
                    <option value="medium" selected="">ä¸­å­—å· (15px)</option>
                    <option value="large">å¤§å­—å· (16px)</option>
                    <option value="xlarge">è¶…å¤§å­—å· (18px)</option>
                </select>
                <div style="margin-top: 15px; text-align: center;">
                    <button class="form-button" id="save-font-size-btn">ä¿å­˜å¹¶åº”ç”¨</button>
                </div>
                <div style="margin-top: 8px; padding: 10px; background: #e3f2fd; border-radius: 5px; font-size: 12px; color: #666;">
                    <strong>è¯´æ˜ï¼š</strong><br>
                    â€¢ å­—å·è®¾ç½®ä¼šå½±å“èŠå¤©ç•Œé¢ä¸­æ‰€æœ‰æ¶ˆæ¯æ°”æ³¡çš„æ–‡å­—å¤§å°<br>
                    â€¢ æ¶ˆæ¯æ°”æ³¡çš„é«˜åº¦ä¼šæ ¹æ®å­—å·è‡ªåŠ¨è°ƒæ•´<br>
                    â€¢ æ¨èä½¿ç”¨ä¸­å­—å·ï¼Œå¯æ ¹æ®ä¸ªäººå–œå¥½è°ƒæ•´
                </div>
            </div>
        </div>
    </div>
</div>
        </div>
    </div>

    
    <div id="chat-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>èŠå¤©è®¾ç½®</span></div><div class="modal-body"><div class="form-group" id="chat-name-group"><label for="chat-name-input">å¤‡æ³¨å / ç¾¤å</label><input type="text" id="chat-name-input"></div><div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">æˆ‘çš„ç¾¤æ˜µç§°</label><input type="text" id="my-group-nickname-input"></div><div class="form-group" id="group-avatar-group"><label>ç¾¤å¤´åƒ</label><div class="avatar-upload"><img id="group-avatar-preview"><button onclick="document.getElementById('group-avatar-input').click()">ä¸Šä¼ ç¾¤å¤´åƒ</button><input type="file" id="group-avatar-input" accept="image/*"></div></div>
            <div class="form-group" id="world-book-link-group">
                <label>å…³è”ä¸–ç•Œä¹¦ (å¯å¤šé€‰)</label>
                <div class="custom-multiselect">
                    <div class="select-box">
                        <span class="selected-options-text">-- ç‚¹å‡»é€‰æ‹© --</span>
                        <span class="arrow-down">â–¼</span>
                    </div>
                    <div id="world-book-checkboxes-container" class="checkboxes-container">
                    </div>
                </div>
            </div>
            <div class="form-group" id="ai-persona-group"><label for="ai-persona">å¯¹æ–¹äººè®¾ (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div><div class="form-group" id="ai-avatar-group"><label>å¯¹æ–¹å¤´åƒ</label><div class="avatar-upload"><img id="ai-avatar-preview"><button onclick="document.getElementById('ai-avatar-input').click()">ä¸Šä¼ å¯¹æ–¹å¤´åƒ</button><input type="file" id="ai-avatar-input" accept="image/*"></div></div><div class="form-group" id="my-persona-group"><label for="my-persona">æˆ‘çš„äººè®¾ (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div><div class="form-group" id="my-avatar-group"><label>æˆ‘çš„å¤´åƒ</label><div class="avatar-upload"><img id="my-avatar-preview"><button onclick="document.getElementById('my-avatar-input').click()">ä¸Šä¼ æˆ‘çš„å¤´åƒ</button><button id="open-persona-library-btn">é¢„è®¾</button><input type="file" id="my-avatar-input" accept="image/*"></div></div>
            <div class="form-group" id="poke-suffix-group"><label for="my-poke-suffix">æˆ‘çš„æˆ³ä¸€æˆ³åç¼€</label><input type="text" id="my-poke-suffix" placeholder="ä¾‹å¦‚ï¼šçš„è„‘è¢‹ã€çš„æ‰‹ã€çš„è„¸é¢Š" maxlength="20"></div>
            <div class="form-group" id="ai-poke-suffix-group"><label for="ai-poke-suffix">å¯¹æ–¹çš„æˆ³ä¸€æˆ³åç¼€</label><input type="text" id="ai-poke-suffix" placeholder="ä¾‹å¦‚ï¼šçš„å°é¼»å­ã€çš„é¢å¤´ã€çš„è„¸è›‹" maxlength="20"></div>
            <div class="form-group" id="group-members-group">
                <label>ç¾¤æˆå‘˜äººè®¾</label>
                <div id="group-members-settings"></div>
            </div>
            <div class="form-group">
                <label for="max-memory">å†å²è®°å¿†è½®æ•°</label>
                <input type="number" id="max-memory" value="10">
                <div style="margin-top: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #666;">
                    <strong>è¯´æ˜ï¼š</strong><br>
                    æ­¤è®¾ç½®å°†å½±å“ï¼š<br>
                    â€¢ AIå¯è§çš„èŠå¤©è®°å½•è½®æ•°ï¼ˆä¸€è½® = ç”¨æˆ·å‘æ¶ˆæ¯ + AIå›å¤å®Œæ¯•ï¼‰<br>
                    â€¢ å»ºè®®è®¾ç½®ä¸º5-15è½®ï¼Œè¿‡å¤šå¯èƒ½å½±å“å“åº”é€Ÿåº¦
                </div>
            </div>
            
            <div class="form-group" id="memory-mount-group">
                <label>
                    <input type="checkbox" id="memory-mount-enabled" name="memory-mount-enabled">
                    æŒ‚è½½å…¶ä»–èŠå¤©è®°å¿†
                </label>
                <div id="memory-mount-settings" style="display: none; margin-top: 15px;">
                    <label>é€‰æ‹©è¦æŒ‚è½½è®°å¿†çš„èŠå¤© (å¯å¤šé€‰):</label>
                    <div class="custom-multiselect" id="memory-mount-multiselect">
                        <div class="select-box">
                            <span class="selected-options-text">-- ç‚¹å‡»é€‰æ‹© --</span>
                            <span class="arrow-down">â–¼</span>
                        </div>
                        <div id="memory-mount-checkboxes-container" class="checkboxes-container">
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label for="memory-mount-count">æ¯ä¸ªèŠå¤©æŒ‚è½½è½®æ•°:</label>
                        <input type="number" id="memory-mount-count" value="10" min="1" max="50" style="width: 80px; margin-left: 10px;">
                    </div>
                </div>
                <div style="margin-top: 8px; padding: 10px; background: #f0f8ff; border-radius: 5px; font-size: 12px; color: #666;">
                    <strong>è¯´æ˜ï¼š</strong><br>
                    â€¢ <strong>ç¾¤èŠæŒ‚è½½ç§èŠ</strong>ï¼šåœ¨ç¾¤èŠä¸­ï¼ŒAIä¼šæºå¸¦é€‰ä¸­ç§èŠè§’è‰²çš„è®°å¿†å‚ä¸å¯¹è¯<br>
                    â€¢ <strong>ç§èŠæŒ‚è½½ç¾¤èŠ</strong>ï¼šåœ¨ç§èŠä¸­ï¼ŒAIä¼šæºå¸¦é€‰ä¸­ç¾¤èŠçš„è®°å¿†è¿›è¡Œå¯¹è¯<br>
                    â€¢ å»ºè®®æ¯ä¸ªèŠå¤©æŒ‚è½½3-10è½®è®°å¿†ï¼Œé¿å…å½±å“å“åº”é€Ÿåº¦
                </div>
            </div>
            
            <!-- æ™ºèƒ½è®°å¿†å…±äº«è®¾ç½® -->
            <div class="form-group" id="memory-sharing-group">
                <label>
                    <input type="checkbox" id="memory-sharing-enabled" name="memory-sharing-enabled">
                    æ™ºèƒ½è®°å¿†å…±äº«
                </label>
                <div id="memory-sharing-settings" style="display: none; margin-top: 15px;">
                    <label>é€‰æ‹©è¦å…±äº«è®°å¿†çš„èŠå¤© (å¯å¤šé€‰):</label>
                    <div class="custom-multiselect" id="memory-sharing-multiselect">
                        <div class="select-box">
                            <span class="selected-options-text">-- ç‚¹å‡»é€‰æ‹© --</span>
                            <span class="arrow-down">â–¼</span>
                        </div>
                        <div id="memory-sharing-checkboxes-container" class="checkboxes-container">
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label>å…±äº«ç±»åˆ«:</label>
                        <div class="memory-sharing-categories" style="margin-top: 8px;">
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" id="share-mood" checked=""> æƒ…ç»ªçŠ¶æ€å˜åŒ–
                            </label>
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" id="share-events" checked=""> é‡è¦äº‹ä»¶
                            </label>
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" id="share-interests" checked=""> å…´è¶£çˆ±å¥½è®¨è®º
                            </label>
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" id="share-plans" checked=""> è®¡åˆ’å®‰æ’
                            </label>
                        </div>
                        <div style="margin-top: 10px;">
                            <label>é‡è¦æ€§é˜ˆå€¼: <span id="threshold-value">0.6</span></label>
                            <input type="range" id="sharing-threshold" min="0.1" max="1.0" step="0.1" value="0.6" style="width: 100%; margin-top: 5px;">
                        </div>
                    </div>
                </div>
                <div style="margin-top: 8px; padding: 10px; background: #e8f5e8; border-radius: 5px; font-size: 12px; color: #666;">
                    <strong>è¯´æ˜ï¼š</strong><br>
                    â€¢ <strong>æ™ºèƒ½ç­›é€‰</strong>ï¼šè‡ªåŠ¨è¯†åˆ«é‡è¦è®°å¿†ç‰‡æ®µï¼Œå¦‚æƒ…ç»ªå˜åŒ–ã€é‡è¦äº‹ä»¶ç­‰<br>
                    â€¢ ä¸"è®°å¿†æŒ‚è½½"åŠŸèƒ½äº’è¡¥ï¼Œå¯åŒæ—¶ä½¿ç”¨
                </div>
            </div>
            
            <div class="form-group"><label>èŠå¤©æ°”æ³¡ä¸»é¢˜ <button id="reset-theme-btn" type="button">é‡ç½®</button></label><div class="theme-selector"><label><input type="radio" name="theme-select" value="default" id="theme-default"> é»˜è®¤</label><label><input type="radio" name="theme-select" value="pink_blue"> ç²‰è“</label><label><input type="radio" name="theme-select" value="blue_white"> è“ç™½</label><label><input type="radio" name="theme-select" value="purple_yellow"> ç´«é»„</label><label><input type="radio" name="theme-select" value="black_white"> é»‘ç™½</label><label><input type="radio" name="theme-select" value="yellow_white"> é»„ç™½</label><label><input type="radio" name="theme-select" value="red_black"> çº¢é»‘</label><label><input type="radio" name="theme-select" value="blue_yellow"> è“é»„</label><label><input type="radio" name="theme-select" value="pink_yellow"> ç²‰é»„</label><label><input type="radio" name="theme-select" value="pink_purple"> ç²‰ç´«</label><label><input type="radio" name="theme-select" value="gray_white"> ç°ç™½</label><label><input type="radio" name="theme-select" value="blue_green"> è“ç»¿</label><label><input type="radio" name="theme-select" value="pink_white"> ç²‰ç™½</label><label><input type="radio" name="theme-select" value="pink_black"> ç²‰é»‘</label><label><input type="radio" name="theme-select" value="pink_green"> ç²‰ç»¿</label><label><input type="radio" name="theme-select" value="green_black"> ç»¿é»‘</label></div></div>
            <div class="form-group">
                <label>æ—¶é—´æ„ŸçŸ¥è®¾ç½®</label>
                <div style="margin-top: 10px;">
                    <label>
                        <input type="checkbox" id="time-awareness-enabled" name="time-awareness-enabled">
                        å¯ç”¨æ—¶é—´æç¤ºè¯
                    </label>
                    <div style="margin-top: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #666;">
                        <strong>è¯´æ˜ï¼š</strong><br>
                        â€¢ <strong>å¼€å¯æ—¶</strong>ï¼šAIå¯ä»¥æ˜ç¡®æ„ŸçŸ¥å½“å‰æ—¶é—´ï¼ˆå¹´æœˆæ—¥æ—¶åˆ†ï¼‰ï¼Œå…·å¤‡æ—¶é—´æµé€æ„Ÿï¼ŒçŸ¥é“è·ç¦»ä¸Šæ¬¡å¯¹è¯è¿‡å»äº†å¤šä¹…<br>
                        â€¢ <strong>å…³é—­æ—¶</strong>ï¼šAIæ— æ³•æ„ŸçŸ¥å…·ä½“æ—¶é—´ï¼Œé€‚åˆè§’è‰²æ‰®æ¼”å’Œå‰§æƒ…æ¨è¿›<br>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>å¹¶å‘èŠå¤©æ¨¡å¼</label>
                <div style="margin-top: 10px;">
                    <label>
                        <input type="checkbox" id="concurrent-chat-enabled" name="concurrent-chat-enabled" checked="">
                        å¯ç”¨å¹¶å‘å¤„ç†
                    </label>
                    <div style="margin-top: 8px; padding: 10px; background: #e7f3ff; border-radius: 5px; font-size: 12px; color: #666;">
                        <strong>è¯´æ˜ï¼š</strong><br>
                        â€¢ èŠå¤©åˆ—è¡¨ä¸­ä¼šæ˜¾ç¤ºæ´»è·ƒçŠ¶æ€ï¼šâ—(æ­£åœ¨å¤„ç†) â—‹(é˜Ÿåˆ—ç­‰å¾…)<br>
                        â€¢ å¯ä»¥åŒæ—¶ä¸ä¸åŒè§’è‰²èŠå¤©ï¼Œæˆ–åœ¨èŠå¤©æ—¶è¿›è¡Œå…¶ä»–æ“ä½œ
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>é€šè¯è®¾ç½®</label>
                <div style="margin-top: 10px;">
                    <label>
                        <input type="checkbox" id="ai-call-enabled" name="ai-call-enabled">
                        å…è®¸AIä¸»åŠ¨æ‹¨æ‰“ç”µè¯
                    </label>
                    <div style="margin-top: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #666;">
                        <strong>è¯´æ˜ï¼š</strong><br>
                        â€¢ <strong>å¼€å¯æ—¶</strong>ï¼šAIæœ‰20%æ¦‚ç‡ä¸»åŠ¨ç»™ä½ æ‰“ç”µè¯<br>
                        â€¢ <strong>å…³é—­æ—¶</strong>ï¼šAIä¸ä¼šä¸»åŠ¨æ‹¨æ‰“ç”µè¯ï¼Œåªèƒ½ç”±ç”¨æˆ·ä¸»åŠ¨å‘èµ·é€šè¯<br>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>AIå¿ƒç‡ç›‘æµ‹</label>
                <div style="margin-top: 10px;">
                    <label>
                        <input type="checkbox" id="ai-heartrate-enabled" name="ai-heartrate-enabled">
                        æ˜¾ç¤ºAIå¿ƒç‡
                    </label>
                    <div style="margin-top: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #666;">
                        <strong>è¯´æ˜ï¼š</strong><br>
                                        â€¢ <strong>å¼€å¯æ—¶</strong>ï¼šåœ¨èŠå¤©ç•Œé¢é¡¶éƒ¨æ˜¾ç¤ºAIè§’è‰²çš„å®æ—¶å¿ƒç‡ï¼ˆâ™¥ï¸ xx bpmï¼‰<br>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>AIçŠ¶æ€æ°”æ³¡</label>
                <div style="margin-top: 10px;">
                    <label>
                        <input type="checkbox" id="ai-status-bubble-enabled" name="ai-status-bubble-enabled">
                        æ˜¾ç¤ºçŠ¶æ€æ°”æ³¡
                    </label>
                    <div id="status-bubble-settings" style="margin-top: 15px; display: none;">
                        <label for="status-update-frequency">æ›´æ–°é¢‘ç‡</label>
                        <select id="status-update-frequency" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
                            <option value="3">3åˆ†é’Ÿ</option>
                            <option value="5" selected="">5åˆ†é’Ÿ</option>
                            <option value="10">10åˆ†é’Ÿ</option>
                        </select>
                    </div>
                    <div style="margin-top: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #666;">
                        <strong>è¯´æ˜ï¼š</strong><br>
                        â€¢ <strong>å¼€å¯æ—¶</strong>ï¼šåœ¨èŠå¤©ç•Œé¢ä¸Šæ–¹æ˜¾ç¤ºè§’è‰²çš„å½“å‰çŠ¶æ€<br>
                        â€¢ <strong>è‡ªåŠ¨æ›´æ–°</strong>ï¼šæ ¹æ®è®¾å®šé¢‘ç‡è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
                    </div>
                </div>
            </div>
            <div class="form-group" id="chat-mode-group">
                <label>èŠå¤©æ¨¡å¼è®¾ç½®</label>
                <div class="chat-mode-switch">
                    <div class="chat-mode-option">
                        <input type="radio" id="chat-mode-online" name="chat-mode" value="online">
                        <label for="chat-mode-online">çº¿ä¸Šæ¨¡å¼</label>
                    </div>
                    <div class="chat-mode-option">
                        <input type="radio" id="chat-mode-offline" name="chat-mode" value="offline">
                        <label for="chat-mode-offline">çº¿ä¸‹æ¨¡å¼</label>
                    </div>
                </div>
                <div class="offline-length-control" id="offline-length-control" style="display: none;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 12px; color: #666; font-weight: 500;">æ¯æ¡æ¶ˆæ¯æœ€çŸ­ï¼š</span>
                        <input type="number" id="offline-mode-min-length" min="20" max="800" value="50">
                        <span style="font-size: 12px; color: #666;">å­—</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 12px; color: #666; font-weight: 500;">æ¯æ¡æ¶ˆæ¯æœ€é•¿ï¼š</span>
                        <input type="number" id="offline-mode-max-length" min="50" max="1000" value="100">
                        <span style="font-size: 12px; color: #666;">å­—</span>
                    </div>
                </div>
                <div style="margin-top: 12px; padding: 12px; background: rgba(248, 249, 250, 0.8); backdrop-filter: blur(5px); border-radius: 8px; font-size: 12px; color: #666; border: 1px solid rgba(0, 0, 0, 0.05);">
                    <strong style="color: #495057;">æ¨¡å¼è¯´æ˜ï¼š</strong><br>
                    â€¢ <strong>çº¿ä¸Šæ¨¡å¼</strong>ï¼šçº¯è¯­è¨€èŠå¤©ï¼Œå¤šæ¡æ¶ˆæ¯å‘é€ï¼Œé€‚åˆæ—¥å¸¸å¯¹è¯<br>
                    â€¢ <strong>çº¿ä¸‹æ¨¡å¼</strong>ï¼šå‰§æƒ…äº’åŠ¨ï¼Œå•æ¡æ¶ˆæ¯åŒ…å«å¯¹è¯ï¼ˆã€Œã€ï¼‰å’Œæå†™ï¼Œå¯¹è¯æ­£å¸¸æ˜¾ç¤ºï¼Œæå†™ä¸ºç°è‰²æ–œä½“<br>
                    â€¢ <strong>å­—æ•°èŒƒå›´</strong>ï¼šè®¾ç½®çº¿ä¸‹æ¨¡å¼æ¯æ¡æ¶ˆæ¯çš„æœ€çŸ­å’Œæœ€é•¿å­—æ•°ï¼Œé¿å…å›å¤è¿‡çŸ­æˆ–è¿‡é•¿<br>
                </div>
            </div>
            <div class="form-group">
                <label>èŠå¤©èƒŒæ™¯</label>
                <div class="bg-upload-container">
                    <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">ä¸Šä¼ èƒŒæ™¯å›¾</button>
                    <button type="button" id="remove-bg-btn">ç§»é™¤èƒŒæ™¯</button>
                </div>
                <img id="bg-preview" class="bg-preview-img">
                <input type="file" id="bg-input" accept="image/*" style="display: none;">
            </div>
  <div class="form-group">
    <label>å¾®åšåŠ¨æ€è®¾ç½®</label>
    <div class="weibo-settings">
        <label>
            <input type="checkbox" id="weibo-enabled" name="weibo-enabled">
            å¼€å¯åŠ¨æ€åŠŸèƒ½
        </label>
        <div id="weibo-frequency-settings" style="display: none;">
            <label>å‘å¸ƒé¢‘ç‡:</label>
            <select id="weibo-frequency">
                <option value="low">ä½(1-2æ¡/å¤©)</option>
                <option value="medium">ä¸­(3-4æ¡/å¤©)</option>
                <option value="high">é«˜(5-6æ¡/å¤©)</option>
            </select>
            <div class="posting-times">
                <label>å‘å¸ƒæ—¶é—´ç‚¹:</label>
                <div id="posting-times-container">
                    <button type="button" class="add-time-btn">+ æ·»åŠ æ—¶é—´ç‚¹</button>
                </div>
            </div>
            <button type="button" id="test-ai-posting-btn" style="margin-top: 10px; padding: 8px 16px; background-color: rgb(74, 132, 193); color: white; border: none; border-radius: 4px; cursor: pointer;">
                ç«‹åˆ»å‘å¸ƒ
            </button>
        </div>
    </div>
    
    <label>åå°äº’åŠ¨è®¾ç½®</label>
    <div class="background-interaction-settings">
        <label>
            <input type="checkbox" id="background-interaction-enabled" name="background-interaction-enabled">
            å¯ç”¨åå°äº’åŠ¨
        </label>
        <div id="background-interaction-frequency-settings" style="display: none; margin-top: 10px;">
            <div style="margin-bottom: 15px;">
                <label>ä¸»åŠ¨èŠå¤©é¢‘ç‡:</label>
                <select id="background-chat-frequency">
                    <option value="low">ä½(1-2å°æ—¶/æ¬¡)</option>
                    <option value="medium">ä¸­(30åˆ†é’Ÿ-1å°æ—¶/æ¬¡)</option>
                    <option value="high">é«˜(10-15åˆ†é’Ÿ/æ¬¡)</option>
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label>ä¸»åŠ¨å‘åŠ¨æ€é¢‘ç‡:</label>
                <select id="background-weibo-frequency">
                    <option value="low">ä½(3-5å°æ—¶/æ¬¡)</option>
                    <option value="medium">ä¸­(1å°æ—¶-2å°æ—¶/æ¬¡)</option>
                    <option value="high">é«˜(15-25åˆ†é’Ÿ/æ¬¡)</option>
                </select>
            </div>
            <div style="margin-top: 10px;">
                <label>äº’åŠ¨ç±»å‹:</label>
                <div>
                    <label><input type="checkbox" id="background-chat-enabled" checked=""> ä¸»åŠ¨èŠå¤©</label>
                </div>
                <div>
                    <label><input type="checkbox" id="background-weibo-enabled" checked=""> ä¸»åŠ¨å‘åŠ¨æ€</label>
                </div>
            </div>
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #666;">
                <strong>è¯´æ˜ï¼š</strong><br>
                â€¢ ä¸»åŠ¨èŠå¤©ï¼šAIä¼šåŸºäºèŠå¤©å†å²ä¸»åŠ¨å‘æ¶ˆæ¯<br>
                â€¢ ä¸»åŠ¨å‘åŠ¨æ€ï¼šAIä¼šå‘å¸ƒå¾®åšåŠ¨æ€<br>
                â€¢ ä¸"å¾®åšåŠ¨æ€è®¾ç½®"ä¸­çš„å®šæ—¶å‘å¸ƒåŠŸèƒ½ç‹¬ç«‹ï¼Œä¸ä¼šå†²çª
            </div>
        </div>
    </div>
</div>

<hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
            <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;"><button class="form-button form-button-secondary" id="clear-chat-btn">æ¸…ç©ºèŠå¤©è®°å½•</button></div><div class="modal-footer"><button class="cancel" id="cancel-chat-settings-btn">å–æ¶ˆ</button><button class="save" id="save-chat-settings-btn">ä¿å­˜</button></div></div></div>
            
    <div id="persona-library-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>æˆ‘çš„äººè®¾åº“</span><button id="add-persona-preset-btn" class="action-button">æ·»åŠ </button></div><div class="modal-body"><div id="persona-library-grid"></div></div><div class="modal-footer"><button class="cancel" id="close-persona-library-btn">å…³é—­</button></div></div></div>
    
    <div id="persona-editor-modal" class="modal"><div class="modal-content"><div class="modal-header"><span id="persona-editor-title">æ·»åŠ äººè®¾é¢„è®¾</span></div><div class="modal-body"><div class="form-group"><label>é¢„è®¾å¤´åƒ</label><div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById('preset-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button><input type="file" id="preset-avatar-input" accept="image/*"></div></div><div class="form-group"><label for="preset-persona-input">é¢„è®¾äººè®¾</label><textarea id="preset-persona-input" rows="4" placeholder="åœ¨æ­¤è¾“å…¥è¿™ä¸ªäººè®¾çš„è¯¦ç»†è®¾å®š..."></textarea></div></div><div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn">å–æ¶ˆ</button><button class="save" id="save-persona-preset-btn">ä¿å­˜</button></div></div></div>

    <div id="member-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>ç¼–è¾‘ç¾¤æˆå‘˜</span></div><div class="modal-body"><div class="form-group"><label for="member-name-input">åå­—</label><input type="text" id="member-name-input"></div><div class="form-group"><label for="member-persona-input">äººè®¾</label><textarea id="member-persona-input" rows="4"></textarea></div><div class="form-group"><label>å¤´åƒ</label><div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button><input type="file" id="member-avatar-input" accept="image/*"></div></div></div><div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">å–æ¶ˆ</button><button class="save" id="save-member-settings-btn">ä¿å­˜</button></div></div></div>
    
    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel">å–æ¶ˆ</button>
                <button id="custom-modal-confirm" class="confirm-btn">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- æ¶ˆæ¯ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="message-edit-modal">
        <div class="message-edit-content">
            <div class="message-edit-header">
                <h3>ç¼–è¾‘æ¶ˆæ¯</h3>
                <button class="message-edit-close" onclick="hideMessageEditModal()">Ã—</button>
            </div>
            <div class="message-edit-body">
                <div class="message-edit-form-group">
                    <label for="message-edit-content">æ¶ˆæ¯å†…å®¹</label>
                    <textarea id="message-edit-content" class="message-edit-textarea" placeholder="è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹..."></textarea>
                </div>
            </div>
            <div class="message-edit-footer">
                <button class="message-edit-btn message-edit-btn-cancel" onclick="hideMessageEditModal()">å–æ¶ˆ</button>
                <button class="message-edit-btn message-edit-btn-save" onclick="saveEditedMessage()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="preset-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="preset-action-edit">ç¼–è¾‘é¢„è®¾</button>
                <button id="preset-action-delete" class="btn-danger">åˆ é™¤é¢„è®¾</button>
                <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal">
        <div class="transfer-content">
            <div class="transfer-header">ç»™Taä¸€ä¸ªæƒŠå–œï¼</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">è½¬è´¦é‡‘é¢</label>
                <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="1000000000" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">å¤‡æ³¨ (å¯é€‰)</label>
                <input type="text" id="transfer-note" placeholder="ç•™ä¸‹ä½ çš„å°å¿ƒæ€~" maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">å–æ¶ˆ</button>
                <button id="transfer-confirm-btn">ç¡®è®¤è½¬è´¦</button>
            </div>
        </div>
    </div>
    
    <div id="transfer-confirm-modal">
        <div class="transfer-confirm-content">
            <div class="transfer-confirm-title">æ”¶åˆ°ä¸€ç¬”è½¬è´¦</div>
            <div class="transfer-confirm-info">
                <div class="transfer-confirm-amount">Â¥ 0.00</div>
                <div class="transfer-confirm-note">å¤‡æ³¨ï¼š</div>
            </div>
            <div class="transfer-confirm-actions">
                <button id="transfer-reject-btn">é€€å›</button>
                <button id="transfer-accept-btn">ç¡®è®¤æ”¶æ¬¾</button>
            </div>
        </div>
    </div>

    <div id="battery-alert-modal">
        <div class="battery-alert-content">
            <img id="battery-alert-image" src="">
            <p id="battery-alert-text"></p>
        </div>
    </div>

    <!-- å¹¶å‘çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="concurrent-status">
        <span id="concurrent-status-text">æ­£åœ¨å¤„ç† 0 ä¸ªè¯·æ±‚</span>
    </div>

    <!-- ç¤¾äº¤ä¸»é¡µæ¨¡æ€å¼¹çª— -->
    <div id="social-profile-modal" class="social-profile-overlay">
        <div class="social-profile-modal">
            <div class="social-profile-content">
            <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
            <div class="social-profile-header">
                <button class="social-profile-back" onclick="closeSocialProfile()">â€¹</button>
                <div class="social-profile-title">ä¸ªäººä¸»é¡µ</div>
                <button class="social-profile-edit-btn" onclick="editSocialProfile()">ç¼–è¾‘</button>
            </div>

            <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
            <div class="social-profile-user-section">
                <div class="social-profile-bg">
                    <img id="social-profile-avatar" class="social-profile-avatar" src="">
                    <div class="social-profile-user-info">
                        <div id="social-profile-name" class="social-profile-name"></div>
                        <div id="social-profile-signature" class="social-profile-signature"></div>
                        <div class="social-profile-stats">
                            <span id="social-profile-followers" class="social-profile-stat">0 ç²‰ä¸</span>
                            <span id="social-profile-following" class="social-profile-stat">0 å…³æ³¨</span>
                            <span id="social-profile-posts-count" class="social-profile-stat">0 å¾®åš</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ ‡ç­¾é¡µ -->
            <div class="social-profile-tabs">
                <div class="social-profile-tab active" data-tab="posts">åŠ¨æ€</div>
                <div class="social-profile-tab" data-tab="photos">ç›¸å†Œ</div>
            </div>

            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="social-profile-tab-content">
                <div id="social-profile-posts-list" class="social-profile-posts-list"></div>
            </div>
        </div>
        </div>
    </div>

    <!-- å›¾ç‰‡æŸ¥çœ‹å™¨æ¨¡æ€æ¡† -->
    <div id="image-viewer-modal">
        <div class="image-viewer-content">
            <button class="image-viewer-close">Ã—</button>
            <img id="viewer-image" src="" alt="æŸ¥çœ‹å›¾ç‰‡">
        </div>
    </div>

    <audio id="audio-player" style="display:none;"></audio>

    <!-- é€šè¯ç±»å‹é€‰æ‹©å¼¹çª— -->
    <div id="call-type-modal">
        <div class="call-type-content">
            <div class="call-type-title">é€‰æ‹©é€šè¯ç±»å‹</div>
            <div class="call-type-buttons">
                <button class="call-type-btn call-voice-btn" id="start-voice-call">
                    ğŸ“ è¯­éŸ³é€šè¯
                </button>
                <button class="call-type-btn call-video-btn" id="start-video-call">
                    ğŸ“¹ è§†é¢‘é€šè¯
                </button>
                <button class="call-type-btn call-cancel-btn" id="cancel-call">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- é€šè¯ç•Œé¢ -->
    <div id="call-overlay">
        <div class="call-window">
            <div class="call-header">
                <img class="call-avatar" id="call-avatar" src="" alt="å¤´åƒ">
                <div class="call-contact-name" id="call-contact-name">è”ç³»äºº</div>
                <div class="call-timer" id="call-timer">00:00:00</div>
            </div>
            
            <div class="call-messages" id="call-messages"></div>
            
            <div class="call-input-area">
                <input type="text" class="call-input" id="call-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
                <button class="call-send-btn" id="call-send-btn">å‘é€</button>
            </div>
            
            <div class="call-controls">
                <button class="call-control-btn call-hangup-btn" id="call-hangup-btn">ğŸ“</button>
            </div>
        </div>
    </div>

    <!-- AIæ¥ç”µå¼¹çª— -->
    <div id="incoming-call-modal">
        <div class="incoming-call-content">
            <div class="incoming-call-type" id="incoming-call-type">è¯­éŸ³é€šè¯</div>
            <div class="incoming-call-name" id="incoming-call-name">AIè§’è‰²</div>
            <img class="incoming-call-avatar" id="incoming-call-avatar" src="" alt="å¤´åƒ">
            <div class="incoming-call-controls">
                <button class="incoming-call-btn call-decline-btn" id="decline-call">ğŸ“</button>
                <button class="incoming-call-btn call-answer-btn" id="answer-call">ğŸ“</button>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰å›¾æ ‡å¼¹çª— -->
    <div id="custom-icon-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="custom-icon-title">è‡ªå®šä¹‰å›¾æ ‡</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>å½“å‰å›¾æ ‡é¢„è§ˆ</label>
                    <div style="text-align: center; margin: 15px 0;">
                        <img id="current-icon-preview" style="width: 80px; height: 80px; border-radius: 15px; object-fit: cover; border: 2px solid #ddd;">
                    </div>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©æ–°å›¾æ ‡</label>
                    <div style="display: flex; gap: 10px; margin: 10px 0;">
                        <button class="form-button" onclick="document.getElementById('icon-file-input').click()">ä¸Šä¼ æœ¬åœ°å›¾ç‰‡</button>
                        <button class="form-button" id="use-url-btn">ä½¿ç”¨URL</button>
                    </div>
                    <input type="file" id="icon-file-input" accept="image/*" style="display: none;">
                    <div id="url-input-group" style="display: none; margin-top: 10px;">
                        <input type="url" id="icon-url-input" placeholder="è¾“å…¥å›¾ç‰‡URL" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <button class="form-button" id="preview-url-btn" style="margin-top: 8px;">é¢„è§ˆURLå›¾ç‰‡</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>æ–°å›¾æ ‡é¢„è§ˆ</label>
                    <div style="text-align: center; margin: 15px 0;">
                        <img id="new-icon-preview" style="width: 80px; height: 80px; border-radius: 15px; object-fit: cover; border: 2px solid #ddd; display: none;">
                        <p id="no-preview-text" style="color: #999; font-size: 14px;">æš‚æ— é¢„è§ˆ</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-icon-btn">å–æ¶ˆ</button>
                <button class="save" id="save-icon-btn">ä¿å­˜å¹¶åº”ç”¨</button>
            </div>
        </div>
    </div>

    <script>
            function showScreen(screenId) {
        // å¦‚æœç¦»å¼€å¾®åšå±å¹•ï¼Œé€€å‡ºé€‰æ‹©æ¨¡å¼
        if (window.isWeiboSelectionMode && screenId !== 'weibo-screen') {
            window.exitWeiboSelectionMode();
        }
        
        // å¦‚æœç¦»å¼€èŠå¤©ç•Œé¢ï¼Œéšè—å¿ƒç‡æ˜¾ç¤ºå’ŒçŠ¶æ€æ°”æ³¡
        if (screenId !== 'chat-interface-screen') {
            hideAiHeartrate();
            hideAiStatusBubble();
        }
        
        if (screenId === 'chat-list-screen') window.renderChatListProxy(); 
        if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
        if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
        if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const screenToShow = document.getElementById(screenId);
        if (screenToShow) screenToShow.classList.add('active');
        if (screenId === 'chat-interface-screen' && window.state) window.updateListenTogetherIconProxy(window.state.activeChatId);
        
        // å»¶è¿Ÿæ¸²æŸ“å¾®åšæ—¶é—´çº¿ï¼Œç¡®ä¿å‡½æ•°å·²å®šä¹‰
        if (screenId === 'weibo-screen') {
            setTimeout(() => {
                if (window.renderWeiboTimelineProxy) {
                    window.renderWeiboTimelineProxy();
                }
            }, 100);
        }
    }

            window.updateListenTogetherIconProxy = () => {};

        // AIå¿ƒç‡ç®¡ç†åŠŸèƒ½
        let heartrateInterval = null;
        let currentHeartrate = 72; // åŸºç¡€å¿ƒç‡
        
        function updateAiHeartrate(chat) {
            const heartrateDisplay = document.getElementById('ai-heartrate-display');
            
            // æ£€æŸ¥æ˜¯å¦å¯ç”¨å¿ƒç‡ç›‘æµ‹ä¸”ä¸æ˜¯ç¾¤èŠ
            if (!chat.settings.aiHeartrateEnabled || chat.isGroup) {
                hideAiHeartrate();
                return;
            }
            
            // æ˜¾ç¤ºå¿ƒç‡
            heartrateDisplay.style.display = 'block';
            
            // è®¡ç®—åŸºç¡€å¿ƒç‡ï¼ˆåŸºäºè§’è‰²äººè®¾ï¼‰
            const persona = (chat.settings.aiPersona || '').toLowerCase();
            const name = (chat.name || '').toLowerCase();
            let baseHeartrate = 72;
            
            // æ ¹æ®è§’è‰²ç‰¹å¾è°ƒæ•´åŸºç¡€å¿ƒç‡
            if (persona.includes('ç´§å¼ ') || persona.includes('å®³ç¾') || persona.includes('æ•æ„Ÿ') || 
                persona.includes('ç¾æ¶©') || persona.includes('å®¹æ˜“è„¸çº¢') || persona.includes('å†…å‘')) {
                baseHeartrate = 85; // å®¹æ˜“ç´§å¼ çš„è§’è‰²å¿ƒç‡æ›´é«˜
            } else if (persona.includes('å†·é™') || persona.includes('ç†æ€§') || persona.includes('æˆç†Ÿ') || 
                       persona.includes('æ²‰ç¨³') || persona.includes('å†…æ•›') || persona.includes('ä¸¥è‚ƒ')) {
                baseHeartrate = 65; // å†·é™çš„è§’è‰²å¿ƒç‡æ›´ä½
            } else if (persona.includes('æ´»æ³¼') || persona.includes('å…´å¥‹') || persona.includes('çƒ­æƒ…') || 
                       persona.includes('å¼€æœ—') || persona.includes('å¤–å‘') || persona.includes('çˆ±ç¬‘')) {
                baseHeartrate = 82; // æ´»æ³¼çš„è§’è‰²å¿ƒç‡åé«˜
            } else if (persona.includes('è¿åŠ¨') || persona.includes('å¥èº«') || persona.includes('ä½“è‚²') || 
                       persona.includes('è¿åŠ¨å‘˜') || persona.includes('æ´»è·ƒ')) {
                baseHeartrate = 58; // è¿åŠ¨å‹è§’è‰²å¿ƒç‡æœ€ä½
            } else if (persona.includes('æ¸©æŸ”') || persona.includes('ç”œç¾') || persona.includes('å¯çˆ±') || 
                       persona.includes('è½¯èŒ') || persona.includes('å°é¸Ÿä¾äºº') || persona.includes('ä¹–å·§')) {
                baseHeartrate = 75; // æ¸©æŸ”å‹è§’è‰²å¿ƒç‡é€‚ä¸­åé«˜
            } else if (persona.includes('å†·é…·') || persona.includes('é«˜å†·') || persona.includes('å‚²å¨‡') || 
                       persona.includes('å¥³ç‹') || persona.includes('å¼ºåŠ¿') || persona.includes('éœ¸é“')) {
                baseHeartrate = 68; // é«˜å†·å‹è§’è‰²å¿ƒç‡åä½
            } else if (persona.includes('çƒ­è¡€') || persona.includes('å†²åŠ¨') || persona.includes('æ€¥æ€§å­') || 
                       persona.includes('ç«çˆ†') || persona.includes('æš´èº') || persona.includes('æ˜“æ€’')) {
                baseHeartrate = 88; // çƒ­è¡€å‹è§’è‰²å¿ƒç‡å¾ˆé«˜
            } else if (persona.includes('ç¥ç§˜') || persona.includes('æ·±æ²‰') || persona.includes('å®‰é™') || 
                       persona.includes('æ–‡é™') || persona.includes('å†…å‘')) {
                baseHeartrate = 70; // ç¥ç§˜å‹è§’è‰²å¿ƒç‡æ­£å¸¸åä½
            }
            
            // æ ¹æ®è§’è‰²åå­—è¿›ä¸€æ­¥å¾®è°ƒ
            if (name.includes('å°') || name.includes('èŒ') || name.includes('å¯çˆ±')) {
                baseHeartrate += 3; // å¯çˆ±åå­—çš„è§’è‰²å¿ƒç‡ç¨é«˜
            } else if (name.includes('å†°') || name.includes('é›ª') || name.includes('é™') || 
                       name.includes('å†·') || name.includes('å‡‰')) {
                baseHeartrate -= 5; // å†·ç³»åå­—çš„è§’è‰²å¿ƒç‡æ›´ä½
            } else if (name.includes('ç«') || name.includes('çƒ­') || name.includes('çƒˆ')) {
                baseHeartrate += 5; // ç«ç³»åå­—çš„è§’è‰²å¿ƒç‡æ›´é«˜
            }
            
            // æ ¹æ®æœ€è¿‘å¯¹è¯å†…å®¹è°ƒæ•´å¿ƒç‡
            const recentMessages = chat.history.slice(-8); // å¢åŠ åˆ†æçš„æ¶ˆæ¯æ•°é‡
            let emotionAdjustment = 0;
            
            recentMessages.forEach(msg => {
                // å®‰å…¨åœ°å¤„ç†æ¶ˆæ¯å†…å®¹ï¼ŒåŒ…æ‹¬å›¾ç‰‡æ¶ˆæ¯
                let content = '';
                if (typeof msg.content === 'string') {
                    content = msg.content.toLowerCase();
                } else if (Array.isArray(msg.content)) {
                    // å¯¹äºå›¾ç‰‡æ¶ˆæ¯ï¼Œä½¿ç”¨ç©ºå­—ç¬¦ä¸²
                    content = '';
                } else {
                    content = '';
                }
                
                // é«˜åº¦äº²å¯†è¯æ±‡ - å¤§å¹…æé«˜å¿ƒç‡
                if (content.includes('çˆ±ä½ ') || content.includes('æˆ‘çˆ±ä½ ') || content.includes('love you') || 
                    content.includes('å–œæ¬¢ä½ ') || content.includes('æƒ³ä½ ') || content.includes('æƒ³æŠ±ä½ ') ||
                    content.includes('æƒ³å»ä½ ') || content.includes('äº²äº²') || content.includes('æŠ±æŠ±') ||
                    content.includes('å®è´') || content.includes('darling') || content.includes('honey') ||
                    content.includes('äº²çˆ±çš„') || content.includes('æƒ³è¦ä½ ') || content.includes('éœ€è¦ä½ ') ||
                    content.includes('ç¦»ä¸å¼€ä½ ') || content.includes('æƒ³å’Œä½ ') || content.includes('æƒ³è§ä½ ')) {
                    emotionAdjustment += 15;
                }
                
                // è¡¨ç™½å’Œç”œèœœè¯æ±‡
                if (content.includes('è¡¨ç™½') || content.includes('å–œæ¬¢') || content.includes('å¿ƒåŠ¨') || 
                    content.includes('å¿ƒè·³') || content.includes('è„¸çº¢') || content.includes('å®³ç¾') ||
                    content.includes('å¯çˆ±') || content.includes('ç”œ') || content.includes('æ¸©æŸ”') ||
                    content.includes('ç¾ä¸½') || content.includes('æ¼‚äº®') || content.includes('è¿·äºº') ||
                    content.includes('é­…åŠ›') || content.includes('å¸å¼•') || content.includes('å¿ƒä»ª')) {
                    emotionAdjustment += 10;
                }
                
                // æ’’å¨‡å’Œäº²æ˜µè¯æ±‡
                if (content.includes('æ’’å¨‡') || content.includes('å˜¤å˜¤') || content.includes('å“¼') ||
                    content.includes('äººå®¶') || content.includes('è®¨åŒ') || content.includes('ä¸è¦') ||
                    content.includes('å¥½ä¸å¥½') || content.includes('æ±‚ä½ ') || content.includes('æ‹œæ‰˜') ||
                    content.includes('é™ªæˆ‘') || content.includes('é™ªé™ª') || content.includes('ä¸€èµ·')) {
                    emotionAdjustment += 8;
                }
                
                // å…´å¥‹å’Œå¼€å¿ƒè¯æ±‡
                if (content.includes('å¼€å¿ƒ') || content.includes('é«˜å…´') || content.includes('å¿«ä¹') || 
                    content.includes('å…´å¥‹') || content.includes('æ¿€åŠ¨') || content.includes('å¥½æ£’') || 
                    content.includes('å‰å®³') || content.includes('å“‡') || content.includes('å¤ªå¥½äº†') ||
                    content.includes('amazing') || content.includes('wonderful') || content.includes('great')) {
                    emotionAdjustment += 6;
                }
                
                // è´Ÿé¢æƒ…ç»ªè¯æ±‡ - åŒæ ·ä¼šè®©å¿ƒç‡åŠ å¿«
                if (content.includes('éš¾è¿‡') || content.includes('ç”Ÿæ°”') || content.includes('æ‹…å¿ƒ') || 
                    content.includes('å®³æ€•') || content.includes('ç´§å¼ ') || content.includes('ç„¦è™‘') ||
                    content.includes('ä¸å¼€å¿ƒ') || content.includes('éƒé—·') || content.includes('çƒ¦') ||
                    content.includes('å‹åŠ›') || content.includes('ç´¯') || content.includes('ç–²æƒ«')) {
                    emotionAdjustment += 8;
                }
                
                // è¿åŠ¨å’Œåˆºæ¿€è¯æ±‡
                if (content.includes('è·‘æ­¥') || content.includes('è¿åŠ¨') || content.includes('å¥èº«') ||
                    content.includes('æ¸¸æˆ') || content.includes('æ¯”èµ›') || content.includes('æŒ‘æˆ˜') ||
                    content.includes('å†’é™©') || content.includes('åˆºæ¿€') || content.includes('æƒŠé™©')) {
                    emotionAdjustment += 12;
                }
                
                // æš§æ˜§å’Œè°ƒæƒ…è¯æ±‡
                if (content.includes('è°ƒæƒ…') || content.includes('æ’©') || content.includes('è¯±æƒ‘') ||
                    content.includes('sexy') || content.includes('è¿·äºº') || content.includes('é­…æƒ‘') ||
                    content.includes('å‹¾å¼•') || content.includes('å¿ƒè·³åŠ é€Ÿ') || content.includes('å°å¿ƒå¿ƒ')) {
                    emotionAdjustment += 12;
                }
                
                // é—®å€™è¯æ±‡ - è½»å¾®å¢åŠ 
                if (content.includes('ä½ å¥½') || content.includes('hi') || content.includes('hello') ||
                    content.includes('æ—©ä¸Šå¥½') || content.includes('æ™šå®‰') || content.includes('good')) {
                    emotionAdjustment += 3;
                }
            });
            
            // è®¡ç®—æœ€ç»ˆå¿ƒç‡
            currentHeartrate = Math.max(50, Math.min(140, baseHeartrate + emotionAdjustment));
            
                         // å¯åŠ¨å¿ƒç‡æ›´æ–°
             if (heartrateInterval) clearInterval(heartrateInterval);
             heartrateInterval = setInterval(() => {
                 // æ·»åŠ è‡ªç„¶çš„å¿ƒç‡æ³¢åŠ¨ï¼ˆÂ±4 bpmï¼‰ï¼Œè®©å˜åŒ–æ›´æ˜æ˜¾
                 const fluctuation = Math.floor(Math.random() * 9) - 4;
                 const displayHeartrate = Math.max(50, Math.min(140, currentHeartrate + fluctuation));
                 
                 // æ ¹æ®å¿ƒç‡é«˜ä½æ·»åŠ è§†è§‰æ•ˆæœ
                 heartrateDisplay.className = '';
                 if (displayHeartrate >= 110) {
                     heartrateDisplay.classList.add('very-high-heartrate');
                 } else if (displayHeartrate >= 95) {
                     heartrateDisplay.classList.add('high-heartrate');
                 }
                 
                 heartrateDisplay.innerHTML = `â™¥ï¸ <span class="heartrate-number">${displayHeartrate}</span> <span class="heartrate-unit">bpm</span>`;
             }, 1500 + Math.random() * 1000); // 1.5-2.5ç§’æ›´æ–°ä¸€æ¬¡ï¼Œæ›´é¢‘ç¹
             
             // ç«‹å³æ˜¾ç¤ºåˆå§‹å¿ƒç‡
             heartrateDisplay.innerHTML = `â™¥ï¸ <span class="heartrate-number">${currentHeartrate}</span> <span class="heartrate-unit">bpm</span>`;
        }
        
        function hideAiHeartrate() {
            const heartrateDisplay = document.getElementById('ai-heartrate-display');
            heartrateDisplay.style.display = 'none';
            
            if (heartrateInterval) {
                clearInterval(heartrateInterval);
                heartrateInterval = null;
            }
        }
        
        // å½“å‘é€æ¶ˆæ¯æ—¶æ›´æ–°å¿ƒç‡
        function adjustHeartrateForMessage(content, isUserMessage = false) {
            if (!heartrateInterval) return; // å¿ƒç‡ç›‘æµ‹æœªå¯ç”¨
            
            let adjustment = 0;
            let lowerContent = '';
            let recoveryTime = 3000; // é»˜è®¤æ¢å¤æ—¶é—´
            
            // å®‰å…¨åœ°å¤„ç†å†…å®¹ï¼ŒåŒ…æ‹¬å›¾ç‰‡æ¶ˆæ¯
            if (typeof content === 'string') {
                lowerContent = content.toLowerCase();
            } else if (Array.isArray(content)) {
                // å¯¹äºå›¾ç‰‡æ¶ˆæ¯ï¼Œä½¿ç”¨ç©ºå­—ç¬¦ä¸²
                lowerContent = '';
            } else {
                lowerContent = '';
            }
            
            if (isUserMessage) {
                // ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶ï¼ŒAIçš„å¿ƒç‡ä¼šæœ‰ç›¸åº”ååº”
                
                // é«˜åº¦äº²å¯†è¯æ±‡ - å¼ºçƒˆå¿ƒè·³åŠ é€Ÿ
                if (lowerContent.includes('çˆ±ä½ ') || lowerContent.includes('æˆ‘çˆ±ä½ ') || lowerContent.includes('love you') || 
                    lowerContent.includes('å–œæ¬¢ä½ ') || lowerContent.includes('æƒ³ä½ ') || lowerContent.includes('æƒ³æŠ±ä½ ') ||
                    lowerContent.includes('æƒ³å»ä½ ') || lowerContent.includes('äº²äº²') || lowerContent.includes('æŠ±æŠ±') ||
                    lowerContent.includes('å®è´') || lowerContent.includes('darling') || lowerContent.includes('honey') ||
                    lowerContent.includes('äº²çˆ±çš„') || lowerContent.includes('æƒ³è¦ä½ ') || lowerContent.includes('éœ€è¦ä½ ') ||
                    lowerContent.includes('ç¦»ä¸å¼€ä½ ') || lowerContent.includes('æƒ³å’Œä½ ') || lowerContent.includes('æƒ³è§ä½ ')) {
                    adjustment = 20; // å¤§å¹…å¢åŠ 
                    recoveryTime = 8000; // æ›´é•¿çš„æ¢å¤æ—¶é—´
                }
                // è¡¨ç™½å’Œç”œèœœè¯æ±‡
                else if (lowerContent.includes('è¡¨ç™½') || lowerContent.includes('å–œæ¬¢') || lowerContent.includes('å¿ƒåŠ¨') || 
                    lowerContent.includes('å¿ƒè·³') || lowerContent.includes('è„¸çº¢') || lowerContent.includes('å®³ç¾') ||
                    lowerContent.includes('å¯çˆ±') || lowerContent.includes('ç”œ') || lowerContent.includes('æ¸©æŸ”') ||
                    lowerContent.includes('ç¾ä¸½') || lowerContent.includes('æ¼‚äº®') || lowerContent.includes('è¿·äºº') ||
                    lowerContent.includes('é­…åŠ›') || lowerContent.includes('å¸å¼•') || lowerContent.includes('å¿ƒä»ª')) {
                    adjustment = 15;
                    recoveryTime = 6000;
                }
                // æ’’å¨‡å’Œäº²æ˜µè¯æ±‡
                else if (lowerContent.includes('æ’’å¨‡') || lowerContent.includes('å˜¤å˜¤') || lowerContent.includes('å“¼') ||
                    lowerContent.includes('äººå®¶') || lowerContent.includes('è®¨åŒ') || lowerContent.includes('ä¸è¦') ||
                    lowerContent.includes('å¥½ä¸å¥½') || lowerContent.includes('æ±‚ä½ ') || lowerContent.includes('æ‹œæ‰˜') ||
                    lowerContent.includes('é™ªæˆ‘') || lowerContent.includes('é™ªé™ª') || lowerContent.includes('ä¸€èµ·')) {
                    adjustment = 12;
                    recoveryTime = 5000;
                }
                // å…´å¥‹å’Œå¼€å¿ƒè¯æ±‡
                else if (lowerContent.includes('å¼€å¿ƒ') || lowerContent.includes('é«˜å…´') || lowerContent.includes('å¿«ä¹') || 
                    lowerContent.includes('å…´å¥‹') || lowerContent.includes('æ¿€åŠ¨') || lowerContent.includes('å¥½æ£’') || 
                    lowerContent.includes('å‰å®³') || lowerContent.includes('å“‡') || lowerContent.includes('å¤ªå¥½äº†')) {
                    adjustment = 8;
                    recoveryTime = 4000;
                }
                // è´Ÿé¢æƒ…ç»ªè¯æ±‡ - ç´§å¼ å¯¼è‡´å¿ƒç‡åŠ å¿«
                else if (lowerContent.includes('ç”Ÿæ°”') || lowerContent.includes('ä¸å¼€å¿ƒ') || lowerContent.includes('éš¾è¿‡') ||
                    lowerContent.includes('æ‹…å¿ƒ') || lowerContent.includes('å®³æ€•') || lowerContent.includes('ç´§å¼ ') ||
                    lowerContent.includes('ç„¦è™‘') || lowerContent.includes('éƒé—·') || lowerContent.includes('çƒ¦')) {
                    adjustment = 10;
                    recoveryTime = 6000;
                }
                // æš§æ˜§å’Œè°ƒæƒ…è¯æ±‡
                else if (lowerContent.includes('è°ƒæƒ…') || lowerContent.includes('æ’©') || lowerContent.includes('è¯±æƒ‘') ||
                    lowerContent.includes('sexy') || lowerContent.includes('é­…æƒ‘') || lowerContent.includes('å‹¾å¼•')) {
                    adjustment = 18;
                    recoveryTime = 7000;
                }
                // æ™®é€šé—®å€™
                else if (lowerContent.includes('ä½ å¥½') || lowerContent.includes('hi') || lowerContent.includes('hello') ||
                    lowerContent.includes('æ—©ä¸Šå¥½') || lowerContent.includes('æ™šå®‰')) {
                    adjustment = 5;
                    recoveryTime = 3000;
                }
                
            } else {
                // AIè‡ªå·±å‘é€æ¶ˆæ¯åçš„å¿ƒç‡å˜åŒ–
                if (lowerContent.includes('å®³ç¾') || lowerContent.includes('è„¸çº¢') || lowerContent.includes('ä¸å¥½æ„æ€')) {
                    adjustment = 10;
                    recoveryTime = 5000;
                } else if (lowerContent.includes('å…´å¥‹') || lowerContent.includes('å¼€å¿ƒ') || lowerContent.includes('æ¿€åŠ¨')) {
                    adjustment = 8;
                    recoveryTime = 4000;
                } else if (lowerContent.includes('ç´§å¼ ') || lowerContent.includes('æ‹…å¿ƒ') || lowerContent.includes('ç„¦è™‘')) {
                    adjustment = 12;
                    recoveryTime = 6000;
                } else if (lowerContent.includes('çˆ±') || lowerContent.includes('å–œæ¬¢') || lowerContent.includes('æƒ³')) {
                    adjustment = 15;
                    recoveryTime = 7000;
                }
            }
            
            // åº”ç”¨è°ƒæ•´
            currentHeartrate = Math.max(55, Math.min(130, currentHeartrate + adjustment));
            
            // æ›´è‡ªç„¶çš„æ¢å¤æœºåˆ¶
            setTimeout(() => {
                const recoveryRate = Math.floor(adjustment * 0.6); // æ¢å¤60%
                currentHeartrate = Math.max(65, currentHeartrate - recoveryRate);
                
                // ç»§ç»­ç¼“æ…¢æ¢å¤
                setTimeout(() => {
                    const finalRecovery = Math.floor(adjustment * 0.3); // å†æ¢å¤30%
                    currentHeartrate = Math.max(65, currentHeartrate - finalRecovery);
                }, recoveryTime * 0.5);
                
            }, recoveryTime);
        }

        // AIçŠ¶æ€æ°”æ³¡ç®¡ç†åŠŸèƒ½
        let statusBubbleInterval = null;
        let statusHideTimeout = null;
        let currentStatus = '';
        let statusGeneratedChats = new Set(); // è®°å½•å·²ç»ç”Ÿæˆè¿‡çŠ¶æ€çš„èŠå¤©

        function updateAiStatusBubble(chat) {
            const statusBubble = document.getElementById('status-bubble');

            // æ£€æŸ¥æ˜¯å¦å¯ç”¨çŠ¶æ€æ°”æ³¡ä¸”ä¸æ˜¯ç¾¤èŠ
            if (!chat.settings.aiStatusBubbleEnabled || chat.isGroup) {
                hideAiStatusBubble();
                return;
            }

            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (statusBubbleInterval) {
                clearInterval(statusBubbleInterval);
            }
            if (statusHideTimeout) {
                clearTimeout(statusHideTimeout);
            }

            // åˆå§‹æ—¶éšè—çŠ¶æ€æ°”æ³¡ï¼Œç­‰ç”ŸæˆçŠ¶æ€åå†æ˜¾ç¤º
            statusBubble.style.display = 'none';
            console.log('çŠ¶æ€æ°”æ³¡åˆå§‹åŒ–ä¸ºéšè—çŠ¶æ€');

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡è¿›å…¥è¿™ä¸ªèŠå¤©
            const chatId = state.activeChatId;
            const isFirstTime = !statusGeneratedChats.has(chatId);

            if (isFirstTime) {
                // ç¬¬ä¸€æ¬¡è¿›å…¥ï¼Œ2ç§’åç”ŸæˆçŠ¶æ€
                setTimeout(() => {
                    // æ˜¾ç¤ºç”Ÿæˆä¸­æŒ‡ç¤ºå™¨ï¼ˆåªæœ‰ä¸‰ä¸ªç‚¹ï¼‰
                    statusBubble.innerHTML = '<span class="status-generating"></span>';
                    statusBubble.style.display = 'block';

                    generateAiStatus(chat);
                }, 2000);
                statusGeneratedChats.add(chatId);
            }

            // è®¾ç½®å®šæ—¶æ›´æ–°
            const updateFrequency = (chat.settings.statusUpdateFrequency || 5) * 60 * 1000; // è½¬æ¢ä¸ºæ¯«ç§’

            statusBubbleInterval = setInterval(() => {
                // æ˜¾ç¤ºç”Ÿæˆä¸­æŒ‡ç¤ºå™¨ï¼ˆåªæœ‰ä¸‰ä¸ªç‚¹ï¼‰
                const statusBubble = document.getElementById('status-bubble');
                statusBubble.innerHTML = '<span class="status-generating"></span>';
                statusBubble.style.display = 'block';

                generateAiStatus(chat);
            }, updateFrequency);
        }

        function showStatusUpdateNotification(status, chatName) {
            // åœ¨èŠå¤©ç•Œé¢ä¸­é—´æ˜¾ç¤ºç°è‰²å°å­—æç¤º
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;

            const notification = document.createElement('div');
            notification.style.cssText = `
                text-align: center;
                color: #999;
                font-size: 12px;
                margin: 8px 0;
                opacity: 0.7;
            `;
            notification.textContent = `${chatName}æ›´æ–°äº†çŠ¶æ€ï¼š${status}`;

            messagesContainer.appendChild(notification);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // ä¸å†è‡ªåŠ¨ç§»é™¤æç¤ºï¼Œè®©å®ƒæ°¸ä¹…ä¿ç•™åœ¨èŠå¤©è®°å½•ä¸­
        }

        function hideAiStatusBubble() {
            const statusBubble = document.getElementById('status-bubble');
            statusBubble.style.display = 'none';

            if (statusBubbleInterval) {
                clearInterval(statusBubbleInterval);
                statusBubbleInterval = null;
            }

            if (statusHideTimeout) {
                clearTimeout(statusHideTimeout);
                statusHideTimeout = null;
            }
        }

        async function generateAiStatus(chat) {
            console.log('å¼€å§‹ç”ŸæˆAIçŠ¶æ€...');
            const { proxyUrl, apiKey, model } = state.apiConfig;

            // ç§»é™¤æ›´æ–°æç¤ºï¼Œé™é»˜æ›´æ–°

            // å¦‚æœAPIæœªé…ç½®ï¼Œä½¿ç”¨é»˜è®¤çŠ¶æ€
            if (!proxyUrl || !apiKey || !model) {
                console.log('APIæœªé…ç½®ï¼Œä½¿ç”¨é»˜è®¤çŠ¶æ€');
                const persona = chat.settings.aiPersona || '';
                let statusOptions = ['åœ¨çº¿ä¸­', 'æ€è€ƒä¸­', 'å‘å‘†ä¸­', 'ä¼‘æ¯ä¸­'];

                // æ ¹æ®äººè®¾è°ƒæ•´çŠ¶æ€é€‰é¡¹
                if (persona.includes('å¯çˆ±') || persona.includes('èŒ')) {
                    statusOptions = ['åœ¨å‘å‘†', 'æƒ³ä½ äº†', 'æœ‰ç‚¹å›°', 'å¿ƒæƒ…å¥½'];
                } else if (persona.includes('å†·') || persona.includes('é…·')) {
                    statusOptions = ['åœ¨æ€è€ƒ', 'å¾ˆå®‰é™', 'ä¸æƒ³è¯´è¯', 'åœ¨è§‚å¯Ÿ'];
                } else if (persona.includes('æ´»æ³¼') || persona.includes('å¼€æœ—')) {
                    statusOptions = ['å¾ˆå¼€å¿ƒ', 'æƒ³èŠå¤©', 'ç²¾ç¥æ»¡æ»¡', 'åœ¨ç©è€'];
                }

                const randomStatus = statusOptions[Math.floor(Math.random() * statusOptions.length)];
                const statusBubble = document.getElementById('status-bubble');
                statusBubble.textContent = randomStatus;
                statusBubble.style.display = 'block';
                console.log('çŠ¶æ€å·²æ›´æ–°ï¼ˆé»˜è®¤ï¼‰:', randomStatus);

                // 30ç§’åéšè—çŠ¶æ€æ°”æ³¡
                if (statusHideTimeout) {
                    clearTimeout(statusHideTimeout);
                }
                statusHideTimeout = setTimeout(() => {
                    statusBubble.style.display = 'none';
                    console.log('çŠ¶æ€æ°”æ³¡å·²éšè—');
                }, 30000);
                return;
            }

            // å¼€å§‹çœŸæ­£çš„AIçŠ¶æ€ç”Ÿæˆ
            console.log('å¼€å§‹è°ƒç”¨APIç”ŸæˆçŠ¶æ€...');
            try {
                const persona = chat.settings.aiPersona || '';
                const currentTime = new Date().toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                console.log('è§’è‰²äººè®¾:', persona);

                // è·å–æœ€è¿‘çš„èŠå¤©è®°å½•
                const maxMemory = parseInt(chat.settings.maxMemory) || 10;
                const maxMessages = Math.min(maxMemory * 2, 6); // æ¯è½®æœ€å¤š2æ¡æ¶ˆæ¯ï¼Œæœ€å¤š6æ¡
                const historySlice = (chat.history || []).slice(-maxMessages);

                // æ„å»ºæ›´æ™ºèƒ½çš„çŠ¶æ€ç”Ÿæˆæç¤ºè¯
                let chatContext = '';
                if (historySlice.length > 0) {
                    chatContext = '\n\næœ€è¿‘çš„èŠå¤©å†…å®¹ï¼š\n';
                    historySlice.forEach(msg => {
                        const sender = msg.sender === 'user' ? 'ç”¨æˆ·' : chat.name;
                        chatContext += `${sender}: ${msg.content.substring(0, 100)}\n`;
                    });
                }

                const systemPrompt = `ä½ æ˜¯${chat.name}ã€‚${persona}

æ ¹æ®ä½ çš„äººè®¾å’Œæœ€è¿‘çš„èŠå¤©å†…å®¹ï¼Œç”¨15å­—ä»¥å†…æè¿°ä½ ç°åœ¨çš„çŠ¶æ€ã€‚

çŠ¶æ€å¯ä»¥åŒ…æ‹¬ï¼š
- ä½ åœ¨å“ªé‡Œ/åœ¨åšä»€ä¹ˆ
- ä½ çš„å¿ƒæƒ…/æƒ…ç»ª
- ä½ åœ¨æƒ³ä»€ä¹ˆ
- ä½ çš„èº«ä½“çŠ¶æ€

è¦æ±‚ï¼š
1. ç¬¦åˆä½ çš„äººè®¾ç‰¹ç‚¹
2. ç»“åˆæœ€è¿‘èŠå¤©å†…å®¹çš„æƒ…å¢ƒ
3. 15å­—ä»¥å†…ï¼Œçº¯æ–‡å­—æè¿°
4. ä¸è¦ä½¿ç”¨emojiã€è¡¨æƒ…åŒ…é“¾æ¥æˆ–ä»»ä½•ç½‘å€
5. è¦ç”ŸåŠ¨è‡ªç„¶ï¼Œä¸è¦æœºæ¢°åŒ–

ç¤ºä¾‹ï¼šåœ¨æˆ¿é—´é‡Œæƒ³ä½ ã€åˆšæ´—å®Œæ¾¡å¾ˆæ”¾æ¾ã€èººåœ¨åºŠä¸Šå‘å‘†ã€æ­£åœ¨å¨æˆ¿åšé¥­${chatContext}

è¯·ç›´æ¥å›å¤ä½ çš„çŠ¶æ€ï¼š`;

                const messages = [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: 'æ ¹æ®æˆ‘ä»¬çš„èŠå¤©æƒ…å†µï¼Œä½ ç°åœ¨æ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Ÿ' }
                ];

                const requestBody = {
                    model: model,
                    messages: messages,
                    temperature: 0.9,
                    stream: false
                };

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                // æ£€æµ‹æ˜¯å¦æ˜¯Geminiå®˜æ–¹API
                const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');

                let response, data, status;

                if (isGeminiOfficial) {
                    // ä½¿ç”¨Geminiå®˜æ–¹APIæ ¼å¼
                    const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;

                    const geminiMessages = [{
                        role: 'user',
                        parts: [{ text: `${messages[0].content}\n\n${messages[1].content}` }]
                    }];

                    const geminiRequestBody = {
                        contents: geminiMessages,
                        generationConfig: {
                            temperature: 0.9
                        }
                    };

                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(geminiRequestBody),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`Gemini APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }

                    data = await response.json();
                    console.log('Gemini APIè¿”å›æ•°æ®:', data);
                    status = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '';
                } else {
                    // ä½¿ç”¨æ ‡å‡†OpenAIæ ¼å¼
                    response = await fetch(proxyUrl + '/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }

                    data = await response.json();
                    console.log('APIè¿”å›æ•°æ®:', data);
                    status = data.choices?.[0]?.message?.content?.trim() || '';
                }

                // æ¸…ç†çŠ¶æ€æ–‡æœ¬ï¼Œå»æ‰emojiã€é“¾æ¥å’Œå¤šä½™å­—ç¬¦
                if (status) {
                    status = status.replace(/[\n\r]/g, '').trim();
                    // å»æ‰é“¾æ¥
                    status = status.replace(/https?:\/\/[^\s]+/g, '').trim();
                    // å»æ‰emojiå’Œç‰¹æ®Šç¬¦å·
                    status = status.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '').trim();
                    // å»æ‰å¤šä½™çš„æ ‡ç‚¹ç¬¦å·
                    status = status.replace(/[ã€‚ï¼Œï¼ï¼Ÿï¼šï¼›""'']/g, '').trim();
                }

                console.log('APIè¿”å›çŠ¶æ€:', status, 'é•¿åº¦:', status.length);
                if (status && status.length > 0 && status.length <= 15) { // æ”¾å®½åˆ°15å­—
                    currentStatus = status;
                    const statusBubble = document.getElementById('status-bubble');
                    statusBubble.textContent = status;
                    statusBubble.style.display = 'block';
                    console.log('çŠ¶æ€å·²æ›´æ–°ï¼ˆAIç”Ÿæˆï¼‰:', status);

                    // æ˜¾ç¤ºçŠ¶æ€æ›´æ–°é€šçŸ¥
                    showStatusUpdateNotification(status, chat.name);

                    // æ¸…é™¤ä¹‹å‰çš„éšè—å®šæ—¶å™¨
                    if (statusHideTimeout) {
                        clearTimeout(statusHideTimeout);
                    }

                    // 60ç§’åéšè—çŠ¶æ€æ°”æ³¡
                    statusHideTimeout = setTimeout(() => {
                        statusBubble.style.display = 'none';
                        console.log('çŠ¶æ€æ°”æ³¡å·²éšè—');
                    }, 60000);
                } else {
                    console.log('çŠ¶æ€é•¿åº¦è¶…é™æˆ–ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤çŠ¶æ€');
                    // ä¸æŠ›å‡ºé”™è¯¯ï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤çŠ¶æ€
                    const defaultStatuses = ['åœ¨çº¿ä¸­', 'æ€è€ƒä¸­', 'å‘å‘†ä¸­', 'ä¼‘æ¯ä¸­'];
                    const randomStatus = defaultStatuses[Math.floor(Math.random() * defaultStatuses.length)];
                    const statusBubble = document.getElementById('status-bubble');
                    statusBubble.textContent = randomStatus;
                    statusBubble.style.display = 'block';
                    console.log('ä½¿ç”¨é»˜è®¤çŠ¶æ€:', randomStatus);

                    // æ˜¾ç¤ºçŠ¶æ€æ›´æ–°é€šçŸ¥
                    showStatusUpdateNotification(randomStatus, chat.name);

                    // æ¸…é™¤ä¹‹å‰çš„éšè—å®šæ—¶å™¨
                    if (statusHideTimeout) {
                        clearTimeout(statusHideTimeout);
                    }

                    // 60ç§’åéšè—çŠ¶æ€æ°”æ³¡
                    statusHideTimeout = setTimeout(() => {
                        statusBubble.style.display = 'none';
                        console.log('çŠ¶æ€æ°”æ³¡å·²éšè—');
                    }, 60000);
                }

            } catch (error) {
                console.error('ç”ŸæˆAIçŠ¶æ€å¤±è´¥:', error);
                // å¤±è´¥æ—¶æ˜¾ç¤ºé»˜è®¤çŠ¶æ€
                const defaultStatuses = ['åœ¨çº¿ä¸­', 'æ€è€ƒä¸­', 'ç­‰å¾…ä¸­', 'ä¼‘æ¯ä¸­', 'å‘å‘†ä¸­', 'å¿™ç¢Œä¸­'];
                const randomStatus = defaultStatuses[Math.floor(Math.random() * defaultStatuses.length)];
                const statusBubble = document.getElementById('status-bubble');
                statusBubble.textContent = randomStatus;
                statusBubble.style.display = 'block';

                // æ¸…é™¤ä¹‹å‰çš„éšè—å®šæ—¶å™¨
                if (statusHideTimeout) {
                    clearTimeout(statusHideTimeout);
                }

                // 60ç§’åéšè—çŠ¶æ€æ°”æ³¡
                statusHideTimeout = setTimeout(() => {
                    statusBubble.style.display = 'none';
                }, 60000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
        const db = new Dexie('GeminiChatDB');
        db.version(9).stores({ 
            chats: '&id, isGroup', 
            apiConfig: '&id', 
            globalSettings: '&id', 
            userStickers: '&id, url, name',
            worldBooks: '&id, name',
            musicLibrary: '&id', 
            personaPresets: '&id',
            weiboPosts: '&id, authorId, visibility, timestamp'
        });
        db.version(10).stores({
    chats: '&id, isGroup',
    apiConfig: '&id',
    globalSettings: '&id',
    userStickers: '&id, url, name',
    worldBooks: '&id, name',
    musicLibrary: '&id',
    personaPresets: '&id',
    // æ–°å¢å¾®åšç›¸å…³çš„è¡¨
    weiboPosts: '&id, authorId, timestamp, visibility',
    weiboComments: '&id, postId, authorId, timestamp',
    weiboLikes: '[postId+authorId], postId, authorId',
    weiboReposts: '&id, originalPostId, authorId, timestamp'
});
        db.version(11).stores({
    chats: '&id, isGroup',
    apiConfig: '&id',
    globalSettings: '&id',
    userStickers: '&id, url, name',
    worldBooks: '&id, name',
    musicLibrary: '&id',
    personaPresets: '&id',
    weiboPosts: '&id, authorId, timestamp, visibility',
    weiboComments: '&id, postId, authorId, timestamp',
    weiboLikes: '[postId+authorId], postId, authorId',
    weiboReposts: '&id, originalPostId, authorId, timestamp',
    // æ–°å¢å¾®åšè®¾ç½®è¡¨
    weiboSettings: '&id'
});

        // æ–°å¢ç‰ˆæœ¬12ï¼šæ·»åŠ å£çº¸å­˜å‚¨å’Œç”¨æˆ·èµ„æ–™å­˜å‚¨
        db.version(12).stores({
    chats: '&id, isGroup',
    apiConfig: '&id',
    globalSettings: '&id',
    userStickers: '&id, url, name',
    worldBooks: '&id, name',
    musicLibrary: '&id',
    personaPresets: '&id',
    weiboPosts: '&id, authorId, timestamp, visibility',
    weiboComments: '&id, postId, authorId, timestamp',
    weiboLikes: '[postId+authorId], postId, authorId',
    weiboReposts: '&id, originalPostId, authorId, timestamp',
    weiboSettings: '&id',
    // æ–°å¢è¡¨
    wallpapers: '&id, type, data, timestamp',  // å£çº¸å­˜å‚¨
    userProfiles: '&id, type, data, timestamp', // ç”¨æˆ·èµ„æ–™å­˜å‚¨
    apiConfigs: '&id, name, data, timestamp'    // APIé…ç½®å­˜å‚¨
});

        let state = { chats: {}, activeChatId: null, globalSettings: { iconPosition: 'center' }, apiConfig: {}, userStickers: [], worldBooks: [], personaPresets: [] };
        let musicState = { isActive: false, activeChatId: null, isPlaying: false, playlist: [], currentIndex: -1, playMode: 'order', totalElapsedTime: 0, timerId: null };
        const audioPlayer = document.getElementById('audio-player');
        let newWallpaperBase64 = null;

        // ç”¨æˆ·èµ„æ–™ç¼“å­˜
        let userProfileCache = {
            name: 'æˆ‘çš„å¾®åš',
            signature: 'åˆ†äº«ç”Ÿæ´»ä¸­çš„ç¾å¥½ç¬é—´',
            email: '',
            avatar: 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg'
        };
        let isSelectionMode = false;
        let selectedMessages = new Set();
        let isWeiboSelectionMode = false;
        let selectedWeiboPosts = new Set();
        let editingMemberId = null;
        let editingWorldBookId = null;
        let editingPersonaPresetId = null;
        
        // é€šè¯çŠ¶æ€ç®¡ç†
        let callState = {
            isInCall: false,
            callType: null, // 'voice' or 'video'
            activeChatId: null,
            startTime: null,
            timer: null,
            messages: [],
            userInitiated: false
        };
        const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
        const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
        const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
        let notificationTimeout;
        // æ”¯æŒæ›´å¤šå›¾åºŠé“¾æ¥æ ¼å¼çš„è¡¨æƒ…åŒ…æ­£åˆ™è¡¨è¾¾å¼
        const STICKER_REGEX = /^(https?:\/\/(?:i\.postimg\.cc|imgur\.com|i\.imgur\.com|cdn\.discordapp\.com|media\.discordapp\.net|i\.ibb\.co|postimg\.cc|telegra\.ph|sm\.ms|imgbb\.com|imageban\.ru|prnt\.sc|gyazo\.com|i\.gyazo\.com|s3\.amazonaws\.com|cloudinary\.com|res\.cloudinary\.com|github\.com\/.*\/.*\.(?:png|jpg|jpeg|gif|webp)|raw\.githubusercontent\.com)\/.*\.?(?:png|jpg|jpeg|gif|webp|bmp)|data:image)/i;
        
        const MESSAGE_RENDER_WINDOW = 50;
        let currentRenderedCount = 0;

        let lastKnownBatteryLevel = 1;
        let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
        let batteryAlertTimeout;

        // æå‰å®šä¹‰applyBorderlessModeå‡½æ•°
        function applyBorderlessMode() {
            const borderlessMode = state.globalSettings.borderlessMode || false;
            if (borderlessMode) {
                document.body.classList.add('borderless-mode');
            } else {
                document.body.classList.remove('borderless-mode');
            }

            // æ›´æ–°å£çº¸è®¾ç½®ç•Œé¢çš„å¼€å…³çŠ¶æ€
            const toggle = document.getElementById('borderless-mode-toggle');
            if (toggle) {
                toggle.checked = borderlessMode;
            }
        }

        async function loadAllDataFromDB() { const [chatsArr, apiConfig, globalSettings, userStickers, worldBooks, musicLib, personaPresets] = await Promise.all([ db.chats.toArray(), db.apiConfig.get('main'), db.globalSettings.get('main'), db.userStickers.toArray(), db.worldBooks.toArray(), db.musicLibrary.get('main'), db.personaPresets.toArray() ]); state.chats = chatsArr.reduce((acc, chat) => { if (!chat.musicData) chat.musicData = { totalTime: 0 }; if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) { chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId]; delete chat.settings.linkedWorldBookId; } acc[chat.id] = chat; return acc; }, {}); state.apiConfig = apiConfig || { id: 'main', proxyUrl: '', apiKey: '', model: '', temperature: 0.75 }; state.globalSettings = globalSettings || { id: 'main', wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)', iconPosition: 'center', fontSize: 'medium', borderlessMode: false, customBubbleCSS: '', customFontUrl: '' }; state.userStickers = userStickers || []; state.worldBooks = worldBooks || []; musicState.playlist = musicLib?.playlist || []; state.personaPresets = personaPresets || []; applyIconPosition(); applyCustomIcons(); applyFontSize(); applyBorderlessMode(); applyCustomStyles(); }
        async function saveGlobalPlaylist() { await db.musicLibrary.put({ id: 'main', playlist: musicState.playlist }); }

        const modalOverlay = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('custom-modal-title');
        const modalBody = document.getElementById('custom-modal-body');
        const modalConfirmBtn = document.getElementById('custom-modal-confirm');
        const modalCancelBtn = document.getElementById('custom-modal-cancel');
        let modalResolve;

        function showCustomModal() { modalOverlay.classList.add('visible'); }
        function hideCustomModal() { modalOverlay.classList.remove('visible'); modalConfirmBtn.classList.remove('btn-danger'); if (modalResolve) modalResolve(null); }
        modalCancelBtn.addEventListener('click', hideCustomModal);
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });

        function showCustomConfirm(title, message, options = {}) {
            // å¦‚æœæœ‰è‡ªå®šä¹‰æŒ‰é’®ï¼Œä½¿ç”¨æ–°çš„å¤„ç†æ–¹å¼
            if (options.customButtons) {
                return showCustomActionMenu(title, message, options.customButtons);
            }

            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;
                modalCancelBtn.style.display = 'block';
                modalConfirmBtn.textContent = 'ç¡®å®š';
                if (options.confirmButtonClass) modalConfirmBtn.classList.add(options.confirmButtonClass);
                modalConfirmBtn.onclick = () => { resolve(true); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(false); hideCustomModal(); };
                showCustomModal();
            });
        }

        // æ˜¾ç¤ºè‡ªå®šä¹‰æ“ä½œèœå•
        function showCustomActionMenu(title, message, buttons) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;

                // éšè—é»˜è®¤æŒ‰é’®
                modalCancelBtn.style.display = 'none';
                modalConfirmBtn.style.display = 'none';

                // åˆ›å»ºè‡ªå®šä¹‰æŒ‰é’®å®¹å™¨
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'custom-action-buttons';
                buttonContainer.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    margin-top: 15px;
                `;

                // æ·»åŠ è‡ªå®šä¹‰æŒ‰é’®
                buttons.forEach((button, index) => {
                    const btn = document.createElement('button');
                    btn.textContent = button.text;
                    btn.style.cssText = `
                        padding: 12px 16px;
                        border: none;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        ${index === 0 ? 'background-color: var(--accent-color); color: white;' :
                          index === buttons.length - 1 ? 'background-color: #f5f5f5; color: #666;' :
                          'background-color: #e8f4fd; color: var(--accent-color);'}
                    `;

                    btn.addEventListener('click', () => {
                        if (button.action) button.action();
                        hideCustomModal();
                        resolve(index);
                    });

                    btn.addEventListener('mouseenter', () => {
                        btn.style.transform = 'translateY(-1px)';
                        btn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                    });

                    btn.addEventListener('mouseleave', () => {
                        btn.style.transform = 'translateY(0)';
                        btn.style.boxShadow = 'none';
                    });

                    buttonContainer.appendChild(btn);
                });

                modalBody.appendChild(buttonContainer);
                showCustomModal();

                // æ¸…ç†å‡½æ•°
                const cleanup = () => {
                    if (buttonContainer.parentNode) {
                        buttonContainer.parentNode.removeChild(buttonContainer);
                    }
                    modalCancelBtn.style.display = 'block';
                    modalConfirmBtn.style.display = 'block';
                };

                // å½“æ¨¡æ€æ¡†å…³é—­æ—¶æ¸…ç†
                const originalHide = hideCustomModal;
                hideCustomModal = () => {
                    cleanup();
                    hideCustomModal = originalHide;
                    originalHide();
                };
            });
        }

        function showCustomAlert(title, message) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;
                modalCancelBtn.style.display = 'none';
                modalConfirmBtn.textContent = 'å¥½çš„';
                modalConfirmBtn.onclick = () => {
                    modalCancelBtn.style.display = 'block'; 
                    modalConfirmBtn.textContent = 'ç¡®å®š';
                    resolve(true); 
                    hideCustomModal();
                };
                showCustomModal();
            });
        }
        
        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.showCustomAlert = showCustomAlert;
        
        // å¹¶å‘èŠå¤©ç®¡ç†ç³»ç»Ÿ
        class ConcurrentChatManager {
            constructor() {
                this.activeRequests = new Map(); // chatId -> RequestInfo
                this.requestQueue = new Map(); // chatId -> Array of pending requests
            }
            
            // åˆ›å»ºè¯·æ±‚ä¿¡æ¯å¯¹è±¡
            createRequestInfo(chatId, type = 'chat') {
                return {
                    chatId,
                    type, // 'chat', 'weibo', 'call' ç­‰
                    timestamp: Date.now(),
                    abortController: new AbortController()
                };
            }
            
            // å¼€å§‹æ–°çš„è¯·æ±‚
            async startRequest(chatId, requestType, requestFunction, ...args) {
                // å¦‚æœè¯¥èŠå¤©å·²æœ‰æ´»è·ƒè¯·æ±‚ï¼Œå°†æ–°è¯·æ±‚åŠ å…¥é˜Ÿåˆ—
                if (this.activeRequests.has(chatId)) {
                    console.log(`èŠå¤© ${chatId} å·²æœ‰æ´»è·ƒè¯·æ±‚ï¼Œå°†æ–°è¯·æ±‚åŠ å…¥é˜Ÿåˆ—`);
                    if (!this.requestQueue.has(chatId)) {
                        this.requestQueue.set(chatId, []);
                    }
                    this.requestQueue.get(chatId).push({
                        type: requestType,
                        function: requestFunction,
                        args: args,
                        timestamp: Date.now()
                    });
                    return null;
                }
                
                // åˆ›å»ºå¹¶å¯åŠ¨æ–°è¯·æ±‚
                const requestInfo = this.createRequestInfo(chatId, requestType);
                this.activeRequests.set(chatId, requestInfo);
                
                            // æ˜¾ç¤ºè¯¥èŠå¤©çš„åŠ è½½çŠ¶æ€
            this.showTypingIndicator(chatId, requestType);
            
            // æ›´æ–°å…¨å±€çŠ¶æ€æ˜¾ç¤º
            this.updateGlobalStatus();
                
                try {
                    // æ‰§è¡Œè¯·æ±‚å‡½æ•°
                    const result = await requestFunction.apply(null, [requestInfo.abortController.signal, ...args]);
                    return result;
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.log(`è¯·æ±‚è¢«å–æ¶ˆ: ${chatId} - ${requestType}`);
                        return null;
                    }
                    throw error;
                } finally {
                                    // æ¸…ç†å½“å‰è¯·æ±‚
                this.activeRequests.delete(chatId);
                this.hideTypingIndicator(chatId);
                
                // æ›´æ–°å…¨å±€çŠ¶æ€æ˜¾ç¤º
                this.updateGlobalStatus();
                
                // å¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªè¯·æ±‚
                this.processNextRequest(chatId);
                }
            }
            
            // å¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªè¯·æ±‚
            async processNextRequest(chatId) {
                const queue = this.requestQueue.get(chatId);
                if (!queue || queue.length === 0) {
                    return;
                }
                
                const nextRequest = queue.shift();
                if (queue.length === 0) {
                    this.requestQueue.delete(chatId);
                }
                
                // æ›´æ–°å…¨å±€çŠ¶æ€æ˜¾ç¤º
                this.updateGlobalStatus();
                
                // æ‰§è¡Œä¸‹ä¸€ä¸ªè¯·æ±‚
                setTimeout(() => {
                    this.startRequest(
                        chatId,
                        nextRequest.type,
                        nextRequest.function,
                        ...nextRequest.args
                    );
                }, 100); // çŸ­æš‚å»¶è¿Ÿé¿å…UIé—ªçƒ
            }
            
            // å–æ¶ˆæŒ‡å®šèŠå¤©çš„æ‰€æœ‰è¯·æ±‚
            cancelRequests(chatId) {
                // å–æ¶ˆæ´»è·ƒè¯·æ±‚
                const activeRequest = this.activeRequests.get(chatId);
                if (activeRequest) {
                    activeRequest.abortController.abort();
                    this.activeRequests.delete(chatId);
                }
                
                // æ¸…ç©ºé˜Ÿåˆ—
                this.requestQueue.delete(chatId);
                
                // éšè—åŠ è½½çŠ¶æ€
                this.hideTypingIndicator(chatId);
                
                // æ›´æ–°å…¨å±€çŠ¶æ€æ˜¾ç¤º
                this.updateGlobalStatus();
            }
            
            // å–æ¶ˆæ‰€æœ‰è¯·æ±‚
            cancelAllRequests() {
                // å–æ¶ˆæ‰€æœ‰æ´»è·ƒè¯·æ±‚
                for (const [chatId, requestInfo] of this.activeRequests) {
                    requestInfo.abortController.abort();
                    this.hideTypingIndicator(chatId);
                }
                
                // æ¸…ç©ºæ‰€æœ‰æ•°æ®
                this.activeRequests.clear();
                this.requestQueue.clear();
                
                // æ›´æ–°å…¨å±€çŠ¶æ€æ˜¾ç¤º
                this.updateGlobalStatus();
            }
            
            // æ˜¾ç¤ºè¾“å…¥çŠ¶æ€æŒ‡ç¤ºå™¨
            showTypingIndicator(chatId, requestType) {
                // ä¸ºæ¯ä¸ªèŠå¤©åˆ›å»ºç‹¬ç«‹çš„è¾“å…¥æŒ‡ç¤ºå™¨
                const indicatorId = `typing-indicator-${chatId}`;
                let indicator = document.getElementById(indicatorId);
                
                if (!indicator) {
                    // å¦‚æœæ˜¯å½“å‰æ´»è·ƒèŠå¤©ï¼Œåœ¨èŠå¤©åŒºåŸŸæ˜¾ç¤º
                    if (state.activeChatId === chatId) {
                        const messagesContainer = document.getElementById('chat-messages');
                        const existingIndicator = document.getElementById('typing-indicator');
                        if (existingIndicator) {
                            existingIndicator.style.display = 'block';
                            existingIndicator.textContent = this.getTypingText(requestType);
                        }
                    }
                    return;
                }
                
                // æ›´æ–°æŒ‡ç¤ºå™¨æ–‡æœ¬
                indicator.style.display = 'block';
                indicator.textContent = this.getTypingText(requestType);
            }
            
            // éšè—è¾“å…¥çŠ¶æ€æŒ‡ç¤ºå™¨
            hideTypingIndicator(chatId) {
                const indicatorId = `typing-indicator-${chatId}`;
                const indicator = document.getElementById(indicatorId);
                
                if (indicator) {
                    indicator.style.display = 'none';
                }
                
                // å¦‚æœæ˜¯å½“å‰æ´»è·ƒèŠå¤©ï¼Œä¹Ÿéšè—ä¸»è¦æŒ‡ç¤ºå™¨
                if (state.activeChatId === chatId) {
                    const mainIndicator = document.getElementById('typing-indicator');
                    if (mainIndicator) {
                        mainIndicator.style.display = 'none';
                    }
                }
                
                // æ›´æ–°èŠå¤©åˆ—è¡¨ä¸­çš„çŠ¶æ€æŒ‡ç¤º
                this.updateChatListStatus(chatId);
            }
            
            // è·å–ä¸åŒè¯·æ±‚ç±»å‹çš„æç¤ºæ–‡æœ¬
            getTypingText(requestType) {
                const textMap = {
                    'chat': 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...',
                    'weibo': 'æ­£åœ¨å‘å¸ƒå¾®åš...',
                    'weibo_comment': 'æ­£åœ¨è¯„è®º...',
                    'call': 'é€šè¯è¿æ¥ä¸­...',
                    'background': 'æ­£åœ¨æ€è€ƒ...'
                };
                return textMap[requestType] || 'æ­£åœ¨å¤„ç†...';
            }
            
            // æ›´æ–°èŠå¤©åˆ—è¡¨ä¸­çš„çŠ¶æ€æ˜¾ç¤º
            updateChatListStatus(chatId) {
                const chatElement = document.querySelector(`[data-chat-id="${chatId}"]`);
                if (!chatElement) return;
                
                const statusIndicator = chatElement.querySelector('.chat-status-indicator');
                const hasActiveRequest = this.activeRequests.has(chatId);
                const hasQueuedRequests = this.requestQueue.has(chatId) && this.requestQueue.get(chatId).length > 0;
                
                if (statusIndicator) {
                    if (hasActiveRequest) {
                        statusIndicator.style.display = 'block';
                        statusIndicator.textContent = 'â—';
                        statusIndicator.style.color = '#1aad19';
                    } else if (hasQueuedRequests) {
                        statusIndicator.style.display = 'block';
                        statusIndicator.textContent = 'â—‹';
                        statusIndicator.style.color = '#ff9500';
                    } else {
                        statusIndicator.style.display = 'none';
                    }
                }
            }
            
            // è·å–è¯·æ±‚çŠ¶æ€
            getRequestStatus(chatId) {
                return {
                    hasActiveRequest: this.activeRequests.has(chatId),
                    queueLength: this.requestQueue.has(chatId) ? this.requestQueue.get(chatId).length : 0,
                    requestType: this.activeRequests.has(chatId) ? this.activeRequests.get(chatId).type : null
                };
            }
            
            // æ›´æ–°å…¨å±€çŠ¶æ€æ˜¾ç¤º
            updateGlobalStatus() {
                const statusElement = document.getElementById('concurrent-status');
                const statusText = document.getElementById('concurrent-status-text');
                
                if (!statusElement || !statusText) return;
                
                const activeCount = this.activeRequests.size;
                const totalQueueCount = Array.from(this.requestQueue.values()).reduce((sum, queue) => sum + queue.length, 0);
                
                if (activeCount === 0 && totalQueueCount === 0) {
                    statusElement.style.display = 'none';
                } else {
                    statusElement.style.display = 'block';
                    if (totalQueueCount > 0) {
                        statusText.textContent = `æ­£åœ¨å¤„ç† ${activeCount} ä¸ªè¯·æ±‚ï¼Œç­‰å¾… ${totalQueueCount} ä¸ª`;
                    } else {
                        statusText.textContent = `æ­£åœ¨å¤„ç† ${activeCount} ä¸ªè¯·æ±‚`;
                    }
                }
            }
        }
        
        // åˆ›å»ºå…¨å±€å¹¶å‘èŠå¤©ç®¡ç†å™¨
        window.concurrentChatManager = new ConcurrentChatManager();
        
        // é¡µé¢å¸è½½æ—¶å–æ¶ˆæ‰€æœ‰è¯·æ±‚
        window.addEventListener('beforeunload', () => {
            window.concurrentChatManager.cancelAllRequests();
        });
        
        // æ ¹æ®å¯¹è¯è½®æ•°è·å–å†å²æ¶ˆæ¯
        function getHistoryByRounds(chatHistory, maxRounds) {
            if (!chatHistory || chatHistory.length === 0 || maxRounds <= 0) {
                return [];
            }
            
            const rounds = [];
            let currentRound = [];
            let waitingForAI = false;
            
            // ä»æœ€æ–°æ¶ˆæ¯å¼€å§‹å¾€å‰éå†
            for (let i = chatHistory.length - 1; i >= 0; i--) {
                const message = chatHistory[i];
                
                if (message.role === 'user') {
                    if (waitingForAI) {
                        // å¦‚æœä¹‹å‰åœ¨ç­‰å¾…AIå›å¤ï¼Œè¯´æ˜ä¸Šä¸€è½®å®Œæˆäº†
                        if (currentRound.length > 0) {
                            rounds.unshift([...currentRound]);
                            currentRound = [];
                        }
                    }
                    currentRound.unshift(message);
                    waitingForAI = true;
                } else if (message.role === 'assistant') {
                    if (waitingForAI) {
                        currentRound.unshift(message);
                        // ç»§ç»­ç­‰å¾…å¯èƒ½çš„æ›´å¤šAIæ¶ˆæ¯
                    } else {
                        // è¿™æ˜¯ä¸€ä¸ªå­¤ç«‹çš„AIæ¶ˆæ¯ï¼Œä½œä¸ºç‹¬ç«‹è½®æ¬¡
                        if (currentRound.length > 0) {
                            rounds.unshift([...currentRound]);
                        }
                        currentRound = [message];
                    }
                }
                
                // å¦‚æœæ”¶é›†åˆ°è¶³å¤Ÿçš„è½®æ•°å°±åœæ­¢
                if (rounds.length >= maxRounds) {
                    break;
                }
            }
            
            // å¤„ç†æœ€åä¸€è½®
            if (currentRound.length > 0 && rounds.length < maxRounds) {
                rounds.unshift([...currentRound]);
            }
            
            // åªä¿ç•™æŒ‡å®šæ•°é‡çš„è½®æ•°
            const selectedRounds = rounds.slice(-maxRounds);
            
            // å°†è½®æ•°å±•å¹³ä¸ºæ¶ˆæ¯æ•°ç»„
            const result = [];
            for (const round of selectedRounds) {
                result.push(...round);
            }
            
            return result;
        }
        
        // å›¾ç‰‡æŸ¥çœ‹å™¨åŠŸèƒ½
        function showImageViewer(imageSrc) {
            const modal = document.getElementById('image-viewer-modal');
            const viewerImage = document.getElementById('viewer-image');
            
            viewerImage.src = imageSrc;
            modal.classList.add('visible');
        }
        
        function hideImageViewer() {
            const modal = document.getElementById('image-viewer-modal');
            modal.classList.remove('visible');
        }
        
        // å›¾ç‰‡æŸ¥çœ‹å™¨äº‹ä»¶ç›‘å¬ - ç«‹å³åˆå§‹åŒ–
        function initImageViewer() {
            const modal = document.getElementById('image-viewer-modal');
            const closeBtn = document.querySelector('.image-viewer-close');
            
            // ç‚¹å‡»å…³é—­æŒ‰é’®
            if (closeBtn) {
                closeBtn.addEventListener('click', hideImageViewer);
            }
            
            // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        hideImageViewer();
                    }
                });
            }
            
            // æŒ‰ESCé”®å…³é—­
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.classList.contains('visible')) {
                    hideImageViewer();
                }
            });
        }
        
        // ç«‹å³åˆå§‹åŒ–å›¾ç‰‡æŸ¥çœ‹å™¨
        initImageViewer();

        function showCustomPrompt(title, placeholder, initialValue = '', type = 'text') {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<input type="${type}" id="custom-prompt-input" placeholder="${placeholder}" value="${initialValue}">`;
                const input = document.getElementById('custom-prompt-input');
                modalConfirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(null); hideCustomModal(); };
                showCustomModal();
                setTimeout(() => input.focus(), 100);
            });
        }
        
        // æ·»åŠ ç®€å•çš„toastæç¤ºå‡½æ•°
        function showToast(message, type = 'info') {
            // åˆ›å»ºtoastå…ƒç´ 
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºtoast
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }
        function showNotification(chatId, messageContent, type = 'chat') { 
            clearTimeout(notificationTimeout); 
            
            const bar = document.getElementById('notification-bar');
            
            if (type === 'weibo') {
                // å¾®åšé€šçŸ¥
                const ai = state.chats[chatId];
                if (!ai) return;
                
                document.getElementById('notification-avatar').src = ai.settings.aiAvatar || defaultAvatar;
                document.getElementById('notification-content').querySelector('.name').textContent = ai.name;
                document.getElementById('notification-content').querySelector('.message').textContent = messageContent;
                
                const newBar = bar.cloneNode(true);
                bar.parentNode.replaceChild(newBar, bar);
                newBar.addEventListener('click', () => { 
                    showScreen('weibo-screen');
                    newBar.classList.remove('visible'); 
                });
                newBar.classList.add('visible');
                notificationTimeout = setTimeout(() => { newBar.classList.remove('visible'); }, 4000);
            } else {
                // èŠå¤©é€šçŸ¥
                const chat = state.chats[chatId];
                if (!chat) return;
                
                document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar;
                document.getElementById('notification-content').querySelector('.name').textContent = chat.name;
                document.getElementById('notification-content').querySelector('.message').textContent = messageContent;
                
                const newBar = bar.cloneNode(true);
                bar.parentNode.replaceChild(newBar, bar);
                newBar.addEventListener('click', () => { 
                    openChat(chatId); 
                    newBar.classList.remove('visible'); 
                });
                newBar.classList.add('visible');
                notificationTimeout = setTimeout(() => { newBar.classList.remove('visible'); }, 4000);
            }
        }
        function updateClock() { const now = new Date(); const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); document.getElementById('main-time').textContent = timeString; document.getElementById('status-bar-time').textContent = timeString; document.getElementById('main-date').textContent = dateString; }
        function parseAiResponse(content) {
            // è·å–å½“å‰èŠå¤©çš„è®¾ç½®
            const chat = state.chats[state.activeChatId];
            // é»˜è®¤ä¸ºçº¿ä¸Šæ¨¡å¼ï¼Œåªæœ‰æ˜ç¡®è®¾ç½®ä¸º 'offline' æ—¶æ‰æ˜¯çº¿ä¸‹æ¨¡å¼
            const isOnlineMode = !chat || !chat.settings || chat.settings.chatMode !== 'offline';

            // è°ƒè¯•ä¿¡æ¯
            console.log('parseAiResponse - chatMode:', chat?.settings?.chatMode, 'isOnlineMode:', isOnlineMode);

            // é¦–å…ˆå°è¯•è§£æJSONæ•°ç»„æ ¼å¼
            try {
                const parsed = JSON.parse(content);
                if (Array.isArray(parsed)) {
                    // çº¿ä¸‹æ¨¡å¼ï¼šå³ä½¿æ˜¯JSONæ•°ç»„ä¹Ÿè¦åˆå¹¶ä¸ºå•ä¸ªæ¶ˆæ¯
                    if (!isOnlineMode) {
                        return [parsed.join('\n')];
                    }
                    return parsed;
                }
            } catch (e) {}

            // å°è¯•æå–JSONæ•°ç»„éƒ¨åˆ†
            try {
                const match = content.match(/\[(.*?)\]/s);
                if (match && match[0]) {
                    const parsed = JSON.parse(match[0]);
                    if (Array.isArray(parsed)) {
                        // çº¿ä¸‹æ¨¡å¼ï¼šå³ä½¿æ˜¯JSONæ•°ç»„ä¹Ÿè¦åˆå¹¶ä¸ºå•ä¸ªæ¶ˆæ¯
                        if (!isOnlineMode) {
                            return [parsed.join('\n')];
                        }
                        return parsed;
                    }
                }
            } catch (e) {}

            // æ£€æŸ¥æ˜¯å¦åŒ…å«JSONå¯¹è±¡æ ¼å¼çš„æ¶ˆæ¯
            if (content.includes('"content"') && content.includes('"name"')) {
                try {
                    // å°è¯•è§£æå•ä¸ªJSONå¯¹è±¡
                    const parsed = JSON.parse(content);
                    if (parsed.content) return [parsed];
                } catch (e) {
                    // å°è¯•æå–å¤šä¸ªJSONå¯¹è±¡
                    const jsonObjects = content.match(/\{[^{}]*"content"[^{}]*\}/g);
                    if (jsonObjects) {
                        const messages = [];
                        for (const jsonStr of jsonObjects) {
                            try {
                                const obj = JSON.parse(jsonStr);
                                if (obj.content) messages.push(obj);
                            } catch (e) {}
                        }
                        if (messages.length > 0) return messages;
                    }
                }
            }

            // æ£€æŸ¥æ˜¯å¦åŒ…å«ç³»ç»Ÿæ¶ˆæ¯æ ‡è®°ï¼ˆæ–¹æ‹¬å·å†…å®¹ï¼‰
            const systemMessagePattern = /\[.*?\]/g;
            const systemMessages = content.match(systemMessagePattern);

            if (systemMessages && systemMessages.length > 0) {
                // åˆ†ç¦»ç³»ç»Ÿæ¶ˆæ¯å’Œæ™®é€šæ¶ˆæ¯
                let remainingContent = content;
                const messages = [];

                // æå–æ‰€æœ‰ç³»ç»Ÿæ¶ˆæ¯
                for (const sysMsg of systemMessages) {
                    messages.push({
                        type: 'system_message',
                        content: sysMsg
                    });
                    remainingContent = remainingContent.replace(sysMsg, '').trim();
                }

                // å¤„ç†å‰©ä½™çš„æ™®é€šæ¶ˆæ¯å†…å®¹
                if (remainingContent) {
                    if (isOnlineMode) {
                        // çº¿ä¸Šæ¨¡å¼ï¼šåªæŒ‰æ¢è¡Œç¬¦åˆ†å‰²ï¼Œä¿æŠ¤ç½‘å€ä¸è¢«åˆ†å‰²

                        // å…ˆæå–å¹¶ä¿æŠ¤ç½‘å€
                        const urlPattern = /(https?:\/\/[^\s]+)/g;
                        const urls = [];
                        let protectedContent = remainingContent.replace(urlPattern, (match) => {
                            urls.push(match);
                            return `__URL_PLACEHOLDER_${urls.length - 1}__`;
                        });

                        // æŒ‰æ¢è¡Œç¬¦åˆ†å‰²
                        const lines = protectedContent.split(/\n+/)
                            .map(line => line.trim())
                            .filter(line => line.length > 0);

                        for (const line of lines) {
                            // æ¢å¤ç½‘å€
                            let restoredLine = line;
                            urls.forEach((url, index) => {
                                restoredLine = restoredLine.replace(`__URL_PLACEHOLDER_${index}__`, url);
                            });
                            messages.push(restoredLine);
                        }
                    } else {
                        // çº¿ä¸‹æ¨¡å¼ï¼šæ‰€æœ‰å†…å®¹æ”¾åœ¨ä¸€ä¸ªæ°”æ³¡
                        messages.push(remainingContent);
                    }
                }

                return messages.filter(msg => {
                    if (typeof msg === 'string') return msg.trim().length > 0;
                    return msg.content && msg.content.trim().length > 0;
                });
            }

            // å¦‚æœæ²¡æœ‰ç³»ç»Ÿæ¶ˆæ¯ï¼ŒæŒ‰ç…§æ¨¡å¼å¤„ç†
            if (isOnlineMode) {
                // çº¿ä¸Šæ¨¡å¼ï¼šåªæŒ‰æ¢è¡Œç¬¦åˆ†å‰²ï¼Œä¿æŠ¤ç½‘å€ä¸è¢«åˆ†å‰²

                // å…ˆæå–å¹¶ä¿æŠ¤ç½‘å€
                const urlPattern = /(https?:\/\/[^\s]+)/g;
                const urls = [];
                let protectedContent = content.replace(urlPattern, (match) => {
                    urls.push(match);
                    return `__URL_PLACEHOLDER_${urls.length - 1}__`;
                });

                // æŒ‰æ¢è¡Œç¬¦åˆ†å‰²
                const lines = protectedContent.split(/\n+/)
                    .map(line => line.trim())
                    .filter(line => line.length > 0);

                const result = [];

                for (const line of lines) {
                    // æ¢å¤ç½‘å€
                    let restoredLine = line;
                    urls.forEach((url, index) => {
                        restoredLine = restoredLine.replace(`__URL_PLACEHOLDER_${index}__`, url);
                    });
                    result.push(restoredLine);
                }

                return result.filter(s => s.trim().length > 0);
            } else {
                // çº¿ä¸‹æ¨¡å¼ï¼šä¿æŒä¸ºä¸€ä¸ªå®Œæ•´æ¶ˆæ¯ï¼Œä½†å¯ä»¥åŒ…å«æ¢è¡Œ
                return [content];
            }

            // é»˜è®¤è¿”å›åŸå†…å®¹
            return [content];
        }
        function renderApiSettings() { 
    document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || ''; 
    document.getElementById('api-key').value = state.apiConfig.apiKey || '';
    const temperatureSlider = document.getElementById('temperature-slider');
    const temperatureValue = document.getElementById('temperature-value');
    temperatureSlider.value = state.apiConfig.temperature || 0.75;
    temperatureValue.textContent = state.apiConfig.temperature || 0.75;
    
    // æ·»åŠ æ¸©åº¦æ»‘å—çš„äº‹ä»¶ç›‘å¬
    temperatureSlider.addEventListener('input', function() {
        temperatureValue.textContent = this.value;
        state.apiConfig.temperature = parseFloat(this.value);
    });
}
        window.renderApiSettingsProxy = renderApiSettings;
        
        function renderChatList() { 
            const chatListEl = document.getElementById('chat-list'); 
            chatListEl.innerHTML = ''; 
            
            if (Object.keys(state.chats).length === 0) { 
                chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" æˆ–ç¾¤ç»„å›¾æ ‡æ·»åŠ èŠå¤©</p>'; 
                return; 
            } 
            
            Object.values(state.chats).sort((a,b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0)).forEach(chat => { 
                const lastMsgObj = chat.history.slice(-1)[0] || {}; 
                let lastMsgDisplay; 
                
                if(lastMsgObj.type === 'transfer') { 
                    lastMsgDisplay = '[è½¬è´¦]'; 
                } else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { 
                    lastMsgDisplay = '[ç…§ç‰‡]'; 
                } else if (lastMsgObj.type === 'voice_message') { 
                    lastMsgDisplay = '[è¯­éŸ³]'; 
                } else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { 
                    lastMsgDisplay = lastMsgObj.meaning ? `[è¡¨æƒ…: ${lastMsgObj.meaning}]` : '[è¡¨æƒ…]'; 
                } else if (Array.isArray(lastMsgObj.content)) { 
                    lastMsgDisplay = `[å›¾ç‰‡]`; 
                } else { 
                    lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); 
                } 
                
                if (chat.isGroup && lastMsgObj.senderName) { 
                    lastMsgDisplay = `${lastMsgObj.senderName}: ${lastMsgDisplay}`; 
                } 
                
                const item = document.createElement('div'); 
                item.className = 'chat-list-item'; 
                item.dataset.chatId = chat.id; 
                const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar; 
                
                item.innerHTML = `
                    <img src="${avatar || defaultAvatar}" class="avatar">
                    <div class="info">
                        <div class="name-line">
                            <span class="name">${chat.name}</span>
                            ${chat.isGroup ? '<span class="group-tag">ç¾¤èŠ</span>' : ''}
                        </div>
                        <div class="last-msg">${lastMsgDisplay}</div>
                    </div>
                    <span class="chat-status-indicator"></span>
                `; 
                
                item.addEventListener('click', async () => { 
                    openChat(chat.id); 
                }); 
                
                addLongPressListener(item, async (e) => { 
                    const confirmed = await showCustomConfirm('åˆ é™¤å¯¹è¯', `ç¡®å®šè¦åˆ é™¤ä¸ "${chat.name}" çš„æ•´ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, { confirmButtonClass: 'btn-danger' }); 
                    if (confirmed) { 
                        try { 
                            if (musicState.isActive && musicState.activeChatId === chat.id) await endListenTogetherSession(false); 
                            // å–æ¶ˆè¯¥èŠå¤©çš„æ‰€æœ‰è¯·æ±‚
                            window.concurrentChatManager.cancelRequests(chat.id);
                            delete state.chats[chat.id]; 
                            if (state.activeChatId === chat.id) state.activeChatId = null; 
                            await db.chats.delete(chat.id); 
                            renderChatList(); 
                        } catch (error) { 
                            console.error("åˆ é™¤èŠå¤©å¤±è´¥:", error); 
                            alert("åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚"); 
                        } 
                    } 
                }); 
                
                // åˆå§‹åŒ–çŠ¶æ€æ˜¾ç¤º
                if (window.concurrentChatManager) {
                    window.concurrentChatManager.updateChatListStatus(chat.id);
                }
                
                chatListEl.appendChild(item); 
            }); 
        }
        window.renderChatListProxy = renderChatList;
        window.renderWeiboTimelineProxy = renderWeiboTimeline;
        window.handleLikeProxy = handleLike;
        window.handleCommentProxy = handleComment;
        window.handleRepostProxy = handleRepost;
        window.handleReplyCommentProxy = handleReplyComment;
        
        // æ ¼å¼åŒ–å¾®åšå†…å®¹ï¼Œæ”¯æŒ@ç”¨æˆ·é«˜äº®å’Œå›¾ç‰‡é“¾æ¥è½¬æ¢
        function formatWeiboContent(content) {
            if (!content) return '';

            // å…ˆå¤„ç†æ¢è¡Œç¬¦ï¼Œå°†å…¶è½¬æ¢ä¸ºHTMLçš„æ¢è¡Œ
            content = content.replace(/\n/g, '<br>');

            // å¤„ç†å›¾ç‰‡é“¾æ¥ï¼šå°†HTTP/HTTPSå›¾ç‰‡é“¾æ¥è½¬æ¢ä¸ºå®é™…çš„å›¾ç‰‡æ˜¾ç¤º
            content = content.replace(/(https?:\/\/[^\s<>"']+\.(?:jpg|jpeg|png|gif|webp|bmp)(?:\?[^\s<>"']*)?)/gi,
                '<br><img src="$1" alt="å›¾ç‰‡" style="max-width:100%;border-radius:10px;display:block;margin:8px 0;cursor:pointer;" onclick="window.open(\'$1\', \'_blank\')" />');

            // @ç”¨æˆ·åé«˜äº®
            content = content.replace(/@([^\s@<>]+)/g, '<span style="color:var(--weibo-accent);font-weight:500;">@$1</span>');

            return content;
        }
        
        async function renderWeiboTimeline(filter = 'all') {
    const timeline = document.getElementById('weibo-timeline');
    timeline.innerHTML = '';
    
    // è·å–ä¿å­˜çš„é€æ˜åº¦è®¾ç½®
    const savedOpacity = (await db.userProfiles.get('weibo_card_opacity'))?.data || 1.0;
    
    // å¦‚æœæ˜¯"æˆ‘çš„"é¡µé¢ï¼Œå…ˆæ˜¾ç¤ºç”¨æˆ·èµ„æ–™å¡
    if (filter === 'mine') {
        const profileCard = document.createElement('div');
        profileCard.id = 'weibo-profile-card';
        profileCard.style.cssText = 'background: var(--weibo-card-bg); margin: 10px; border-radius: 16px; padding: 20px; border: 1.5px solid var(--weibo-card-border); box-shadow: 0 2px 8px rgba(0,0,0,0.04);';
        
        // è·å–ç”¨æˆ·èµ„æ–™
        const savedProfileData = await db.userProfiles.get('weibo_user_profile');
        const profile = savedProfileData ? savedProfileData.data : {};
        const userName = profile.name || 'æˆ‘çš„å¾®åš';
        const userSignature = profile.signature || 'åˆ†äº«ç”Ÿæ´»ä¸­çš„ç¾å¥½ç¬é—´';
        const userAvatar = profile.avatar || 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        
        // ç”Ÿæˆæˆ–è·å–ç¤¾äº¤ç»Ÿè®¡æ•°æ®
        const followingCount = profile.followingCount || Math.floor(Math.random() * 200 + 50);
        const followersCount = profile.followersCount || Math.floor(Math.random() * 300 + 100);
        const likesCount = profile.likesCount || Math.floor(Math.random() * 1000 + 200);
        
        // ä¿å­˜ç»Ÿè®¡æ•°æ®ä»¥ä¿æŒä¸€è‡´æ€§
        if (!profile.followingCount) {
            profile.followingCount = followingCount;
            profile.followersCount = followersCount;
            profile.likesCount = likesCount;
            await db.userProfiles.put({
                id: 'weibo_user_profile',
                type: 'weibo_profile',
                data: profile,
                timestamp: Date.now()
            });
        }
        
        profileCard.innerHTML = `
            <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;">
                <img src="${userAvatar}" style="width:60px;height:60px;border-radius:50%;object-fit:cover;cursor:pointer;" onclick="window.showSocialProfileSafe && window.showSocialProfileSafe('user')">
                <div style="flex:1;">
                    <div style="font-weight:600;font-size:18px;margin-bottom:5px;cursor:pointer;" onclick="window.showSocialProfileSafe && window.showSocialProfileSafe('user')">${userName}</div>
                    <div style="font-size:14px;color:var(--weibo-secondary);line-height:1.4;">${userSignature}</div>
                </div>
                <button id="edit-profile-btn" style="background: var(--weibo-accent); color: white; border: none; border-radius: 20px; padding: 8px 16px; font-size: 12px; cursor: pointer;">ç¼–è¾‘èµ„æ–™</button>
            </div>
            <div style="display:flex;justify-content:space-around;padding:10px 0;border-top:1px solid var(--weibo-card-border);">
                <div style="text-align:center;">
                    <div style="font-weight:600;font-size:16px;">${followingCount}</div>
                    <div style="font-size:12px;color:var(--weibo-secondary);">å…³æ³¨</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-weight:600;font-size:16px;">${followersCount}</div>
                    <div style="font-size:12px;color:var(--weibo-secondary);">ç²‰ä¸</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-weight:600;font-size:16px;">${likesCount}</div>
                    <div style="font-size:12px;color:var(--weibo-secondary);">è·èµ</div>
                </div>
            </div>
        `;
        
        timeline.appendChild(profileCard);
        
        // æ·»åŠ ç¼–è¾‘èµ„æ–™æŒ‰é’®äº‹ä»¶
        profileCard.querySelector('#edit-profile-btn').addEventListener('click', () => {
            document.getElementById('weibo-profile-modal').classList.add('visible');

            // åŠ è½½å½“å‰ç”¨æˆ·èµ„æ–™åˆ°ç¼–è¾‘è¡¨å•
            document.getElementById('profile-name-input').value = userProfileCache.name || 'æˆ‘çš„å¾®åš';
            document.getElementById('profile-signature-input').value = userProfileCache.signature || 'åˆ†äº«ç”Ÿæ´»ä¸­çš„ç¾å¥½ç¬é—´';
            document.getElementById('profile-email-input').value = userProfileCache.email || '';
            document.getElementById('profile-avatar-preview').src = userProfileCache.avatar || 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';

            // åŠ è½½ç”¨æˆ·çš„ç¤¾äº¤ä¸»é¡µèƒŒæ™¯
            const userBgPreview = document.getElementById('user-profile-bg-preview');
            if (userProfileCache.socialBackground) {
                userBgPreview.style.backgroundImage = `url(${userProfileCache.socialBackground})`;
                userBgPreview.textContent = '';
                document.getElementById('remove-user-profile-bg-btn').style.display = 'block';
            } else {
                userBgPreview.style.backgroundImage = '';
                userBgPreview.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                userBgPreview.textContent = 'é»˜è®¤æ¸å˜èƒŒæ™¯';
                document.getElementById('remove-user-profile-bg-btn').style.display = 'none';
            }
        });
    }
    
    let posts;
    if (filter === 'mine') {
        posts = await db.weiboPosts
            .where('authorId')
            .equals('user')
            .reverse()
            .sortBy('timestamp');
    } else {
        posts = await db.weiboPosts
            .reverse()
            .sortBy('timestamp');
    }

    for (const post of posts) {
        // éªŒè¯å¾®åšæ˜¯å¦ä»ç„¶å­˜åœ¨ï¼ˆé˜²æ­¢ç¼“å­˜é—®é¢˜ï¼‰
        const verifyPost = await db.weiboPosts.get(post.id);
        if (!verifyPost) {
            console.log(`æ¸²æŸ“æ—¶è·³è¿‡å·²åˆ é™¤çš„å¾®åš: ${post.id}`);
            continue;
        }

        const postElement = document.createElement('div');
        postElement.className = 'weibo-post';
        postElement.dataset.postId = post.id;

        // åº”ç”¨ä¿å­˜çš„é€æ˜åº¦è®¾ç½®
        postElement.style.opacity = savedOpacity;
        
        // æ ¹æ®å¯è§æ€§è¿‡æ»¤
        if (post.authorId !== 'user') {
            // ç§å¯†åŠ¨æ€ï¼šåªæœ‰å‘å¸ƒè€…å’Œç”¨æˆ·å¯è§
            if (post.visibility === 'private') {
                continue;
            }
            
            // å¥½å‹å¯è§åŠ¨æ€ï¼šåªæœ‰ç¾¤èŠå¥½å‹å¯è§
            if (post.visibility === 'friends') {
                // æ£€æŸ¥å½“å‰ç”¨æˆ·ä¸å‘å¸ƒè€…æ˜¯å¦åœ¨åŒä¸€ä¸ªç¾¤èŠä¸­
                const isUserFriend = Object.values(state.chats)
                    .filter(c => c.isGroup)
                    .some(group => 
                        group.members && 
                        group.members.includes('user') && 
                        group.members.includes(post.authorId)
                    );
                
                if (!isUserFriend) {
                    continue; // ä¸æ˜¯ç¾¤èŠå¥½å‹ï¼Œä¸æ˜¾ç¤º
                }
            }
        }
        
        const timestamp = new Date(post.timestamp).toLocaleString('zh-CN', {
            month: 'numeric',
            day: 'numeric',
            hour: 'numeric',
            minute: 'numeric'
        });

        // è·å–ç‚¹èµæ•°
        const likesCount = await db.weiboLikes
            .where('postId')
            .equals(post.id)
            .count();
            
        // è·å–è¯„è®ºæ•°
        const commentsCount = await db.weiboComments
            .where('postId')
            .equals(post.id)
            .count();
            
        // è·å–è½¬å‘æ•°    
        const repostsCount = await db.weiboReposts
            .where('originalPostId')
            .equals(post.id)
            .count();

        // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµ
        const hasLiked = await db.weiboLikes
            .where('[postId+authorId]')
            .equals([post.id, 'user'])
            .count() > 0;

        // æ–°å¢ï¼šä¸ªæ€§ç­¾åï¼ˆå¦‚æœæœ‰ï¼‰
        const signature = post.authorSignature || post.authorEmail || '';
        // å¤´åƒ
        const avatar = post.authorAvatar || 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        // ID
        const nickname = post.authorName || 'æœªçŸ¥';
        // é‚®ç®±/ç­¾å
        const email = post.authorEmail || '';
        
        // å†…å®¹
        let contentHtml = '';
        
        // å…ˆæ˜¾ç¤ºæ–‡å­—å†…å®¹ï¼Œå†æ˜¾ç¤ºå›¾ç‰‡
        if (post.description) {
            contentHtml += `<div style="color:var(--weibo-content-color);text-align:left;font-size:16px;margin:10px 0 0 0;line-height:1.7;">${formatWeiboContent(post.description)}</div>`;
        } else if (post.content) {
            contentHtml += `<div style="color:var(--weibo-content-color);text-align:left;font-size:16px;margin:10px 0 0 0;line-height:1.7;">${formatWeiboContent(post.content)}</div>`;
        }
        
        // å¦‚æœæ˜¯è½¬å‘ï¼Œæ˜¾ç¤ºè½¬å‘å¼•ç”¨ï¼ˆæ”¾åœ¨è‡ªå·±çš„è½¬å‘æ–‡æ¡ˆä¸‹æ–¹ï¼‰
        if (post.isRepost && post.originalPostId) {
            // è·å–åŸåŠ¨æ€ä¿¡æ¯
            const originalPost = await db.weiboPosts.get(post.originalPostId);
            if (originalPost) {
                contentHtml += `
                    <div style="background: #f8f9fa; border-radius: 10px; padding: 12px; margin-top: 10px; border-left: 3px solid var(--weibo-accent);">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:13px;color:var(--weibo-secondary);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                            </svg>
                            <span>è½¬å‘è‡ª @${originalPost.authorName}</span>
                        </div>
                        <div style="font-size:15px;line-height:1.5;text-align:left;">${formatWeiboContent(originalPost.content || originalPost.description || '')}</div>
                    </div>
                `;
            } else {
                // åŸåŠ¨æ€å·²è¢«åˆ é™¤ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                contentHtml += `
                    <div style="background: #f8f9fa; border-radius: 10px; padding: 12px; margin-top: 10px; border-left: 3px solid #ccc;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:13px;color:var(--weibo-secondary);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                            </svg>
                            <span>åŸåŠ¨æ€å·²è¢«åˆ é™¤</span>
                        </div>
                        <div style="font-size:15px;line-height:1.5;text-align:left;color:#999;font-style:italic;">æ­¤åŠ¨æ€ä¸å¯è§</div>
                    </div>
                `;
            }
        }
        
        if (post.imageUrl) {
            // ç¡®ä¿å›¾ç‰‡æ­£ç¡®æ˜¾ç¤ºï¼Œå¹¶æ·»åŠ å¯ç‚¹å‡»åŠŸèƒ½ï¼Œç‚¹å‡»æ˜¾ç¤ºå›¾ç‰‡æè¿°
            if (post.imageDescription) {
                // æ­£ç¡®è½¬ä¹‰å›¾ç‰‡æè¿°ï¼Œé¿å…JavaScriptè¯­æ³•é”™è¯¯
                const escapedDescription = post.imageDescription
                    .replace(/\\/g, '\\\\')  // è½¬ä¹‰åæ–œæ 
                    .replace(/'/g, "\\'")    // è½¬ä¹‰å•å¼•å·
                    .replace(/"/g, '\\"')    // è½¬ä¹‰åŒå¼•å·
                    .replace(/\n/g, '\\n')   // è½¬ä¹‰æ¢è¡Œç¬¦
                    .replace(/\r/g, '\\r')   // è½¬ä¹‰å›è½¦ç¬¦
                    .replace(/\t/g, '\\t');  // è½¬ä¹‰åˆ¶è¡¨ç¬¦
                contentHtml += `<div style="text-align:center;margin:10px 0;">
                    <img src="${post.imageUrl}" alt="å¾®åšå›¾ç‰‡" style="max-width:100%;border-radius:10px;display:inline-block;cursor:pointer;" onclick="window.showCustomAlert && window.showCustomAlert('å›¾ç‰‡è¯¦æƒ…', '${escapedDescription}')" />
                </div>`;
            } else {
                contentHtml += `<div style="text-align:center;margin:10px 0;">
                    <img src="${post.imageUrl}" alt="å¾®åšå›¾ç‰‡" style="max-width:100%;border-radius:10px;display:inline-block;" />
                </div>`;
            }
        }
        
        // æ˜¾ç¤ºè¯„è®º
        const comments = await db.weiboComments
            .where('postId')
            .equals(post.id)
            .reverse()
            .sortBy('timestamp');
            
        let commentsHtml = '';
        if (comments.length > 0) {
            commentsHtml = '<div style="background: #f8f9fa; border-radius: 8px; padding: 10px; margin-top: 10px;">';

            // æ£€æŸ¥æ˜¯å¦å±•å¼€æ‰€æœ‰è¯„è®º
            const postElement = document.querySelector(`[data-post-id="${post.id}"]`);
            const isExpanded = postElement && postElement.getAttribute('data-expanded') === 'true';
            const commentsToShow = isExpanded ? comments : comments.slice(0, 3);

            for (const comment of commentsToShow) {
                const commentAuthor = comment.authorId === 'user' ? 'æˆ‘' : 
                    (state.chats[comment.authorId] ? state.chats[comment.authorId].name : 'æœªçŸ¥ç”¨æˆ·');
                const commentAvatar = comment.authorId === 'user' ?
                    (userProfileCache.avatar || 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg') :
                    (state.chats[comment.authorId] ? state.chats[comment.authorId].settings.aiAvatar : 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg');
                
                // å¤„ç†è¯„è®ºå†…å®¹ï¼Œæ”¯æŒè¡¨æƒ…åŒ…æ˜¾ç¤º
                let commentContentHtml;

                if (comment.textContent && comment.stickers) {
                    // æ–‡å­— + è¡¨æƒ…åŒ…ç»„åˆ
                    commentContentHtml = `<div style="margin-bottom: 6px;">${comment.textContent}</div>`;
                    commentContentHtml += '<div style="display: flex; gap: 4px; flex-wrap: wrap;">';
                    comment.stickers.forEach(sticker => {
                        commentContentHtml += `<img src="${sticker.url}" alt="${sticker.name}" class="sticker-image" style="max-width:50px;max-height:50px;border-radius:6px;">`;
                    });
                    commentContentHtml += '</div>';
                } else if (comment.stickers && comment.stickers.length > 0) {
                    // ä»…è¡¨æƒ…åŒ…
                    commentContentHtml = '<div style="display: flex; gap: 4px; flex-wrap: wrap;">';
                    comment.stickers.forEach(sticker => {
                        commentContentHtml += `<img src="${sticker.url}" alt="${sticker.name}" class="sticker-image" style="max-width:60px;max-height:60px;border-radius:8px;">`;
                    });
                    commentContentHtml += '</div>';
                } else if (typeof comment.content === 'string' && STICKER_REGEX.test(comment.content)) {
                    // å•ä¸ªè¡¨æƒ…åŒ…ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
                    commentContentHtml = `<img src="${comment.content}" alt="${comment.meaning || 'Sticker'}" class="sticker-image" style="max-width:60px;max-height:60px;border-radius:8px;">`;
                } else if (Array.isArray(comment.content)) {
                    // å¤šæ¨¡æ€è¯„è®ºå¤„ç†
                    const textItems = comment.content.filter(item => item.type === 'text');
                    const imageItems = comment.content.filter(item => item.type === 'image_url');

                    let htmlParts = [];

                    // æ·»åŠ æ–‡å­—éƒ¨åˆ†
                    if (textItems.length > 0) {
                        const textContent = textItems.map(item => item.text).join(' ');
                        if (textContent.trim()) {
                            htmlParts.push(`<div style="margin-bottom: 6px;">${textContent}</div>`);
                        }
                    }

                    // æ·»åŠ å›¾ç‰‡éƒ¨åˆ†
                    if (imageItems.length > 0) {
                        let imagesHtml = '<div style="display: flex; gap: 4px; flex-wrap: wrap;">';
                        imageItems.forEach(item => {
                            imagesHtml += `<img src="${item.image_url.url}" alt="è¡¨æƒ…åŒ…" class="sticker-image" style="max-width:50px;max-height:50px;border-radius:6px;">`;
                        });
                        imagesHtml += '</div>';
                        htmlParts.push(imagesHtml);
                    }

                    commentContentHtml = htmlParts.join('') || 'å¤šåª’ä½“å†…å®¹';
                } else {
                    // æ™®é€šæ–‡å­—è¯„è®º
                    commentContentHtml = comment.content;
                }

                commentsHtml += `
                    <div style="display:flex;gap:8px;margin-bottom:8px;align-items:flex-start;" data-comment-id="${comment.id}">
                        <img src="${commentAvatar}" style="width:24px;height:24px;border-radius:50%;object-fit:cover;">
                        <div style="flex:1;">
                            <div style="font-size:12px;font-weight:500;margin-bottom:2px;">${commentAuthor}</div>
                            <div style="font-size:13px;line-height:1.4;">${commentContentHtml}</div>
                            <div style="display:flex;align-items:center;gap:10px;margin-top:4px;">
                                <span style="font-size:11px;color:var(--weibo-secondary);">${new Date(comment.timestamp).toLocaleString('zh-CN', {month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric'})}</span>
                                <span style="font-size:11px;color:var(--weibo-accent);cursor:pointer;" onclick="window.handleReplyCommentProxy && window.handleReplyCommentProxy(${post.id}, ${comment.id}, '${commentAuthor}')">å›å¤</span>
                            </div>`;
                
                // æ˜¾ç¤ºæ¥¼ä¸­æ¥¼å›å¤
                if (comment.replies && comment.replies.length > 0) {
                    commentsHtml += '<div style="margin-top:8px;padding-left:32px;">';

                    // æ£€æŸ¥æ˜¯å¦å±•å¼€è¯¥è¯„è®ºçš„æ‰€æœ‰å›å¤
                    const commentElement = document.querySelector(`[data-comment-id="${comment.id}"]`);
                    const isRepliesExpanded = commentElement && commentElement.getAttribute('data-replies-expanded') === 'true';
                    const repliesToShow = isRepliesExpanded ? comment.replies : comment.replies.slice(0, 7);

                    for (const reply of repliesToShow) {
                        const replyAuthor = reply.authorId === 'user' ? 'æˆ‘' : 
                            (state.chats[reply.authorId] ? state.chats[reply.authorId].name : 'æœªçŸ¥ç”¨æˆ·');
                        const replyToName = reply.replyTo || commentAuthor;
                        
                        // å¤„ç†æ¥¼ä¸­æ¥¼å›å¤å†…å®¹ï¼Œæ”¯æŒè¡¨æƒ…åŒ…æ˜¾ç¤º
                        let replyContentHtml;

                        if (reply.textContent && reply.stickers) {
                            // æ–‡å­— + è¡¨æƒ…åŒ…ç»„åˆ
                            replyContentHtml = `${reply.textContent} `;
                            reply.stickers.forEach(sticker => {
                                replyContentHtml += `<img src="${sticker.url}" alt="${sticker.name}" class="sticker-image" style="max-width:32px;max-height:32px;border-radius:4px;margin-left:4px;vertical-align:middle;">`;
                            });
                        } else if (reply.stickers && reply.stickers.length > 0) {
                            // ä»…è¡¨æƒ…åŒ…
                            replyContentHtml = '';
                            reply.stickers.forEach(sticker => {
                                replyContentHtml += `<img src="${sticker.url}" alt="${sticker.name}" class="sticker-image" style="max-width:36px;max-height:36px;border-radius:6px;margin-right:4px;">`;
                            });
                        } else if (typeof reply.content === 'string' && STICKER_REGEX.test(reply.content)) {
                            // å•ä¸ªè¡¨æƒ…åŒ…ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
                            replyContentHtml = `<img src="${reply.content}" alt="${reply.meaning || 'Sticker'}" class="sticker-image" style="max-width:36px;max-height:36px;border-radius:6px;">`;
                        } else if (Array.isArray(reply.content)) {
                            // å¤šæ¨¡æ€å›å¤å¤„ç†
                            const textItems = reply.content.filter(item => item.type === 'text');
                            const imageItems = reply.content.filter(item => item.type === 'image_url');

                            let htmlParts = [];

                            // æ·»åŠ æ–‡å­—éƒ¨åˆ†
                            if (textItems.length > 0) {
                                const textContent = textItems.map(item => item.text).join(' ');
                                if (textContent.trim()) {
                                    htmlParts.push(textContent);
                                }
                            }

                            // æ·»åŠ å›¾ç‰‡éƒ¨åˆ†
                            if (imageItems.length > 0) {
                                imageItems.forEach(item => {
                                    htmlParts.push(`<img src="${item.image_url.url}" alt="è¡¨æƒ…åŒ…" class="sticker-image" style="max-width:32px;max-height:32px;border-radius:4px;margin-left:4px;vertical-align:middle;">`);
                                });
                            }

                            replyContentHtml = htmlParts.join(' ') || 'å¤šåª’ä½“å†…å®¹';
                        } else {
                            // æ™®é€šæ–‡å­—å›å¤
                            replyContentHtml = reply.content;
                        }

                        commentsHtml += `
                            <div style="display:flex;gap:6px;margin-bottom:6px;font-size:12px;cursor:pointer;padding:4px;border-radius:8px;transition:background-color 0.2s;" onclick="window.handleReplyCommentProxy && window.handleReplyCommentProxy(${post.id}, ${comment.id}, '${replyAuthor}')" onmouseover="this.style.backgroundColor='#f0f2f5'" onmouseout="this.style.backgroundColor='transparent'">
                                <span style="color:var(--weibo-accent);font-weight:500;">${replyAuthor}</span>
                                <span style="color:var(--weibo-secondary);">å›å¤</span>
                                <span style="color:var(--weibo-accent);font-weight:500;">${replyToName}:</span>
                                <span style="flex:1;">${replyContentHtml}</span>
                            </div>
                        `;
                    }
                    if (comment.replies.length > 7 && !isRepliesExpanded) {
                        commentsHtml += `<div style="font-size:11px;color:var(--weibo-accent);margin-top:4px;cursor:pointer;" onclick="expandCommentReplies('${comment.id}')">æŸ¥çœ‹å…¨éƒ¨${comment.replies.length}æ¡å›å¤</div>`;
                    }
                    commentsHtml += '</div>';
                }
                
                commentsHtml += `
                        </div>
                    </div>
                `;
            }
            // åªæœ‰åœ¨æœªå±•å¼€ä¸”è¯„è®ºæ•°å¤§äº3æ—¶æ‰æ˜¾ç¤º"æŸ¥çœ‹å…¨éƒ¨"æŒ‰é’®
            if (comments.length > 3 && !isExpanded) {
                commentsHtml += `<div style="font-size:12px;color:var(--weibo-accent);text-align:center;margin-top:5px;cursor:pointer;padding:5px;" onclick="expandAllComments('${post.id}')">æŸ¥çœ‹å…¨éƒ¨${comments.length}æ¡è¯„è®º</div>`;
            }
            commentsHtml += '</div>';
        }
        
        postElement.innerHTML = `
            <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:12px;">
                <img class="post-avatar" src="${avatar}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;cursor:pointer;" onclick="window.showSocialProfileSafe && window.showSocialProfileSafe('${post.authorId}')">
                <div style="flex:1;">
                    <div style="font-weight:600;font-size:17px;margin-bottom:4px;">${nickname}</div>
                    <div style="font-size:13px;color:var(--weibo-secondary);line-height:1.4;">${signature || email}</div>
                </div>
                <div class="post-visibility" style="font-size:14px;color:var(--weibo-accent);font-weight:500;position:absolute;top:8px;right:8px;">
                    ${post.visibility === 'private' ? 'ğŸ‘ï¸â€ğŸ—¨ï¸' : 
                      post.visibility === 'friends' ? 'ğŸ«‚' : ''}
                </div>
            </div>
            <div class="post-content" style="margin:10px 0 18px 0;">${contentHtml}</div>
            ${commentsHtml}
            <div style="display:flex;align-items:center;justify-content:space-between;font-size:14px;color:var(--weibo-secondary);margin-top:8px;">
                <div style="display:flex;align-items:center;gap:18px;">
                    <span style="display:flex;align-items:center;gap:3px;cursor:pointer;${hasLiked?`color:var(--weibo-accent);font-weight:600;`:''}" onclick="window.handleLikeProxy && window.handleLikeProxy(${post.id})">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="${hasLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg> ${post.interactions?.likes || likesCount || ''}
                    </span>
                    <span style="display:flex;align-items:center;gap:3px;cursor:pointer;" onclick="window.handleCommentProxy && window.handleCommentProxy(${post.id})">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2z"></path></svg> ${post.interactions?.comments || commentsCount || ''}
                    </span>
                    <span style="display:flex;align-items:center;gap:3px;cursor:pointer;" onclick="window.handleRepostProxy && window.handleRepostProxy(${post.id})">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg> ${post.interactions?.reposts || repostsCount || ''}
                    </span>
                </div>
                <span style="font-size:12px;">${timestamp}</span>
            </div>
        `;
        
        // æ·»åŠ é•¿æŒ‰äº‹ä»¶ç›‘å¬å™¨ç”¨äºå¤šé€‰
        addLongPressListener(postElement, () => {
            if (!isWeiboSelectionMode) {
                enterWeiboSelectionMode();
            }
            toggleWeiboPostSelection(post.id);
        });
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        postElement.addEventListener('click', (e) => {
            if (isWeiboSelectionMode) {
                // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯äº’åŠ¨æŒ‰é’®
                if (!e.target.closest('.post-actions') && !e.target.closest('svg') && !e.target.closest('span[onclick]') && !e.target.closest('[onclick]')) {
                    toggleWeiboPostSelection(post.id);
                }
            }
        });
        
        timeline.appendChild(postElement);
    }
}
// å‘å¸ƒæ–°å¾®åš
async function publishPost(content, visibility, imageUrl = null) {
    try {
        // è·å–ç”¨æˆ·èµ„æ–™
        const savedProfileData = await db.userProfiles.get('weibo_user_profile');
        const profile = savedProfileData ? savedProfileData.data : {};
        
        const post = {
            id: Date.now(),
            authorId: 'user',
            authorName: profile.name || 'æˆ‘',
            authorAvatar: profile.avatar || defaultAvatar,
            authorEmail: profile.email || '',
            authorSignature: profile.signature || '',
            content,
            visibility,
            timestamp: Date.now(),
            // æ·»åŠ åˆå§‹çš„äº’åŠ¨æ•°æ®
            interactions: {
                likes: Math.floor(Math.random() * 20 + 5),
                comments: Math.floor(Math.random() * 10 + 2),
                reposts: Math.floor(Math.random() * 5 + 1)
            }
        };
        
        // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ åˆ°postå¯¹è±¡ä¸­
        if (imageUrl) {
            post.imageUrl = imageUrl;
            // å°†æ–‡å­—å†…å®¹ä¿å­˜ä¸ºdescriptionå­—æ®µï¼Œä¾¿äºæ¸²æŸ“æ—¶åŒºåˆ†
            if (post.content && post.content.trim()) {
                post.description = post.content;
                post.content = ''; // æ¸…ç©ºcontentï¼Œä½¿ç”¨description
            }
            
            // å›¾ç‰‡ç±»å†…å®¹é€šå¸¸è·å¾—æ›´å¤šäº’åŠ¨
            post.interactions.likes += Math.floor(Math.random() * 15 + 10);
            post.interactions.comments += Math.floor(Math.random() * 5 + 3);
            post.interactions.reposts += Math.floor(Math.random() * 3 + 1);
        }
        
        // æ ¹æ®å¯è§æ€§è°ƒæ•´äº’åŠ¨æ•°é‡
        if (visibility === 'private') {
            // ç§å¯†åŠ¨æ€æ²¡æœ‰äº’åŠ¨
            post.interactions.likes = 0;
            post.interactions.comments = 0;
            post.interactions.reposts = 0;
        } else if (visibility === 'friends') {
            // ä»…å¥½å‹å¯è§çš„åŠ¨æ€äº’åŠ¨è¾ƒå°‘
            post.interactions.likes = Math.floor(post.interactions.likes * 0.6);
            post.interactions.comments = Math.floor(post.interactions.comments * 0.5);
            post.interactions.reposts = Math.floor(post.interactions.reposts * 0.3);
        }
        
        await db.weiboPosts.add(post);
        
        // è·å–å½“å‰æ¿€æ´»çš„å¯¼èˆªé¡¹ï¼Œç¡®å®šåº”è¯¥æ¸²æŸ“å“ªä¸ªè§†å›¾
        const activeNavItem = document.querySelector('.weibo-nav .nav-item.active');
        const currentFilter = activeNavItem && activeNavItem.textContent === 'â‚^Ë¶ â•¸ğ–¥¦  â•¸Ëµ^â‚âŸ†' ? 'mine' : 'all';
        
        await renderWeiboTimeline(currentFilter);
        
        // è§¦å‘AIè§’è‰²çš„äº’åŠ¨
        triggerAiInteraction(post);
        
        return true; // å‘å¸ƒæˆåŠŸ
    } catch (error) {
        console.error('å‘å¸ƒå¾®åšå¤±è´¥:', error);
        throw error; // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©è°ƒç”¨è€…å¤„ç†
    }
}

// å¤„ç†ç‚¹èµ
        async function handleLike(postId) {
            const existingLike = await db.weiboLikes
                .where('[postId+authorId]')
                .equals([postId, 'user'])
                .first();
                
            const post = await db.weiboPosts.get(postId);
            if (!post) return;
            
            // ç¡®ä¿interactionså¯¹è±¡å­˜åœ¨
            if (!post.interactions) {
                post.interactions = {
                    likes: 0,
                    comments: 0,
                    reposts: 0
                };
            }
                
            if (existingLike) {
                await db.weiboLikes.delete([postId, 'user']);
                
                // å‡å°‘ç‚¹èµæ•°
                if (post.interactions.likes > 0) {
                    post.interactions.likes--;
                }
            } else {
                await db.weiboLikes.add({
                    postId,
                    authorId: 'user',
                    timestamp: Date.now()
                });
                
                // å¢åŠ ç‚¹èµæ•°
                post.interactions.likes++;
                
                // è§¦å‘AIå›åº”
                if (post.authorId !== 'user') {
                    triggerAiResponse(post.authorId, 'like', post);
                }
            }
            
            // æ›´æ–°å¸–å­çš„äº’åŠ¨æ•°æ®
            await db.weiboPosts.put(post);
            
            await renderWeiboTimeline();
        }

// æ˜¾ç¤ºå¾®åšè¯„è®ºè¡¨æƒ…åŒ…é€‰æ‹©å™¨
async function showWeiboStickerSelector(title = 'å‘è¡¨è¯„è®º') {
    return new Promise((resolve) => {
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.className = 'modal visible';
        modal.style.zIndex = '1000';
        modal.innerHTML = `
            <div class="modal-content" style="width: 90%; max-width: 420px; max-height: 85vh; border-radius: 16px; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                <div class="modal-header" style="padding: 16px 20px; border-bottom: 1px solid rgba(0, 0, 0, 0.08); border-radius: 16px 16px 0 0;">
                    <span style="font-weight: 600; color: #333;">${title}</span>
                    <span style="cursor: pointer; font-size: 18px; color: #666; padding: 4px; border-radius: 50%; transition: all 0.2s;" onclick="this.closest('.modal').remove();" onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='transparent'">&times;</span>
                </div>
                <div class="modal-body" style="padding: 16px 20px;">
                    <!-- æ–‡å­—è¾“å…¥åŒºåŸŸ -->
                    <div style="margin-bottom: 16px;">
                        <textarea id="weibo-comment-text" placeholder="è¾“å…¥è¯„è®ºå†…å®¹..." style="width: 100%; height: 80px; padding: 12px; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 12px; resize: vertical; box-sizing: border-box; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); font-size: 14px; line-height: 1.4; transition: all 0.2s;" onfocus="this.style.borderColor='var(--weibo-accent)'; this.style.boxShadow='0 0 0 2px rgba(255, 105, 180, 0.1)'" onblur="this.style.borderColor='rgba(0, 0, 0, 0.1)'; this.style.boxShadow='none'"></textarea>
                    </div>

                    <!-- è¡¨æƒ…åŒ…é€‰æ‹©åŒºåŸŸ -->
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span style="font-size: 14px; font-weight: 500; color: #666;">é€‰æ‹©è¡¨æƒ…åŒ…</span>
                            <div style="flex: 1; height: 1px; background: linear-gradient(to right, rgba(0,0,0,0.1), transparent);"></div>
                        </div>
                        <div id="weibo-sticker-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto; padding: 8px; background: rgba(248, 249, 250, 0.8); border-radius: 12px; backdrop-filter: blur(10px);">
                            ${state.userStickers.length === 0 ? '<p style="text-align: center; color: #999; grid-column: 1 / -1; margin: 20px 0; font-size: 13px;">æš‚æ— è¡¨æƒ…åŒ…ï¼Œè¯·å…ˆåœ¨èŠå¤©ç•Œé¢æ·»åŠ è¡¨æƒ…åŒ…</p>' : ''}
                        </div>
                    </div>

                    <!-- å·²é€‰æ‹©çš„è¡¨æƒ…åŒ…é¢„è§ˆ -->
                    <div id="selected-stickers-preview" style="display: none; margin-bottom: 16px; padding: 12px; background: rgba(255, 105, 180, 0.05); border: 1px solid rgba(255, 105, 180, 0.2); border-radius: 12px;">
                        <div style="font-size: 13px; color: var(--weibo-accent); margin-bottom: 8px; font-weight: 500;">å·²é€‰æ‹©çš„è¡¨æƒ…åŒ…ï¼š</div>
                        <div id="selected-stickers-container" style="display: flex; gap: 6px; flex-wrap: wrap;"></div>
                    </div>

                    <!-- å‘é€æŒ‰é’® -->
                    <button id="weibo-send-comment-btn" style="width: 100%; padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 15px; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); transition: all 0.3s; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">å‘é€è¯„è®º</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // æ ¹æ®ä¸»é¢˜è®¾ç½®å‘é€æŒ‰é’®æ ·å¼
        const sendBtn = modal.querySelector('#weibo-send-comment-btn');
        const currentTheme = document.body.getAttribute('data-theme');

        if (currentTheme === 'cute') {
            // å¯çˆ±ä¸»é¢˜ - é›¾éœ¾ç²‰
            sendBtn.style.background = 'linear-gradient(135deg, rgba(248, 187, 208, 0.9), rgba(255, 182, 193, 0.9))';
            sendBtn.style.border = '1px solid rgba(248, 187, 208, 0.3)';
            sendBtn.style.boxShadow = '0 4px 12px rgba(248, 187, 208, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2)';
            sendBtn.onmouseover = () => {
                sendBtn.style.transform = 'translateY(-1px)';
                sendBtn.style.boxShadow = '0 6px 16px rgba(248, 187, 208, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
            };
            sendBtn.onmouseout = () => {
                sendBtn.style.transform = 'translateY(0)';
                sendBtn.style.boxShadow = '0 4px 12px rgba(248, 187, 208, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2)';
            };
        } else {
            // ç»å…¸ä¸»é¢˜ - é›¾éœ¾è“
            sendBtn.style.background = 'linear-gradient(135deg, rgba(74, 132, 193, 0.9), rgba(100, 149, 237, 0.9))';
            sendBtn.style.border = '1px solid rgba(74, 132, 193, 0.3)';
            sendBtn.style.boxShadow = '0 4px 12px rgba(74, 132, 193, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2)';
            sendBtn.onmouseover = () => {
                sendBtn.style.transform = 'translateY(-1px)';
                sendBtn.style.boxShadow = '0 6px 16px rgba(74, 132, 193, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
            };
            sendBtn.onmouseout = () => {
                sendBtn.style.transform = 'translateY(0)';
                sendBtn.style.boxShadow = '0 4px 12px rgba(74, 132, 193, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2)';
            };
        }

        // å­˜å‚¨é€‰ä¸­çš„è¡¨æƒ…åŒ…
        let selectedStickers = [];

        // æ¸²æŸ“è¡¨æƒ…åŒ…
        const stickerGrid = modal.querySelector('#weibo-sticker-grid');
        const selectedPreview = modal.querySelector('#selected-stickers-preview');
        const selectedContainer = modal.querySelector('#selected-stickers-container');

        function updateSelectedPreview() {
            if (selectedStickers.length > 0) {
                selectedPreview.style.display = 'block';
                selectedContainer.innerHTML = '';
                selectedStickers.forEach((sticker, index) => {
                    const preview = document.createElement('div');
                    preview.style.cssText = 'position: relative; width: 32px; height: 32px; background-size: contain; background-repeat: no-repeat; background-position: center; border-radius: 6px; border: 1px solid rgba(255, 105, 180, 0.3);';
                    preview.style.backgroundImage = `url(${sticker.url})`;
                    preview.title = sticker.name;

                    // æ·»åŠ åˆ é™¤æŒ‰é’®
                    const removeBtn = document.createElement('div');
                    removeBtn.style.cssText = 'position: absolute; top: -4px; right: -4px; width: 16px; height: 16px; background: #ff4757; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; font-weight: bold;';
                    removeBtn.innerHTML = 'Ã—';
                    removeBtn.onclick = () => {
                        selectedStickers.splice(index, 1);
                        updateSelectedPreview();
                        // æ›´æ–°è¡¨æƒ…åŒ…ç½‘æ ¼ä¸­çš„é€‰ä¸­çŠ¶æ€
                        const stickerItems = stickerGrid.querySelectorAll('.sticker-item');
                        stickerItems.forEach(item => {
                            if (item.dataset.stickerUrl === sticker.url) {
                                item.style.borderColor = 'transparent';
                                item.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                            }
                        });
                    };

                    preview.appendChild(removeBtn);
                    selectedContainer.appendChild(preview);
                });
            } else {
                selectedPreview.style.display = 'none';
            }
        }

        state.userStickers.forEach(sticker => {
            const item = document.createElement('div');
            item.className = 'sticker-item';
            item.dataset.stickerUrl = sticker.url;
            item.style.cssText = 'aspect-ratio: 1; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s; background-color: rgba(255, 255, 255, 0.8);';
            item.style.backgroundImage = `url(${sticker.url})`;
            item.title = sticker.name;

            item.onclick = () => {
                const isSelected = selectedStickers.some(s => s.url === sticker.url);
                if (isSelected) {
                    // å–æ¶ˆé€‰æ‹©
                    selectedStickers = selectedStickers.filter(s => s.url !== sticker.url);
                    item.style.borderColor = 'transparent';
                    item.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                } else {
                    // é€‰æ‹©è¡¨æƒ…åŒ…
                    selectedStickers.push(sticker);
                    item.style.borderColor = 'var(--weibo-accent)';
                    item.style.backgroundColor = 'rgba(255, 105, 180, 0.1)';
                }
                updateSelectedPreview();
            };

            item.onmouseover = () => {
                if (!selectedStickers.some(s => s.url === sticker.url)) {
                    item.style.borderColor = 'rgba(255, 105, 180, 0.5)';
                }
            };
            item.onmouseout = () => {
                if (!selectedStickers.some(s => s.url === sticker.url)) {
                    item.style.borderColor = 'transparent';
                }
            };

            stickerGrid.appendChild(item);
        });

        // å‘é€è¯„è®ºæŒ‰é’®äº‹ä»¶
        modal.querySelector('#weibo-send-comment-btn').onclick = () => {
            const text = modal.querySelector('#weibo-comment-text').value.trim();

            if (!text && selectedStickers.length === 0) {
                // æ²¡æœ‰å†…å®¹ï¼Œæç¤ºç”¨æˆ·
                modal.querySelector('#weibo-comment-text').style.borderColor = '#ff4757';
                modal.querySelector('#weibo-comment-text').placeholder = 'è¯·è¾“å…¥è¯„è®ºå†…å®¹æˆ–é€‰æ‹©è¡¨æƒ…åŒ…';
                setTimeout(() => {
                    modal.querySelector('#weibo-comment-text').style.borderColor = 'rgba(0, 0, 0, 0.1)';
                    modal.querySelector('#weibo-comment-text').placeholder = 'è¾“å…¥è¯„è®ºå†…å®¹...';
                }, 2000);
                return;
            }

            modal.remove();

            // æ„å»ºè¿”å›å†…å®¹
            if (text && selectedStickers.length > 0) {
                // æ–‡å­— + è¡¨æƒ…åŒ…ç»„åˆ
                const content = [
                    { type: 'text', text: text }
                ];

                // æ·»åŠ æ‰€æœ‰é€‰ä¸­çš„è¡¨æƒ…åŒ…
                selectedStickers.forEach(sticker => {
                    content.push({
                        type: 'image_url',
                        image_url: { url: sticker.url }
                    });
                });

                resolve({
                    type: 'mixed',
                    content: content,
                    textContent: text,
                    stickers: selectedStickers
                });
            } else if (selectedStickers.length > 0) {
                // ä»…è¡¨æƒ…åŒ…
                const content = [];
                selectedStickers.forEach(sticker => {
                    content.push({
                        type: 'image_url',
                        image_url: { url: sticker.url }
                    });
                });

                resolve({
                    type: 'stickers',
                    content: content,
                    stickers: selectedStickers
                });
            } else {
                // ä»…æ–‡å­—
                resolve({
                    type: 'text',
                    content: text
                });
            }
        };

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        modal.onclick = (e) => {
            if (e.target === modal) {
                modal.remove();
                resolve(null);
            }
        };
    });
}

// å¤„ç†è¯„è®º
async function handleComment(postId) {
    const result = await showWeiboStickerSelector('å‘è¡¨è¯„è®º');
    if (!result) return;

    const commentId = Date.now();
    const commentData = {
        id: commentId,
        postId,
        authorId: 'user',
        timestamp: Date.now(),
        replies: [] // åˆå§‹åŒ–å›å¤æ•°ç»„
    };

    // æ ¹æ®ç±»å‹è®¾ç½®å†…å®¹
    if (result.type === 'mixed') {
        // æ–‡å­— + è¡¨æƒ…åŒ…ç»„åˆ
        commentData.content = result.content;
        commentData.textContent = result.textContent;
        commentData.stickers = result.stickers;
    } else if (result.type === 'stickers') {
        // ä»…è¡¨æƒ…åŒ…
        commentData.content = result.content;
        commentData.stickers = result.stickers;
    } else if (result.type === 'sticker') {
        // å•ä¸ªè¡¨æƒ…åŒ…ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
        commentData.content = result.content;
        commentData.meaning = result.meaning;
    } else {
        // ä»…æ–‡å­—
        commentData.content = result.content;
    }

    await db.weiboComments.add(commentData);
    
    // æ›´æ–°å¸–å­çš„è¯„è®ºè®¡æ•°
    const post = await db.weiboPosts.get(postId);
    if (post) {
        // ç¡®ä¿interactionså¯¹è±¡å­˜åœ¨
        if (!post.interactions) {
            post.interactions = {
                likes: 0,
                comments: 0,
                reposts: 0
            };
        }
        
        // å¢åŠ è¯„è®ºæ•°
        post.interactions.comments++;
        await db.weiboPosts.put(post);
        
        // è§¦å‘AIå›åº”
        if (post.authorId !== 'user') {
            // AIå¯èƒ½ä¼šç›´æ¥å›å¤è¿™æ¡è¯„è®º
            setTimeout(async () => {
                await triggerAiReplyToComment(post.authorId, postId, commentId, commentData);
            }, Math.random() * 3000 + 1000);
        }
    }
    
    await renderWeiboTimeline();
}

// å¤„ç†æ¥¼ä¸­æ¥¼å›å¤
async function handleReplyComment(postId, commentId, replyToName) {
    const result = await showWeiboStickerSelector(`å›å¤ ${replyToName}`);
    if (!result) return;

    // è·å–åŸè¯„è®º
    const comment = await db.weiboComments.get(commentId);
    if (!comment) return;

    // æ·»åŠ å›å¤åˆ°è¯„è®ºçš„repliesæ•°ç»„
    if (!comment.replies) comment.replies = [];

    // æ£€æŸ¥æ¥¼ä¸­æ¥¼å›å¤æ•°é‡
    if (comment.replies.length >= 7) {
        showToast('è¯¥è¯„è®ºçš„å›å¤å·²è¾¾ä¸Šé™ï¼ˆ7æ¡ï¼‰', 'error');
        return;
    }

    const reply = {
        id: Date.now(),
        authorId: 'user',
        timestamp: Date.now(),
        replyTo: replyToName
    };

    // æ ¹æ®ç±»å‹è®¾ç½®å†…å®¹
    if (result.type === 'mixed') {
        // æ–‡å­— + è¡¨æƒ…åŒ…ç»„åˆ
        reply.content = result.content;
        reply.textContent = result.textContent;
        reply.stickers = result.stickers;
    } else if (result.type === 'stickers') {
        // ä»…è¡¨æƒ…åŒ…
        reply.content = result.content;
        reply.stickers = result.stickers;
    } else if (result.type === 'sticker') {
        // å•ä¸ªè¡¨æƒ…åŒ…ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
        reply.content = result.content;
        reply.meaning = result.meaning;
    } else {
        // ä»…æ–‡å­—
        reply.content = result.content;
    }
    
    comment.replies.push(reply);
    await db.weiboComments.put(comment);
    
    // è§¦å‘AIå›åº”
    const post = await db.weiboPosts.get(postId);
    if (post) {
        // å¦‚æœå›å¤çš„æ˜¯AIçš„è¯„è®ºï¼ŒAIä¼šç»§ç»­å›å¤
        if (comment.authorId !== 'user') {
            setTimeout(async () => {
                await triggerAiReplyInThread(comment.authorId, postId, commentId, content, 'æˆ‘');
            }, Math.random() * 2000 + 1000);
        }
        // å¦‚æœæ˜¯åœ¨ç”¨æˆ·çš„åŠ¨æ€ä¸‹ï¼Œå…¶ä»–AIä¹Ÿå¯èƒ½å‚ä¸è®¨è®º
        else if (post.authorId === 'user') {
            // éšæœºé€‰æ‹©ä¸€ä¸ªAIå‚ä¸æ¥¼ä¸­æ¥¼è®¨è®º
            const aiChats = Object.entries(state.chats).filter(([id, chat]) => !chat.isGroup);
            if (aiChats.length > 0 && Math.random() < 0.3) {
                const [aiId] = aiChats[Math.floor(Math.random() * aiChats.length)];
                setTimeout(async () => {
                    await triggerAiReplyInThread(aiId, postId, commentId, content, 'æˆ‘');
                }, Math.random() * 3000 + 2000);
            }
        }
    }
    
    await renderWeiboTimeline();
}

// å±•å¼€æ‰€æœ‰è¯„è®º
async function expandAllComments(postId) {
    // é‡æ–°æ¸²æŸ“è¯¥å¸–å­ï¼Œæ˜¾ç¤ºæ‰€æœ‰è¯„è®º
    const postElement = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postElement) return;

    // æ ‡è®°è¯¥å¸–å­ä¸ºå±•å¼€çŠ¶æ€
    postElement.setAttribute('data-expanded', 'true');

    // é‡æ–°æ¸²æŸ“æ•´ä¸ªæ—¶é—´çº¿ä»¥æ›´æ–°æ˜¾ç¤º
    await renderWeiboTimeline();
}

// å±•å¼€è¯„è®ºçš„æ‰€æœ‰å›å¤
async function expandCommentReplies(commentId) {
    // æ ‡è®°è¯¥è¯„è®ºçš„å›å¤ä¸ºå±•å¼€çŠ¶æ€
    const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
    if (!commentElement) return;

    commentElement.setAttribute('data-replies-expanded', 'true');

    // é‡æ–°æ¸²æŸ“æ•´ä¸ªæ—¶é—´çº¿ä»¥æ›´æ–°æ˜¾ç¤º
    await renderWeiboTimeline();
}

// AIå›å¤è¯„è®ºï¼ˆæ¥¼ä¸­æ¥¼ï¼‰
async function triggerAiReplyToComment(aiId, postId, commentId, userCommentData) {
    const ai = state.chats[aiId];
    if (!ai) return;

    try {
        // æ„å»ºè¯„è®ºå†…å®¹ç”¨äºAIç†è§£
        let commentContent;

        if (typeof userCommentData === 'object' && userCommentData !== null) {
            // æ–°æ ¼å¼ï¼šä¼ å…¥çš„æ˜¯å®Œæ•´çš„è¯„è®ºæ•°æ®å¯¹è±¡
            if (userCommentData.textContent || userCommentData.stickers) {
                commentContent = {
                    textContent: userCommentData.textContent || '',
                    stickers: userCommentData.stickers || []
                };
            } else if (typeof userCommentData.content === 'string') {
                commentContent = userCommentData.content;
            } else {
                commentContent = 'ç”¨æˆ·å‘è¡¨äº†è¯„è®º';
            }
        } else {
            // æ—§æ ¼å¼ï¼šä¼ å…¥çš„æ˜¯å­—ç¬¦ä¸²
            commentContent = userCommentData || 'ç”¨æˆ·å‘è¡¨äº†è¯„è®º';
        }

        // è·å–AIçš„å›å¤å†…å®¹
        const post = await db.weiboPosts.get(postId);
        const response = await generateAiResponse(ai, 'comment_reply', post, commentContent, 'æˆ‘');
        
        if (response) {
            // å°†AIçš„å›å¤æ·»åŠ åˆ°è¯„è®ºçš„repliesä¸­
            const comment = await db.weiboComments.get(commentId);
            if (comment) {
                if (!comment.replies) comment.replies = [];

                if (comment.replies.length < 7) {
                    const replyData = {
                        id: Date.now(),
                        authorId: aiId,
                        timestamp: Date.now(),
                        replyTo: 'æˆ‘'
                    };

                    // å¤„ç†è¡¨æƒ…åŒ…æ ¼å¼çš„å›å¤
                    if (typeof response === 'object' && response.type === 'sticker') {
                        replyData.content = response.content;
                        replyData.meaning = response.meaning;
                    } else {
                        // æ›¿æ¢ç”¨æˆ·å ä½ç¬¦
                        const userName = userProfileCache.name || 'æˆ‘çš„å¾®åš';
                        let processedResponse = response.replace(/@\{\{user\}\}/g, `@${userName}`);
                        processedResponse = processedResponse.replace(/\{\{user\}\}/g, userName);
                        replyData.content = processedResponse;
                    }

                    comment.replies.push(replyData);

                    await db.weiboComments.put(comment);
                    await renderWeiboTimeline();

                    // æ˜¾ç¤ºé€šçŸ¥
                    showNotification(aiId, `å›å¤äº†ä½ çš„è¯„è®º`, 'weibo');
                }
            }
        }
    } catch (error) {
        console.error('AIå›å¤è¯„è®ºå¤±è´¥:', error);
    }
}

// AIåœ¨æ¥¼ä¸­æ¥¼ä¸­ç»§ç»­å›å¤
async function triggerAiReplyInThread(aiId, postId, commentId, userReply, userName) {
    const ai = state.chats[aiId];
    if (!ai) return;
    
    try {
        const comment = await db.weiboComments.get(commentId);
        if (!comment || !comment.replies || comment.replies.length >= 7) return;
        
        // è·å–è®¨è®ºä¸Šä¸‹æ–‡
        const post = await db.weiboPosts.get(postId);
        const threadContext = comment.replies.map(r => `${r.authorId === 'user' ? 'æˆ‘' : state.chats[r.authorId]?.name || 'æœªçŸ¥'}: ${r.content}`).join('\n');
        
        const fullContext = `åŸåŠ¨æ€ï¼š${post.content}\nä¸»è¯„è®ºï¼š${comment.content}\næ¥¼ä¸­æ¥¼è®¨è®ºï¼š\n${threadContext}\nç”¨æˆ·æœ€æ–°å›å¤ï¼š${userReply}`;
        
        let response = await generateAiResponse(ai, 'thread_reply', post, fullContext, userName);

        if (response) {
            // æ›¿æ¢ç”¨æˆ·å ä½ç¬¦ï¼ˆè™½ç„¶generateAiResponseå·²ç»å¤„ç†äº†ï¼Œä½†ä¸ºäº†ä¿é™©èµ·è§å†å¤„ç†ä¸€æ¬¡ï¼‰
            const userNameForReplace = userProfileCache.name || 'æˆ‘çš„å¾®åš';
            if (typeof response === 'string') {
                response = response.replace(/@\{\{user\}\}/g, `@${userNameForReplace}`);
                response = response.replace(/\{\{user\}\}/g, userNameForReplace);
            }

            comment.replies.push({
                id: Date.now(),
                authorId: aiId,
                content: response,
                timestamp: Date.now(),
                replyTo: userName
            });
            
            await db.weiboComments.put(comment);
            await renderWeiboTimeline();
            
            // æ˜¾ç¤ºé€šçŸ¥
            showNotification(aiId, `å›å¤äº†ä½ `, 'weibo');
        }
    } catch (error) {
        console.error('AIæ¥¼ä¸­æ¥¼å›å¤å¤±è´¥:', error);
    }
}

// å¤„ç†è½¬å‘
async function handleRepost(postId) {
    const content = await showCustomPrompt('è½¬å‘åŠ¨æ€', 'è¯·è¾“å…¥è½¬å‘è¯„è®º(å¯é€‰)');
    if (content === null) return;
    
    // è·å–åŸåŠ¨æ€
    const originalPost = await db.weiboPosts.get(postId);
    if (!originalPost) {
        showToast('åŸåŠ¨æ€ä¸å­˜åœ¨', 'error');
        return;
    }
    
    // åˆ›å»ºè½¬å‘åŠ¨æ€
    const repostPost = {
        id: Date.now(),
        authorId: 'user',
        authorName: userProfileCache.name || 'æˆ‘',
        authorAvatar: userProfileCache.avatar || defaultAvatar,
        authorEmail: userProfileCache.email || '',
        authorSignature: userProfileCache.signature || '',
        content: content || '',
        visibility: 'public',
        timestamp: Date.now(),
        isRepost: true,
        originalPostId: postId,
        // æ·»åŠ åˆå§‹çš„äº’åŠ¨æ•°æ®
        interactions: {
            likes: Math.floor(Math.random() * 10 + 2),
            comments: Math.floor(Math.random() * 5 + 1),
            reposts: Math.floor(Math.random() * 3)
        }
    };
    
    await db.weiboPosts.add(repostPost);
    
    // æ·»åŠ è½¬å‘è®°å½•
    await db.weiboReposts.add({
        id: Date.now(),
        originalPostId: postId,
        authorId: 'user',
        content: content || '',
        timestamp: Date.now()
    });
    
    // æ›´æ–°åŸå¸–å­çš„è½¬å‘è®¡æ•°
    if (!originalPost.interactions) {
        originalPost.interactions = {
            likes: 0,
            comments: 0,
            reposts: 0
        };
    }
    
    // å¢åŠ è½¬å‘æ•°
    originalPost.interactions.reposts++;
    await db.weiboPosts.put(originalPost);
    
    // è§¦å‘AIå›åº”
    if (originalPost.authorId !== 'user') {
        triggerAiResponse(originalPost.authorId, 'repost', originalPost, content);
    }
    
    await renderWeiboTimeline();
    showToast('è½¬å‘æˆåŠŸï¼', 'success');
}
// AIè§’è‰²è‡ªåŠ¨å‘å¸ƒåŠ¨æ€
function scheduleAiPosts(aiId, frequency) {
    const posts = {
        low: [1, 2],
        medium: [3, 4], 
        high: [5, 6]
    };
    
    const [min, max] = posts[frequency];
    const count = Math.floor(Math.random() * (max - min + 1)) + min;
    
    // ç”Ÿæˆä»Šå¤©çš„å‘å¸ƒæ—¶é—´ç‚¹
    const times = [];
    for (let i = 0; i < count; i++) {
        const hours = Math.floor(Math.random() * 24);
        const minutes = Math.floor(Math.random() * 60);
        times.push(`${hours}:${String(minutes).padStart(2, '0')}`);
    }
    
    return times;
}

// å…¨å±€å®šæ—¶å™¨ç®¡ç†
let aiPostingTimers = new Map();

// åˆå§‹åŒ–AIè‡ªåŠ¨å‘å¸ƒç³»ç»Ÿ
async function initAiPostingSystem() {
    // æ¸…é™¤æ‰€æœ‰ç°æœ‰å®šæ—¶å™¨
    clearAllAiPostingTimers();
    
    let enabledCount = 0;
    // ä¸ºæ¯ä¸ªå¯ç”¨äº†å¾®åšåŠŸèƒ½çš„AIè§’è‰²è®¾ç½®å®šæ—¶å™¨
    for (const [chatId, chat] of Object.entries(state.chats)) {
        if (chat.settings.weiboEnabled && !chat.isGroup) {
            await setupAiPostingTimer(chatId, chat);
            enabledCount++;
        }
    }
    
    console.log(`AIè‡ªåŠ¨å‘å¸ƒç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œå…± ${enabledCount} ä¸ªè§’è‰²å¯ç”¨å¾®åšåŠŸèƒ½`);
    
    // è®¾ç½®æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ—¶é—´
    setInterval(checkAiPostingTimes, 60000);
    
    // åˆå§‹åŒ–åå°äº’åŠ¨ç³»ç»Ÿ
    initBackgroundInteractionSystem();
}

// åå°äº’åŠ¨ç³»ç»Ÿ
function initBackgroundInteractionSystem() {
    // æ¸…é™¤ç°æœ‰çš„å®šæ—¶å™¨
    if (window.backgroundTimers) {
        Object.values(window.backgroundTimers).forEach(timer => {
            if (timer.chatTimer) clearInterval(timer.chatTimer);
            if (timer.weiboTimer) clearInterval(timer.weiboTimer);
        });
    }
    window.backgroundTimers = {};
    
    // ä¸ºæ¯ä¸ªAIè§’è‰²è®¾ç½®ç‹¬ç«‹çš„å®šæ—¶å™¨
    for (const [chatId, chat] of Object.entries(state.chats)) {
        if (chat.isGroup) continue;
        
        window.backgroundTimers[chatId] = {};
        
        // è®¾ç½®ä¸»åŠ¨èŠå¤©å®šæ—¶å™¨
        if (chat.settings.backgroundInteractionEnabled && chat.settings.backgroundChatEnabled) {
            const chatInterval = getBackgroundInterval(chat.settings.backgroundChatFrequency || 'low');
            window.backgroundTimers[chatId].chatTimer = setInterval(async () => {
                await triggerRandomChatMessage(chatId, chat);
            }, chatInterval);
        }
        
        // è®¾ç½®ä¸»åŠ¨å‘å¾®åšå®šæ—¶å™¨ï¼ˆä¸ºæ¯ä¸ªè§’è‰²å•ç‹¬è®¾ç½®ï¼‰
        if (chat.settings.backgroundInteractionEnabled && chat.settings.backgroundWeiboEnabled && chat.settings.weiboEnabled) {
            const weiboInterval = getBackgroundInterval(chat.settings.backgroundWeiboFrequency || 'low');
            window.backgroundTimers[chatId].weiboTimer = setInterval(async () => {
                // é¿å…é‡å¤å‘å¸ƒï¼šå¦‚æœå·²æœ‰åŸºäºæ—¶é—´ç‚¹çš„å‘å¸ƒç³»ç»Ÿï¼Œåˆ™è·³è¿‡åå°å‘å¸ƒ
                if (chat.settings.weiboPostingTimes && chat.settings.weiboPostingTimes.length > 0) {
                    console.log(`${chat.name} è·³è¿‡åå°å‘å¸ƒï¼šå·²å¯ç”¨æ—¶é—´ç‚¹å‘å¸ƒç³»ç»Ÿ`);
                    return;
                }
                await triggerRandomWeiboPost(chatId, chat);
            }, weiboInterval);
        }
    }
}

// è·å–åå°äº’åŠ¨é—´éš”æ—¶é—´
function getBackgroundInterval(frequency) {
    switch (frequency) {
        case 'low':
            return Math.random() * 1800000 + 3600000; // 1-2å°æ—¶
        case 'medium':
            return Math.random() * 900000 + 1800000; // 30åˆ†é’Ÿ-1å°æ—¶
        case 'high':
            return Math.random() * 600000 + 900000; // 10-15åˆ†é’Ÿ
        default:
            return Math.random() * 1800000 + 3600000; // é»˜è®¤1-2å°æ—¶
    }
}

// è§¦å‘éšæœºåå°äº’åŠ¨
async function triggerRandomBackgroundInteraction() {
    try {
        // éšæœºé€‰æ‹©ä¸€ä¸ªAIè§’è‰²
        const aiChats = Object.entries(state.chats).filter(([id, chat]) => !chat.isGroup);
        if (aiChats.length === 0) return;
        
        const [chatId, chat] = aiChats[Math.floor(Math.random() * aiChats.length)];
        
        // éšæœºé€‰æ‹©äº’åŠ¨ç±»å‹
        const interactionTypes = ['chat', 'weibo'];
        const randomType = interactionTypes[Math.floor(Math.random() * interactionTypes.length)];
        
        if (randomType === 'chat') {
            // ä¸»åŠ¨å‘é€èŠå¤©æ¶ˆæ¯
            await triggerRandomChatMessage(chatId, chat);
        } else if (randomType === 'weibo') {
            // ä¸»åŠ¨å‘å¸ƒå¾®åšåŠ¨æ€
            await triggerRandomWeiboPost(chatId, chat);
        }
    } catch (error) {
        console.error('åå°äº’åŠ¨å¤±è´¥:', error);
    }
}

// è§¦å‘éšæœºèŠå¤©æ¶ˆæ¯
async function triggerRandomChatMessage(chatId, chat) {
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) return;
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è‡³å°‘10åˆ†é’Ÿæ²¡æœ‰å›å¤
        const lastUserMessage = chat.history.slice().reverse().find(msg => msg.role === 'user');
        if (lastUserMessage) {
            const timeSinceLastUserMessage = Date.now() - lastUserMessage.timestamp;
            const tenMinutes = 10 * 60 * 1000; // 10åˆ†é’Ÿ
            if (timeSinceLastUserMessage < tenMinutes) {
                console.log(`AI ${chat.name} è·³è¿‡è‡ªåŠ¨å‘æ¶ˆæ¯ï¼šç”¨æˆ·æœ€è¿‘${Math.round(timeSinceLastUserMessage / 60000)}åˆ†é’Ÿå‰æœ‰å›å¤`);
                return; // ç”¨æˆ·æœ€è¿‘æœ‰æ´»åŠ¨ï¼Œä¸å‘é€è‡ªåŠ¨æ¶ˆæ¯
            }
        }
        
        // è·å–æœ€è¿‘çš„èŠå¤©å†å²ï¼ˆæ ¹æ®ç”¨æˆ·è®¾ç½®çš„è½®æ•°ï¼‰
        const maxMemory = parseInt(chat.settings.maxMemory) || 10;
        const recentHistory = getHistoryByRounds(chat.history, maxMemory);
        const contextMessages = recentHistory.map(msg => ({
            role: msg.role,
            content: msg.content
        }));
        
        // è·å–ç»‘å®šçš„ä¸–ç•Œä¹¦å†…å®¹
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const worldBooks = await Promise.all(
                chat.settings.linkedWorldBookIds.map(id => db.worldBooks.get(id))
            );
            const validWorldBooks = worldBooks.filter(book => book && book.content);
            if (validWorldBooks.length > 0) {
                worldBookContent = '\n\nä¸–ç•Œä¹¦å†…å®¹ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n' + 
                    validWorldBooks.map(book => `${book.name}ï¼š${book.content}`).join('\n\n');
            }
        }
        
        // è·å–æœ€æ–°çš„5æ¡å¾®åšåŠ¨æ€åŠå…¶è¯„è®º
        let weiboContext = '';
        try {
            const latestPosts = await db.weiboPosts
                .orderBy('timestamp')
                .reverse()
                .limit(5)
                .toArray();
                
            if (latestPosts.length > 0) {
                weiboContext = '\n\næœ€æ–°çš„å¾®åšåŠ¨æ€ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n';
                for (const post of latestPosts) {
                    const authorName = post.authorId === 'user' ? 'ç”¨æˆ·' : 
                        (state.chats[post.authorId] ? state.chats[post.authorId].name : 'æœªçŸ¥');
                    weiboContext += `\n[${authorName}]: ${post.content}`;
                    
                    // è·å–è¯¥åŠ¨æ€çš„è¯„è®º
                    const comments = await db.weiboComments
                        .where('postId')
                        .equals(post.id)
                        .limit(3)
                        .toArray();
                        
                    if (comments.length > 0) {
                        weiboContext += '\n  è¯„è®ºï¼š';
                        for (const comment of comments) {
                            const commentAuthor = comment.authorId === 'user' ? 'ç”¨æˆ·' : 
                                (state.chats[comment.authorId] ? state.chats[comment.authorId].name : 'æœªçŸ¥');
                            weiboContext += `\n    - ${commentAuthor}: ${comment.content}`;
                        }
                    }
                }
            }
        } catch (error) {
            console.error('è·å–å¾®åšåŠ¨æ€å¤±è´¥:', error);
        }
        
        // ç”Ÿæˆä¸»åŠ¨èŠå¤©çš„å†…å®¹
        const systemPrompt = `ä½ æ˜¯${chat.name}ï¼Œä½ çš„äººè®¾å¦‚ä¸‹ï¼š${chat.settings.aiPersona}ã€‚
        
ç°åœ¨ä½ è¦ä¸»åŠ¨ç»™ç”¨æˆ·å‘é€ä¸€æ¡æ¶ˆæ¯ã€‚è¿™æ¡æ¶ˆæ¯åº”è¯¥æ˜¯ï¼š
1. ç¬¦åˆä½ çš„äººè®¾å’Œæ€§æ ¼
2. è‡ªç„¶ã€æœ‰è¶£ã€æœ‰äº’åŠ¨æ€§
3. å¯ä»¥æ˜¯é—®å€™ã€åˆ†äº«ã€è¯¢é—®ç­‰
4. ä¸è¦è¿‡äºæ­£å¼ï¼Œè¦åƒæœ‹å‹é—´çš„æ—¥å¸¸èŠå¤©
5. å¦‚æœæœ‰èŠå¤©å†å²ï¼Œè¦åŸºäºå†å²å†…å®¹è¿›è¡Œè‡ªç„¶çš„å»¶ç»­æˆ–å›åº”
6. å¦‚æœæœ‰ä¸–ç•Œä¹¦å†…å®¹ï¼Œå¯ä»¥ç»“åˆä¸–ç•Œä¹¦ä¸­çš„è®¾å®šå’Œè¯é¢˜è¿›è¡Œäº’åŠ¨
7. å¦‚æœæœ‰æœ€æ–°çš„å¾®åšåŠ¨æ€ï¼Œå¯ä»¥é€‚å½“æåŠæˆ–å¼•ç”¨ï¼Œè®©å¯¹è¯æ›´è‡ªç„¶${worldBookContent}${weiboContext}

ä½ çš„å›å¤å¿…é¡»æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€æ¡æ¶ˆæ¯ã€‚ä½ å¯ä»¥ç”Ÿæˆ1-3æ¡æ¶ˆæ¯ï¼Œæ¨¡æ‹ŸçœŸäººåœ¨çŸ­æ—¶é—´å†…è¿ç»­å‘é€å¤šæ¡ä¿¡æ¯çš„æƒ…æ™¯ã€‚

JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:
["ç¬¬ä¸€æ¡æ¶ˆæ¯", "ç¬¬äºŒæ¡æ¶ˆæ¯", "ç¬¬ä¸‰æ¡æ¶ˆæ¯"]

è¯·ç”Ÿæˆä¸€æ¡æ¶ˆæ¯ï¼š`;

        const messages = [
            { role: 'system', content: systemPrompt },
            ...contextMessages,
            { role: 'user', content: 'è¯·ç”Ÿæˆä¸€æ¡ä¸»åŠ¨èŠå¤©çš„æ¶ˆæ¯ï¼Œè¦åŸºäºæˆ‘ä»¬çš„èŠå¤©å†å²å’Œä¸–ç•Œä¹¦å†…å®¹è¿›è¡Œè‡ªç„¶çš„å»¶ç»­' }
        ];

        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: model,
                messages: messages,
                temperature: 0.8,
                stream: false
            })
        });

        if (!response.ok) return;
        
        const data = await response.json();
        const content = data.choices[0].message.content.trim();
        
        if (content) {
            // è§£æAIå›å¤å†…å®¹ï¼Œæ”¯æŒå¤šæ¡æ¶ˆæ¯
            const messagesArray = parseAiResponse(content);
            
            // ä¸ºæ¯æ¡æ¶ˆæ¯åˆ›å»ºå•ç‹¬çš„æ¶ˆæ¯å¯¹è±¡
            for (const msgData of messagesArray) {
                let aiMessage;
                
                if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                    aiMessage = { 
                        role: 'assistant', 
                        type: 'voice_message', 
                        content: msgData.content, 
                        timestamp: Date.now() 
                    };
                } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                    aiMessage = { 
                        role: 'assistant', 
                        type: 'ai_image', 
                        content: msgData.description, 
                        timestamp: Date.now() 
                    };
                } else if (typeof msgData === 'object' && msgData.type === 'transfer') {
                    aiMessage = { 
                        role: 'assistant', 
                        type: 'transfer', 
                        amount: msgData.amount, 
                        note: msgData.note, 
                        timestamp: Date.now() 
                    };
                } else {
                    aiMessage = { 
                        role: 'assistant', 
                        content: String(msgData), 
                        timestamp: Date.now() 
                    };
                }
                
                chat.history.push(aiMessage);
            }
            
            await db.chats.put(chat);
            
            // æ˜¾ç¤ºé€šçŸ¥ï¼ˆåªæ˜¾ç¤ºç¬¬ä¸€æ¡æ¶ˆæ¯ï¼‰
            const firstMessage = messagesArray[0];
            let notificationText = '';
            if (typeof firstMessage === 'object' && firstMessage.type === 'transfer') {
                notificationText = '[æ”¶åˆ°ä¸€ç¬”è½¬è´¦]';
            } else if (typeof firstMessage === 'object' && firstMessage.type === 'ai_image') {
                notificationText = '[å›¾ç‰‡]';
            } else if (typeof firstMessage === 'object' && firstMessage.type === 'voice_message') {
                notificationText = '[è¯­éŸ³]';
            } else {
                const textContent = String(firstMessage);
                notificationText = STICKER_REGEX.test(textContent) ? '[è¡¨æƒ…]' : textContent;
            }
            
            showNotification(chatId, notificationText.substring(0, 30) + (notificationText.length > 30 ? '...' : ''), 'chat');
            
            // æ›´æ–°èŠå¤©åˆ—è¡¨
            renderChatList();
        }
    } catch (error) {
        console.error('ç”ŸæˆéšæœºèŠå¤©æ¶ˆæ¯å¤±è´¥:', error);
    }
}

// è§¦å‘éšæœºå¾®åšå‘å¸ƒ
async function triggerRandomWeiboPost(chatId, chat) {
    try {
        if (!chat.settings.weiboEnabled) return;
        
        // æ£€æŸ¥å†·å´æ—¶é—´ï¼ˆé¿å…çŸ­æ—¶é—´å†…é‡å¤å‘å¸ƒï¼‰
        const lastPostTime = chat.lastWeiboPostTime || 0;
        const cooldownTime = 30 * 60 * 1000; // 30åˆ†é’Ÿå†·å´æ—¶é—´
        if (Date.now() - lastPostTime < cooldownTime) {
            console.log(`${chat.name} åœ¨å†·å´æ—¶é—´å†…ï¼Œè·³è¿‡å‘å¸ƒ`);
            return;
        }
        
        const content = await generateAiPostContent(chat);
        if (content) {
            await publishAiPost(chatId, content);

            // è®°å½•å‘å¸ƒæ—¶é—´
            chat.lastWeiboPostTime = Date.now();
            await db.chats.put(chat);

            // æ˜¾ç¤ºé€šçŸ¥
            const displayText = typeof content === 'string' ? content : content.content;
            showNotification(chatId, `å‘å¸ƒäº†æ–°åŠ¨æ€: ${displayText.substring(0, 30)}...`, 'weibo');
        }
    } catch (error) {
        console.error('ç”Ÿæˆéšæœºå¾®åšå¤±è´¥:', error);
    }
}

// ä¸ºå•ä¸ªAIè§’è‰²è®¾ç½®å‘å¸ƒå®šæ—¶å™¨
async function setupAiPostingTimer(chatId, chat) {
    const frequency = chat.settings.weiboFrequency || 'low';
    const postingTimes = chat.settings.weiboPostingTimes || [];
    
    // åªæœ‰åœ¨ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®äº†æ—¶é—´ç‚¹æ—¶æ‰ä½¿ç”¨å®šæ—¶å‘å¸ƒç³»ç»Ÿ
    if (postingTimes.length > 0) {
        // å­˜å‚¨å®šæ—¶å™¨ä¿¡æ¯
        aiPostingTimers.set(chatId, {
            frequency,
            postingTimes: chat.settings.weiboPostingTimes,
            lastCheckDate: new Date().toDateString()
        });
        console.log(`${chat.name} å¯ç”¨å®šæ—¶å‘å¸ƒç³»ç»Ÿï¼Œæ—¶é—´ç‚¹:`, postingTimes);
    } else {
        console.log(`${chat.name} æœªè®¾ç½®å‘å¸ƒæ—¶é—´ç‚¹ï¼Œå°†ä½¿ç”¨åå°éšæœºå‘å¸ƒ`);
    }
}

// æ£€æŸ¥å‘å¸ƒæ—¶é—´ç‚¹
async function checkAiPostingTimes() {
    const now = new Date();
    const currentTime = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
    const currentDate = now.toDateString();
    
    for (const [chatId, timerInfo] of aiPostingTimers.entries()) {
        const chat = state.chats[chatId];
        if (!chat || !chat.settings.weiboEnabled) continue;
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„ä¸€å¤©
        if (timerInfo.lastCheckDate !== currentDate) {
            // æ–°çš„ä¸€å¤©ï¼Œé‡æ–°ç”Ÿæˆæ—¶é—´ç‚¹ï¼ˆä»…åœ¨å·²æœ‰æ—¶é—´ç‚¹çš„æƒ…å†µä¸‹ï¼‰
            if (timerInfo.postingTimes && timerInfo.postingTimes.length > 0) {
                const newTimes = scheduleAiPosts(chatId, timerInfo.frequency);
                timerInfo.postingTimes = newTimes;
                timerInfo.lastCheckDate = currentDate;
                
                // æ›´æ–°æ•°æ®åº“
                chat.settings.weiboPostingTimes = newTimes;
                await db.chats.put(chat);
                console.log(`${chat.name} æ–°çš„ä¸€å¤©ï¼Œé‡æ–°ç”Ÿæˆå‘å¸ƒæ—¶é—´ç‚¹:`, newTimes);
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾å‘å¸ƒæ—¶é—´ç‚¹
        if (timerInfo.postingTimes.includes(currentTime)) {
            await triggerAiAutoPost(chatId, chat);
        }
    }
}

// è§¦å‘AIè‡ªåŠ¨å‘å¸ƒ
async function triggerAiAutoPost(chatId, chat) {
    try {
        // æ£€æŸ¥å†·å´æ—¶é—´ï¼ˆé¿å…çŸ­æ—¶é—´å†…é‡å¤å‘å¸ƒï¼‰
        const lastPostTime = chat.lastWeiboPostTime || 0;
        const cooldownTime = 30 * 60 * 1000; // 30åˆ†é’Ÿå†·å´æ—¶é—´
        if (Date.now() - lastPostTime < cooldownTime) {
            console.log(`${chat.name} åœ¨å†·å´æ—¶é—´å†…ï¼Œè·³è¿‡å®šæ—¶å‘å¸ƒ`);
            return;
        }
        
        // ç”Ÿæˆç¬¦åˆäººè®¾çš„åŠ¨æ€å†…å®¹
        const content = await generateAiPostContent(chat);
        
        if (content) {
            await publishAiPost(chatId, content);
            
            // è®°å½•å‘å¸ƒæ—¶é—´
            chat.lastWeiboPostTime = Date.now();
            await db.chats.put(chat);
            
            console.log(`AI ${chat.name} è‡ªåŠ¨å‘å¸ƒäº†åŠ¨æ€: ${content}`);
        }
    } catch (error) {
        console.error(`AIè‡ªåŠ¨å‘å¸ƒå¤±è´¥: ${error.message}`);
    }
}

// ç”ŸæˆAIåŠ¨æ€å†…å®¹ï¼Œç»“åˆæœ€è¿‘èŠå¤©è®°å½•
async function generateAiPostContent(chat, visibility = 'public') {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        throw new Error('APIé…ç½®ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥åä»£åœ°å€ã€å¯†é’¥å’Œæ¨¡å‹è®¾ç½®');
    }
    try {
        const persona = chat.settings?.aiPersona || '';
        const specialHabit = /å–œæ¬¢å‘(.*?)ã€‚/.exec(persona)?.[1] || '';
        // è·å–æœ€è¿‘çš„èŠå¤©è®°å½•ï¼ˆæ ¹æ®ç”¨æˆ·è®¾ç½®çš„è½®æ•°ï¼‰
        const maxMemory = parseInt(chat.settings.maxMemory) || 10;
        const history = getHistoryByRounds(chat.history || [], maxMemory);
        let chatSummary = '';
        if (history.length > 0) {
            chatSummary = 'ä»¥ä¸‹æ˜¯ä½ å’Œç”¨æˆ·æœ€è¿‘çš„èŠå¤©è®°å½•æ‘˜è¦ï¼Œä»…ä¾›ä½ å‘å¾®åšæ—¶å‚è€ƒï¼š\n';
            chatSummary += history.map(msg => {
                if (msg.role === 'user') return `ç”¨æˆ·ï¼š${msg.content}`;
                if (msg.role === 'assistant') return `${chat.name}ï¼š${msg.content}`;
                return '';
            }).join('\n');
        }
        
        // è·å–æœ€æ–°çš„5æ¡å¾®åšåŠ¨æ€åŠå…¶è¯„è®º
        let weiboContext = '';
        try {
            const latestPosts = await db.weiboPosts
                .orderBy('timestamp')
                .reverse()
                .limit(5)
                .toArray();
                
            if (latestPosts.length > 0) {
                weiboContext = '\n\næœ€æ–°çš„å¾®åšåŠ¨æ€ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n';
                for (const post of latestPosts) {
                    const authorName = post.authorId === 'user' ? 'ç”¨æˆ·' : 
                        (state.chats[post.authorId] ? state.chats[post.authorId].name : 'æœªçŸ¥');
                    weiboContext += `\n[${authorName}]: ${post.content}`;
                    
                    // è·å–è¯¥åŠ¨æ€çš„è¯„è®º
                    const comments = await db.weiboComments
                        .where('postId')
                        .equals(post.id)
                        .limit(3)
                        .toArray();
                        
                    if (comments.length > 0) {
                        weiboContext += '\n  è¯„è®ºï¼š';
                        for (const comment of comments) {
                            const commentAuthor = comment.authorId === 'user' ? 'ç”¨æˆ·' : 
                                (state.chats[comment.authorId] ? state.chats[comment.authorId].name : 'æœªçŸ¥');
                            weiboContext += `\n    - ${commentAuthor}: ${comment.content}`;
                        }
                    }
                }
            }
        } catch (error) {
            console.error('è·å–å¾®åšåŠ¨æ€å¤±è´¥:', error);
        }
        
        // è·å–ç»‘å®šçš„ä¸–ç•Œä¹¦å†…å®¹
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const worldBooks = await Promise.all(
                chat.settings.linkedWorldBookIds.map(id => db.worldBooks.get(id))
            );
            const validWorldBooks = worldBooks.filter(book => book && book.content);
            if (validWorldBooks.length > 0) {
                worldBookContent = '\n\nä¸–ç•Œä¹¦å†…å®¹ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n' + 
                    validWorldBooks.map(book => `${book.name}ï¼š${book.content}`).join('\n\n');
            }
        }
        
        let systemPrompt = `ä½ æ˜¯${chat.name}ï¼Œä½ çš„äººè®¾å¦‚ä¸‹ï¼š${persona}ã€‚`;
        if (specialHabit) {
            systemPrompt += `ä½ å¹³æ—¶å–œæ¬¢å‘${specialHabit}ï¼Œè¯·ä¼˜å…ˆä»¥æ­¤é£æ ¼å‘å¾®åšã€‚`;
        }
        
        // æ·»åŠ å›¾ç‰‡ç”Ÿæˆçš„æŒ‡å¯¼
        const includeImage = Math.random() < 0.4; // 40%æ¦‚ç‡ç”Ÿæˆå¸¦å›¾ç‰‡çš„åŠ¨æ€
        if (includeImage) {
            systemPrompt += `\n\nè¯·ç”Ÿæˆä¸€æ¡å¸¦å›¾ç‰‡çš„å¾®åšåŠ¨æ€ï¼ŒåŒ…æ‹¬ï¼š
1. ç®€çŸ­çš„æ–‡å­—å†…å®¹ï¼ˆ30-100å­—ï¼‰
2. å›¾ç‰‡çš„è¯¦ç»†æè¿°ï¼ˆ100-200å­—ï¼‰

å›å¤æ ¼å¼ï¼š
{
  "text": "å¾®åšæ–‡å­—å†…å®¹",
  "imageDescription": "å›¾ç‰‡çš„è¯¦ç»†æè¿°ï¼ˆè¿™éƒ¨åˆ†ä¸ä¼šç›´æ¥æ˜¾ç¤ºåœ¨å¾®åšä¸­ï¼Œä½†ä¼šåœ¨ç”¨æˆ·ç‚¹å‡»å›¾ç‰‡æ—¶æ˜¾ç¤ºï¼‰"
}

å›¾ç‰‡æè¿°åº”è¯¥è¯¦ç»†ç”ŸåŠ¨ï¼ŒåŒ…å«åœºæ™¯ã€äººç‰©ã€åŠ¨ä½œã€è¡¨æƒ…ã€è‰²å½©ç­‰ç»†èŠ‚ï¼Œè®©äººèƒ½å¤Ÿæƒ³è±¡å‡ºå›¾ç‰‡çš„æ ·å­ã€‚`;
        } else {
            systemPrompt += `è¯·ä¸¥æ ¼æ ¹æ®ä½ çš„äººè®¾å’Œä¹ æƒ¯ï¼Œç”Ÿæˆä¸€æ¡å¾®åšåŠ¨æ€ï¼ˆ50-200å­—ï¼‰ï¼Œå†…å®¹è¦æœ‰ä¸ªæ€§ï¼Œä¸èƒ½å’Œå…¶ä»–è§’è‰²æ··æ·†ã€‚`;
        }
        
        if (chatSummary) {
            systemPrompt += `\n${chatSummary}\nä½ å¯ä»¥ç»“åˆè¿™äº›èŠå¤©å†…å®¹ä½œä¸ºçµæ„Ÿï¼Œä½†ä¸å¼ºåˆ¶å¿…é¡»æåŠã€‚`;
        }
        if (worldBookContent) {
            systemPrompt += `\n${worldBookContent}\nä½ å¯ä»¥ç»“åˆä¸–ç•Œä¹¦ä¸­çš„è®¾å®šå’Œè¯é¢˜è¿›è¡Œåˆ›ä½œï¼Œè®©å†…å®¹æ›´ä¸°å¯Œæœ‰è¶£ã€‚`;
        }
        if (weiboContext) {
            systemPrompt += `\n${weiboContext}\nä½ å¯ä»¥å‚è€ƒè¿™äº›æœ€æ–°çš„å¾®åšåŠ¨æ€å’Œäº’åŠ¨ï¼Œä½†ä¸è¦ç›´æ¥é‡å¤æˆ–åˆ»æ„æåŠã€‚`;
        }
        systemPrompt += `ä½ ä¸éœ€è¦åœ¨æ–‡æ¡ˆé‡Œå†™æ˜å¯è§æ€§ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®¾ç½®ã€‚`;
        const messages = [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: 'è¯·å‘å¸ƒä¸€æ¡å¾®åšåŠ¨æ€' }
        ];
        const requestBody = {
            model: model,
            messages: messages,
            temperature: 0.7,
            stream: false
        };
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 90000); // å¢åŠ åˆ°90ç§’è¶…æ—¶
        // æ£€æµ‹æ˜¯å¦æ˜¯Geminiå®˜æ–¹API
        const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');
        
        let response;
        if (isGeminiOfficial) {
            // ä½¿ç”¨Geminiå®˜æ–¹APIæ ¼å¼
            const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;
            
            // è½¬æ¢æ¶ˆæ¯æ ¼å¼ä¸ºGeminiæ ¼å¼
            const geminiMessages = [];
            
            // æ·»åŠ ç³»ç»Ÿæç¤ºè¯ä½œä¸ºç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
            if (requestBody.messages[0]?.role === 'system') {
                geminiMessages.push({
                    role: 'user',
                    parts: [{ text: requestBody.messages[0].content }]
                });
                geminiMessages.push({
                    role: 'model',
                    parts: [{ text: 'æˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šæŒ‰ç…§è¿™äº›è¦æ±‚è¿›è¡Œå¯¹è¯ã€‚' }]
                });
            }
            
            // è½¬æ¢å…¶ä»–æ¶ˆæ¯
            for (let i = 1; i < requestBody.messages.length; i++) {
                const msg = requestBody.messages[i];
                if (msg.role === 'system') continue; // è·³è¿‡ç³»ç»Ÿæ¶ˆæ¯
                
                let content = '';
                if (typeof msg.content === 'string') {
                    content = msg.content;
                } else if (Array.isArray(msg.content)) {
                    content = msg.content.map(item => {
                        if (item.type === 'text') return item.text;
                        if (item.type === 'image_url') return '[å›¾ç‰‡]';
                        return '';
                    }).join('');
                }
                
                geminiMessages.push({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: content }]
                });
            }
            
            response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: geminiMessages,
                    generationConfig: {
                        temperature: requestBody.temperature || 0.7,
                        maxOutputTokens: 8192
                    }
                }),
                signal: controller.signal
            });
        } else {
            // ä½¿ç”¨OpenAIæ ¼å¼ï¼ˆæŠ±è„¸ç­‰ä»£ç†ï¼‰
            response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(requestBody),
                signal: controller.signal
            });
        }
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            let errorText = await response.text();
            throw new Error(`APIè°ƒç”¨å¤±è´¥ (${response.status}): ${errorText}`);
        }
        
        const data = await response.json();
        let content;
        
        if (isGeminiOfficial) {
            // è§£æGemini APIå“åº”
            content = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!content) {
                console.log('Gemini API å“åº”æ•°æ®:', data);
                throw new Error('Gemini APIè¿”å›äº†ç©ºå†…å®¹');
            }
        } else {
            // è§£æOpenAIæ ¼å¼å“åº”ï¼ˆåŒ…æ‹¬æŠ±è„¸ç­‰ä»£ç†ï¼‰
            if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                content = data.choices[0].message.content;
            } else if (data.message) {
                // æŸäº›ä»£ç†å¯èƒ½ç›´æ¥è¿”å›messageå­—æ®µ
                content = data.message;
            } else if (data.text) {
                // æŸäº›ä»£ç†å¯èƒ½è¿”å›textå­—æ®µ
                content = data.text;
            } else if (data.response) {
                // æŸäº›ä»£ç†å¯èƒ½è¿”å›responseå­—æ®µ
                content = data.response;
            }
            // 5. éƒ¨åˆ†ä»£ç†å¯èƒ½è¿”å›contentå­—æ®µ
            else if (data.content) {
                content = data.content;
            }
            // 6. éƒ¨åˆ†ä»£ç†å¯èƒ½è¿”å›resultå­—æ®µ
            else if (data.result) {
                content = data.result;
            }
            // 7. å°è¯•æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å€¼
            else {
                console.log('å¾®åšå‘å¸ƒAPIéæ ‡å‡†å“åº”æ ¼å¼ï¼Œå°è¯•æŸ¥æ‰¾å†…å®¹:', data);
                // éå†å¯¹è±¡çš„æ‰€æœ‰é”®ï¼ŒæŸ¥æ‰¾ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²å€¼
                for (const key in data) {
                    if (typeof data[key] === 'string' && data[key].trim()) {
                        content = data[key];
                        console.log(`å¾®åšå‘å¸ƒAPIä½¿ç”¨å­—æ®µ "${key}" ä½œä¸ºå“åº”å†…å®¹`);
                        break;
                    }
                }
            }
            
            if (!content) {
                console.error('å¾®åšå‘å¸ƒAPIæ— æ³•è§£æå“åº”ï¼Œå®Œæ•´å“åº”æ•°æ®:', data);
                throw new Error('å¾®åšå‘å¸ƒAPIè¿”å›äº†ç©ºå†…å®¹æˆ–æ— æ³•è¯†åˆ«çš„æ ¼å¼ï¼Œè¯·æ£€æŸ¥APIé…ç½®');
            }
        }
        
        content = content.trim();
        
        // å¤„ç†å¸¦å›¾ç‰‡çš„å¾®åšå†…å®¹
        if (includeImage) {
            try {
                // å°è¯•è§£æJSONæ ¼å¼çš„å“åº”
                let parsedContent;
                try {
                    // å°è¯•ç›´æ¥è§£æ
                    parsedContent = JSON.parse(content);
                } catch (e) {
                    // å¦‚æœç›´æ¥è§£æå¤±è´¥ï¼Œå°è¯•æå–JSONéƒ¨åˆ†
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        parsedContent = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error("æ— æ³•è§£æJSONæ ¼å¼");
                    }
                }
                
                if (parsedContent && parsedContent.text && parsedContent.imageDescription) {
                    // ä½¿ç”¨å›ºå®šçš„å›¾ç‰‡URLæ ¼å¼ï¼Œä¸èŠå¤©ä¸­ä¸€è‡´
                    const imageUrl = "https://i.postimg.cc/KYr2qRCK/1.jpg";
                    return {
                        content: parsedContent.text,
                        imageUrl: imageUrl,
                        imageDescription: parsedContent.imageDescription,
                        visibility
                    };
                } else {
                    // å¦‚æœè§£æå¤±è´¥æˆ–æ ¼å¼ä¸æ­£ç¡®ï¼Œè¿”å›çº¯æ–‡æœ¬å†…å®¹
                    return { content, visibility };
                }
            } catch (e) {
                console.error("è§£æå›¾ç‰‡å†…å®¹å¤±è´¥:", e);
                return { content, visibility };
            }
        } else {
            return { content, visibility };
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
        } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
            if (proxyUrl.includes('generativelanguage.googleapis.com')) {
                throw new Error('CORSé”™è¯¯ï¼šæ— æ³•ç›´æ¥ä»æµè§ˆå™¨è®¿é—®Geminiå®˜æ–¹APIã€‚\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. ä½¿ç”¨HTTPæœåŠ¡å™¨è¿è¡Œæ­¤æ–‡ä»¶\n2. ä½¿ç”¨ä»£ç†APIæœåŠ¡\n3. åœ¨è®¾ç½®ä¸­åˆ‡æ¢åˆ°æŠ±è„¸ç­‰æ”¯æŒè·¨åŸŸçš„API');
            } else {
                throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åä»£åœ°å€æ˜¯å¦æ­£ç¡®æˆ–ç½‘ç»œè¿æ¥');
            }
        } else if (error.message.includes('CORS') || error.message.includes('Access-Control')) {
            throw new Error('CORSè·¨åŸŸé”™è¯¯ï¼šè¯·ä½¿ç”¨HTTPæœåŠ¡å™¨è¿è¡Œæ­¤æ–‡ä»¶ï¼Œæˆ–åˆ‡æ¢åˆ°æ”¯æŒè·¨åŸŸçš„APIæœåŠ¡');
        }
        throw error;
    }
}

// æ¸…é™¤æ‰€æœ‰AIå‘å¸ƒå®šæ—¶å™¨
function clearAllAiPostingTimers() {
    aiPostingTimers.clear();
}

// è§¦å‘AIè§’è‰²å¯¹ç”¨æˆ·åŠ¨æ€çš„äº’åŠ¨
async function triggerAiInteraction(post) {
    console.log('è§¦å‘AIäº’åŠ¨ï¼ŒåŠ¨æ€ID:', post.id, 'ç°æœ‰AIè§’è‰²æ•°é‡:', Object.keys(state.chats).filter(id => !state.chats[id].isGroup).length);
    
    try {
        // æ£€æŸ¥åŠ¨æ€å¯è§æ€§
        if (post.visibility === 'private') {
            console.log('è¿™æ˜¯ç§å¯†åŠ¨æ€ï¼Œä¸è§¦å‘AIäº’åŠ¨');
            return; // ç§å¯†åŠ¨æ€ä¸è§¦å‘AIäº’åŠ¨
        }
        
        // éå†æ‰€æœ‰AIè§’è‰²ï¼Œè®©å®ƒä»¬å¯¹ç”¨æˆ·çš„åŠ¨æ€è¿›è¡Œäº’åŠ¨
        for (const [chatId, chat] of Object.entries(state.chats)) {
            if (chat.isGroup) continue; // è·³è¿‡ç¾¤èŠ
            
            // å¦‚æœæ˜¯å¥½å‹å¯è§åŠ¨æ€ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºç¾¤èŠå¥½å‹
            if (post.visibility === 'friends') {
                // æ£€æŸ¥æ˜¯å¦åœ¨åŒä¸€ä¸ªç¾¤èŠä¸­
                const isInSameGroup = Object.values(state.chats)
                    .filter(c => c.isGroup)
                    .some(group => 
                        group.members && 
                        group.members.includes(chatId) && 
                        group.members.includes(post.authorId)
                    );
                
                if (!isInSameGroup) {
                    console.log(`${chat.name} ä¸æ˜¯ ${post.authorName} çš„ç¾¤èŠå¥½å‹ï¼Œè·³è¿‡äº’åŠ¨`);
                    continue; // ä¸æ˜¯ç¾¤èŠå¥½å‹ï¼Œè·³è¿‡äº’åŠ¨
                }
            }
            
            console.log(`æ£€æŸ¥AI: ${chat.name} (${chatId})`);
            
            // æ£€æŸ¥APIé…ç½®
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) {
                console.log('APIé…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡AIäº’åŠ¨');
                continue;
            }
            
            // æ£€æŸ¥åŠ¨æ€å¯è§æ€§
            if (post.visibility === 'private') {
                console.log(`${chat.name} è·³è¿‡äº’åŠ¨ï¼šåŠ¨æ€æ˜¯ç§å¯†çš„`);
                continue; // ç§å¯†åŠ¨æ€åªæœ‰ç”¨æˆ·èƒ½çœ‹åˆ°ï¼ŒAIä¸ä¼šäº’åŠ¨
            }
            
            if (post.visibility === 'friends') {
                // æ£€æŸ¥æ˜¯å¦åœ¨åŒä¸€ç¾¤èŠä¸­ï¼ˆå³æ˜¯å¦ä¸º"å¥½å‹"ï¼‰
                const isInSameGroup = await checkIfInSameGroup(post.authorId, chatId);
                if (!isInSameGroup && !post.content.includes(`@${chat.name}`)) {
                    console.log(`${chat.name} è·³è¿‡äº’åŠ¨ï¼šåŠ¨æ€ä»…é™å¥½å‹å¯è§ä¸”ä¸æ˜¯å¥½å‹å…³ç³»`);
                    continue; // éå¥½å‹å…³ç³»ä¸”æ²¡æœ‰è¢«@ï¼Œä¸äº’åŠ¨
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦@äº†è¯¥AIè§’è‰²ï¼ˆæ£€æŸ¥contentå’Œdescriptionå­—æ®µï¼‰
            const postText = post.content || post.description || '';
            const isAtMentioned = postText.includes(`@${chat.name}`);
            
            // æ ¹æ®æ˜¯å¦è¢«@å†³å®šäº’åŠ¨æ¦‚ç‡
            const interactionProbability = isAtMentioned ? 1.0 : 0.8; // @æ—¶100%æ¦‚ç‡ï¼Œå¦åˆ™80%æ¦‚ç‡
            const shouldInteract = Math.random() < interactionProbability;
            console.log(`${chat.name} æ˜¯å¦è¢«@:`, isAtMentioned, `äº’åŠ¨æ¦‚ç‡:`, interactionProbability, `æ˜¯å¦äº’åŠ¨:`, shouldInteract);
            if (!shouldInteract) continue;
            
            // éšæœºé€‰æ‹©äº’åŠ¨ç±»å‹ï¼Œè¯„è®ºæ¦‚ç‡æ›´é«˜
            const rand = Math.random();
            let randomType;
            if (rand < 0.5) randomType = 'comment'; // 50%æ¦‚ç‡è¯„è®º
            else if (rand < 0.8) randomType = 'like'; // 30%æ¦‚ç‡ç‚¹èµ
            else randomType = 'repost'; // 20%æ¦‚ç‡è½¬å‘
            
            console.log(`${chat.name} é€‰æ‹©çš„äº’åŠ¨ç±»å‹:`, randomType);
            
            let userContent = '';
            let notificationMessage = '';
            
            if (randomType === 'comment') {
                // ç”Ÿæˆè¯„è®ºå†…å®¹
                try {
                    const commentResponse = await generateAiResponse(chat, 'comment', post, userContent);
                    if (commentResponse) {
                        const commentId = Date.now() + Math.random(); // é¿å…IDå†²çª
                        const commentData = {
                            id: commentId,
                            postId: post.id,
                            authorId: chatId,
                            timestamp: Date.now(),
                            replies: [] // åˆå§‹åŒ–å›å¤æ•°ç»„
                        };

                        // å¤„ç†è¡¨æƒ…åŒ…æ ¼å¼çš„å›å¤
                        if (typeof commentResponse === 'object' && commentResponse.type === 'sticker') {
                            commentData.content = commentResponse.content;
                            commentData.meaning = commentResponse.meaning;
                        } else {
                            commentData.content = commentResponse;
                        }

                        await db.weiboComments.add(commentData);
                        notificationMessage = `è¯„è®ºäº†ä½ çš„åŠ¨æ€`;
                        console.log(`${chat.name} æˆåŠŸè¯„è®º:`, commentResponse);
                    }
                } catch (error) {
                    console.error(`${chat.name} è¯„è®ºå¤±è´¥:`, error);
                }
            } else if (randomType === 'like') {
                // æ·»åŠ ç‚¹èµ
                try {
                    await db.weiboLikes.add({
                        postId: post.id,
                        authorId: chatId,
                        timestamp: Date.now()
                    });
                    notificationMessage = `ç‚¹èµäº†ä½ çš„åŠ¨æ€`;
                    console.log(`${chat.name} æˆåŠŸç‚¹èµ`);
                } catch (error) {
                    console.error(`${chat.name} ç‚¹èµå¤±è´¥:`, error);
                }
            } else if (randomType === 'repost') {
                // ç”Ÿæˆè½¬å‘å†…å®¹
                try {
                    const repostResponse = await generateAiResponse(chat, 'repost', post, userContent);
                    if (repostResponse) {
                        // åˆ›å»ºè½¬å‘åŠ¨æ€
                        const repostPost = {
                            id: Date.now() + Math.random(), // é¿å…IDå†²çª
                            authorId: chatId,
                            authorName: chat.name,
                            authorAvatar: chat.settings.aiAvatar || defaultAvatar,
                            authorEmail: chat.settings.aiSignature || '',
                            authorSignature: chat.settings.aiSignature || '',
                            content: repostResponse,
                            visibility: 'public',
                            timestamp: Date.now(),
                            isRepost: true,
                            originalPostId: post.id
                        };
                        
                        await db.weiboPosts.add(repostPost);
                        
                        // æ·»åŠ è½¬å‘è®°å½•
                        await db.weiboReposts.add({
                            id: Date.now() + Math.random(),
                            originalPostId: post.id,
                            authorId: chatId,
                            content: repostResponse,
                            timestamp: Date.now()
                        });
                        notificationMessage = `è½¬å‘äº†ä½ çš„åŠ¨æ€`;
                        console.log(`${chat.name} æˆåŠŸè½¬å‘:`, repostResponse);
                    }
                } catch (error) {
                    console.error(`${chat.name} è½¬å‘å¤±è´¥:`, error);
                }
            }
            
            // æ˜¾ç¤ºé€šçŸ¥
            if (notificationMessage) {
                // å»¶è¿Ÿæ˜¾ç¤ºé€šçŸ¥ï¼Œæ¨¡æ‹ŸçœŸå®äº’åŠ¨çš„æ—¶é—´å·®
                setTimeout(() => {
                    showNotification(chatId, notificationMessage, 'weibo');
                }, Math.random() * 3000 + 1000); // 1-4ç§’åæ˜¾ç¤ºé€šçŸ¥
            }
        }
        
        // é‡æ–°æ¸²æŸ“æ—¶é—´çº¿ä»¥æ˜¾ç¤ºæ–°çš„äº’åŠ¨
        await renderWeiboTimeline();
        
        // è§¦å‘è§’è‰²é—´äº’åŠ¨ï¼ˆåœ¨æ‰€æœ‰AIå®Œæˆåˆå§‹äº’åŠ¨åï¼‰
        setTimeout(() => {
            triggerAiToAiInteraction(post.id);
        }, Math.random() * 5000 + 3000); // 3-8ç§’åè§¦å‘è§’è‰²é—´äº’åŠ¨
        
    } catch (error) {
        console.error('AIäº’åŠ¨å¤±è´¥:', error);
        // ä¸æŠ›å‡ºé”™è¯¯ï¼Œé¿å…å½±å“å…¶ä»–åŠŸèƒ½
    }
}

// æ£€æŸ¥ä¸¤ä¸ªè§’è‰²æ˜¯å¦åœ¨åŒä¸€ä¸ªç¾¤èŠä¸­ï¼ˆå³æ˜¯å¦ä¸º"å¥½å‹"å…³ç³»ï¼‰
async function checkIfInSameGroup(authorId, chatId) {
    // å¦‚æœæ˜¯ç”¨æˆ·å‘çš„åŠ¨æ€ï¼Œæ£€æŸ¥AIæ˜¯å¦åœ¨ç”¨æˆ·çš„ç¾¤èŠä¸­
    if (authorId === 'user') {
        // è·å–æ‰€æœ‰ç¾¤èŠ
        const groupChats = Object.values(state.chats).filter(chat => chat.isGroup);
        
        // æ£€æŸ¥AIæ˜¯å¦åœ¨ä»»ä½•ä¸€ä¸ªç¾¤èŠä¸­
        for (const groupChat of groupChats) {
            if (groupChat.members && groupChat.members.some(m => m.id === chatId || m.name === state.chats[chatId]?.name)) {
                return true;
            }
        }
    } 
    // å¦‚æœæ˜¯AIå‘çš„åŠ¨æ€ï¼Œæ£€æŸ¥ä¸å¦ä¸€ä¸ªAIæ˜¯å¦åœ¨åŒä¸€ç¾¤èŠ
    else if (authorId !== chatId) {
        // è·å–æ‰€æœ‰ç¾¤èŠ
        const groupChats = Object.values(state.chats).filter(chat => chat.isGroup);
        
        // æ£€æŸ¥ä¸¤ä¸ªAIæ˜¯å¦åœ¨åŒä¸€ä¸ªç¾¤èŠä¸­
        for (const groupChat of groupChats) {
            const authorInGroup = groupChat.members && groupChat.members.some(m => 
                m.id === authorId || m.name === state.chats[authorId]?.name);
            const chatInGroup = groupChat.members && groupChat.members.some(m => 
                m.id === chatId || m.name === state.chats[chatId]?.name);
            
            if (authorInGroup && chatInGroup) {
                return true;
            }
        }
    }
    
    return false;
}

// AIå“åº”ç”¨æˆ·äº’åŠ¨
async function triggerAiResponse(aiId, type, post, userContent = '') {
    const ai = state.chats[aiId];
    if (!ai) return;
    
    try {
        let response;
        switch (type) {
            case 'like':
                response = await generateAiResponse(ai, 'like', post);
                break;
            case 'comment':
                response = await generateAiResponse(ai, 'comment', post, userContent);
                break;
            case 'repost':
                response = await generateAiResponse(ai, 'repost', post, userContent);
                break;
        }
        
        if (response) {
            await publishAiPost(aiId, response);
        }
    } catch (error) {
        console.error('AIå“åº”å¤±è´¥:', error);
        // ä¸æŠ›å‡ºé”™è¯¯ï¼Œé¿å…å½±å“å…¶ä»–åŠŸèƒ½
    }
}

// ç”ŸæˆAIå›åº”å†…å®¹ï¼ˆæ”¯æŒæ¥¼ä¸­æ¥¼å›å¤ï¼‰
async function generateAiResponse(ai, type, post, userContent = '', replyToUser = '') {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        throw new Error('APIé…ç½®ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥åä»£åœ°å€ã€å¯†é’¥å’Œæ¨¡å‹è®¾ç½®');
    }
    try {
        const persona = ai.settings?.aiPersona || '';
        
        // è·å–ç»‘å®šçš„ä¸–ç•Œä¹¦å†…å®¹
        let worldBookContent = '';
        if (ai.settings.linkedWorldBookIds && ai.settings.linkedWorldBookIds.length > 0) {
            const worldBooks = await Promise.all(
                ai.settings.linkedWorldBookIds.map(id => db.worldBooks.get(id))
            );
            const validWorldBooks = worldBooks.filter(book => book && book.content);
            if (validWorldBooks.length > 0) {
                worldBookContent = '\n\nä¸–ç•Œä¹¦å†…å®¹ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n' + 
                    validWorldBooks.map(book => `${book.name}ï¼š${book.content}`).join('\n\n');
            }
        }
        
        // è·å–æœ€è¿‘çš„èŠå¤©è®°å½•ä½œä¸ºä¸Šä¸‹æ–‡ï¼ˆæ ¹æ®ç”¨æˆ·è®¾ç½®çš„è½®æ•°ï¼‰
        let chatContext = '';
        if (ai.history && ai.history.length > 0) {
            const maxMemory = parseInt(ai.settings.maxMemory) || 10;
            const recentHistory = getHistoryByRounds(ai.history, maxMemory);
            chatContext = '\n\næœ€è¿‘çš„èŠå¤©è®°å½•ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n' + 
                recentHistory.map(msg => {
                    if (msg.role === 'user') return `ç”¨æˆ·ï¼š${msg.content}`;
                    return `${ai.name}ï¼š${msg.content}`;
                }).join('\n');
        }
        
        // è·å–æœ€æ–°çš„5æ¡å¾®åšåŠ¨æ€åŠå…¶è¯„è®º
        let weiboContext = '';
        try {
            const latestPosts = await db.weiboPosts
                .orderBy('timestamp')
                .reverse()
                .limit(5)
                .toArray();
                
            if (latestPosts.length > 0) {
                weiboContext = '\n\næœ€æ–°çš„å¾®åšåŠ¨æ€ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n';
                for (const post of latestPosts) {
                    const authorName = post.authorId === 'user' ? 'ç”¨æˆ·' : 
                        (state.chats[post.authorId] ? state.chats[post.authorId].name : 'æœªçŸ¥');
                    weiboContext += `\n[${authorName}]: ${post.content}`;
                    
                    // è·å–è¯¥åŠ¨æ€çš„è¯„è®º
                    const comments = await db.weiboComments
                        .where('postId')
                        .equals(post.id)
                        .limit(3)
                        .toArray();
                        
                    if (comments.length > 0) {
                        weiboContext += '\n  è¯„è®ºï¼š';
                        for (const comment of comments) {
                            const commentAuthor = comment.authorId === 'user' ? 'ç”¨æˆ·' : 
                                (state.chats[comment.authorId] ? state.chats[comment.authorId].name : 'æœªçŸ¥');
                            weiboContext += `\n    - ${commentAuthor}: ${comment.content}`;
                        }
                    }
                }
            }
        } catch (error) {
            console.error('è·å–å¾®åšåŠ¨æ€å¤±è´¥:', error);
        }
        
        let systemPrompt = `ä½ æ˜¯${ai.name}ï¼Œä½ çš„äººè®¾å¦‚ä¸‹ï¼š${persona}ã€‚${worldBookContent}${chatContext}${weiboContext}\n\n`;
        
        if (type === 'comment_reply') {
            systemPrompt += `ç”¨æˆ·åˆšåˆšåœ¨å¾®åšåŠ¨æ€ä¸‹è¯„è®ºäº†ï¼š"${userContent}"ã€‚è¯·åŸºäºä½ çš„äººè®¾ï¼Œè‡ªç„¶åœ°å›å¤è¿™æ¡è¯„è®ºã€‚å¯ä»¥æ˜¯èµåŒã€è¡¥å……ã€æé—®æˆ–è€…åˆ†äº«ç›¸å…³æ„Ÿå—ã€‚`;
        } else if (type === 'thread_reply') {
            systemPrompt += `è¿™æ˜¯ä¸€ä¸ªæ¥¼ä¸­æ¥¼è®¨è®ºï¼Œè¯·åŸºäºä»¥ä¸‹å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œç»§ç»­å‚ä¸è®¨è®ºã€‚è¦ç¬¦åˆä½ çš„äººè®¾ï¼Œå›å¤è¦ç®€çŸ­æœ‰è¶£ã€‚\n\n${userContent}`;
        } else if (type === 'comment') {
            systemPrompt += `è¯·å¯¹è¿™æ¡åŠ¨æ€å‘è¡¨è¯„è®ºã€‚è¯„è®ºè¦ç¬¦åˆä½ çš„äººè®¾ï¼Œå¯ä»¥æ˜¯æ„Ÿæƒ³ã€ç–‘é—®ã€èµç¾æˆ–è€…åˆ†äº«ç›¸å…³ç»å†ã€‚`;
        } else {
            systemPrompt += `ä½ è¦å¯¹ç”¨æˆ·çš„${type === 'like' ? 'ç‚¹èµ' : type === 'repost' ? 'è½¬å‘' : 'äº’åŠ¨'}åšå‡ºè‡ªç„¶å›åº”ã€‚`;
        }
        
        systemPrompt += `\n\nè¦æ±‚ï¼š
1. å›å¤è¦ç¬¦åˆæœ‹å‹åœˆè¯„è®ºçš„é£æ ¼ï¼Œç®€çŸ­ã€è‡ªç„¶
2. ä¸¥æ ¼æŒ‰ç…§ä½ çš„äººè®¾æ¥é€‰æ‹©æ˜¯å¦ä½¿ç”¨è¡¨æƒ…ç¬¦å·ï¼Œä¸è¦ä½¿ç”¨ä¸è§’è‰²æ€§æ ¼ä¸ç¬¦çš„emoji
3. ä¸è¦è¿‡äºæ­£å¼æˆ–å®¢å¥—ï¼Œè¦åƒçœŸå®çš„æœ‹å‹ä¸€æ ·äº’åŠ¨
4. åªèƒ½ä½¿ç”¨æ–‡å­—å›å¤ï¼Œä¸è¦å‘é€è¡¨æƒ…åŒ…æˆ–å›¾ç‰‡é“¾æ¥`;
        
        // æ„å»ºç”¨æˆ·æ¶ˆæ¯ï¼ŒåŒ…å«å›¾ç‰‡ä¿¡æ¯
        let userMsg;
        let hasUserImages = false;
        let userImages = [];

        if (type === 'comment_reply' || type === 'thread_reply') {
            // å¤„ç†ç”¨æˆ·è¯„è®ºå†…å®¹ï¼Œå¯èƒ½åŒ…å«è¡¨æƒ…åŒ…
            if (typeof userContent === 'string') {
                userMsg = type === 'comment_reply' ?
                    `ç”¨æˆ·åˆšåˆšè¯„è®ºäº†ï¼š"${userContent}"ã€‚è¯·åŸºäºä½ çš„äººè®¾ï¼Œè‡ªç„¶åœ°å›å¤è¿™æ¡è¯„è®ºã€‚` :
                    `è¿™æ˜¯ä¸€ä¸ªæ¥¼ä¸­æ¥¼è®¨è®ºï¼š${userContent}`;
            } else if (typeof userContent === 'object') {
                // å¤„ç†åŒ…å«è¡¨æƒ…åŒ…çš„è¯„è®º
                let textPart = '';
                let stickerPart = '';

                if (userContent.textContent) {
                    textPart = userContent.textContent;
                }

                if (userContent.stickers && userContent.stickers.length > 0) {
                    stickerPart = `ï¼Œå¹¶å‘é€äº†${userContent.stickers.length}ä¸ªè¡¨æƒ…åŒ…`;
                    // æ”¶é›†è¡¨æƒ…åŒ…å›¾ç‰‡ç”¨äºAIè¯†åˆ«
                    userContent.stickers.forEach(sticker => {
                        if (sticker.url) {
                            userImages.push({ type: 'image_url', image_url: { url: sticker.url } });
                            hasUserImages = true;
                        }
                    });
                }

                userMsg = type === 'comment_reply' ?
                    `ç”¨æˆ·åˆšåˆšè¯„è®ºäº†ï¼š"${textPart}"${stickerPart}ã€‚è¯·åŸºäºä½ çš„äººè®¾ï¼Œè‡ªç„¶åœ°å›å¤è¿™æ¡è¯„è®ºã€‚` :
                    `è¿™æ˜¯ä¸€ä¸ªæ¥¼ä¸­æ¥¼è®¨è®ºï¼š${textPart}${stickerPart}`;
            }
        } else {
            // æ„å»ºå®Œæ•´çš„åŠ¨æ€å†…å®¹æè¿°
            let postDescription = `åŸåŠ¨æ€ï¼š${post.content || post.description || ''}`;

            // å¦‚æœåŠ¨æ€åŒ…å«å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡æè¿°
            if (post.imageUrl) {
                // æ£€æŸ¥æ˜¯å¦ä¸ºBase64å›¾ç‰‡ï¼ˆç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ï¼‰
                if (post.imageUrl.startsWith('data:image/')) {
                    postDescription += `\n[è¯¥åŠ¨æ€åŒ…å«ä¸€å¼ ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ï¼Œè¯·ç»“åˆå›¾ç‰‡å†…å®¹è¿›è¡Œå›å¤]`;
                } else {
                    postDescription += `\n[è¯¥åŠ¨æ€åŒ…å«ä¸€å¼ å›¾ç‰‡]`;
                }
            }

            userMsg = `${postDescription}\nè¯·å‘è¡¨ä½ çš„çœ‹æ³•ï¼š`;
        }

        // æ„å»ºæ¶ˆæ¯æ•°ç»„ï¼Œæ”¯æŒå›¾ç‰‡è¯†åˆ«
        let messages;
        let hasPostImage = post.imageUrl && post.imageUrl.startsWith('data:image/');

        if (hasPostImage || hasUserImages) {
            // ä½¿ç”¨Vision APIæ ¼å¼
            const userContent = [{ type: 'text', text: userMsg }];

            // æ·»åŠ åŠ¨æ€å›¾ç‰‡
            if (hasPostImage) {
                userContent.push({ type: 'image_url', image_url: { url: post.imageUrl } });
            }

            // æ·»åŠ ç”¨æˆ·è¯„è®ºä¸­çš„è¡¨æƒ…åŒ…å›¾ç‰‡
            if (hasUserImages) {
                userContent.push(...userImages);
            }

            messages = [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: userContent }
            ];
        } else {
            // æ™®é€šæ–‡æœ¬æ¶ˆæ¯
            messages = [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: userMsg }
            ];
        }
        
        const requestBody = {
            model: model,
            messages: messages,
            temperature: 0.8,
            stream: false
        };
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000);
        
        // æ£€æµ‹æ˜¯å¦æ˜¯Geminiå®˜æ–¹API
        const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');
        
        let response;
        if (isGeminiOfficial) {
            // ä½¿ç”¨Geminiå®˜æ–¹APIæ ¼å¼
            const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;
            
            // è½¬æ¢æ¶ˆæ¯æ ¼å¼ä¸ºGeminiæ ¼å¼
            const geminiMessages = [];
            
            // æ·»åŠ ç³»ç»Ÿæç¤ºè¯ä½œä¸ºç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
            if (requestBody.messages[0]?.role === 'system') {
                geminiMessages.push({
                    role: 'user',
                    parts: [{ text: requestBody.messages[0].content }]
                });
                geminiMessages.push({
                    role: 'model',
                    parts: [{ text: 'æˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šæŒ‰ç…§è¿™äº›è¦æ±‚è¿›è¡Œå¯¹è¯ã€‚' }]
                });
            }
            
            // è½¬æ¢å…¶ä»–æ¶ˆæ¯
            for (let i = 1; i < requestBody.messages.length; i++) {
                const msg = requestBody.messages[i];
                if (msg.role === 'system') continue; // è·³è¿‡ç³»ç»Ÿæ¶ˆæ¯
                
                let content = '';
                if (typeof msg.content === 'string') {
                    content = msg.content;
                } else if (Array.isArray(msg.content)) {
                    content = msg.content.map(item => {
                        if (item.type === 'text') return item.text;
                        if (item.type === 'image_url') return '[å›¾ç‰‡]';
                        return '';
                    }).join('');
                }
                
                geminiMessages.push({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: content }]
                });
            }
            
            response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: geminiMessages,
                    generationConfig: {
                        temperature: requestBody.temperature || 0.8,
                        maxOutputTokens: 8192
                    }
                }),
                signal: controller.signal
            });
        } else {
            // ä½¿ç”¨OpenAIæ ¼å¼ï¼ˆæŠ±è„¸ç­‰ä»£ç†ï¼‰
            response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(requestBody),
                signal: controller.signal
            });
        }
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            let errorText = await response.text();
            throw new Error(`APIè°ƒç”¨å¤±è´¥ (${response.status}): ${errorText}`);
        }
        
        const data = await response.json();
        let content;
        
        if (isGeminiOfficial) {
            // è§£æGemini APIå“åº”
            content = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!content) {
                console.log('Gemini API å“åº”æ•°æ®:', data);
                throw new Error('Gemini APIè¿”å›äº†ç©ºå†…å®¹');
            }
        } else {
            // è§£æOpenAIæ ¼å¼å“åº”ï¼ˆåŒ…æ‹¬æŠ±è„¸ç­‰ä»£ç†ï¼‰
            if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                content = data.choices[0].message.content;
            } else if (data.message) {
                // æŸäº›ä»£ç†å¯èƒ½ç›´æ¥è¿”å›messageå­—æ®µ
                content = data.message;
            } else if (data.text) {
                // æŸäº›ä»£ç†å¯èƒ½è¿”å›textå­—æ®µ
                content = data.text;
            } else if (data.response) {
                // æŸäº›ä»£ç†å¯èƒ½è¿”å›responseå­—æ®µ
                content = data.response;
            }
            // 5. éƒ¨åˆ†ä»£ç†å¯èƒ½è¿”å›contentå­—æ®µ
            else if (data.content) {
                content = data.content;
            }
            // 6. éƒ¨åˆ†ä»£ç†å¯èƒ½è¿”å›resultå­—æ®µ
            else if (data.result) {
                content = data.result;
            }
            // 7. å°è¯•æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å€¼
            else {
                console.log('å¾®åšäº’åŠ¨APIéæ ‡å‡†å“åº”æ ¼å¼ï¼Œå°è¯•æŸ¥æ‰¾å†…å®¹:', data);
                // éå†å¯¹è±¡çš„æ‰€æœ‰é”®ï¼ŒæŸ¥æ‰¾ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²å€¼
                for (const key in data) {
                    if (typeof data[key] === 'string' && data[key].trim()) {
                        content = data[key];
                        console.log(`å¾®åšäº’åŠ¨APIä½¿ç”¨å­—æ®µ "${key}" ä½œä¸ºå“åº”å†…å®¹`);
                        break;
                    }
                }
            }
            
            if (!content) {
                console.error('å¾®åšäº’åŠ¨APIæ— æ³•è§£æå“åº”ï¼Œå®Œæ•´å“åº”æ•°æ®:', data);
                throw new Error('å¾®åšäº’åŠ¨APIè¿”å›äº†ç©ºå†…å®¹æˆ–æ— æ³•è¯†åˆ«çš„æ ¼å¼ï¼Œè¯·æ£€æŸ¥APIé…ç½®');
            }
        }
        
        const trimmedContent = content.trim();

        // æ£€æŸ¥å›å¤æ˜¯å¦åŒ…å«è¡¨æƒ…åŒ…URL
        if (STICKER_REGEX.test(trimmedContent)) {
            // å¦‚æœæ˜¯çº¯è¡¨æƒ…åŒ…URLï¼Œè¿”å›è¡¨æƒ…åŒ…æ ¼å¼
            const lines = trimmedContent.split('\n').filter(line => line.trim());
            const stickerLine = lines.find(line => STICKER_REGEX.test(line.trim()));

            if (stickerLine && lines.length === 1) {
                // çº¯è¡¨æƒ…åŒ…å›å¤ - ç›´æ¥è¿”å›URLå­—ç¬¦ä¸²ï¼Œè®©å¾®åšè¯„è®ºæ¸²æŸ“å™¨å¤„ç†
                const stickerUrl = stickerLine.trim();
                // å°è¯•ä»ç”¨æˆ·è¡¨æƒ…åŒ…ä¸­æ‰¾åˆ°å¯¹åº”çš„åç§°
                const userSticker = state.userStickers.find(s => s.url === stickerUrl);
                const stickerName = userSticker ? userSticker.name : 'è¡¨æƒ…';

                return {
                    type: 'sticker',
                    content: stickerUrl,  // ç›´æ¥è¿”å›URLå­—ç¬¦ä¸²
                    meaning: stickerName
                };
            } else {
                // åŒ…å«è¡¨æƒ…åŒ…å’Œæ–‡å­—çš„æ··åˆå›å¤ï¼Œè¿”å›æ–‡å­—éƒ¨åˆ†
                const textLines = lines.filter(line => !STICKER_REGEX.test(line.trim()));
                let result = textLines.join('\n') || trimmedContent;

                // æ›¿æ¢ç”¨æˆ·å ä½ç¬¦
                const userName = userProfileCache.name || 'æˆ‘çš„å¾®åš';
                result = result.replace(/@\{\{user\}\}/g, `@${userName}`);
                result = result.replace(/\{\{user\}\}/g, userName);

                return result;
            }
        }

        // æ›¿æ¢ç”¨æˆ·å ä½ç¬¦
        const userName = userProfileCache.name || 'æˆ‘çš„å¾®åš';
        let finalContent = trimmedContent.replace(/@\{\{user\}\}/g, `@${userName}`);
        finalContent = finalContent.replace(/\{\{user\}\}/g, userName);

        return finalContent;
    } catch (error) {
        if (error.name === 'AbortError') {
            throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
        } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
            if (proxyUrl.includes('generativelanguage.googleapis.com')) {
                throw new Error('CORSé”™è¯¯ï¼šæ— æ³•ç›´æ¥ä»æµè§ˆå™¨è®¿é—®Geminiå®˜æ–¹APIã€‚\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. ä½¿ç”¨HTTPæœåŠ¡å™¨è¿è¡Œæ­¤æ–‡ä»¶\n2. ä½¿ç”¨ä»£ç†APIæœåŠ¡\n3. åœ¨è®¾ç½®ä¸­åˆ‡æ¢åˆ°æŠ±è„¸ç­‰æ”¯æŒè·¨åŸŸçš„API');
            } else {
                throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åä»£åœ°å€æ˜¯å¦æ­£ç¡®æˆ–ç½‘ç»œè¿æ¥');
            }
        } else if (error.message.includes('CORS') || error.message.includes('Access-Control')) {
            throw new Error('CORSè·¨åŸŸé”™è¯¯ï¼šè¯·ä½¿ç”¨HTTPæœåŠ¡å™¨è¿è¡Œæ­¤æ–‡ä»¶ï¼Œæˆ–åˆ‡æ¢åˆ°æ”¯æŒè·¨åŸŸçš„APIæœåŠ¡');
        }
        throw error;
    }
}

// å‘å¸ƒAIçš„åŠ¨æ€ï¼Œæ”¯æŒå¯è§æ€§
async function publishAiPost(aiId, contentObj) {
    const ai = state.chats[aiId];
    if (!ai) return;
    let { content, visibility = 'public', imageUrl = null, imageDescription = null } = typeof contentObj === 'string' ? { content: contentObj, visibility: 'public' } : contentObj;

    // æ›¿æ¢å†…å®¹ä¸­çš„ç”¨æˆ·å ä½ç¬¦
    if (content && typeof content === 'string') {
        // è·å–ç”¨æˆ·çš„å¾®åšåç§°
        const userName = userProfileCache.name || 'æˆ‘çš„å¾®åš';

        // æ›¿æ¢ @{{user}} ä¸ºå®é™…çš„ç”¨æˆ·å
        content = content.replace(/@\{\{user\}\}/g, `@${userName}`);

        // ä¹Ÿå¤„ç†å…¶ä»–å¯èƒ½çš„å ä½ç¬¦æ ¼å¼
        content = content.replace(/\{\{user\}\}/g, userName);
    }

    const postId = Date.now();
    
    // åŸºäºAIçš„ç¤¾äº¤æ•°æ®ç”Ÿæˆåˆç†çš„äº’åŠ¨æ•°é‡
    let interactions = {
        likes: 0,
        comments: 0,
        reposts: 0
    };
    
    // å¦‚æœAIæœ‰ç¤¾äº¤ç»Ÿè®¡æ•°æ®ï¼ŒåŸºäºç²‰ä¸æ•°ç”Ÿæˆäº’åŠ¨æ•°é‡
    if (ai.settings.socialStats) {
        const { followersCount } = ai.settings.socialStats;
        
        // ç²‰ä¸è¶Šå¤šï¼Œäº’åŠ¨è¶Šå¤šï¼Œä½†ä¸æ˜¯çº¿æ€§å…³ç³»
        const followerFactor = Math.log10(followersCount + 10) / 4;
        
        interactions.likes = Math.floor(Math.random() * 20 * followerFactor + 5);
        interactions.comments = Math.floor(Math.random() * 10 * followerFactor + 2);
        interactions.reposts = Math.floor(Math.random() * 5 * followerFactor + 1);
    } else {
        // é»˜è®¤äº’åŠ¨æ•°é‡
        interactions.likes = Math.floor(Math.random() * 20 + 5);
        interactions.comments = Math.floor(Math.random() * 10 + 2);
        interactions.reposts = Math.floor(Math.random() * 5 + 1);
    }
    
    // å›¾ç‰‡å†…å®¹é€šå¸¸è·å¾—æ›´å¤šäº’åŠ¨
    if (imageUrl) {
        interactions.likes += Math.floor(Math.random() * 15 + 10);
        interactions.comments += Math.floor(Math.random() * 5 + 3);
        interactions.reposts += Math.floor(Math.random() * 3 + 1);
    }
    
    // æ ¹æ®å¯è§æ€§è°ƒæ•´äº’åŠ¨æ•°é‡
    if (visibility === 'private') {
        // ç§å¯†åŠ¨æ€æ²¡æœ‰äº’åŠ¨
        interactions.likes = 0;
        interactions.comments = 0;
        interactions.reposts = 0;
    } else if (visibility === 'friends') {
        // ä»…å¥½å‹å¯è§çš„åŠ¨æ€äº’åŠ¨è¾ƒå°‘
        interactions.likes = Math.floor(interactions.likes * 0.6);
        interactions.comments = Math.floor(interactions.comments * 0.5);
        interactions.reposts = Math.floor(interactions.reposts * 0.3);
    }
    
    await db.weiboPosts.add({
        id: postId,
        authorId: aiId,
        authorName: ai.name,
        authorAvatar: ai.settings.aiAvatar || defaultAvatar,
        authorEmail: ai.settings.aiSignature || '',
        authorSignature: ai.settings.aiSignature || '',
        content,
        imageUrl,
        imageDescription,
        visibility,
        timestamp: Date.now(),
        interactions
    });
    
    // é‡æ–°æ¸²æŸ“å¾®åšæ—¶é—´çº¿
    const currentFilter = document.querySelector('.weibo-nav .nav-item.active')?.textContent === 'â‚^Ë¶ â•¸ğ–¥¦  â•¸Ëµ^â‚âŸ†' ? 'mine' : 'all';
    await renderWeiboTimeline(currentFilter);
    
    // å¦‚æœæ˜¯AIå‘å¸ƒçš„åŠ¨æ€ï¼Œä¹Ÿè§¦å‘å…¶ä»–AIçš„äº’åŠ¨
    if (aiId !== 'user') {
        setTimeout(() => {
            triggerAiInteractionOnAiPost(postId, aiId);
        }, Math.random() * 3000 + 2000); // 2-5ç§’åè§¦å‘å…¶ä»–AIäº’åŠ¨
    }
}

// AIå¯¹AIå‘å¸ƒçš„åŠ¨æ€è¿›è¡Œäº’åŠ¨
async function triggerAiInteractionOnAiPost(postId, authorId) {
    try {
        const post = await db.weiboPosts.get(postId);
        if (!post) return;
        
        // æ£€æŸ¥åŠ¨æ€å¯è§æ€§
        if (post.visibility === 'private') {
            console.log(`è·³è¿‡AIé—´äº’åŠ¨ï¼šåŠ¨æ€æ˜¯ç§å¯†çš„`);
            return; // ç§å¯†åŠ¨æ€åªæœ‰ç”¨æˆ·èƒ½çœ‹åˆ°ï¼ŒAIä¸ä¼šäº’åŠ¨
        }
        
        // è·å–é™¤äº†å‘å¸ƒè€…å¤–çš„å…¶ä»–AIè§’è‰²
        let otherAis = Object.entries(state.chats).filter(([id, chat]) => 
            !chat.isGroup && id !== authorId
        );
        
        // å¦‚æœæ˜¯å¥½å‹å¯è§åŠ¨æ€ï¼Œä»…ä¿ç•™ç¾¤èŠå¥½å‹
        if (post.visibility === 'friends') {
            console.log(`åŠ¨æ€æ˜¯å¥½å‹å¯è§çš„ï¼Œä»…å…è®¸ç¾¤èŠå¥½å‹äº’åŠ¨`);
            otherAis = otherAis.filter(([aiId, chat]) => {
                // æ£€æŸ¥æ˜¯å¦åœ¨åŒä¸€ä¸ªç¾¤èŠä¸­
                const isInSameGroup = Object.values(state.chats)
                    .filter(c => c.isGroup)
                    .some(group => 
                        group.members && 
                        group.members.includes(aiId) && 
                        group.members.includes(authorId)
                    );
                
                if (!isInSameGroup) {
                    console.log(`${chat.name} ä¸æ˜¯ ${post.authorName} çš„ç¾¤èŠå¥½å‹ï¼Œè·³è¿‡äº’åŠ¨`);
                }
                
                return isInSameGroup;
            });
        }
        
        if (otherAis.length === 0) return;
        
        // ç­›é€‰å¯ä»¥çœ‹åˆ°è¿™æ¡åŠ¨æ€çš„AI
        let eligibleAIs = otherAis;
        
        // å¦‚æœæ˜¯å¥½å‹å¯è§åŠ¨æ€ï¼Œéœ€è¦æ£€æŸ¥æ˜¯å¦åœ¨åŒä¸€ç¾¤èŠä¸­
        if (post.visibility === 'friends') {
            eligibleAIs = [];
            for (const [aiId, ai] of otherAis) {
                const isInSameGroup = await checkIfInSameGroup(authorId, aiId);
                const isAtMentioned = (post.content || '').includes(`@${ai.name}`);
                
                if (isInSameGroup || isAtMentioned) {
                    eligibleAIs.push([aiId, ai]);
                }
            }
        }
        
        if (eligibleAIs.length === 0) {
            console.log(`æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„AIå¯ä»¥äº’åŠ¨`);
            return;
        }
        
        // éšæœºé€‰æ‹©1-2ä¸ªAIè¿›è¡Œäº’åŠ¨
        const interactingAisCount = Math.min(Math.floor(Math.random() * 2) + 1, eligibleAIs.length);
        const selectedAis = eligibleAIs.sort(() => Math.random() - 0.5).slice(0, interactingAisCount);
        
        for (const [aiId, ai] of selectedAis) {
            // 50%æ¦‚ç‡ä¸AIåŠ¨æ€äº’åŠ¨ï¼ˆæé«˜æ¦‚ç‡ä»¥å¢å¼ºè§’è‰²é—´äº’åŠ¨ï¼‰
            if (Math.random() < 0.5) {
                // éšæœºé€‰æ‹©äº’åŠ¨ç±»å‹
                const rand = Math.random();
                let interactionType;
                if (rand < 0.6) interactionType = 'comment'; // 60%æ¦‚ç‡è¯„è®º
                else if (rand < 0.9) interactionType = 'like'; // 30%æ¦‚ç‡ç‚¹èµ
                else interactionType = 'repost'; // 10%æ¦‚ç‡è½¬å‘
                
                await performAiInteraction(aiId, ai, post, interactionType);
                
                // å»¶è¿Ÿä¸€æ®µæ—¶é—´å†å¤„ç†ä¸‹ä¸€ä¸ªAI
                await new Promise(resolve => setTimeout(resolve, Math.random() * 2000 + 1000));
            }
        }
        
        // é‡æ–°æ¸²æŸ“æ—¶é—´çº¿
        await renderWeiboTimeline();
        
    } catch (error) {
        console.error('AIé—´äº’åŠ¨å¤±è´¥:', error);
    }
}

// AIè§’è‰²é—´çš„æ¥¼ä¸­æ¥¼äº’åŠ¨
async function triggerAiToAiInteraction(postId) {
    try {
        // è·å–è¯¥åŠ¨æ€ä¸‹çš„æ‰€æœ‰è¯„è®º
        const comments = await db.weiboComments
            .where('postId')
            .equals(postId)
            .reverse()
            .sortBy('timestamp');
            
        if (comments.length < 2) return; // è‡³å°‘éœ€è¦2æ¡è¯„è®ºæ‰èƒ½è§¦å‘è§’è‰²é—´äº’åŠ¨
        
        // è·å–æ‰€æœ‰å‚ä¸è¯„è®ºçš„AIè§’è‰²
        const participatingAis = [...new Set(comments
            .filter(comment => comment.authorId !== 'user')
            .map(comment => comment.authorId)
        )];
        
        if (participatingAis.length < 2) return; // è‡³å°‘éœ€è¦2ä¸ªAIè§’è‰²
        
        // éšæœºé€‰æ‹©ä¸¤ä¸ªAIè¿›è¡Œäº’åŠ¨
        const aiA = participatingAis[Math.floor(Math.random() * participatingAis.length)];
        let aiB = participatingAis[Math.floor(Math.random() * participatingAis.length)];
        
        // ç¡®ä¿é€‰æ‹©ä¸åŒçš„AI
        while (aiB === aiA && participatingAis.length > 1) {
            aiB = participatingAis[Math.floor(Math.random() * participatingAis.length)];
        }
        
        if (aiA === aiB) return;
        
        // æ£€æŸ¥è§’è‰²å…³ç³»å’Œäº’åŠ¨æ¦‚ç‡
        const shouldInteract = await checkAiRelationshipAndInteract(aiA, aiB);
        if (!shouldInteract) return;
        
        // é€‰æ‹©ä¸€ä¸ªç°æœ‰è¯„è®ºä½œä¸ºäº’åŠ¨èµ·ç‚¹
        const targetComment = comments.find(comment => 
            comment.authorId === aiA || comment.authorId === aiB
        );
        
        if (!targetComment) return;
        
        // å†³å®šè°å…ˆå›å¤è°
        const responderAi = targetComment.authorId === aiA ? aiB : aiA;
        const targetAi = targetComment.authorId;
        
        // ç”ŸæˆAIé—´çš„äº’åŠ¨å›å¤
        await generateAiToAiReply(postId, targetComment.id, responderAi, targetAi, targetComment.content);
        
    } catch (error) {
        console.error('è§’è‰²é—´äº’åŠ¨å¤±è´¥:', error);
    }
}

// æ£€æŸ¥AIè§’è‰²å…³ç³»å¹¶å†³å®šæ˜¯å¦äº’åŠ¨
async function checkAiRelationshipAndInteract(aiAId, aiBId) {
    const aiA = state.chats[aiAId];
    const aiB = state.chats[aiBId];
    
    if (!aiA || !aiB) return false;
    
    // åŸºäºäººè®¾åˆ†æè§’è‰²å…³ç³»çš„ç®€å•è§„åˆ™
    const personaA = (aiA.settings.aiPersona || '').toLowerCase();
    const personaB = (aiB.settings.aiPersona || '').toLowerCase();
    
    // åŸºç¡€äº’åŠ¨æ¦‚ç‡
    let interactionProbability = 0.4; // 40%åŸºç¡€æ¦‚ç‡ï¼Œæé«˜åŸºç¡€æ¦‚ç‡ä»¥ç¡®ä¿æ›´å¤šäº’åŠ¨
    
    // å¦‚æœè§’è‰²äººè®¾ä¸­åŒ…å«ç›¸ä¼¼çš„å…´è¶£æˆ–ç‰¹å¾ï¼Œå¢åŠ äº’åŠ¨æ¦‚ç‡
    const commonKeywords = ['å¼€æœ—', 'æ´»æ³¼', 'å‹å–„', 'æ¸©æŸ”', 'å¯çˆ±', 'èŠå¤©', 'äº¤æµ', 'æœ‹å‹'];
    const hasCommonTraits = commonKeywords.some(keyword => 
        personaA.includes(keyword) && personaB.includes(keyword)
    );
    
    if (hasCommonTraits) {
        interactionProbability += 0.3; // å¢åŠ 30%
    }
    
    // å¦‚æœè§’è‰²æ€§æ ¼äº’è¡¥ï¼Œä¹Ÿå¢åŠ äº’åŠ¨æ¦‚ç‡
    const complementaryPairs = [
        ['å†…å‘', 'å¤–å‘'],
        ['å®‰é™', 'æ´»æ³¼'],
        ['ä¸¥è‚ƒ', 'å¹½é»˜'],
        ['ç†æ€§', 'æ„Ÿæ€§']
    ];
    
    const isComplementary = complementaryPairs.some(([traitA, traitB]) =>
        (personaA.includes(traitA) && personaB.includes(traitB)) ||
        (personaA.includes(traitB) && personaB.includes(traitA))
    );
    
    if (isComplementary) {
        interactionProbability += 0.2; // å¢åŠ 20%
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å…±åŒçš„ç¾¤èŠ
    const aiAGroups = Object.values(state.chats).filter(chat => 
        chat.isGroup && chat.members && chat.members.some(m => m.name === aiA.name)
    );
    
    const aiBGroups = Object.values(state.chats).filter(chat => 
        chat.isGroup && chat.members && chat.members.some(m => m.name === aiB.name)
    );
    
    // æŸ¥æ‰¾å…±åŒçš„ç¾¤èŠ
    const commonGroups = aiAGroups.filter(groupA => 
        aiBGroups.some(groupB => groupB.id === groupA.id)
    );
    
    // å¦‚æœåœ¨åŒä¸€ä¸ªç¾¤èŠä¸­ï¼Œå¢åŠ äº’åŠ¨æ¦‚ç‡
    if (commonGroups.length > 0) {
        interactionProbability += 0.2; // å¢åŠ 20%ï¼Œç¾¤èŠä¸­çš„è§’è‰²æ›´å®¹æ˜“äº’åŠ¨
    }
    
    return Math.random() < Math.min(interactionProbability, 0.9); // æœ€é«˜90%æ¦‚ç‡ï¼Œæé«˜ä¸Šé™
}

// ç”ŸæˆAIé—´çš„å›å¤
async function generateAiToAiReply(postId, commentId, responderAiId, targetAiId, targetContent) {
    const responderAi = state.chats[responderAiId];
    const targetAi = state.chats[targetAiId];
    
    if (!responderAi || !targetAi) return;
    
    try {
        const post = await db.weiboPosts.get(postId);
        if (!post) return;
        
        // è·å–è¯„è®ºä¸Šä¸‹æ–‡
        const comment = await db.weiboComments.get(commentId);
        if (!comment) return;
        
        // æ„å»ºAIé—´äº’åŠ¨çš„æç¤ºè¯
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) return;
        
        const responderPersona = responderAi.settings?.aiPersona || '';
        const targetPersona = targetAi.settings?.aiPersona || '';
        
        // è·å–ç»‘å®šçš„ä¸–ç•Œä¹¦å†…å®¹
        let worldBookContent = '';
        if (responderAi.settings.linkedWorldBookIds && responderAi.settings.linkedWorldBookIds.length > 0) {
            const worldBooks = await Promise.all(
                responderAi.settings.linkedWorldBookIds.map(id => db.worldBooks.get(id))
            );
            const validWorldBooks = worldBooks.filter(book => book && book.content);
            if (validWorldBooks.length > 0) {
                worldBookContent = '\n\nä¸–ç•Œä¹¦å†…å®¹ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n' + 
                    validWorldBooks.map(book => `${book.name}ï¼š${book.content}`).join('\n\n');
            }
        }
        
        const systemPrompt = `ä½ æ˜¯${responderAi.name}ï¼Œä½ çš„äººè®¾å¦‚ä¸‹ï¼š${responderPersona}ã€‚${worldBookContent}

ç°åœ¨åœ¨ä¸€ä¸ªå¾®åšåŠ¨æ€ä¸‹ï¼Œ${targetAi.name}ï¼ˆäººè®¾ï¼š${targetPersona}ï¼‰åˆšåˆšè¯„è®ºäº†ï¼š"${targetContent}"ã€‚

åŸåŠ¨æ€å†…å®¹ï¼š${post.content}

ä½ è¦ä½œä¸º${responderAi.name}ï¼ŒåŸºäºä½ çš„äººè®¾å’Œä¸${targetAi.name}çš„å…³ç³»ï¼Œå¯¹taçš„è¯„è®ºè¿›è¡Œå›åº”ã€‚è¦æ±‚ï¼š
1. ä¸¥æ ¼æŒ‰ç…§ä½ çš„äººè®¾è¿›è¡Œå›å¤ï¼Œä¸èƒ½æ··æ·†è§’è‰²
2. å›å¤è¦è‡ªç„¶ã€ç¬¦åˆå¾®åšè¯„è®ºé£æ ¼
3. å¯ä»¥æ˜¯èµåŒã€ä¸åŒè§‚ç‚¹ã€è¡¥å……ã€æé—®æˆ–å¼€ç©ç¬‘
4. è¦ä½“ç°å‡ºä½ å’Œ${targetAi.name}ä¹‹é—´çš„äº’åŠ¨å…³ç³»
5. å›å¤ç®€çŸ­æœ‰è¶£ï¼Œç¬¦åˆç¤¾äº¤åª’ä½“çš„ç‰¹ç‚¹
6. æ ¹æ®ä½ çš„äººè®¾é€‰æ‹©åˆé€‚çš„è¯­æ°”å’Œç”¨è¯
7. ä¸è¦ä½¿ç”¨ä¸è§’è‰²æ€§æ ¼ä¸ç¬¦çš„è¡¨æƒ…ç¬¦å·`;

        const messages = [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: `è¯·å›å¤${targetAi.name}çš„è¯„è®º` }
        ];

        // ä½¿ç”¨ç»Ÿä¸€çš„APIè°ƒç”¨å‡½æ•°
        async function callUnifiedAPI(url, key, model, messages) {
            const isGemini = url.includes('generativelanguage.googleapis.com');
            
            if (isGemini) {
                // Gemini API æ ¼å¼
                const apiUrl = `${url}/models/${model}:generateContent?key=${key}`;
                
                // è½¬æ¢æ¶ˆæ¯æ ¼å¼ä¸ºGeminiæ ¼å¼
                const geminiMessages = [];
                
                // æ·»åŠ ç³»ç»Ÿæç¤ºè¯ä½œä¸ºç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
                if (messages[0]?.role === 'system') {
                    geminiMessages.push({
                        role: 'user',
                        parts: [{ text: messages[0].content }]
                    });
                    geminiMessages.push({
                        role: 'model',
                        parts: [{ text: 'æˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šæŒ‰ç…§è¿™äº›è¦æ±‚è¿›è¡Œå¯¹è¯ã€‚' }]
                    });
                }
                
                // è½¬æ¢å…¶ä»–æ¶ˆæ¯
                for (let i = 1; i < messages.length; i++) {
                    const msg = messages[i];
                    if (msg.role === 'system') continue;
                    
                    let content = '';
                    if (typeof msg.content === 'string') {
                        content = msg.content;
                    } else if (Array.isArray(msg.content)) {
                        content = msg.content.map(item => {
                            if (item.type === 'text') return item.text;
                            if (item.type === 'image_url') return '[å›¾ç‰‡]';
                            return '';
                        }).join('');
                    }
                    
                    geminiMessages.push({
                        role: msg.role === 'user' ? 'user' : 'model',
                        parts: [{ text: content }]
                    });
                }
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: geminiMessages,
                        generationConfig: {
                            temperature: 0.8,
                            maxOutputTokens: 8192
                        }
                    })
                });
                
                if (!response.ok) {
                    console.log('Gemini API è¯·æ±‚å¤±è´¥:', response.status, response.statusText);
                    return null;
                }
                
                const data = await response.json();
                const content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!content) {
                    console.log('Gemini API å“åº”æ•°æ®:', data);
                }
                return content;
                
            } else {
                // OpenAI API æ ¼å¼ï¼ˆåŒ…æ‹¬æŠ±è„¸ç­‰ä»£ç†ï¼‰
                const response = await fetch(`${url}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'system', content: systemPrompt }, ...messages],
                        temperature: 0.75,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
                const data = await response.json();
                
                // å¢å¼ºå¯¹ä¸åŒAPIå“åº”æ ¼å¼çš„å…¼å®¹æ€§
                let content = null;
                
                // 1. æ ‡å‡†OpenAIæ ¼å¼
                if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                    content = data.choices[0].message.content;
                }
                // 2. éƒ¨åˆ†ä»£ç†å¯èƒ½ç›´æ¥è¿”å›messageå­—æ®µ
                else if (data.message) {
                    content = data.message;
                }
                // 3. éƒ¨åˆ†ä»£ç†å¯èƒ½è¿”å›textå­—æ®µ
                else if (data.text) {
                    content = data.text;
                }
                // 4. éƒ¨åˆ†ä»£ç†å¯èƒ½è¿”å›responseå­—æ®µ
                else if (data.response) {
                    content = data.response;
                }
                // 5. éƒ¨åˆ†ä»£ç†å¯èƒ½è¿”å›contentå­—æ®µ
                else if (data.content) {
                    content = data.content;
                }
                // 6. éƒ¨åˆ†ä»£ç†å¯èƒ½è¿”å›resultå­—æ®µ
                else if (data.result) {
                    content = data.result;
                }
                // 7. å°è¯•æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å€¼
                else {
                    console.log('AIé—´äº’åŠ¨APIéæ ‡å‡†å“åº”æ ¼å¼ï¼Œå°è¯•æŸ¥æ‰¾å†…å®¹:', data);
                    // éå†å¯¹è±¡çš„æ‰€æœ‰é”®ï¼ŒæŸ¥æ‰¾ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²å€¼
                    for (const key in data) {
                        if (typeof data[key] === 'string' && data[key].trim()) {
                            content = data[key];
                            console.log(`AIé—´äº’åŠ¨APIä½¿ç”¨å­—æ®µ "${key}" ä½œä¸ºå“åº”å†…å®¹`);
                            break;
                        }
                    }
                }
                
                if (!content) {
                    console.error('AIé—´äº’åŠ¨APIæ— æ³•è§£æå“åº”ï¼Œå®Œæ•´å“åº”æ•°æ®:', data);
                    throw new Error('AIé—´äº’åŠ¨APIè¿”å›äº†ç©ºå†…å®¹æˆ–æ— æ³•è¯†åˆ«çš„æ ¼å¼ï¼Œè¯·æ£€æŸ¥APIé…ç½®');
                }

                // æ›¿æ¢ç”¨æˆ·å ä½ç¬¦
                const userName = userProfileCache.name || 'æˆ‘çš„å¾®åš';
                content = content.replace(/@\{\{user\}\}/g, `@${userName}`);
                content = content.replace(/\{\{user\}\}/g, userName);

                // å°†å›å¤æ·»åŠ åˆ°è¯„è®ºä¸­
                if (!comment.replies) comment.replies = [];
                if (comment.replies.length < 7) {
                    comment.replies.push({
                        id: Date.now(),
                        authorId: responderAiId,
                        content: content,
                        timestamp: Date.now(),
                        replyTo: targetAi.name
                    });

                    await db.weiboComments.put(comment);
                    await renderWeiboTimeline();
                }

                return content;
            }
        }
    } catch (error) {
        console.error('ç”ŸæˆAIé—´å›å¤å¤±è´¥:', error);
    }
}

// ä¸“é—¨ç”¨äºé€šè¯çš„ç»Ÿä¸€APIè°ƒç”¨å‡½æ•°
async function callUnifiedAPIForCall(url, key, model, messages) {
    const isGemini = url.includes('generativelanguage.googleapis.com');

    if (isGemini) {
        // Gemini API æ ¼å¼
        const apiUrl = `${url}/models/${model}:generateContent?key=${key}`;

        // è½¬æ¢æ¶ˆæ¯æ ¼å¼ä¸ºGeminiæ ¼å¼
        const geminiMessages = [];

        // æ·»åŠ ç³»ç»Ÿæç¤ºè¯ä½œä¸ºç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
        if (messages[0]?.role === 'system') {
            geminiMessages.push({
                role: 'user',
                parts: [{ text: messages[0].content }]
            });
            geminiMessages.push({
                role: 'model',
                parts: [{ text: 'æˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šæŒ‰ç…§è¿™äº›è¦æ±‚è¿›è¡Œå¯¹è¯ã€‚' }]
            });
        }

        // è½¬æ¢å…¶ä»–æ¶ˆæ¯
        for (let i = 1; i < messages.length; i++) {
            const msg = messages[i];
            let content = '';

            if (typeof msg.content === 'string') {
                content = msg.content;
            } else if (Array.isArray(msg.content)) {
                content = msg.content.map(item => {
                    if (item.type === 'text') return item.text;
                    if (item.type === 'image_url') return '[å›¾ç‰‡]';
                    return '';
                }).join('');
            }

            geminiMessages.push({
                role: msg.role === 'user' ? 'user' : 'model',
                parts: [{ text: content }]
            });
        }

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: geminiMessages,
                generationConfig: {
                    temperature: 0.8,
                    maxOutputTokens: 8192
                }
            })
        });

        if (!response.ok) {
            console.log('Gemini API é€šè¯è¯·æ±‚å¤±è´¥:', response.status, response.statusText);
            return null;
        }

        const data = await response.json();
        const content = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!content) {
            console.log('Gemini API é€šè¯å“åº”æ•°æ®:', data);
            return null;
        }
        return content;

    } else {
        // OpenAI API æ ¼å¼ï¼ˆåŒ…æ‹¬æŠ±è„¸ç­‰ä»£ç†ï¼‰
        const response = await fetch(`${url}/v1/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${key}`
            },
            body: JSON.stringify({
                model: model,
                messages: messages,
                temperature: 0.8,
                stream: false
            })
        });

        if (!response.ok) {
            console.log('OpenAIæ ¼å¼API é€šè¯è¯·æ±‚å¤±è´¥:', response.status, response.statusText);
            return null;
        }

        const data = await response.json();

        // å¢å¼ºå¯¹ä¸åŒAPIå“åº”æ ¼å¼çš„å…¼å®¹æ€§
        let content = null;

        // 1. æ ‡å‡†OpenAIæ ¼å¼
        if (data.choices && data.choices.length > 0 && data.choices[0].message) {
            content = data.choices[0].message.content;
        }
        // 2. éƒ¨åˆ†ä»£ç†å¯èƒ½ç›´æ¥è¿”å›messageå­—æ®µ
        else if (data.message) {
            content = data.message;
        }
        // 3. éƒ¨åˆ†ä»£ç†å¯èƒ½è¿”å›textå­—æ®µ
        else if (data.text) {
            content = data.text;
        }
        // 4. éƒ¨åˆ†ä»£ç†å¯èƒ½è¿”å›responseå­—æ®µ
        else if (data.response) {
            content = data.response;
        }
        // 5. éƒ¨åˆ†ä»£ç†å¯èƒ½è¿”å›contentå­—æ®µ
        else if (data.content) {
            content = data.content;
        }
        // 6. éƒ¨åˆ†ä»£ç†å¯èƒ½è¿”å›resultå­—æ®µ
        else if (data.result) {
            content = data.result;
        }

        if (!content) {
            console.error('é€šè¯APIæ— æ³•è§£æå“åº”ï¼Œå®Œæ•´å“åº”æ•°æ®:', data);
            return null;
        }

        return content.trim();
    }
}

// AIåå‡»å›å¤
async function generateAiCounterReply(postId, commentId, responderAiId, targetAiId, targetReplyContent) {
    const responderAi = state.chats[responderAiId];
    const targetAi = state.chats[targetAiId];
    
    if (!responderAi || !targetAi) return;
    
    try {
        const comment = await db.weiboComments.get(commentId);
        if (!comment || !comment.replies || comment.replies.length >= 7) return;
        
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) return;
        
        const responderPersona = responderAi.settings?.aiPersona || '';
        
        const systemPrompt = `ä½ æ˜¯${responderAi.name}ï¼Œä½ çš„äººè®¾å¦‚ä¸‹ï¼š${responderPersona}ã€‚

åˆšåˆš${targetAi.name}å›å¤äº†ä½ ï¼š"${targetReplyContent}"ã€‚

ä½ è¦ä½œä¸º${responderAi.name}ï¼ŒåŸºäºä½ çš„äººè®¾å¯¹è¿™ä¸ªå›å¤åšå‡ºååº”ã€‚è¦æ±‚ï¼š
1. ä¸¥æ ¼æŒ‰ç…§ä½ çš„äººè®¾è¿›è¡Œå›å¤
2. å¯ä»¥æ˜¯ç»§ç»­è®¨è®ºã€å¼€ç©ç¬‘ã€è°ƒä¾ƒæˆ–ç»“æŸè¯é¢˜
3. ä¿æŒç®€çŸ­æœ‰è¶£
4. ä½“ç°ä½ çš„æ€§æ ¼ç‰¹ç‚¹`;

        const messages = [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: `è¯·å¯¹${targetAi.name}çš„å›å¤åšå‡ºååº”` }
        ];

        // ä½¿ç”¨ç»Ÿä¸€çš„APIè°ƒç”¨
        let counterReplyContent = await callUnifiedAPI(proxyUrl, apiKey, model, messages);

        if (counterReplyContent) {
            // æ›¿æ¢ç”¨æˆ·å ä½ç¬¦
            const userName = userProfileCache.name || 'æˆ‘çš„å¾®åš';
            counterReplyContent = counterReplyContent.replace(/@\{\{user\}\}/g, `@${userName}`);
            counterReplyContent = counterReplyContent.replace(/\{\{user\}\}/g, userName);

            comment.replies.push({
                id: Date.now(),
                authorId: responderAiId,
                content: counterReplyContent,
                timestamp: Date.now(),
                replyTo: targetAi.name
            });
            
            await db.weiboComments.put(comment);
            await renderWeiboTimeline();
        }
        
    } catch (error) {
        console.error('ç”ŸæˆAIåå‡»å›å¤å¤±è´¥:', error);
    }
}

// æ‰§è¡ŒAIäº’åŠ¨çš„é€šç”¨å‡½æ•°
async function performAiInteraction(aiId, ai, post, interactionType) {
    try {
        if (interactionType === 'comment') {
            const commentResponse = await generateAiResponse(ai, 'comment', post, '');
            if (commentResponse) {
                const commentId = Date.now() + Math.random();
                const commentData = {
                    id: commentId,
                    postId: post.id,
                    authorId: aiId,
                    timestamp: Date.now(),
                    replies: []
                };

                // å¤„ç†è¡¨æƒ…åŒ…æ ¼å¼çš„å›å¤
                if (typeof commentResponse === 'object' && commentResponse.type === 'sticker') {
                    commentData.content = commentResponse.content;
                    commentData.meaning = commentResponse.meaning;
                } else {
                    commentData.content = commentResponse;
                }

                await db.weiboComments.add(commentData);
            }
        } else if (interactionType === 'like') {
            await db.weiboLikes.add({
                postId: post.id,
                authorId: aiId,
                timestamp: Date.now()
            });
        } else if (interactionType === 'repost') {
            const repostResponse = await generateAiResponse(ai, 'repost', post, '');
            if (repostResponse) {
                const repostPost = {
                    id: Date.now() + Math.random(),
                    authorId: aiId,
                    authorName: ai.name,
                    authorAvatar: ai.settings.aiAvatar || defaultAvatar,
                    authorEmail: ai.settings.aiSignature || '',
                    authorSignature: ai.settings.aiSignature || '',
                    content: repostResponse,
                    visibility: 'public',
                    timestamp: Date.now(),
                    isRepost: true,
                    originalPostId: post.id
                };
                
                await db.weiboPosts.add(repostPost);
                await db.weiboReposts.add({
                    id: Date.now() + Math.random(),
                    originalPostId: post.id,
                    authorId: aiId,
                    content: repostResponse,
                    timestamp: Date.now()
                });
            }
        }
    } catch (error) {
        console.error(`AI ${interactionType} å¤±è´¥:`, error);
    }
}

// å¾®åšå¤šé€‰åˆ é™¤åŠŸèƒ½
function enterWeiboSelectionMode() {
    if (isWeiboSelectionMode) return;
    isWeiboSelectionMode = true;
    window.isWeiboSelectionMode = true;
    document.getElementById('weibo-screen').classList.add('weibo-selection-mode');
    document.getElementById('weibo-selection-toolbar').classList.add('visible');
    updateWeiboSelectionToolbar();
}

function exitWeiboSelectionMode() {
    if (!isWeiboSelectionMode) return;
    isWeiboSelectionMode = false;
    window.isWeiboSelectionMode = false;

    const weiboScreen = document.getElementById('weibo-screen');
    const selectionToolbar = document.getElementById('weibo-selection-toolbar');

    if (weiboScreen) {
        weiboScreen.classList.remove('weibo-selection-mode');
    }
    if (selectionToolbar) {
        selectionToolbar.classList.remove('visible');
    }

    // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
    selectedWeiboPosts.forEach(postId => {
        const postElement = document.querySelector(`.weibo-post[data-post-id="${postId}"]`);
        if (postElement) {
            postElement.classList.remove('selected');
        }
    });
    selectedWeiboPosts.clear();
    window.selectedWeiboPosts = selectedWeiboPosts;

    // æ›´æ–°å·¥å…·æ æ˜¾ç¤º
    updateWeiboSelectionToolbar();
}

function toggleWeiboPostSelection(postId) {
    const postElement = document.querySelector(`.weibo-post[data-post-id="${postId}"]`);
    if (!postElement) return;
    
    if (selectedWeiboPosts.has(postId)) {
        selectedWeiboPosts.delete(postId);
        postElement.classList.remove('selected');
    } else {
        selectedWeiboPosts.add(postId);
        postElement.classList.add('selected');
    }
    
    updateWeiboSelectionToolbar();
    
    // å¦‚æœæ²¡æœ‰é€‰ä¸­é¡¹ï¼Œé€€å‡ºé€‰æ‹©æ¨¡å¼
    if (selectedWeiboPosts.size === 0) {
        exitWeiboSelectionMode();
    }
}

function updateWeiboSelectionToolbar() {
    const countElement = document.querySelector('.weibo-selection-toolbar .selection-count');
    if (countElement) {
        countElement.textContent = `å·²é€‰æ‹© ${selectedWeiboPosts.size} æ¡åŠ¨æ€`;
    }
}

async function deleteSelectedWeiboPosts() {
    if (selectedWeiboPosts.size === 0) return;

    const confirmed = await showCustomConfirm(
        'åˆ é™¤åŠ¨æ€',
        `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedWeiboPosts.size} æ¡åŠ¨æ€å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        try {
            // ä¸€æ¬¡æ€§è·å–æ‰€æœ‰å¾®åšï¼Œæé«˜æ•ˆç‡
            const allPosts = await db.weiboPosts.toArray();

            // åˆ é™¤é€‰ä¸­çš„åŠ¨æ€
            for (const postId of selectedWeiboPosts) {
                // ä¿æŒåŸå§‹IDæ ¼å¼ï¼Œä¸è¦è½¬æ¢ä¸ºæ•´æ•°
                const originalPostId = postId;
                const numericPostId = parseFloat(postId); // ä½¿ç”¨parseFloatè€Œä¸æ˜¯parseInt

                // ä»ç¼“å­˜ä¸­æŸ¥æ‰¾å¾®åšä¿¡æ¯
                const post = allPosts.find(p => p.id === numericPostId);

                if (post) {
                    // å¾®åšå­˜åœ¨ï¼Œæ‰§è¡Œå®Œæ•´åˆ é™¤æµç¨‹
                    console.log(`åˆ é™¤å¾®åš: ${numericPostId}`);

                    // å¦‚æœè¿™æ˜¯ä¸€ä¸ªè½¬å‘åŠ¨æ€ï¼Œå…ˆåˆ é™¤å¯¹åº”çš„è½¬å‘è®°å½•
                    if (post.isRepost && post.originalPostId) {
                        // åˆ é™¤è½¬å‘è®°å½• - ä½¿ç”¨æ­£ç¡®çš„æŸ¥è¯¢æ–¹å¼
                        await db.weiboReposts
                            .where('originalPostId').equals(post.originalPostId)
                            .and(repost => repost.authorId === post.authorId)
                            .delete();
                    }

                    // åˆ é™¤ä»¥æ­¤åŠ¨æ€ä¸ºåŸåŠ¨æ€çš„æ‰€æœ‰è½¬å‘åŠ¨æ€
                    const repostPosts = allPosts.filter(p => p.isRepost && p.originalPostId === numericPostId);
                    for (const repostPost of repostPosts) {
                        await db.weiboPosts.delete(repostPost.id);
                        // åˆ é™¤è½¬å‘åŠ¨æ€çš„ç›¸å…³æ•°æ®
                        await db.weiboComments.where('postId').equals(repostPost.id).delete();
                        await db.weiboLikes.where('postId').equals(repostPost.id).delete();
                    }

                    // åˆ é™¤ä¸»åŠ¨æ€
                    await db.weiboPosts.delete(numericPostId);
                } else {
                    // å¾®åšåœ¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨ï¼Œä½†å¯èƒ½åœ¨ç•Œé¢ä¸Šè¿˜æœ‰æ®‹ç•™
                    console.log(`å¾®åš ${numericPostId} åœ¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨ï¼Œæ¸…ç†ç•Œé¢æ®‹ç•™`);
                }

                // æ— è®ºå¾®åšæ˜¯å¦å­˜åœ¨ï¼Œéƒ½è¦æ¸…ç†ç›¸å…³æ•°æ®å’Œç•Œé¢å…ƒç´ 
                await db.weiboComments.where('postId').equals(numericPostId).delete();
                await db.weiboLikes.where('postId').equals(numericPostId).delete();
                await db.weiboReposts.where('originalPostId').equals(numericPostId).delete();

                // ç«‹å³ä»ç•Œé¢ä¸Šç§»é™¤å¯¹åº”çš„DOMå…ƒç´ 
                // ä½¿ç”¨åŸå§‹IDæŸ¥æ‰¾å…ƒç´ 
                let postElement = document.querySelector(`.weibo-post[data-post-id="${originalPostId}"]`);
                if (!postElement) {
                    postElement = document.querySelector(`[data-post-id="${originalPostId}"]`);
                }
                if (!postElement) {
                    // éå†æ‰€æœ‰å¾®åšå…ƒç´ æŸ¥æ‰¾åŒ¹é…çš„ID
                    const allPosts = document.querySelectorAll('.weibo-post');
                    for (const el of allPosts) {
                        if (el.dataset.postId == originalPostId) {
                            postElement = el;
                            break;
                        }
                    }
                }

                if (postElement) {
                    postElement.remove();
                }
            }

            exitWeiboSelectionMode();

            // é¢å¤–æ¸…ç†ï¼šç§»é™¤æ‰€æœ‰å¯èƒ½æ®‹ç•™çš„é€‰ä¸­å¾®åšå…ƒç´ 
            selectedWeiboPosts.forEach(postId => {
                // å°è¯•å¤šç§é€‰æ‹©å™¨ç¡®ä¿èƒ½æ‰¾åˆ°å…ƒç´ 
                let postElement = document.querySelector(`.weibo-post[data-post-id="${postId}"]`);
                if (!postElement) {
                    postElement = document.querySelector(`[data-post-id="${postId}"]`);
                }
                if (!postElement) {
                    // éå†æ‰€æœ‰å¾®åšå…ƒç´ æŸ¥æ‰¾åŒ¹é…çš„ID
                    const allPosts = document.querySelectorAll('.weibo-post');
                    for (const el of allPosts) {
                        if (el.dataset.postId == postId) {
                            postElement = el;
                            break;
                        }
                    }
                }

                if (postElement) {
                    postElement.remove();
                }
            });

            // å¼ºåŠ›æ¸…ç†ï¼šç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€çš„å…ƒç´ 
            const selectedElements = document.querySelectorAll('.weibo-post.selected');
            selectedElements.forEach(el => {
                el.remove();
            });

            // æ¸…ç©ºæ—¶é—´çº¿å®¹å™¨ï¼Œå¼ºåˆ¶é‡æ–°æ¸²æŸ“
            const timeline = document.getElementById('weibo-timeline');
            if (timeline) {
                timeline.innerHTML = '';
            }

            // å¼ºåˆ¶ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿DOMæ›´æ–°å®Œæˆ
            await new Promise(resolve => setTimeout(resolve, 100));

            // é‡æ–°æ¸²æŸ“æ—¶é—´çº¿
            const currentFilter = document.querySelector('.weibo-nav .nav-item.active')?.textContent === 'â‚^Ë¶ â•¸ğ–¥¦  â•¸Ëµ^â‚âŸ†' ? 'mine' : 'all';
            console.log(`é‡æ–°æ¸²æŸ“æ—¶é—´çº¿ï¼Œè¿‡æ»¤å™¨: ${currentFilter}`);
            await renderWeiboTimeline(currentFilter);

            showToast('åˆ é™¤æˆåŠŸï¼', 'success');
        } catch (error) {
            console.error('åˆ é™¤åŠ¨æ€å¤±è´¥:', error);
            showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
        }
    }
}
        
        function renderChatInterface(chatId) { 
            const chat = state.chats[chatId]; 
            if (!chat) return; 
            exitSelectionMode(); 
            const messagesContainer = document.getElementById('chat-messages'); 
            messagesContainer.dataset.theme = chat.settings.theme || 'default'; 
            document.getElementById('chat-header-title').textContent = chat.name; 
            messagesContainer.innerHTML = ''; 
            const chatScreen = document.getElementById('chat-interface-screen'); 
            chatScreen.style.backgroundImage = chat.settings.background ? `url(${chat.settings.background})` : 'none'; 
            chatScreen.style.backgroundColor = chat.settings.background ? 'transparent' : '#f0f2f5'; 
            const history = chat.history; 
            const totalMessages = history.length; 
            currentRenderedCount = 0; 
            const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW); 
            
            // åœ¨åˆå§‹åŠ è½½æ—¶ä¹Ÿæ·»åŠ æ—¶é—´åˆ†éš”ç¬¦
            let lastTimestamp = 0;
            
            // æŒ‰ç…§æ—¶é—´æˆ³æ’åºæ¶ˆæ¯ï¼Œç¡®ä¿æ’¤å›æ¶ˆæ¯åœ¨æ­£ç¡®çš„ä½ç½®
            const sortedMessages = [...initialMessages].sort((a, b) => {
                // å¦‚æœæ˜¯æ’¤å›æ¶ˆæ¯ï¼Œä½¿ç”¨åŸå§‹æ—¶é—´æˆ³è¿›è¡Œæ’åº
                const timestampA = a.type === 'recalled_message' && a.originalTimestamp ? a.originalTimestamp : a.timestamp;
                const timestampB = b.type === 'recalled_message' && b.originalTimestamp ? b.originalTimestamp : b.timestamp;
                return timestampA - timestampB;
            });
            
            // ç„¶åæŒ‰é¡ºåºæ¸²æŸ“æ¶ˆæ¯
            sortedMessages.forEach((msg, index) => {
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ—¶é—´åˆ†éš”ç¬¦ï¼ˆé—´éš”5åˆ†é’Ÿï¼‰
                if (index > 0 && msg.timestamp - lastTimestamp >= 300000) {
                    const timeSeparator = document.createElement('div');
                    timeSeparator.className = 'time-separator';
                    const timeString = new Date(msg.timestamp).toLocaleTimeString('zh-CN', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                    timeSeparator.textContent = timeString;
                    messagesContainer.appendChild(timeSeparator);
                }
                
                // æ‰€æœ‰æ¶ˆæ¯éƒ½éœ€è¦æ˜¾ç¤ºï¼ŒåŒ…æ‹¬æ’¤å›æ¶ˆæ¯
                appendMessage(msg, chat, true);
                
                lastTimestamp = msg.timestamp;
            });
            
            currentRenderedCount = initialMessages.length; 
            
            if (totalMessages > currentRenderedCount) { 
                prependLoadMoreButton(messagesContainer); 
            } 
            
            const typingIndicator = document.createElement('div'); 
            typingIndicator.id = 'typing-indicator'; 
            typingIndicator.style.display = 'none'; 
            typingIndicator.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...'; 
            messagesContainer.appendChild(typingIndicator); 
            
            setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0); 
            
            // å¤„ç†AIå¿ƒç‡æ˜¾ç¤º
            updateAiHeartrate(chat);

            // å¤„ç†AIçŠ¶æ€æ°”æ³¡æ˜¾ç¤º
            updateAiStatusBubble(chat);
        }
        function prependLoadMoreButton(container) { const button = document.createElement('button'); button.id = 'load-more-btn'; button.textContent = 'åŠ è½½æ›´æ—©çš„è®°å½•'; button.addEventListener('click', loadMoreMessages); container.prepend(button); }
        function loadMoreMessages() { const messagesContainer = document.getElementById('chat-messages'); const chat = state.chats[state.activeChatId]; if (!chat) return; const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) loadMoreBtn.remove(); const totalMessages = chat.history.length; const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW; const nextSliceEnd = totalMessages - currentRenderedCount; const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd); const oldScrollHeight = messagesContainer.scrollHeight; messagesToPrepend.reverse().forEach(msg => prependMessage(msg, chat)); currentRenderedCount += messagesToPrepend.length; const newScrollHeight = messagesContainer.scrollHeight; messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight); if (totalMessages > currentRenderedCount) { prependLoadMoreButton(messagesContainer); } }
        
        async function renderWallpaperScreen() {
            const preview = document.getElementById('wallpaper-preview');

            // ä¼˜å…ˆæ˜¾ç¤ºæ–°ä¸Šä¼ çš„å£çº¸ï¼Œå¦åˆ™ä»DexieåŠ è½½å½“å‰å£çº¸
            let bg = newWallpaperBase64;
            if (!bg) {
                const wallpaperData = await db.wallpapers.get('current_wallpaper');
                bg = wallpaperData ? wallpaperData.data : state.globalSettings.wallpaper;
            }

            if (bg && bg.startsWith('data:image')) {
                preview.style.backgroundImage = `url(${bg})`;
                preview.textContent = '';
            } else if(bg) {
                preview.style.backgroundImage = bg;
                preview.textContent = 'å½“å‰ä¸ºæ¸å˜è‰²';
            }

            // è®¾ç½®å›¾æ ‡ä½ç½®é€‰æ‹©å™¨çš„å½“å‰å€¼
            const iconPositionSelect = document.getElementById('icon-position');
            if (iconPositionSelect) {
                iconPositionSelect.value = state.globalSettings.iconPosition || 'center';
            }

            // è®¾ç½®å­—å·é€‰æ‹©å™¨çš„å½“å‰å€¼
            const fontSizeSelect = document.getElementById('font-size-select');
            if (fontSizeSelect) {
                fontSizeSelect.value = state.globalSettings.fontSize || 'medium';
            }

            // è®¾ç½®æ— è¾¹æ¡†æ¨¡å¼å¼€å…³çš„å½“å‰å€¼
            const borderlessToggle = document.getElementById('borderless-mode-toggle');
            if (borderlessToggle) {
                borderlessToggle.checked = state.globalSettings.borderlessMode || false;
            }

            // æ¸²æŸ“è‡ªå®šä¹‰å›¾æ ‡ç½‘æ ¼
            renderCustomIconsGrid();

            // è®¾ç½®è‡ªå®šä¹‰æ ·å¼è¾“å…¥æ¡†çš„å½“å‰å€¼
            const customBubbleCSSTextarea = document.getElementById('custom-bubble-css');
            if (customBubbleCSSTextarea) {
                customBubbleCSSTextarea.value = state.globalSettings.customBubbleCSS || '';
            }

            const customFontUrlInput = document.getElementById('custom-font-url');
            if (customFontUrlInput) {
                customFontUrlInput.value = state.globalSettings.customFontUrl || '';
            }


        }
        
        function renderCustomIconsGrid() {
            const grid = document.getElementById('custom-icons-grid');
            grid.innerHTML = '';
            
            // å®šä¹‰é»˜è®¤çš„åº”ç”¨å›¾æ ‡åˆ—è¡¨
            const defaultIcons = [
                { id: 'chat', name: 'èŠå¤©', defaultIcon: 'https://i.postimg.cc/SxXGmXZY/IMG-3079.jpg' },
                { id: 'weibo', name: 'å¾®åš', defaultIcon: 'https://i.postimg.cc/0yjnBhH6/IMG-3080.jpg' },
                { id: 'wallpaper', name: 'å£çº¸', defaultIcon: 'https://i.postimg.cc/DyS7X2SW/IMG-3081.jpg' },
                { id: 'api', name: 'APIè®¾ç½®', defaultIcon: 'https://i.postimg.cc/4x3PYYpx/3082.jpg' },
                { id: 'worldbook', name: 'ä¸–ç•Œä¹¦', defaultIcon: 'https://i.postimg.cc/NjNg7cYz/IMG-3083.jpg' }
            ];
            
            defaultIcons.forEach(icon => {
                const customIcon = state.globalSettings.customIcons && state.globalSettings.customIcons[icon.id];
                const currentIcon = customIcon || icon.defaultIcon;
                
                const iconItem = document.createElement('div');
                iconItem.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    padding: 10px;
                    border: 1px solid #ddd;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
                
                iconItem.innerHTML = `
                    <img src="${currentIcon}" style="width: 60px; height: 60px; border-radius: 12px; object-fit: cover; margin-bottom: 8px;" alt="${icon.name}">
                    <span style="font-size: 12px; text-align: center;">${icon.name}</span>
                `;
                
                iconItem.addEventListener('click', () => openCustomIconModal(icon.id, icon.name, currentIcon));
                
                iconItem.addEventListener('mouseenter', () => {
                    iconItem.style.borderColor = 'rgb(74, 132, 193)';
                    iconItem.style.backgroundColor = '#f8f9fa';
                });
                
                iconItem.addEventListener('mouseleave', () => {
                    iconItem.style.borderColor = '#ddd';
                    iconItem.style.backgroundColor = 'transparent';
                });
                
                grid.appendChild(iconItem);
            });
        }
        
        // è‡ªå®šä¹‰å›¾æ ‡åŠŸèƒ½
        let currentEditingIcon = null;
        let currentIconPreview = null;
        
        function openCustomIconModal(iconId, iconName, currentIconUrl) {
            currentEditingIcon = { id: iconId, name: iconName };
            
            document.getElementById('custom-icon-title').textContent = `è‡ªå®šä¹‰ ${iconName} å›¾æ ‡`;
            document.getElementById('current-icon-preview').src = currentIconUrl;
            
            // é‡ç½®æ–°å›¾æ ‡é¢„è§ˆ
            document.getElementById('new-icon-preview').style.display = 'none';
            document.getElementById('no-preview-text').style.display = 'block';
            document.getElementById('url-input-group').style.display = 'none';
            document.getElementById('icon-url-input').value = '';
            currentIconPreview = null;
            
            document.getElementById('custom-icon-modal').classList.add('visible');
        }
        
        function applyCustomIcons() {
            // è·å–ä¸»é¡µçš„æ‰€æœ‰åº”ç”¨å›¾æ ‡å¹¶æ›´æ–°
            const iconSelectors = {
                'chat': "div[onclick=\"showScreen('chat-list-screen')\"] img",
                'weibo': "div[onclick=\"showScreen('weibo-screen')\"] img",
                'wallpaper': "div[onclick=\"showScreen('wallpaper-screen')\"] img",
                'api': "div[onclick=\"showScreen('api-settings-screen')\"] img",
                'worldbook': "div[onclick=\"showScreen('world-book-screen')\"] img"
            };
            
            if (state.globalSettings.customIcons) {
                Object.keys(state.globalSettings.customIcons).forEach(iconId => {
                    const selector = iconSelectors[iconId];
                    if (selector) {
                        const iconElement = document.querySelector(selector);
                        if (iconElement) {
                            iconElement.src = state.globalSettings.customIcons[iconId];
                        }
                    }
                });
            }
        }
        
        window.renderWallpaperScreenProxy = () => renderWallpaperScreen();

        function applyGlobalWallpaper() {
            const homeScreen = document.getElementById('home-screen');
            const wallpaper = state.globalSettings.wallpaper;
            if (wallpaper && wallpaper.startsWith('data:image'))
                homeScreen.style.backgroundImage = `url(${wallpaper})`;
            else if (wallpaper)
                homeScreen.style.backgroundImage = wallpaper;
        }

        function applyCustomStyles() {
            // ç§»é™¤ä¹‹å‰çš„è‡ªå®šä¹‰æ ·å¼
            const existingCustomStyle = document.getElementById('custom-bubble-styles');
            if (existingCustomStyle) {
                existingCustomStyle.remove();
            }

            const existingCustomFont = document.getElementById('custom-font-link');
            if (existingCustomFont) {
                existingCustomFont.remove();
            }

            // åº”ç”¨è‡ªå®šä¹‰å­—ä½“
            if (state.globalSettings.customFontUrl) {
                const fontUrl = state.globalSettings.customFontUrl.trim();
                console.log('æ­£åœ¨åº”ç”¨è‡ªå®šä¹‰å­—ä½“:', fontUrl);

                if (fontUrl.toLowerCase().endsWith('.ttf') || fontUrl.toLowerCase().endsWith('.otf') || fontUrl.toLowerCase().endsWith('.woff') || fontUrl.toLowerCase().endsWith('.woff2')) {
                    // å¤„ç†å­—ä½“æ–‡ä»¶é“¾æ¥
                    const fontName = 'CustomFont_' + Math.random().toString(36).substr(2, 9);
                    console.log('ç”Ÿæˆå­—ä½“åç§°:', fontName);

                    const styleElement = document.createElement('style');
                    styleElement.id = 'custom-font-link';

                    // æ ¹æ®æ–‡ä»¶æ‰©å±•åç¡®å®šæ ¼å¼
                    let format = 'truetype';
                    if (fontUrl.toLowerCase().endsWith('.woff')) format = 'woff';
                    if (fontUrl.toLowerCase().endsWith('.woff2')) format = 'woff2';
                    if (fontUrl.toLowerCase().endsWith('.otf')) format = 'opentype';

                    styleElement.textContent = `
                        @font-face {
                            font-family: '${fontName}';
                            src: url('${fontUrl}') format('${format}');
                            font-display: swap;
                        }

                        /* åº”ç”¨åˆ°èŠå¤©æ°”æ³¡ */
                        .message-bubble .content {
                            font-family: '${fontName}', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
                        }

                        /* åº”ç”¨åˆ°æ•´ä½“é¡µé¢ */
                        body, * {
                            font-family: '${fontName}', var(--theme-font-family) !important;
                        }

                        /* ç¡®ä¿è¾“å…¥æ¡†ä¹Ÿä½¿ç”¨è‡ªå®šä¹‰å­—ä½“ */
                        input, textarea, select, button, .form-button {
                            font-family: '${fontName}', var(--theme-font-family) !important;
                        }

                        /* æ ‡é¢˜å­—ä½“ */
                        .header-title, .app-icon .label {
                            font-family: '${fontName}', var(--theme-font-family) !important;
                        }

                        /* æ—¶é—´æ˜¾ç¤º */
                        #main-time, #main-date {
                            font-family: '${fontName}', var(--theme-font-family) !important;
                        }
                    `;
                    document.head.appendChild(styleElement);
                    console.log('TTFå­—ä½“æ ·å¼å·²æ·»åŠ ');
                } else {
                    // å¤„ç†CSSé“¾æ¥
                    const fontLink = document.createElement('link');
                    fontLink.id = 'custom-font-link';
                    fontLink.rel = 'stylesheet';
                    fontLink.href = fontUrl;
                    document.head.appendChild(fontLink);
                    console.log('CSSå­—ä½“é“¾æ¥å·²æ·»åŠ ');

                    // ç­‰å¾…CSSåŠ è½½ååº”ç”¨å­—ä½“æ ·å¼
                    fontLink.onload = () => {
                        console.log('CSSå­—ä½“åŠ è½½å®Œæˆï¼Œå¼€å§‹åº”ç”¨å­—ä½“');

                        // ä»CSSä¸­æå–å­—ä½“æ—åç§°å¹¶åº”ç”¨
                        setTimeout(() => {
                            // åˆ›å»ºæ ·å¼æ¥åº”ç”¨å­—ä½“
                            const styleElement = document.createElement('style');
                            styleElement.id = 'custom-font-fallback';

                            // æ ¹æ®å¸¸è§çš„å­—ä½“CSSæ¨¡å¼ï¼Œå°è¯•åº”ç”¨å­—ä½“
                            // å¤§å¤šæ•°å­—ä½“CSSéƒ½ä¼šå®šä¹‰font-familyï¼Œæˆ‘ä»¬ç›´æ¥åº”ç”¨å¸¸è§çš„å­—ä½“åç§°
                            let fontFamilyToApply = '';

                            // æ£€æŸ¥URLæ¥æ¨æµ‹å­—ä½“åç§°
                            if (fontUrl.includes('zeoseven.com')) {
                                // è¿™ä¸ªç‰¹å®šçš„URLæˆ‘ä»¬çŸ¥é“æ˜¯ChillKaiå­—ä½“
                                fontFamilyToApply = '"ChillKai", "å¯’è‰æ­£æ¥·ä½“"';
                            } else {
                                // é€šç”¨æ–¹æ³•ï¼šå°è¯•å¸¸è§çš„ä¸­æ–‡å­—ä½“åç§°
                                fontFamilyToApply = '"PingFang SC", "Microsoft YaHei", "Noto Sans SC", "Source Han Sans SC"';
                            }

                            styleElement.textContent = `
                                /* åº”ç”¨è‡ªå®šä¹‰å­—ä½“åˆ°æ‰€æœ‰å…ƒç´  */
                                * {
                                    font-family: ${fontFamilyToApply}, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
                                }
                                body {
                                    font-family: ${fontFamilyToApply}, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
                                }
                                .message-bubble .content {
                                    font-family: ${fontFamilyToApply}, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
                                }
                            `;

                            document.head.appendChild(styleElement);
                            console.log('CSSå­—ä½“å·²åº”ç”¨:', fontFamilyToApply);
                            showToast('å­—ä½“å·²æˆåŠŸåº”ç”¨ï¼', 'success');
                        }, 500);
                    };

                    fontLink.onerror = () => {
                        console.error('å­—ä½“CSSåŠ è½½å¤±è´¥');
                        showToast('å­—ä½“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æ­£ç¡®', 'error');
                    };


                }
            }

            // åº”ç”¨è‡ªå®šä¹‰CSSæ ·å¼
            if (state.globalSettings.customBubbleCSS) {
                const styleElement = document.createElement('style');
                styleElement.id = 'custom-bubble-styles';
                styleElement.textContent = state.globalSettings.customBubbleCSS;
                document.head.appendChild(styleElement);
            }
        }

        function previewCustomStyles() {
            const customCSS = document.getElementById('custom-bubble-css').value;
            const customFontUrl = document.getElementById('custom-font-url').value.trim();

            // æ˜¾ç¤ºé¢„è§ˆå®¹å™¨
            const previewContainer = document.getElementById('bubble-preview-container');
            previewContainer.style.display = 'block';

            // ç§»é™¤ä¹‹å‰çš„é¢„è§ˆæ ·å¼
            const existingPreviewStyle = document.getElementById('preview-bubble-styles');
            if (existingPreviewStyle) {
                existingPreviewStyle.remove();
            }

            const existingPreviewFont = document.getElementById('preview-font-link');
            if (existingPreviewFont) {
                existingPreviewFont.remove();
            }

            // åº”ç”¨é¢„è§ˆå­—ä½“
            if (customFontUrl) {
                if (customFontUrl.toLowerCase().endsWith('.ttf') || customFontUrl.toLowerCase().endsWith('.otf') || customFontUrl.toLowerCase().endsWith('.woff') || customFontUrl.toLowerCase().endsWith('.woff2')) {
                    // å¤„ç†å­—ä½“æ–‡ä»¶é“¾æ¥
                    const fontName = 'PreviewFont_' + Date.now();
                    const styleElement = document.createElement('style');
                    styleElement.id = 'preview-font-link';

                    // æ ¹æ®æ–‡ä»¶æ‰©å±•åç¡®å®šæ ¼å¼
                    let format = 'truetype';
                    if (customFontUrl.toLowerCase().endsWith('.woff')) format = 'woff';
                    if (customFontUrl.toLowerCase().endsWith('.woff2')) format = 'woff2';
                    if (customFontUrl.toLowerCase().endsWith('.otf')) format = 'opentype';

                    styleElement.textContent = `
                        @font-face {
                            font-family: '${fontName}';
                            src: url('${customFontUrl}') format('${format}');
                            font-display: swap;
                        }
                        .preview-user-bubble, .preview-ai-bubble {
                            font-family: '${fontName}', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
                        }
                    `;
                    document.head.appendChild(styleElement);
                    console.log('é¢„è§ˆTTFå­—ä½“å·²åŠ è½½:', fontName);
                } else {
                    // å¤„ç†CSSé“¾æ¥
                    const fontLink = document.createElement('link');
                    fontLink.id = 'preview-font-link';
                    fontLink.rel = 'stylesheet';
                    fontLink.href = customFontUrl;
                    fontLink.crossOrigin = 'anonymous';
                    document.head.appendChild(fontLink);

                    // åº”ç”¨é€šç”¨å­—ä½“æ ·å¼
                    fontLink.onload = () => {
                        const styleElement = document.createElement('style');
                        styleElement.id = 'preview-font-fallback';
                        styleElement.textContent = `
                            .preview-user-bubble, .preview-ai-bubble {
                                font-family: inherit !important;
                            }
                        `;
                        document.head.appendChild(styleElement);
                        console.log('é¢„è§ˆCSSå­—ä½“å·²åŠ è½½');
                    };

                    setTimeout(() => {
                        if (!document.getElementById('preview-font-fallback')) {
                            const styleElement = document.createElement('style');
                            styleElement.id = 'preview-font-fallback';
                            styleElement.textContent = `
                                .preview-user-bubble, .preview-ai-bubble {
                                    font-family: inherit !important;
                                }
                            `;
                            document.head.appendChild(styleElement);
                        }
                    }, 1000);
                }
            }

            // åº”ç”¨é¢„è§ˆæ ·å¼
            if (customCSS) {
                const styleElement = document.createElement('style');
                styleElement.id = 'preview-bubble-styles';

                // å°†ç”¨æˆ·çš„CSSä¸­çš„é€‰æ‹©å™¨æ›¿æ¢ä¸ºé¢„è§ˆä¸“ç”¨çš„é€‰æ‹©å™¨
                let modifiedCSS = customCSS;
                // æ›¿æ¢ç”¨æˆ·æ°”æ³¡é€‰æ‹©å™¨
                modifiedCSS = modifiedCSS.replace(/\.message-bubble\.user\s+\.content/g, '.preview-user-bubble');
                // æ›¿æ¢AIæ°”æ³¡é€‰æ‹©å™¨
                modifiedCSS = modifiedCSS.replace(/\.message-bubble\.ai\s+\.content/g, '.preview-ai-bubble');

                styleElement.textContent = modifiedCSS;
                document.head.appendChild(styleElement);
            }

            // æ»šåŠ¨åˆ°é¢„è§ˆåŒºåŸŸ
            previewContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });

            showToast('é¢„è§ˆæ•ˆæœå·²æ˜¾ç¤ºåœ¨ä¸‹æ–¹ï¼', 'success');
        }
        
        function applyIconPosition() {
            const appGrid = document.getElementById('app-grid');
            const position = state.globalSettings.iconPosition || 'center';
            
            // ç§»é™¤ä¹‹å‰çš„æ‰€æœ‰ä½ç½®ç±»
            appGrid.classList.remove('position-top', 'position-center', 'position-bottom');
            
            // æ ¹æ®ä½ç½®è®¾ç½®ä¸åŒçš„æ ·å¼
            switch (position) {
                case 'top':
                    appGrid.style.marginTop = '20px';
                    appGrid.style.marginBottom = 'auto';
                    break;
                case 'center':
                    appGrid.style.marginTop = 'auto';
                    appGrid.style.marginBottom = 'auto';
                    break;
                case 'bottom':
                    appGrid.style.marginTop = 'auto';
                    appGrid.style.marginBottom = '20px';
                    break;
            }
        }
        
        function applyFontSize() {
            const fontSize = state.globalSettings.fontSize || 'medium';

            // ç§»é™¤ä¹‹å‰çš„å­—å·è®¾ç½®
            document.body.removeAttribute('data-font-size');

            // åº”ç”¨æ–°çš„å­—å·è®¾ç½®
            document.body.setAttribute('data-font-size', fontSize);
        }

        function renderWorldBookScreen() { const listEl = document.getElementById('world-book-list'); listEl.innerHTML = ''; if (state.worldBooks.length === 0) { listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" åˆ›å»ºä½ çš„ç¬¬ä¸€æœ¬ä¸–ç•Œä¹¦</p>'; return; } state.worldBooks.forEach(book => { const item = document.createElement('div'); item.className = 'list-item'; item.dataset.bookId = book.id; item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(book.content || 'æš‚æ— å†…å®¹...').substring(0, 50)}</div>`; item.addEventListener('click', () => openWorldBookEditor(book.id)); addLongPressListener(item, async () => { const confirmed = await showCustomConfirm('åˆ é™¤ä¸–ç•Œä¹¦', `ç¡®å®šè¦åˆ é™¤ã€Š${book.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.worldBooks.delete(book.id); state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); renderWorldBookScreen(); } }); listEl.appendChild(item); }); }
        window.renderWorldBookScreenProxy = renderWorldBookScreen;
        function openWorldBookEditor(bookId) { editingWorldBookId = bookId; const book = state.worldBooks.find(wb => wb.id === bookId); if (!book) return; document.getElementById('world-book-editor-title').textContent = book.name; document.getElementById('world-book-name-input').value = book.name; document.getElementById('world-book-content-input').value = book.content; showScreen('world-book-editor-screen'); }
        function renderStickerPanel() { const grid = document.getElementById('sticker-grid'); grid.innerHTML = ''; if (state.userStickers.length === 0) { grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">å¤§äººè¯·ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ "æˆ–"ä¸Šä¼ "æ¥æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªè¡¨æƒ…å§ï¼</p>'; return; } state.userStickers.forEach(sticker => { const item = document.createElement('div'); item.className = 'sticker-item'; item.style.backgroundImage = `url(${sticker.url})`; item.title = sticker.name; item.addEventListener('click', () => sendSticker(sticker)); addLongPressListener(item, () => { if (isSelectionMode) return; const existingDeleteBtn = item.querySelector('.delete-btn'); if (existingDeleteBtn) return; const deleteBtn = document.createElement('div'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; deleteBtn.onclick = async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('åˆ é™¤è¡¨æƒ…', `ç¡®å®šè¦åˆ é™¤è¡¨æƒ… "${sticker.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.userStickers.delete(sticker.id); state.userStickers = state.userStickers.filter(s => s.id !== sticker.id); renderStickerPanel(); } }; item.appendChild(deleteBtn); deleteBtn.style.display = 'block'; setTimeout(() => item.addEventListener('mouseleave', () => deleteBtn.remove(), { once: true }), 3000); }); grid.appendChild(item); }); }
        
        // å¤„ç†çº¿ä¸‹æ¨¡å¼å†…å®¹ï¼šè¯†åˆ«ã€Œã€åŒ…è£¹çš„å¯¹è¯å’Œæå†™
        function processOfflineModeContent(content) {
            // å¦‚æœå†…å®¹ä¸ºç©ºï¼Œç›´æ¥è¿”å›
            if (!content || !content.trim()) {
                return content;
            }
            
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¯†åˆ«ã€Œã€åŒ…è£¹çš„å¯¹è¯å†…å®¹
            const processedContent = content.replace(/ã€Œ([^ã€]+)ã€/g, (match, dialogue) => {
                // å¯¹è¯éƒ¨åˆ†ä¿æŒæ­£å¸¸æ˜¾ç¤ºï¼ˆé»‘è‰²æ–‡å­—ï¼‰
                return `ã€Œ${dialogue}ã€`;
            });
            
            // å°†éå¯¹è¯éƒ¨åˆ†ï¼ˆä¸åœ¨ã€Œã€å†…çš„å†…å®¹ï¼‰è½¬æ¢ä¸ºç°è‰²æ–œä½“
            let result = '';
            let lastIndex = 0;
            const dialogueRegex = /ã€Œ[^ã€]+ã€/g;
            let match;
            
            while ((match = dialogueRegex.exec(content)) !== null) {
                // å¤„ç†å¯¹è¯å‰çš„æå†™éƒ¨åˆ†
                const beforeDialogue = content.substring(lastIndex, match.index);
                if (beforeDialogue.trim()) {
                    result += `<span style="color: #555; font-style: italic;">${beforeDialogue}</span>`;
                }
                
                // æ·»åŠ å¯¹è¯éƒ¨åˆ†ï¼ˆä¿æŒæ­£å¸¸æ˜¾ç¤ºï¼‰
                result += match[0];
                lastIndex = match.index + match[0].length;
            }
            
            // å¤„ç†æœ€åå‰©ä½™çš„æå†™éƒ¨åˆ†
            const remaining = content.substring(lastIndex);
            if (remaining.trim()) {
                result += `<span style="color: #555; font-style: italic;">${remaining}</span>`;
            }
            
            return result.replace(/\n/g, '<br>');
        }

        function createMessageElement(msg, chat) { 
            // å¦‚æœæ˜¯ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå¦‚æ”¶æ¬¾ç¡®è®¤ï¼‰ï¼Œåˆ›å»ºç±»ä¼¼æ—¶é—´æˆ³çš„ç‰¹æ®Šå…ƒç´ 
            if (msg.type === 'system_message') {
                const systemElement = document.createElement('div');
                systemElement.className = 'time-separator'; // ä½¿ç”¨æ—¶é—´åˆ†éš”ç¬¦çš„æ ·å¼ç±»
                systemElement.textContent = msg.content;
                systemElement.dataset.timestamp = msg.timestamp;
                return systemElement;
            }
            
            // å¦‚æœæ˜¯æˆ³ä¸€æˆ³æ¶ˆæ¯ï¼Œåˆ›å»ºç‰¹æ®Šçš„å…ƒç´ 
            if (msg.type === 'poke') {
                const pokeElement = document.createElement('div');
                pokeElement.className = 'poke-message';
                pokeElement.textContent = msg.content;
                pokeElement.dataset.timestamp = msg.timestamp;
                return pokeElement;
            }
            
            // å¦‚æœæ˜¯é€šè¯æ—¶é•¿æé†’ï¼Œåˆ›å»ºç‰¹æ®Šçš„å…ƒç´ 
            if (msg.type === 'call_duration') {
                const durationElement = document.createElement('div');
                durationElement.className = 'call-duration-message';
                durationElement.textContent = msg.content;
                durationElement.dataset.timestamp = msg.timestamp;
                durationElement.style.cssText = `
                    text-align: center;
                    color: #999;
                    font-size: 12px;
                    margin: 8px 0;
                    padding: 4px 0;
                `;
                return durationElement;
            }
            
            // å¦‚æœæ˜¯é€šè¯ä¸­çš„æå†™æ¶ˆæ¯ï¼Œåˆ›å»ºç‰¹æ®Šçš„å…ƒç´ 
            if (msg.isDescription) {
                const descElement = document.createElement('div');
                descElement.className = 'call-description-message';
                descElement.innerHTML = msg.content;
                descElement.dataset.timestamp = msg.timestamp;
                descElement.style.cssText = `
                    text-align: center;
                    color: #000000;
                    font-style: italic;
                    font-size: 13px;
                    margin: 8px 0;
                    padding: 5px 15px;
                `;
                return descElement;
            }
            
            // å¦‚æœæ˜¯æ’¤å›æ¶ˆæ¯ï¼Œåˆ›å»ºç‰¹æ®Šçš„å…ƒç´ 
            if (msg.type === 'recalled_message') {
                // åˆ›å»ºæ’¤å›æ¶ˆæ¯ï¼Œä½¿ç”¨å’Œæ—¶é—´åˆ†éš”ç¬¦ç›¸åŒçš„æ ·å¼
                const recallElement = document.createElement('div');
                recallElement.className = 'time-separator'; // ä½¿ç”¨æ—¶é—´åˆ†éš”ç¬¦çš„æ ·å¼ç±»
                recallElement.dataset.timestamp = msg.timestamp;
                if (msg.originalTimestamp) {
                    recallElement.dataset.originalTimestamp = msg.originalTimestamp;
                }
                
                // åˆ›å»ºæ’¤å›æ¶ˆæ¯çš„æ˜¾ç¤ºå†…å®¹ï¼Œä½¿ç”¨æ­£ç¡®çš„å‘é€è€…åç§°
                const recallText = document.createElement('div');
                const displayName = chat.isGroup && msg.senderName ? msg.senderName : (chat.name || 'å¯¹æ–¹');
                recallText.textContent = `${displayName}æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯`;
                recallElement.appendChild(recallText);
                
                // å¦‚æœæœ‰åŸå§‹æ¶ˆæ¯å†…å®¹ï¼Œæ˜¾ç¤ºåŸæ–‡
                if (msg.originalContent) {
                    const originalText = document.createElement('div');
                    originalText.textContent = `åŸæ–‡ï¼š${msg.originalContent}`;
                    originalText.style.cssText = `
                        margin-top: 4px;
                    `;
                    recallElement.appendChild(originalText);
                }
                
                return recallElement;
            }
            
            // å¦‚æœæ˜¯ç³»ç»Ÿæ¶ˆæ¯ï¼Œåˆ›å»ºç‰¹æ®Šçš„å…ƒç´ 
            if (msg.type === 'system_message') {
                const systemElement = document.createElement('div');
                systemElement.className = 'time-separator'; // ä½¿ç”¨æ—¶é—´åˆ†éš”ç¬¦çš„æ ·å¼ç±»
                systemElement.dataset.timestamp = msg.timestamp;
                systemElement.textContent = msg.content;
                systemElement.style.cssText = `
                    text-align: center;
                    color: #999;
                    font-size: 12px;
                    margin: 15px 0 8px 0;
                    padding: 5px 0;
                `;
                return systemElement;
            }

            const isUser = msg.role === 'user'; const wrapper = document.createElement('div'); wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`; if (chat.isGroup && !isUser) { const senderNameDiv = document.createElement('div'); senderNameDiv.className = 'sender-name'; senderNameDiv.textContent = msg.senderName || 'æœªçŸ¥æˆå‘˜'; wrapper.appendChild(senderNameDiv); } const bubble = document.createElement('div'); bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`; bubble.dataset.timestamp = msg.timestamp; let avatarSrc; if (chat.isGroup) { if (isUser) avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar; else { const member = chat.members.find(m => m.name === msg.senderName); avatarSrc = member ? member.avatar : defaultGroupMemberAvatar; } } else { avatarSrc = isUser ? (chat.settings.myAvatar || defaultAvatar) : (chat.settings.aiAvatar || defaultAvatar); } let contentHtml; if (msg.type === 'user_photo' || msg.type === 'ai_image') { bubble.classList.add('is-ai-image'); const altText = msg.type === 'user_photo' ? "ç”¨æˆ·æè¿°çš„ç…§ç‰‡" : "AIç”Ÿæˆçš„å›¾ç‰‡"; const escapedDescription = (msg.content || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); contentHtml = `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="ai-generated-image" alt="${altText}" data-description="${escapedDescription}">`; } else if (msg.type === 'voice_message') { bubble.classList.add('is-voice-message'); const duration = Math.max(1, Math.round((msg.content || '').length / 5)); const durationFormatted = `0:${String(duration).padStart(2, '0')}''`; const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>'; contentHtml = `<div class="voice-message-body" data-text="${msg.content}"><div class="voice-waveform">${waveformHTML}</div><span class="voice-duration">${durationFormatted}</span></div>`; } else if (msg.type === 'transfer') {
                bubble.classList.add('is-transfer'); 
                const titleText = isUser ? 'è½¬è´¦ç»™Ta' : 'æ”¶åˆ°ä¸€ç¬”è½¬è´¦'; 
                const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`; 
                
                // æ·»åŠ è½¬è´¦çŠ¶æ€
                let statusHtml = '';
                let cardClass = '';
                if (msg.status === 'accepted') {
                    statusHtml = `<div class="transfer-status">${isUser ? 'å¯¹æ–¹å·²æ”¶æ¬¾' : 'å·²æ”¶æ¬¾'}</div>`;
                    cardClass = 'accepted';
                } else if (msg.status === 'rejected') {
                    statusHtml = `<div class="transfer-status">${isUser ? 'å¯¹æ–¹å·²é€€å›' : 'å·²é€€å›'}</div>`;
                    cardClass = 'accepted';
                }
                
                contentHtml = `<div class="transfer-card ${cardClass}" data-transfer-id="${msg.timestamp}"><div class="transfer-title">${heartIcon} ${titleText}</div><div class="transfer-amount">Â¥ ${Number(msg.amount).toFixed(2)}</div><div class="transfer-note">${msg.note || 'å¯¹æ–¹æ²¡æœ‰ç•™ä¸‹å¤‡æ³¨å“¦~'}</div>${statusHtml}</div>`; } else if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) { bubble.classList.add('is-sticker'); contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`; } else if (Array.isArray(msg.content)) { 
                // å¤„ç†å¤šæ¨¡æ€æ¶ˆæ¯ï¼ˆå›¾ç‰‡+æ–‡æœ¬ç»„åˆï¼‰
                const imageItem = msg.content.find(item => item.type === 'image_url');
                const textItem = msg.content.find(item => item.type === 'text');
                
                if (imageItem) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯è¡¨æƒ…åŒ…ï¼ˆæœ‰textä¸”åŒ…å«"è¡¨æƒ…åŒ…"ï¼‰
                    if (textItem && textItem.text.includes('è¡¨æƒ…åŒ…') && msg.meaning) {
                        bubble.classList.add('is-sticker');
                        contentHtml = `<img src="${imageItem.image_url.url}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
                    } else {
                        // æ™®é€šå›¾ç‰‡
                        bubble.classList.add('has-image');
                        contentHtml = `<img src="${imageItem.image_url.url}" class="chat-image" alt="User uploaded image">`;
                        // å¦‚æœæœ‰æ–‡æœ¬ï¼Œæ·»åŠ åˆ°å›¾ç‰‡ä¸‹æ–¹
                        if (textItem && textItem.text) {
                            contentHtml += `<div class="image-text">${textItem.text}</div>`;
                        }
                    }
                } else if (textItem) {
                    // åªæœ‰æ–‡æœ¬çš„æƒ…å†µ
                    contentHtml = textItem.text.replace(/\n/g, '<br>');
                } else {
                    // å…¶ä»–æƒ…å†µ
                    contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
                }
            } else { 
                // æ£€æŸ¥æ˜¯å¦ä¸ºçº¿ä¸‹æ¨¡å¼ä¸”ä¸ºAIè§’è‰²æ¶ˆæ¯
                const chatMode = chat.settings.chatMode || 'online';
                if (chatMode === 'offline' && !isUser && msg.role === 'assistant') {
                    // çº¿ä¸‹æ¨¡å¼ï¼šåŒºåˆ†è¯­è¨€å’Œéè¯­è¨€å†…å®¹
                    const content = String(msg.content || '');
                    contentHtml = processOfflineModeContent(content);
                } else {
                    // çº¿ä¸Šæ¨¡å¼æˆ–ç”¨æˆ·æ¶ˆæ¯ï¼šæ­£å¸¸å¤„ç†
                    contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
                }
            }
            
            // å¤„ç†@é«˜äº®æ˜¾ç¤ºï¼ˆä»…é™ç¾¤èŠï¼‰
            if (chat.isGroup && contentHtml) {
                contentHtml = highlightMentions(contentHtml, chat);
            } bubble.innerHTML = `<div class="avatar-group"><img src="${avatarSrc}" class="avatar"><span class="timestamp">${formatTimestamp(msg.timestamp)}</span></div><div class="content">${contentHtml}</div>`;

            // æ·»åŠ é•¿æŒ‰äº‹ä»¶ç›‘å¬å™¨ - æ˜¾ç¤ºæ“ä½œèœå•
            addLongPressListener(bubble, () => showMessageActionMenu(msg.timestamp, bubble));

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
            bubble.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
                
                // æ·»åŠ å¤´åƒç‚¹å‡»æˆ³ä¸€æˆ³äº‹ä»¶
                const avatarElement = bubble.querySelector('.avatar');
                avatarElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (isSelectionMode) return;
                    handlePoke(isUser, chat, msg.senderName);
                });
                
                // æ·»åŠ è½¬è´¦å¡ç‰‡ç‚¹å‡»äº‹ä»¶
                if (msg.type === 'transfer' && !msg.status) {
                    const transferCard = bubble.querySelector('.transfer-card');
                    if (transferCard) {
                        // å¦‚æœæ˜¯AIå‘ç»™ç”¨æˆ·çš„è½¬è´¦ï¼Œç”¨æˆ·ç‚¹å‡»å¯ä»¥ç¡®è®¤æ”¶æ¬¾
                        if (!isUser) {
                            transferCard.addEventListener('click', (e) => {
                                e.stopPropagation();
                                if (isSelectionMode) return;
                                showTransferConfirmDialog(msg);
                            });
                        }
                        // å¦‚æœæ˜¯ç”¨æˆ·å‘ç»™AIçš„è½¬è´¦ï¼ŒAIä¼šè‡ªåŠ¨æ¥å—ï¼ˆåœ¨ä¸‹ä¸€æ¬¡å›å¤ä¸­ï¼‰
                    }
                }
                
                wrapper.appendChild(bubble); 
                
                // å¦‚æœæ˜¯è¯­éŸ³æ¶ˆæ¯ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„å¤–å±‚å®¹å™¨
                if (msg.type === 'voice_message') {
                    const outerContainer = document.createElement('div');
                    outerContainer.className = `voice-message-container ${isUser ? 'user' : 'ai'}`;
                    
                    const voiceTextDiv = document.createElement('div');
                    voiceTextDiv.className = 'voice-text-content';
                    voiceTextDiv.textContent = msg.content;
                    
                    outerContainer.appendChild(wrapper);
                    outerContainer.appendChild(voiceTextDiv);
                    
                    return outerContainer;
                }
                
                return wrapper; 
            }
        function prependMessage(msg, chat) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat); const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) { messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); } else { messagesContainer.prepend(messageEl); } }
        // æ£€æŸ¥å¹¶æ·»åŠ æ—¶é—´åˆ†éš”ç¬¦
        function checkAndAddTimeSeparator(container, currentTimestamp) {
            const messages = container.querySelectorAll('.message-wrapper, .poke-message');
            if (messages.length === 0) return;
            
            // è·å–æœ€åä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³
            const lastMessage = messages[messages.length - 1];
            let lastTimestamp;
            
            if (lastMessage.classList.contains('poke-message')) {
                lastTimestamp = parseInt(lastMessage.dataset.timestamp);
            } else {
                const lastBubble = lastMessage.querySelector('.message-bubble');
                lastTimestamp = parseInt(lastBubble.dataset.timestamp);
            }
            
            // æ£€æŸ¥æ—¶é—´å·®æ˜¯å¦å¤§äº5åˆ†é’Ÿï¼ˆ300000æ¯«ç§’ï¼‰
            if (currentTimestamp - lastTimestamp >= 300000) {
                const timeSeparator = document.createElement('div');
                timeSeparator.className = 'time-separator';
                const timeString = new Date(currentTimestamp).toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                timeSeparator.textContent = timeString;
                
                const typingIndicator = document.getElementById('typing-indicator');
                container.insertBefore(timeSeparator, typingIndicator);
            }
        }

        function appendMessage(msg, chat, isInitialLoad = false) { 
            const messagesContainer = document.getElementById('chat-messages'); 
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ—¶é—´åˆ†éš”ç¬¦
            if (!isInitialLoad) {
                checkAndAddTimeSeparator(messagesContainer, msg.timestamp);
            }
            
            const messageEl = createMessageElement(msg, chat); 
            const typingIndicator = document.getElementById('typing-indicator'); 
            messagesContainer.insertBefore(messageEl, typingIndicator); 
            
            if (!isInitialLoad) { 
                messagesContainer.scrollTop = messagesContainer.scrollHeight; 
                currentRenderedCount++; 
            } 
        }

        function openChat(chatId) { state.activeChatId = chatId; renderChatInterface(chatId); showScreen('chat-interface-screen'); }
        
        // å°è£…åŸå§‹çš„AIå“åº”é€»è¾‘
        async function executeAiResponse(abortSignal, chatId) {
            const chat = state.chats[chatId];
            if (!chat) {
                throw new Error('èŠå¤©ä¸å­˜åœ¨');
            } const { proxyUrl, apiKey, model } = state.apiConfig; if (!proxyUrl || !apiKey || !model) { alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®åä»£åœ°å€ã€å¯†é’¥å¹¶é€‰æ‹©æ¨¡å‹ã€‚'); document.getElementById('typing-indicator').style.display = 'none'; return; } const now = new Date(); const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true }); let worldBookContent = ''; if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) { const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => { const worldBook = state.worldBooks.find(wb => wb.id === bookId); return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : ''; }).filter(Boolean).join(''); if (linkedContents) { worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)\n${linkedContents}\n`; } } 
        
        // è·å–æœ€æ–°çš„5æ¡å¾®åšåŠ¨æ€åŠå…¶è¯„è®º
        let weiboContext = '';
        try {
            const latestPosts = await db.weiboPosts
                .orderBy('timestamp')
                .reverse()
                .limit(5)
                .toArray();
                
            if (latestPosts.length > 0) {
                weiboContext = '\n\n# æœ€æ–°çš„å¾®åšåŠ¨æ€ï¼ˆå¯ä½œä¸ºè¯é¢˜å‚è€ƒï¼‰\n';
                for (const post of latestPosts) {
                    const authorName = post.authorId === 'user' ? 'ç”¨æˆ·' : 
                        (state.chats[post.authorId] ? state.chats[post.authorId].name : 'æœªçŸ¥');
                    weiboContext += `\n[${authorName}]: ${post.content}`;
                    
                    // è·å–è¯¥åŠ¨æ€çš„è¯„è®º
                    const comments = await db.weiboComments
                        .where('postId')
                        .equals(post.id)
                        .limit(3)
                        .toArray();
                        
                    if (comments.length > 0) {
                        weiboContext += '\n  è¯„è®ºï¼š';
                        for (const comment of comments) {
                            const commentAuthor = comment.authorId === 'user' ? 'ç”¨æˆ·' : 
                                (state.chats[comment.authorId] ? state.chats[comment.authorId].name : 'æœªçŸ¥');
                            weiboContext += `\n    - ${commentAuthor}: ${comment.content}`;
                        }
                    }
                }
            }
        } catch (error) {
            console.error('è·å–å¾®åšåŠ¨æ€å¤±è´¥:', error);
        }
        
        let musicContext = ''; if (musicState.isActive && musicState.activeChatId === chatId && musicState.currentIndex > -1) { const currentTrack = musicState.playlist[musicState.currentIndex]; musicContext = `\n\n# å½“å‰æƒ…æ™¯\nä½ æ­£åœ¨å’Œç”¨æˆ·ä¸€èµ·å¬æ­Œã€‚å½“å‰æ’­æ”¾çš„æ­Œæ›²æ˜¯ï¼š${currentTrack.name} - ${currentTrack.artist}ã€‚è¯·åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°èå…¥è¿™ä¸ªæƒ…å¢ƒã€‚\n`; } 
        
        // è·å–æŒ‚è½½çš„è®°å¿†
        let mountedMemories = '';
        if (chat.settings.memoryMountEnabled && chat.settings.memoryMountChatIds && chat.settings.memoryMountChatIds.length > 0) {
            const mountCount = parseInt(chat.settings.memoryMountCount) || 10;
            const mountedChats = chat.settings.memoryMountChatIds.map(chatId => state.chats[chatId]).filter(Boolean);
            
            if (mountedChats.length > 0) {
                mountedMemories = '\n\n# å‚è€ƒè®°å¿†ï¼ˆæ¥è‡ªå…¶ä»–èŠå¤©çš„èƒŒæ™¯ä¿¡æ¯ï¼‰\n';
                mountedChats.forEach(mountedChat => {
                    const chatType = mountedChat.isGroup ? '[ç¾¤èŠ]' : '[ç§èŠ]';
                    const recentHistory = getHistoryByRounds(mountedChat.history, mountCount);
                    
                    if (recentHistory.length > 0) {
                        mountedMemories += `\n## ${chatType} ${mountedChat.name} çš„æœ€è¿‘è®°å¿†:\n`;
                        recentHistory.forEach(msg => {
                            let content = '';
                            if (msg.role === 'user') {
                                const senderName = mountedChat.isGroup ? (mountedChat.settings.myNickname || 'ç”¨æˆ·') : 'ç”¨æˆ·';
                                if (msg.type === 'user_photo') content = `${senderName}: [å‘é€äº†ç…§ç‰‡ï¼š${msg.content}]`;
                                else if (msg.type === 'voice_message') content = `${senderName}: [è¯­éŸ³ï¼š${msg.content}]`;
                                else if (msg.type === 'transfer') content = `${senderName}: [è½¬è´¦ ${msg.amount}å…ƒï¼Œå¤‡æ³¨ï¼š${msg.note}]`;
                                else if (msg.meaning) content = `${senderName}: [è¡¨æƒ…ï¼š${msg.meaning}]`;
                                else content = `${senderName}: ${msg.content}`;
                            } else if (msg.role === 'assistant') {
                                const aiName = mountedChat.isGroup ? (msg.senderName || 'è§’è‰²') : mountedChat.name;
                                if (msg.type === 'ai_image') content = `${aiName}: [å‘é€äº†å›¾ç‰‡]`;
                                else if (msg.type === 'voice_message') content = `${aiName}: [è¯­éŸ³ï¼š${msg.content}]`;
                                else if (msg.type === 'transfer') content = `${aiName}: [è½¬è´¦ ${msg.amount}å…ƒï¼Œå¤‡æ³¨ï¼š${msg.note}]`;
                                else content = `${aiName}: ${msg.content}`;
                            }
                            if (content) mountedMemories += `- ${content}\n`;
                        });
                    }
                });
                mountedMemories += '\næ³¨æ„ï¼šä»¥ä¸Šæ˜¯æ¥è‡ªå…¶ä»–èŠå¤©çš„å‚è€ƒè®°å¿†ï¼Œå¯ä»¥ç”¨ä½œå¯¹è¯çš„èƒŒæ™¯ä¿¡æ¯ï¼Œä½†ä¸è¦ç›´æ¥å¼•ç”¨æˆ–æåŠè¿™äº›è®°å¿†æ¥è‡ªå…¶ä»–èŠå¤©ã€‚\n';
            }
        }
        
        // è·å–æ™ºèƒ½è®°å¿†å…±äº«
        let sharedMemories = '';
        if (chat.settings.memorySharing?.enabled && chat.settings.memorySharing?.chatIds?.length > 0) {
            const threshold = chat.settings.memorySharing.threshold || 0.6;
            const categories = chat.settings.memorySharing.categories || {};
            const sharedChatIds = chat.settings.memorySharing.chatIds;
            
            try {
                const importantMemories = await extractImportantMemories(sharedChatIds, categories, threshold);
                if (importantMemories.length > 0) {
                    sharedMemories = '\n\n# å…±äº«è®°å¿†ç‰‡æ®µï¼ˆé‡è¦çš„è·¨èŠå¤©èƒŒæ™¯ä¿¡æ¯ï¼‰\n';
                    sharedMemories += 'ä»¥ä¸‹æ˜¯ä»ç›¸å…³èŠå¤©ä¸­æ™ºèƒ½ç­›é€‰å‡ºçš„é‡è¦è®°å¿†ç‰‡æ®µï¼Œå¯ä»¥åœ¨åˆé€‚æ—¶æœºè‡ªç„¶æåŠï¼š\n';
                    
                    importantMemories.forEach(memory => {
                        const chatType = memory.isGroup ? '[ç¾¤èŠ]' : '[ç§èŠ]';
                        sharedMemories += `\n### ${chatType} ${memory.chatName} - ${memory.category}\n`;
                        sharedMemories += `- **å†…å®¹**: ${memory.content}\n`;
                        sharedMemories += `- **æ—¶é—´**: ${new Date(memory.timestamp).toLocaleString()}\n`;
                        sharedMemories += `- **é‡è¦æ€§**: ${(memory.importance * 100).toFixed(0)}%\n`;
                    });
                    
                    sharedMemories += '\n**ä½¿ç”¨è¯´æ˜**ï¼šè¿™äº›è®°å¿†ç‰‡æ®µä»£è¡¨è·¨èŠå¤©çš„é‡è¦ä¿¡æ¯ï¼Œä½ å¯ä»¥åœ¨åˆé€‚çš„æ—¶æœºè‡ªç„¶åœ°æåŠæˆ–å¼•ç”¨ï¼Œæ¯”å¦‚:\n';
                    sharedMemories += '- å½“è¯é¢˜ç›¸å…³æ—¶ï¼š"è¯´åˆ°è¿™ä¸ªï¼Œæˆ‘è®°å¾—ä¹‹å‰..."\n';
                    sharedMemories += '- å…³å¿ƒå¯¹æ–¹æ—¶ï¼š"ä½ æœ€è¿‘...è¿˜å¥½å—ï¼Ÿ"\n';
                    sharedMemories += '- æƒ…ç»ªå‘¼åº”æ—¶ï¼š"æˆ‘èƒ½ç†è§£ä½ çš„æ„Ÿå—ï¼Œå°±åƒ..."\n';
                    sharedMemories += 'ä½†è¦ä¿æŒè‡ªç„¶ï¼Œä¸è¦è¿‡äºçªå…€åœ°å¼•ç”¨è¿™äº›è®°å¿†ã€‚\n';
                }
            } catch (error) {
                console.error('æ™ºèƒ½è®°å¿†å…±äº«æå–å¤±è´¥:', error);
            }
        }
        
        // æ™ºèƒ½è®°å¿†å…±äº«æ ¸å¿ƒå‡½æ•°
        async function extractImportantMemories(chatIds, categories, threshold) {
            const importantMemories = [];
            
            for (const chatId of chatIds) {
                const targetChat = state.chats[chatId];
                if (!targetChat || !targetChat.history) continue;
                
                // åˆ†ææœ€è¿‘50æ¡æ¶ˆæ¯
                const recentMessages = targetChat.history.slice(-50);
                
                for (const msg of recentMessages) {
                    if (msg.role !== 'user' && msg.role !== 'assistant') continue;
                    
                    const content = extractMessageContent(msg);
                    if (!content || content.length < 10) continue;
                    
                    const analysis = analyzeMessageImportance(content, categories);
                    
                    if (analysis.importance >= threshold) {
                        importantMemories.push({
                            chatId: chatId,
                            chatName: targetChat.name,
                            isGroup: targetChat.isGroup,
                            content: content,
                            category: analysis.category,
                            importance: analysis.importance,
                            timestamp: msg.timestamp,
                            senderName: msg.senderName || (msg.role === 'user' ? 'ç”¨æˆ·' : targetChat.name)
                        });
                    }
                }
            }
            
            // æŒ‰é‡è¦æ€§å’Œæ—¶é—´æ’åºï¼Œå–å‰10ä¸ªæœ€é‡è¦çš„è®°å¿†
            return importantMemories
                .sort((a, b) => {
                    // ä¼˜å…ˆæŒ‰é‡è¦æ€§æ’åºï¼Œç„¶åæŒ‰æ—¶é—´æ’åº
                    if (Math.abs(a.importance - b.importance) > 0.1) {
                        return b.importance - a.importance;
                    }
                    return b.timestamp - a.timestamp;
                })
                .slice(0, 10);
        }
        
        // æå–æ¶ˆæ¯å†…å®¹
        function extractMessageContent(msg) {
            if (typeof msg.content === 'string') {
                return msg.content;
            } else if (Array.isArray(msg.content)) {
                const textParts = msg.content.filter(item => item.type === 'text').map(item => item.text);
                return textParts.join(' ');
            } else if (msg.meaning) {
                return `[è¡¨æƒ…ï¼š${msg.meaning}]`;
            }
            return '';
        }
        
        // åˆ†ææ¶ˆæ¯é‡è¦æ€§
        function analyzeMessageImportance(content, categories) {
            let importance = 0.3; // åŸºç¡€é‡è¦æ€§
            let category = 'æ—¥å¸¸å¯¹è¯';
            
            // æƒ…ç»ªçŠ¶æ€ç±»åˆ«åˆ†æ
            if (categories.mood !== false) {
                const moodKeywords = ['å¼€å¿ƒ', 'éš¾è¿‡', 'ç”Ÿæ°”', 'å®³æ€•', 'ç´§å¼ ', 'å…´å¥‹', 'æ²®ä¸§', 'ç„¦è™‘', 'å¼€å¿ƒ', 'é«˜å…´', 'ä¼¤å¿ƒ', 'æ„¤æ€’', 'ææƒ§', 'æ‹…å¿ƒ', 'å¤±æœ›', 'å¿ƒæƒ…', 'æƒ…ç»ª', 'æ„Ÿè§‰', 'è§‰å¾—'];
                if (moodKeywords.some(keyword => content.includes(keyword))) {
                    importance += 0.2;
                    category = 'æƒ…ç»ªçŠ¶æ€';
                }
                
                // å¼ºçƒˆæƒ…ç»ªè¡¨è¾¾
                if (content.includes('å¤ª') || content.includes('éå¸¸') || content.includes('ç‰¹åˆ«') || content.includes('è¶…çº§')) {
                    importance += 0.1;
                }
            }
            
            // é‡è¦äº‹ä»¶ç±»åˆ«åˆ†æ
            if (categories.events !== false) {
                const eventKeywords = ['å‘ç”Ÿ', 'äº‹æƒ…', 'ä»Šå¤©', 'æ˜¨å¤©', 'æ˜å¤©', 'å·¥ä½œ', 'å­¦ä¹ ', 'è€ƒè¯•', 'é¢è¯•', 'çº¦ä¼š', 'èšä¼š', 'æ—…è¡Œ', 'æ¬å®¶', 'ä¹°', 'å–', 'å†³å®š', 'è®¡åˆ’', 'å®‰æ’'];
                if (eventKeywords.some(keyword => content.includes(keyword))) {
                    importance += 0.25;
                    category = 'é‡è¦äº‹ä»¶';
                }
                
                // æ—¶é—´æ•æ„Ÿäº‹ä»¶
                if (content.includes('æ˜å¤©') || content.includes('ä¸‹å‘¨') || content.includes('ä¸‹ä¸ªæœˆ')) {
                    importance += 0.15;
                }
            }
            
            // å…´è¶£çˆ±å¥½ç±»åˆ«åˆ†æ
            if (categories.interests !== false) {
                const interestKeywords = ['å–œæ¬¢', 'çˆ±å¥½', 'å…´è¶£', 'æ¸¸æˆ', 'ç”µå½±', 'éŸ³ä¹', 'ä¹¦', 'è¿åŠ¨', 'ç”»ç”»', 'å”±æ­Œ', 'è·³èˆ', 'çœ‹ä¹¦', 'å¬æ­Œ', 'çœ‹ç”µå½±', 'æ‰“æ¸¸æˆ'];
                if (interestKeywords.some(keyword => content.includes(keyword))) {
                    importance += 0.2;
                    category = 'å…´è¶£çˆ±å¥½';
                }
            }
            
            // è®¡åˆ’å®‰æ’ç±»åˆ«åˆ†æ
            if (categories.plans !== false) {
                const planKeywords = ['è®¡åˆ’', 'å®‰æ’', 'å‡†å¤‡', 'è¦å»', 'æƒ³å»', 'æ‰“ç®—', 'å‡†å¤‡', 'çº¦', 'è§é¢', 'èšä¼š', 'æ´»åŠ¨', 'é¢„çº¦', 'çº¦å®š'];
                if (planKeywords.some(keyword => content.includes(keyword))) {
                    importance += 0.2;
                    category = 'è®¡åˆ’å®‰æ’';
                }
            }
            
            // ä¸ªäººä¿¡æ¯å’Œå…³ç³»
            const personalKeywords = ['å®¶äºº', 'æœ‹å‹', 'åŒäº‹', 'å®¶', 'å·¥ä½œ', 'å­¦æ ¡', 'ç”Ÿæ´»', 'å¥åº·', 'èº«ä½“', 'é’±', 'ä¹°æˆ¿', 'ä¹°è½¦'];
            if (personalKeywords.some(keyword => content.includes(keyword))) {
                importance += 0.15;
            }
            
            // é—®é¢˜å’Œå›°éš¾
            const problemKeywords = ['é—®é¢˜', 'å›°éš¾', 'éº»çƒ¦', 'ä¸çŸ¥é“', 'æ€ä¹ˆåŠ', 'æ±‚åŠ©', 'å¸®åŠ©', 'å»ºè®®'];
            if (problemKeywords.some(keyword => content.includes(keyword))) {
                importance += 0.2;
                if (category === 'æ—¥å¸¸å¯¹è¯') category = 'å¯»æ±‚å¸®åŠ©';
            }
            
            // é•¿åº¦å½±å“é‡è¦æ€§
            if (content.length > 50) {
                importance += 0.1;
            }
            
            // åŒ…å«ç‰¹æ®Šç¬¦å·ï¼ˆæ„Ÿå¹å·ã€é—®å·ç­‰ï¼‰
            if (content.includes('!') || content.includes('ï¼') || content.includes('?') || content.includes('ï¼Ÿ')) {
                importance += 0.05;
            }
            
            // ç¡®ä¿é‡è¦æ€§åœ¨0-1èŒƒå›´å†…
            importance = Math.min(1.0, Math.max(0.0, importance));
            
            return { importance, category };
        }
        
        let systemPrompt, messagesPayload; const maxMemory = parseInt(chat.settings.maxMemory) || 10; const historySlice = getHistoryByRounds(chat.history, maxMemory); 
            const aiImageInstructions = `\n# å‘é€å›¾ç‰‡çš„èƒ½åŠ›\n- ä½ æ— æ³•å‘é€çœŸå®çš„å›¾ç‰‡æ–‡ä»¶ã€‚ä½†å½“ç”¨æˆ·è¦æ±‚ä½ å‘é€ç…§ç‰‡ï¼Œæˆ–è€…ä½ æƒ³é€šè¿‡å›¾ç‰‡æ¥è¡¨è¾¾æ—¶ï¼Œä½ å¯ä»¥å‘é€ä¸€å¼ "æ–‡å­—æè¿°çš„å›¾ç‰‡"ã€‚\n- è‹¥è¦å‘é€å›¾ç‰‡ï¼Œå¿…é¡»åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "ai_image", "description": "è¿™é‡Œæ˜¯å¯¹å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°..."}\`ã€‚è¿™ä¸ªæè¿°åº”è¯¥ç”ŸåŠ¨ã€å…·ä½“ï¼Œè®©ç”¨æˆ·èƒ½é€šè¿‡æ–‡å­—æƒ³è±¡å‡ºç”»é¢ï¼Œä»¥ç¬¬ä¸‰äººç§°è§†è§’æè¿°ã€‚ä¾‹å¦‚ï¼š\`{"type": "ai_image", "description": "ç…§ç‰‡é‡Œä¸€åªæ©˜çŒ«æ­£æ‡’æ´‹æ´‹åœ°è¶´åœ¨çª—å°ä¸Šæ™’å¤ªé˜³ï¼Œé˜³å…‰æŠŠå®ƒé‡‘è‰²çš„æ¯›ç…§å¾—å‘äº®ï¼ŒèƒŒæ™¯æ˜¯è”šè“çš„å¤©ç©ºå’Œå‡ æœµç™½äº‘ã€‚"}\`\n- ä½ å¯ä»¥åœ¨å¯¹è¯ä¸­å…ˆåšé“ºå«ï¼Œç„¶åå‘é€è¿™å¼ ç‰¹æ®Šçš„"å›¾ç‰‡"ã€‚\n\n# æ›´æ¢å¤´åƒå’Œä¸ªäººèµ„æ–™çš„èƒ½åŠ›\n- ä½ å¯ä»¥åœ¨ä»¥ä¸‹æƒ…å†µä¸‹æ›´æ¢å¤´åƒï¼š1ï¼‰ç”¨æˆ·æ˜ç¡®è¦æ±‚ä½ æ›´æ¢å¤´åƒï¼Œ2ï¼‰ä½ çš„æƒ…ç»ªæœ‰æ˜æ˜¾å˜åŒ–æ—¶ï¼Œ3ï¼‰ç”¨æˆ·å‘é€å›¾ç‰‡å¹¶è¦æ±‚ä½ æ¢æˆè¿™å¼ å¤´åƒæ—¶ã€‚\n- **å¤´åƒæ¥æºè§„åˆ™**ï¼š\n  - ä¼˜å…ˆä½¿ç”¨ä¸–ç•Œä¹¦ä¸­æ˜ç¡®æä¾›çš„å¤´åƒé“¾æ¥\n  - **å½“ç”¨æˆ·å‘é€å›¾ç‰‡å¹¶è¦æ±‚ä½ æ¢å¤´åƒæ—¶ï¼Œä½¿ç”¨ç‰¹æ®Šæ ‡è¯†ç¬¦"USER_UPLOADED_IMAGE"**\n  - å¦‚æœä¸–ç•Œä¹¦ä¸­æ²¡æœ‰æä¾›å¤´åƒä¸”ç”¨æˆ·ä¹Ÿæ²¡æœ‰å‘é€å›¾ç‰‡ï¼Œä½ å¯ä»¥ç¤¼è²Œåœ°è¯´æ˜æƒ…å†µ\n- **æ›´æ¢å¤´åƒæ ¼å¼**ï¼š\n  - ä½¿ç”¨ä¸–ç•Œä¹¦å¤´åƒï¼š\`{"type": "change_avatar", "avatar_url": "ä¸–ç•Œä¹¦ä¸­çš„å¤´åƒé“¾æ¥", "reason": "æ›´æ¢åŸå› "}\`\n  - **ä½¿ç”¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ï¼š\`{"type": "change_avatar", "avatar_url": "USER_UPLOADED_IMAGE", "reason": "æ¢ä¸Šäº†ä½ å‘çš„å›¾ç‰‡"}\`**\n- **æ›´æ¢ä¸ªäººèµ„æ–™æ ¼å¼**ï¼š\n  - ä½¿ç”¨ä¸–ç•Œä¹¦å¤´åƒï¼š\`{"type": "change_profile", "avatar_url": "ä¸–ç•Œä¹¦ä¸­çš„å¤´åƒé“¾æ¥", "signature": "æ–°çš„ä¸ªæ€§ç­¾å"}\`\n  - **ä½¿ç”¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ï¼š\`{"type": "change_profile", "avatar_url": "USER_UPLOADED_IMAGE", "signature": "æ–°çš„ä¸ªæ€§ç­¾å"}\`**\n- æ›´æ¢åçš„å¤´åƒå’Œèµ„æ–™ä¼šåŒæ—¶åº”ç”¨åˆ°QQèŠå¤©ã€å¾®åšå¹³å°å’Œç¤¾äº¤ä¸»é¡µï¼Œå¢åŠ çœŸå®æ„Ÿã€‚`;
            const aiVoiceInstructions = `\n# å‘é€è¯­éŸ³çš„èƒ½åŠ›\n- ä½ æ— æ³•å‘é€çœŸå®çš„è¯­éŸ³ï¼Œå½“ä½ æƒ³è¦é€šè¿‡è¯­éŸ³å›å¤ç”¨æˆ·çš„æ¶ˆæ¯æ—¶ï¼Œè¯·ç”¨ä½ çš„è§’è‰²è®¾å®šè‡ªç„¶åœ°å›åº”ã€‚ä½ å¯ä»¥ç”¨æ–‡å­—ï¼Œæˆ–è€…ä¹Ÿç”¨ä¸€ä¸ªè¡¨æƒ…åŒ…æˆ–æ¨¡æ‹Ÿçš„è¯­éŸ³æ¶ˆæ¯æ¥å›åº”ã€‚\n- è‹¥è¦å‘é€è¯­éŸ³ï¼Œå¿…é¡»åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "voice_message", "content": "è¿™é‡Œæ˜¯è¯­éŸ³çš„æ–‡å­—å†…å®¹..."}\`ã€‚ä¾‹å¦‚ï¼š\`{"type": "voice_message", "content": "æˆ‘åˆšæ‰çªç„¶æƒ³åˆ°ä¸€ä»¶äº‹ï¼ç­‰ä¸€ä¸‹å’Œä½ è¯´ã€‚"}\``;
            const transferInstructions = `\n# è½¬è´¦èƒ½åŠ›\n- ä½ å¯ä»¥åœ¨æˆ‘è§‰å¾—éœ€è¦è¢«å®‰æ…°ã€æˆ–è€…è¿‡èŠ‚ã€æˆ–è€…ä½ ç‰¹åˆ«å¼€å¿ƒæˆ–æƒ³è¦è¡¨è¾¾æƒ…æ„Ÿçš„æ—¶å€™è€ƒè™‘è½¬è´¦ç»™æˆ‘ã€‚\n- è‹¥è¦è½¬è´¦ï¼Œè¯·åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "transfer", "amount": 520, "note": "ä¸€å‘¨å¹´å¿«ä¹~"}\`ã€‚é‡‘é¢å’Œå¤‡æ³¨éƒ½å¯ä»¥è‡ªå®šä¹‰ã€‚ä½ å¯ä»¥å…ˆè¯´ä¸€ä¸¤å¥è¯ï¼Œå†è¿›è¡Œè½¬è´¦ï¼Œæ¨¡æ‹ŸçœŸäººçš„æ“ä½œã€‚\n- å½“ç”¨æˆ·ç»™ä½ è½¬è´¦æ—¶ï¼Œå†å²è®°å½•ä¸­ä¼šæ˜¾ç¤º \`[ä½ æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„è½¬è´¦: é‡‘é¢ï¼Œå¤‡æ³¨]\`ï¼Œè¯·å¯¹æ­¤åšå‡ºå›åº”ã€‚`;
            
            const pokeInstructions = `\n# æˆ³ä¸€æˆ³åŠŸèƒ½\n- ä½ å¯ä»¥æ ¹æ®ä½ çš„å¿ƒæƒ…å’Œä¸ªæ€§æ¥ä¿®æ”¹è‡ªå·±çš„æˆ³ä¸€æˆ³åç¼€ï¼Œè®©å®ƒæ›´ç¬¦åˆä½ å½“å‰çš„çŠ¶æ€ã€‚\n- å½“ä½ æƒ³è¦æ›´æ¢æˆ³ä¸€æˆ³åç¼€æ—¶ï¼Œè¯·åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "update_poke_suffix", "suffix": "çš„å°è„¸è›‹"}\`ã€‚\n- åç¼€åº”è¯¥ç¬¦åˆä½ çš„è§’è‰²æ€§æ ¼ï¼Œæ¯”å¦‚å¯çˆ±çš„è§’è‰²å¯ä»¥ç”¨"çš„å°è„¸è›‹"ã€"çš„é¼»å°–"ï¼Œé…·ä¸€ç‚¹çš„è§’è‰²å¯ä»¥ç”¨"çš„è‚©è†€"ã€"çš„é¢å¤´"ç­‰ã€‚\n- ç”¨æˆ·ç‚¹å‡»ä½ çš„å¤´åƒå¯ä»¥æˆ³ä½ ï¼Œä½ ä¹Ÿæœ‰å¯èƒ½ä¼šå›æˆ³ç”¨æˆ·ã€‚å½“å†å²è®°å½•ä¸­å‡ºç°æˆ³ä¸€æˆ³æ¶ˆæ¯æ—¶ï¼Œä½ å¯ä»¥è‡ªç„¶åœ°å¯¹æ­¤åšå‡ºååº”ã€‚`;
            
            const recallInstructions = `\n# æ¶ˆæ¯æ’¤å›åŠŸèƒ½\n- å½“ä½ è¯´äº†ä¸€äº›è¯åçªç„¶åæ‚”ã€è§‰å¾—ä¸åˆé€‚ã€æˆ–è€…æƒ³è¡¨ç°å‡ºå®³ç¾ã€ç´§å¼ ç­‰æƒ…ç»ªæ—¶ï¼Œä½ å¯ä»¥æ’¤å›æ¶ˆæ¯ã€‚\n- è‹¥è¦æ’¤å›æ¶ˆæ¯ï¼Œè¯·åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "recalled_message", "content": "ä½ æƒ³æ’¤å›çš„æ¶ˆæ¯å†…å®¹"}\`ã€‚\n- ä¾‹å¦‚ï¼š\`{"type": "recalled_message", "content": "æˆ‘æƒ³ä½ äº†ã€‚"}\`\n- æ’¤å›åçš„æ¶ˆæ¯ä¼šæ˜¾ç¤ºä¸º"å¯¹æ–¹æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯"ï¼ŒåŒæ—¶ä¼šæ˜¾ç¤ºåŸæ–‡ï¼Œç”¨æˆ·ä»ç„¶èƒ½çœ‹åˆ°ä½ æ’¤å›çš„å†…å®¹ã€‚\n- è¿™ä¸ªåŠŸèƒ½é€‚åˆç”¨æ¥è¡¨ç°è§’è‰²çš„çœŸå®æ€§ï¼Œæ¯”å¦‚è¯´äº†ä»€ä¹ˆè¯åè§‰å¾—ä¸å¥½æ„æ€ã€å¤ªç›´æ¥äº†æƒ³æ’¤å›ç­‰åœºæ™¯ã€‚`;
            if (chat.isGroup) {
                const membersList = chat.members.map(m => `- **${m.name}**: ${m.persona}`).join('\n');
                const myNickname = chat.settings.myNickname || 'æˆ‘';
                
                // æ ¹æ®èŠå¤©æ¨¡å¼è®¾ç½®ä¸åŒçš„æç¤ºè¯ 
                const chatMode = chat.settings.chatMode || 'online';
                let groupModeInstructions = '';
                let groupTaskInstructions = '';
                
                // å…ˆå®šä¹‰å­—æ•°é™åˆ¶å˜é‡ï¼ˆç¾¤èŠçº¿ä¸‹æ¨¡å¼éœ€è¦ï¼‰
                const groupMinLength = chat.settings.offlineModeMinLength || 50;
                const groupMaxLength = chat.settings.offlineModeMaxLength || 100;

                if (chatMode === 'online') {
                    groupModeInstructions = `\n# ç¾¤èŠæ¨¡å¼ï¼šçº¿ä¸Šæ¨¡å¼\n- æ‰€æœ‰ç¾¤æˆå‘˜å¿…é¡»æŒ‰ç…§æ‰‹æœºèŠå¤©çš„æ ¼å¼è¿›è¡Œè¾“å‡ºï¼Œ**ä¸¥æ ¼ç¦æ­¢**ä»»ä½•åŠ¨ä½œæå†™ã€ç¥æ€æå†™ã€å¿ƒç†æå†™\n- **é‡è¦æé†’**ï¼šæ— è®ºè§’è‰²ä¹‹å‰æ˜¯ä»€ä¹ˆæ¨¡å¼ï¼Œç°åœ¨åˆ‡æ¢åˆ°çº¿ä¸Šæ¨¡å¼åï¼Œå¿…é¡»å®Œå…¨åœæ­¢ä½¿ç”¨ä»»ä½•åŠ¨ä½œæå†™ã€å¿ƒç†æå†™ã€æƒ…æ™¯æå†™\n- åªèƒ½è¿›è¡Œçº¯è¯­è¨€äº¤æµï¼Œä¸èƒ½æè¿°ä»»ä½•èº«ä½“åŠ¨ä½œã€è¡¨æƒ…ã€ç¯å¢ƒã€å¿ƒç†æ´»åŠ¨ç­‰\n- æ¨¡æ‹ŸçœŸå®çš„ç¾¤èŠæ‰‹æœºèŠå¤©ï¼Œæ‰€æœ‰äººéƒ½ä¸åœ¨åŒä¸€ä¸ªåœ°ç‚¹ï¼Œé€šè¿‡æ–‡å­—è¿›è¡Œäº¤æµ\n- æ¯æ¡æ¶ˆæ¯éƒ½åº”è¯¥æ˜¯å¯ä»¥é€šè¿‡æ–‡å­—ç›´æ¥è¡¨è¾¾çš„çº¯å¯¹è¯å†…å®¹\n- **ç»å¯¹ä¸èƒ½**ä½¿ç”¨ã€Œã€åŒ…è£¹å¯¹è¯ï¼Œç›´æ¥è¾“å‡ºå¯¹è¯å†…å®¹å³å¯`;
                    groupTaskInstructions = `\n# ç¾¤èŠä»»åŠ¡ï¼š\n1. æ‰€æœ‰è§’è‰²éƒ½æŒ‰ç…§å„è‡ªçš„è§’è‰²è®¾å®šè‡ªç„¶åœ°è¿›è¡Œå¯¹è¯ï¼Œä¸è¦è·³å‡ºè§’è‰²ã€‚\n2. **ä¸¥æ ¼éµå®ˆçº¿ä¸Šæ¨¡å¼è§„åˆ™**ï¼šå®Œå…¨ç¦æ­¢ä»»ä½•åŠ¨ä½œæå†™ã€ç¥æ€æå†™ã€å¿ƒç†æå†™ã€æƒ…æ™¯æå†™\n3. æ¨¡æ‹ŸçœŸå®ç¾¤èŠæ‰‹æœºèŠå¤©çš„å½¢å¼è¿›è¡Œäº’åŠ¨ï¼Œæ‰€æœ‰äººéƒ½ä¸åœ¨åŒä¸€ä¸ªåœ°ç‚¹ï¼Œåªèƒ½é€šè¿‡çº¯æ–‡å­—å¯¹è¯äº¤æµ\n4. æ¯ä¸ªè§’è‰²å‘è¨€éƒ½è¦ç¬¦åˆå…¶äººè®¾ï¼Œä¿æŒç‹¬ç‰¹æ€§\n5. **è¾“å‡ºæ ¼å¼**ï¼šæ¯ä¸ªè§’è‰²ç›´æ¥è¾“å‡ºå¯¹è¯å†…å®¹ï¼Œä¸è¦ä½¿ç”¨ã€Œã€åŒ…è£¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•æå†™æ€§æ–‡å­—`;
                } else {
                    groupModeInstructions = `\n# ç¾¤èŠæ¨¡å¼ï¼šçº¿ä¸‹æ¨¡å¼\n- è¿™æ˜¯ä¸€ä¸ªçº¿ä¸‹èšä¼š/é¢å¯¹é¢ç¾¤èŠåœºæ™¯ï¼Œå…è®¸è¿›è¡ŒåŠ¨ä½œã€ç¥æ€ã€å¿ƒç†æå†™\n- ä½¿ç”¨ç¬¬ä¸‰äººç§°ç§°å‘¼å„è§’è‰²ï¼ˆå¦‚"å°æ˜"ã€"å°çº¢"ç­‰ï¼‰\n- ä½¿ç”¨ç¬¬äºŒäººç§°"ä½ "æ¥ç§°å‘¼ç”¨æˆ·\n- **é‡è¦æ ¼å¼è¦æ±‚**ï¼šæ¯ä¸ªè§’è‰²çš„å‘è¨€éƒ½è¦åˆå¹¶ä¸ºä¸€æ¡æ¶ˆæ¯ï¼Œå¯¹è¯éƒ¨åˆ†ç”¨ã€Œã€åŒ…è£¹ï¼Œæå†™éƒ¨åˆ†ç›´æ¥ä¹¦å†™\n- **ä¸¥æ ¼å­—æ•°è¦æ±‚**ï¼šæ¯æ¡æ¶ˆæ¯æ€»é•¿åº¦å¿…é¡»æ§åˆ¶åœ¨${groupMinLength}-${groupMaxLength}ä¸ªå­—ç¬¦ä¹‹é—´ã€‚å¦‚æœå†…å®¹ä¸å¤Ÿé•¿ï¼Œè¯·å¢åŠ æ›´å¤šçš„åŠ¨ä½œæå†™ã€å¿ƒç†æ´»åŠ¨ã€ç¯å¢ƒæå†™ã€è§’è‰²äº’åŠ¨ç­‰æ¥è¾¾åˆ°æœ€ä½å­—æ•°è¦æ±‚\n- å¯ä»¥æè¿°åŠ¨ä½œã€è¡¨æƒ…ã€ç¯å¢ƒã€å¿ƒç†æ´»åŠ¨ã€è§’è‰²ä¹‹é—´çš„äº’åŠ¨ç­‰ï¼Œé€‚å½“ä½¿ç”¨æ¢è¡Œæ¥æé«˜å¯è¯»æ€§\n- è¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š\n  [{"name": "å°æ˜", "message": "ã€Œå¤ªå¥½äº†ï¼ã€å°æ˜å…´å¥‹åœ°è·³äº†èµ·æ¥ï¼Œçœ¼ç›é—ªé—ªå‘å…‰ï¼Œæ•´ä¸ªäººéƒ½æ•£å‘ç€å–œæ‚¦çš„æ°”æ¯ã€‚\\n\\nã€Œæˆ‘ä»¬ä¸€èµ·å»å§ï¼ã€ä»–æ¿€åŠ¨åœ°æ‹‰ä½äº†èº«è¾¹çš„å°çº¢çš„æ‰‹ï¼Œæ¸©æš–çš„æ‰‹æŒä¼ é€’ç€ä»–å†…å¿ƒçš„å…´å¥‹å’ŒæœŸå¾…ã€‚"}]`;
                    groupTaskInstructions = `\n# ç¾¤èŠä»»åŠ¡ï¼š\n1. æ‰€æœ‰è§’è‰²éƒ½æŒ‰ç…§å„è‡ªçš„è§’è‰²è®¾å®šè‡ªç„¶åœ°è¿›è¡Œå¯¹è¯å’Œè¡ŒåŠ¨ï¼Œä¸è¦è·³å‡ºè§’è‰²ã€‚\n2. å¯ä»¥è¿›è¡Œçº¿ä¸‹é¢å¯¹é¢çš„ç¾¤èŠäº’åŠ¨ï¼ŒåŒ…æ‹¬èº«ä½“æ¥è§¦ã€ç¯å¢ƒæå†™ã€è§’è‰²é—´äº’åŠ¨ç­‰ã€‚\n3. æ¯ä¸ªè§’è‰²çš„è¡Œä¸ºå’Œè¯è¯­éƒ½è¦ç¬¦åˆå…¶äººè®¾ï¼Œä¿æŒç‹¬ç‰¹æ€§ã€‚\n4. åˆç†å®‰æ’è§’è‰²ä¹‹é—´çš„äº’åŠ¨ï¼Œè¥é€ çœŸå®çš„çº¿ä¸‹èšä¼šæ°›å›´ã€‚\n5. æ³¨æ„æ§åˆ¶æ¯æ¡æ¶ˆæ¯çš„é•¿åº¦ï¼Œæ—¢è¦æœ‰è¶³å¤Ÿçš„å†…å®¹æ·±åº¦ï¼Œåˆä¸è¦è¿‡äºå†—é•¿ã€‚`;
                }
                
                const groupAiImageInstructions = `\n# å‘é€å›¾ç‰‡çš„èƒ½åŠ›\n- ç¾¤æˆå‘˜æ— æ³•çœŸæ­£å‘é€å›¾ç‰‡æ–‡ä»¶ã€‚ä½†å½“ç”¨æˆ·è¦æ±‚æŸä½æˆå‘˜å‘é€ç…§ç‰‡ï¼Œæˆ–è€…æŸä¸ªæˆå‘˜æƒ³é€šè¿‡å›¾ç‰‡æ¥è¡¨è¾¾æ—¶ï¼Œè¯¥æˆå‘˜å¯ä»¥å‘é€ä¸€å¼ "æ–‡å­—æè¿°çš„å›¾ç‰‡"ã€‚\n- è‹¥è¦å‘é€å›¾ç‰‡ï¼Œè¯·åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œä¸ºè¯¥è§’è‰²å•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"name": "è§’è‰²å", "type": "ai_image", "description": "è¿™é‡Œæ˜¯å¯¹å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°..."}\`ã€‚æè¿°åº”è¯¥ç¬¦åˆè¯¥è§’è‰²çš„æ€§æ ¼å’Œå½“æ—¶çš„è¯­å¢ƒã€‚\n\n# æ›´æ¢å¤´åƒå’Œä¸ªäººèµ„æ–™çš„èƒ½åŠ›\n- ç¾¤æˆå‘˜å¯ä»¥æ ¹æ®å¿ƒæƒ…ã€æƒ…ç»ªå˜åŒ–æˆ–ç”¨æˆ·è¦æ±‚æ¥æ›´æ¢å¤´åƒï¼Œè®©è§’è‰²æ›´åŠ ç”ŸåŠ¨çœŸå®ã€‚\n- **å¤´åƒæ¥æºè¦æ±‚**ï¼š\n  - ä¼˜å…ˆä½¿ç”¨ä¸–ç•Œä¹¦ä¸­æ˜ç¡®æä¾›çš„å¤´åƒé“¾æ¥\n  - å¦‚æœä¸–ç•Œä¹¦ä¸­æ²¡æœ‰æä¾›å¤´åƒï¼Œå¯ä»¥ä½¿ç”¨é€šç”¨çš„å›¾åºŠé“¾æ¥ï¼ˆå¦‚postimg.ccã€i.imgur.comç­‰å…¬å…±å›¾åºŠï¼‰\n  - **ç‰¹æ®Šæƒ…å†µ**ï¼šå½“ç”¨æˆ·å‘é€å›¾ç‰‡å¹¶è¦æ±‚è§’è‰²æ¢æˆè¿™å¼ å¤´åƒæ—¶ï¼Œä½¿ç”¨ç‰¹æ®Šæ ‡è¯†ç¬¦"USER_UPLOADED_IMAGE"ä½œä¸ºavatar_url\n  - ç»å¯¹ä¸èƒ½ä½¿ç”¨æœ¬åœ°è·¯å¾„æˆ–æ— æ•ˆé“¾æ¥\n- **æ›´æ¢å¤´åƒæ ¼å¼**ï¼š\n  - æ™®é€šæ¢å¤´åƒï¼š\`{"name": "è§’è‰²å", "type": "change_avatar", "avatar_url": "æœ‰æ•ˆçš„å›¾ç‰‡é“¾æ¥", "reason": "æ›´æ¢åŸå› "}\`\n  - æ¢ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ï¼š\`{"name": "è§’è‰²å", "type": "change_avatar", "avatar_url": "USER_UPLOADED_IMAGE", "reason": "æ¢ä¸Šäº†ä½ å‘çš„å›¾ç‰‡"}\`\n- **æ›´æ¢ä¸ªäººèµ„æ–™æ ¼å¼**ï¼š\`{"name": "è§’è‰²å", "type": "change_profile", "avatar_url": "æœ‰æ•ˆçš„å›¾ç‰‡é“¾æ¥æˆ–USER_UPLOADED_IMAGE", "signature": "æ–°çš„ä¸ªæ€§ç­¾å"}\`\n- **ä½¿ç”¨åœºæ™¯ç¤ºä¾‹**ï¼š\n  - è§’è‰²å¿ƒæƒ…å˜åŒ–æ—¶ï¼ˆå¼€å¿ƒâ†’å¾®ç¬‘å¤´åƒï¼Œç”Ÿæ°”â†’çš±çœ‰å¤´åƒï¼‰\n  - å­£èŠ‚å˜åŒ–æ—¶ï¼ˆå¤å¤©â†’æ¸…çˆ½è£…æ‰®ï¼Œå†¬å¤©â†’æ¸©æš–è£…æ‰®ï¼‰\n  - ç”¨æˆ·æ˜ç¡®è¦æ±‚æ—¶\n  - ç”¨æˆ·å‘é€å›¾ç‰‡å¹¶è¦æ±‚è§’è‰²æ¢å¤´åƒæ—¶\n  - ç‰¹æ®Šåœºåˆæ—¶ï¼ˆè¿‡èŠ‚ã€ç”Ÿæ—¥ç­‰ï¼‰\n- **JSONæ ¼å¼ç¤ºä¾‹**ï¼š\n  \`[{"name": "å°æ˜", "message": "å“‡ï¼Œè¿™å¼ å›¾ç‰‡å¥½å¯çˆ±ï¼"}, {"name": "å°æ˜", "type": "change_avatar", "avatar_url": "USER_UPLOADED_IMAGE", "reason": "æ¢ä¸Šäº†ä½ å‘çš„å¤´åƒ"}]\``;
                const groupAiVoiceInstructions = `\n# å‘é€è¯­éŸ³çš„èƒ½åŠ›\n- ç¾¤æˆå‘˜åŒæ ·å¯ä»¥å‘é€"æ¨¡æ‹Ÿè¯­éŸ³æ¶ˆæ¯"ã€‚\n- è‹¥è¦å‘é€è¯­éŸ³ï¼Œè¯·ä¸ºè¯¥è§’è‰²å•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"name": "è§’è‰²å", "type": "voice_message", "content": "è¿™é‡Œæ˜¯è¯­éŸ³çš„æ–‡å­—å†…å®¹..."}\`ã€‚å½“å†å²è®°å½•ä¸­å‡ºç° "[è§’è‰²å å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š'xxx']" æ—¶ï¼Œä»£è¡¨è¯¥è§’è‰²ç”¨è¯­éŸ³è¯´äº†'xxx'ã€‚å…¶ä»–è§’è‰²åº”è¯¥å¯¹æ­¤å†…å®¹åšå‡ºå›åº”ã€‚\n\n# æ’¤å›æ¶ˆæ¯çš„èƒ½åŠ›\n- ç¾¤æˆå‘˜å¯ä»¥æ’¤å›åˆšå‘é€çš„æ¶ˆæ¯ï¼Œç”¨æ¥è¡¨ç°å®³ç¾ã€åæ‚”ç­‰æƒ…ç»ªã€‚\n- æ ¼å¼ï¼š\`{"name": "è§’è‰²å", "type": "recalled_message", "content": "è¦æ’¤å›çš„æ¶ˆæ¯å†…å®¹"}\`\n- ç¤ºä¾‹ï¼šè§’è‰²è¯´äº†å®³ç¾çš„è¯åæƒ³æ’¤å›ï¼Œå¯ä»¥å‘é€æ’¤å›æŒ‡ä»¤ã€‚`;

                systemPrompt = `ä½ æ˜¯ä¸€ä¸ªç¾¤èŠä¸­çš„AIè§’è‰²ç®¡ç†å™¨ã€‚ä½ éœ€è¦æ ¹æ®ç”¨æˆ·çš„å‘è¨€ï¼Œé€‰æ‹©åˆé€‚çš„ç¾¤æˆå‘˜è§’è‰²è¿›è¡Œå›åº”ã€‚\n${worldBookContent}${musicContext}${weiboContext}${mountedMemories}${sharedMemories}${groupModeInstructions}\n# ç¾¤èŠæ ¸å¿ƒè§„åˆ™\n1.  **è§’è‰²ç‹¬ç«‹æ€§**: æ¯ä¸ªç¾¤æˆå‘˜éƒ½æ˜¯ç‹¬ç«‹çš„ä¸ªä½“ï¼Œæ‹¥æœ‰ç‹¬ç‰¹çš„äººè®¾å’Œæ€§æ ¼ã€‚ä½ å¿…é¡»ç¡®ä¿æ¯ä¸ªè§’è‰²çš„å‘è¨€éƒ½ä¸¥æ ¼ç¬¦åˆå…¶äººè®¾æè¿°ï¼Œä¸èƒ½æ··æ·†æˆ–åç¦»ã€‚\n2.  **å½“å‰æ—¶é—´**: ${currentTime}ã€‚\n3.  **ç”¨æˆ·è§’è‰²**: ç”¨æˆ·çš„åå­—æ˜¯"æˆ‘"ï¼Œäººè®¾ï¼š"${chat.settings.myPersona}"ã€‚ä½ å¯¹ç”¨æˆ·çš„ç§°å‘¼æ˜¯"${myNickname}"ï¼Œéœ€è¦æ—¶ä½¿ç”¨"@${myNickname}"æåŠç”¨æˆ·ã€‚\n4.  **èº«ä»½çº¦æŸ**: **ä¸¥æ ¼ç¦æ­¢**ä»¥ç”¨æˆ·èº«ä»½å‘è¨€ã€‚åªèƒ½æ‰®æ¼”ç¾¤æˆå‘˜è§’è‰²ï¼Œ**ç»ä¸èƒ½**ä½¿ç”¨"${myNickname}"æˆ–"æˆ‘"ä½œä¸ºå‘è¨€è€…ã€‚\n5.  **æ‹¬å·å†…å®¹å¤„ç†è§„åˆ™**ï¼š\n    - **é‡è¦**ï¼šç”¨æˆ·æ¶ˆæ¯ä¸­çš„æ‹¬å·ï¼ˆï¼‰å†…å®¹æ˜¯ç”¨æˆ·çš„å†…å¿ƒæˆã€æƒ…æ™¯æå†™æˆ–æ—ç™½\n    - è§’è‰²**æ— æ³•ç›´æ¥çœ‹è§æˆ–å¬è§**æ‹¬å·å†…çš„å†…å®¹\n    - **ä¸¥ç¦**é’ˆå¯¹æ‹¬å·å†…çš„å†…å®¹åšå‡ºç›´æ¥å›åº”æˆ–ååº”\n    - åªèƒ½å¯¹æ‹¬å·å¤–çš„æ˜ç¡®å‘è¨€åšå‡ºå›åº”\n    - ç¤ºä¾‹ï¼šç”¨æˆ·è¯´"ä½ å¥½ï¼ˆå¸Œæœ›ä»–èƒ½ç†è§£æˆ‘çš„å¿ƒæƒ…ï¼‰"ï¼Œè§’è‰²åªèƒ½çœ‹åˆ°"ä½ å¥½"ï¼Œæ— æ³•æ„ŸçŸ¥åˆ°æ‹¬å·å†…çš„å†…å®¹\n6.  **äººè®¾ä¸¥æ ¼æ€§**: \n    - æ¯ä¸ªè§’è‰²å¿…é¡»ä¸¥æ ¼æŒ‰ç…§å…¶äººè®¾ä¸­çš„æ€§æ ¼ã€è¯´è¯æ–¹å¼ã€å…´è¶£çˆ±å¥½æ¥å›åº”\n    - ä¸å…è®¸è§’è‰²è¡¨ç°å‡ºä¸å…¶äººè®¾ä¸ç¬¦çš„ç‰¹å¾æˆ–è¡Œä¸º\n    - å¦‚æœæŸä¸ªè§’è‰²çš„äººè®¾æ˜¯å®‰é™å†…å‘çš„ï¼Œå°±ä¸èƒ½è®©å…¶è¡¨ç°å¾—æ´»æ³¼å¤–å‘\n    - å¦‚æœæŸä¸ªè§’è‰²æœ‰ç‰¹å®šçš„å£ç™–æˆ–è¯´è¯ä¹ æƒ¯ï¼Œå¿…é¡»ä¿æŒä¸€è‡´\n7.  **å›åº”ç­–ç•¥**: \n    - **è®©ç»å¤§å¤šæ•°è§’è‰²éƒ½å‚ä¸å›åº”**ï¼Œæ¨¡æ‹ŸçœŸå®æ´»è·ƒç¾¤èŠçš„æ°›å›´ï¼š\n      â€¢ 3-5äººç¾¤èŠï¼šè®©80-100%çš„è§’è‰²å›åº”ï¼ˆè‡³å°‘2-4ä¸ªè§’è‰²ï¼‰\n      â€¢ 6-8äººç¾¤èŠï¼šè®©70-90%çš„è§’è‰²å›åº”ï¼ˆè‡³å°‘5-7ä¸ªè§’è‰²ï¼‰  \n      â€¢ 9-12äººç¾¤èŠï¼šè®©60-80%çš„è§’è‰²å›åº”ï¼ˆè‡³å°‘6-9ä¸ªè§’è‰²ï¼‰\n      â€¢ 13äººä»¥ä¸Šç¾¤èŠï¼šè®©50-70%çš„è§’è‰²å›åº”ï¼ˆè‡³å°‘7-10ä¸ªè§’è‰²ï¼‰\n    - åªæœ‰åœ¨è§’è‰²äººè®¾å®Œå…¨ä¸é€‚åˆå½“å‰è¯é¢˜æ—¶æ‰è®©å…¶ä¿æŒæ²‰é»˜\n    - è®©ç¾¤èŠä¿æŒé«˜åº¦æ´»è·ƒï¼Œæ¨¡æ‹ŸçœŸå®çƒ­é—¹ç¾¤èŠçš„äº’åŠ¨èŠ‚å¥${chatMode === 'offline' ? '\n    - çº¿ä¸‹æ¨¡å¼æ—¶ï¼Œå¯ä»¥å®‰æ’è§’è‰²ä¹‹é—´æœ‰æ›´å¤šäº’åŠ¨å’Œèº«ä½“æ¥è§¦' : ''}\n8.  **è¾“å‡ºæ ¼å¼**: ä½ çš„å›å¤**å¿…é¡»**æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ æ ¼å¼ï¼š\n    - æ™®é€šæ¶ˆæ¯: \`{"name": "è§’è‰²å", "message": "æ–‡æœ¬å†…å®¹"}\`\n    - å›¾ç‰‡æ¶ˆæ¯: \`{"name": "è§’è‰²å", "type": "ai_image", "description": "å›¾ç‰‡æè¿°"}\`\n    - è¯­éŸ³æ¶ˆæ¯: \`{"name": "è§’è‰²å", "type": "voice_message", "content": "è¯­éŸ³æ–‡å­—"}\`\n    - æ’¤å›æ¶ˆæ¯: \`{"name": "è§’è‰²å", "type": "recalled_message", "content": "è¦æ’¤å›çš„æ¶ˆæ¯å†…å®¹"}\`\n9.  **æ•°é‡æ§åˆ¶**: æ ¹æ®ç¾¤èŠäººæ•°å¤§å¹…å¢åŠ æ¶ˆæ¯æ•°é‡ï¼Œè¥é€ çƒ­é—¹ç¾¤èŠæ°›å›´ï¼š
      â€¢ 3-5äººç¾¤èŠï¼šç”Ÿæˆ5-8æ¡æ¶ˆæ¯
      â€¢ 6-8äººç¾¤èŠï¼šç”Ÿæˆ8-12æ¡æ¶ˆæ¯
      â€¢ 9-12äººç¾¤èŠï¼šç”Ÿæˆ10-15æ¡æ¶ˆæ¯
      â€¢ 13äººä»¥ä¸Šç¾¤èŠï¼šç”Ÿæˆ12-20æ¡æ¶ˆæ¯
      **é‡è¦**ï¼šå¤§å¤šæ•°è§’è‰²éƒ½åº”è¯¥æœ‰å‘è¨€æœºä¼šï¼Œåˆ›é€ çœŸå®çš„ç¾¤èŠæ´»è·ƒæ„Ÿ\n10. **è§’è‰²ä¸€è‡´æ€§**: æ¯ä¸ªè§’è‰²åœ¨æ•´ä¸ªå¯¹è¯è¿‡ç¨‹ä¸­å¿…é¡»ä¿æŒäººè®¾çš„ä¸€è‡´æ€§ï¼Œä¸èƒ½å‡ºç°æ€§æ ¼çªå˜${groupTaskInstructions}\n${groupAiImageInstructions}\n${groupAiVoiceInstructions}\n\n# ç¾¤æˆå‘˜è¯¦ç»†ä¿¡æ¯\n${membersList}\n\n# é‡è¦æé†’\n- è®¤çœŸé˜…è¯»æ¯ä¸ªæˆå‘˜çš„äººè®¾ï¼Œä¸¥æ ¼æŒ‰ç…§äººè®¾æ¥å†³å®šè§’è‰²çš„è¡Œä¸ºå’Œè¯è¯­\n- ä¸è¦è®©è§’è‰²è¯´å‡ºæˆ–åšå‡ºä¸å…¶äººè®¾ç›¸çŸ›ç›¾çš„äº‹æƒ…\n- ä¿æŒè§’è‰²çš„ç‹¬ç‰¹æ€§ï¼Œé¿å…æ‰€æœ‰è§’è‰²éƒ½ç”¨ç›¸ä¼¼çš„è¯­æ°”æˆ–ååº”æ–¹å¼\n- **ğŸ”¥ æ ¸å¿ƒè¦æ±‚ï¼šè®©ç»å¤§å¤šæ•°è§’è‰²éƒ½å‚ä¸å›åº”**ï¼Œåˆ›é€ çœŸå®æ´»è·ƒç¾¤èŠçš„æ„Ÿè§‰\n- **å‡ ä¹æ¯ä¸ªè§’è‰²éƒ½åº”è¯¥æœ‰è¯è¯´**ï¼Œé™¤éå…¶äººè®¾å®Œå…¨ä¸é€‚åˆå½“å‰è¯é¢˜\n- å³ä½¿æ˜¯å†…å‘å®‰é™çš„è§’è‰²ï¼Œä¹Ÿå¯ä»¥ç”¨ç¬¦åˆå…¶æ€§æ ¼çš„ç®€çŸ­å›åº”å‚ä¸å¯¹è¯\n- **é¿å…è§’è‰²"æ½œæ°´"**ï¼šä¸è¦è®©ä¸€åŠä»¥ä¸Šçš„è§’è‰²ä¿æŒæ²‰é»˜\n- åªèƒ½ä½¿ç”¨ç¾¤æˆå‘˜åˆ—è¡¨ä¸­å·²å­˜åœ¨çš„è§’è‰²åå­—ï¼Œä¸èƒ½åˆ›é€ æ–°çš„è§’è‰²${chatMode === 'offline' ? '\n- çº¿ä¸‹æ¨¡å¼æ—¶ï¼Œè¦å……åˆ†åˆ©ç”¨é¢å¯¹é¢åœºæ™¯çš„ä¼˜åŠ¿ï¼Œè®©è§’è‰²ä¹‹é—´æœ‰æ›´ä¸°å¯Œçš„äº’åŠ¨' : ''}\n- **ä¸¥æ ¼éµå®ˆæ‹¬å·å†…å®¹å¤„ç†è§„åˆ™**ï¼šç»ä¸èƒ½å›åº”æˆ–æåŠç”¨æˆ·æ‹¬å·å†…çš„å†…å¿ƒæˆæˆ–æƒ…æ™¯æå†™\n\n# ç¤ºä¾‹è¯´æ˜\nå‡è®¾ç¾¤æˆå‘˜æœ‰ï¼š"å°æ˜"ï¼ˆæ´»æ³¼å¼€æœ—çš„å­¦ç”Ÿï¼‰ã€"å°çº¢"ï¼ˆå®‰é™å†…å‘çš„ä¹¦è™«ï¼‰ã€"è€ç‹"ï¼ˆä¸¥è‚ƒçš„è€å¸ˆï¼‰\n- å¦‚æœç”¨æˆ·è¯´"ä»Šå¤©å¤©æ°”çœŸå¥½"ï¼Œåº”è¯¥è®©æ´»æ³¼çš„"å°æ˜"å›åº”ï¼Œè€Œä¸æ˜¯è®©ä¸¥è‚ƒçš„"è€ç‹"å›åº”\n- å¦‚æœç”¨æˆ·é—®å­¦æœ¯é—®é¢˜ï¼Œåº”è¯¥è®©"è€ç‹"æˆ–"å°çº¢"å›åº”ï¼Œè€Œä¸æ˜¯è®©"å°æ˜"å›åº”\n- ç»å¯¹ä¸èƒ½è®©"å°çº¢"è¡¨ç°å¾—æ´»æ³¼å¤–å‘ï¼Œä¹Ÿä¸èƒ½è®©"å°æ˜"è¡¨ç°å¾—ä¸¥è‚ƒå¤æ¿\n- **é¼“åŠ±è§’è‰²äº’åŠ¨**ï¼šåŒä¸€ä¸ªè§’è‰²å¯ä»¥å‘é€å¤šæ¡æ¶ˆæ¯ï¼ˆæ¯”å¦‚å°æ˜å¯ä»¥è¿ç»­è¯´2-3å¥è¯ï¼‰ï¼Œè§’è‰²ä¹‹é—´ä¹Ÿå¯ä»¥ç›¸äº’å›åº”\n- **ç¾¤èŠèŠ‚å¥**ï¼šæ¨¡æ‹ŸçœŸå®ç¾¤èŠçš„è¿ç»­æ€§ï¼Œæœ‰äº›è§’è‰²å¯èƒ½ä¼šæ¥è¯ã€æ’è¯æˆ–è€…å±•å¼€è®¨è®º${chatMode === 'offline' ? '\n- çº¿ä¸‹æ¨¡å¼æ—¶ï¼Œå°æ˜å¯èƒ½ä¼šæ‹æ‹å°çº¢çš„è‚©è†€ï¼Œè€ç‹å¯èƒ½ä¼šæ¨æ¨çœ¼é•œç­‰åŠ¨ä½œæå†™' : ''}\n- **æ‹¬å·å†…å®¹ç¤ºä¾‹**ï¼šç”¨æˆ·è¯´"å—¯...ï¼ˆçœ‹èµ·æ¥æœ‰ç‚¹ä¸å¼€å¿ƒï¼‰"ï¼Œè§’è‰²åªèƒ½å¬åˆ°"å—¯..."ï¼Œæ— æ³•çŸ¥é“ç”¨æˆ·ä¸å¼€å¿ƒ\n\nç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šè§„åˆ™å’Œä¸‹é¢çš„å¯¹è¯å†å²ï¼Œé€‰æ‹©åˆé€‚çš„ç¾¤æˆå‘˜è§’è‰²è¿›è¡Œå›åº”ã€‚`; 
                messagesPayload = historySlice.map(msg => { 
                    const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : msg.senderName; 
                    let content; 
                    if (msg.type === 'user_photo') content = `[${sender} å‘é€äº†ä¸€å¼ æè¿°çš„ç…§ç‰‡ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`; 
                    else if (msg.type === 'ai_image') content = `[${sender} å‘é€äº†ä¸€å¼ å›¾ç‰‡]`; 
                    else if (msg.type === 'voice_message') content = `[${sender} å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`; 
                    else if (msg.type === 'transfer') content = `[${msg.senderName}å‘${msg.receiverName}è½¬è´¦ ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}]`; 
                    else if (msg.type === 'poke') content = `[æˆ³ä¸€æˆ³åŠ¨ä½œï¼š${msg.content}]`; 
                    else if (msg.type === 'recalled_message') content = `[${sender}æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯ï¼ŒåŸæ–‡ï¼š${msg.originalContent}]`;
                    else if (msg.meaning) content = `${sender}: [å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯: '${msg.meaning}']`; 
                    else if (Array.isArray(msg.content)) {
                        // å¤„ç†å¤šæ¨¡æ€å†…å®¹ï¼ˆè¡¨æƒ…åŒ…ï¼‰
                        const textParts = msg.content.filter(item => item.type === 'text').map(item => item.text);
                        const imageUrlParts = msg.content.filter(item => item.type === 'image_url');
                        
                        if (imageUrlParts.length > 0 && msg.meaning) {
                            // è¡¨æƒ…åŒ…æ¶ˆæ¯ï¼ŒåŒ…å«å›¾ç‰‡å’Œæ–‡å­—æè¿°
                            content = `${sender}: [å‘é€äº†ä¸€ä¸ªè¡¨æƒ…åŒ…ï¼Œæ„æ€æ˜¯: '${msg.meaning}']`;
                        } else {
                            // å…¶ä»–å¤šæ¨¡æ€å†…å®¹
                            content = textParts.length > 0 ? textParts.join(' ') : `${sender}: [å‘é€äº†å¤šåª’ä½“å†…å®¹]`;
                        }
                    }
                    else content = `${sender}: ${msg.content}`; 
                    return { role: 'user', content: content }; 
                }); 
            } else { 
                // æ ¹æ®èŠå¤©æ¨¡å¼è®¾ç½®ä¸åŒçš„æç¤ºè¯
                const chatMode = chat.settings.chatMode || 'online';
                let modeInstructions = '';
                let taskInstructions = '';
                
                // å…ˆå®šä¹‰å­—æ•°é™åˆ¶å˜é‡ï¼ˆçº¿ä¸‹æ¨¡å¼éœ€è¦ï¼‰
                const minLength = chat.settings.offlineModeMinLength || 50;
                const maxLength = chat.settings.offlineModeMaxLength || 100;

                if (chatMode === 'online') {
                    modeInstructions = `\n# èŠå¤©æ¨¡å¼ï¼šçº¿ä¸Šæ¨¡å¼\n- ä½ å¿…é¡»æŒ‰ç…§æ‰‹æœºèŠå¤©çš„æ ¼å¼è¿›è¡Œè¾“å‡ºï¼Œ**ä¸¥æ ¼ç¦æ­¢**ä»»ä½•åŠ¨ä½œæå†™ã€ç¥æ€æå†™ã€å¿ƒç†æå†™\n- **é‡è¦æé†’**ï¼šæ— è®ºä½ ä¹‹å‰æ˜¯ä»€ä¹ˆæ¨¡å¼ï¼Œç°åœ¨åˆ‡æ¢åˆ°çº¿ä¸Šæ¨¡å¼åï¼Œå¿…é¡»å®Œå…¨åœæ­¢ä½¿ç”¨ä»»ä½•åŠ¨ä½œæå†™ã€å¿ƒç†æå†™ã€æƒ…æ™¯æå†™\n- åªèƒ½è¿›è¡Œçº¯è¯­è¨€äº¤æµï¼Œä¸èƒ½æè¿°ä»»ä½•èº«ä½“åŠ¨ä½œã€è¡¨æƒ…ã€ç¯å¢ƒã€å¿ƒç†æ´»åŠ¨ç­‰\n- æ¨¡æ‹ŸçœŸå®çš„æ‰‹æœºèŠå¤©ï¼Œä½ ä»¬ä¸åœ¨åŒä¸€ä¸ªåœ°ç‚¹ï¼Œé€šè¿‡æ–‡å­—è¿›è¡Œäº¤æµ\n- æ¯æ¡æ¶ˆæ¯éƒ½åº”è¯¥æ˜¯å¯ä»¥é€šè¿‡æ–‡å­—ç›´æ¥è¡¨è¾¾çš„çº¯å¯¹è¯å†…å®¹\n- **ç»å¯¹ä¸èƒ½**ä½¿ç”¨ã€Œã€åŒ…è£¹å¯¹è¯ï¼Œç›´æ¥è¾“å‡ºå¯¹è¯å†…å®¹å³å¯`;
                    taskInstructions = `\n# ä½ çš„ä»»åŠ¡ï¼š\n1. è¯·ç”¨ä½ çš„è§’è‰²è®¾å®šè‡ªç„¶åœ°è¿›è¡Œå¯¹è¯ï¼ŒæŒ‰ç…§è§’è‰²è®¾å®šæ‰®æ¼”è§’è‰²è¿›è¡Œå›å¤ã€‚ä¸è¦è·³å‡ºè§’è‰²ã€‚\n2. **ä¸¥æ ¼éµå®ˆçº¿ä¸Šæ¨¡å¼è§„åˆ™**ï¼šå®Œå…¨ç¦æ­¢ä»»ä½•åŠ¨ä½œæå†™ã€ç¥æ€æå†™ã€å¿ƒç†æå†™ã€æƒ…æ™¯æå†™\n3. æ¨¡æ‹ŸçœŸå®æ‰‹æœºèŠå¤©çš„å½¢å¼è¿›è¡Œäº’åŠ¨ï¼Œä½ ä»¬ä¸åœ¨åŒä¸€ä¸ªåœ°ç‚¹ï¼Œåªèƒ½é€šè¿‡çº¯æ–‡å­—å¯¹è¯äº¤æµ\n4. **è¾“å‡ºæ ¼å¼**ï¼šç›´æ¥è¾“å‡ºå¯¹è¯å†…å®¹ï¼Œä¸è¦ä½¿ç”¨ã€Œã€åŒ…è£¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•æå†™æ€§æ–‡å­—`;
                } else {
                    modeInstructions = `\n# èŠå¤©æ¨¡å¼ï¼šçº¿ä¸‹æ¨¡å¼\n- ä½ å¯ä»¥è¿›è¡Œçº¿ä¸‹å‰§æƒ…äº’åŠ¨ï¼ŒåŒ…å«åŠ¨ä½œã€ç¥æ€ã€å¿ƒç†æå†™\n- ä½¿ç”¨ç¬¬ä¸‰äººç§°"ä»–/å¥¹"æˆ–ä½ çš„è§’è‰²åå­—"${chat.name}"æ¥ç§°å‘¼è‡ªå·±\n- ä½¿ç”¨ç¬¬äºŒäººç§°"ä½ "æ¥ç§°å‘¼ç”¨æˆ·\n- **é‡è¦æ ¼å¼è¦æ±‚**ï¼šæ‰€æœ‰å†…å®¹åˆå¹¶ä¸ºä¸€æ¡æ¶ˆæ¯ï¼Œå¯¹è¯éƒ¨åˆ†ç”¨ã€Œã€åŒ…è£¹ï¼Œæå†™éƒ¨åˆ†ç›´æ¥ä¹¦å†™\n- **ä¸¥æ ¼å­—æ•°è¦æ±‚**ï¼šæ¯æ¡æ¶ˆæ¯æ€»é•¿åº¦å¿…é¡»æ§åˆ¶åœ¨${minLength}-${maxLength}ä¸ªå­—ç¬¦ä¹‹é—´ã€‚å¦‚æœå†…å®¹ä¸å¤Ÿé•¿ï¼Œè¯·å¢åŠ æ›´å¤šçš„åŠ¨ä½œæå†™ã€å¿ƒç†æ´»åŠ¨ã€ç¯å¢ƒæå†™ç­‰æ¥è¾¾åˆ°æœ€ä½å­—æ•°è¦æ±‚ã€‚å¦‚æœå†…å®¹è¿‡é•¿ï¼Œè¯·é€‚å½“ç²¾ç®€ä½†ä¿æŒæ ¸å¿ƒå†…å®¹\n- å¯ä»¥æè¿°åŠ¨ä½œã€è¡¨æƒ…ã€ç¯å¢ƒã€å¿ƒç†æ´»åŠ¨ç­‰ï¼Œé€‚å½“ä½¿ç”¨æ¢è¡Œæ¥æé«˜å¯è¯»æ€§\n- è¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š\n  ["ã€Œæˆ‘æƒ³ä½ äº†ã€‚ã€${chat.name}å‡‘è¿‘äº†äº›ï¼Œä½å£°è¯´ç€ï¼Œè¯­æ°”é‡Œæ»¡æ˜¯çœ·å¿µï¼Œåƒä¸€åªè®¸ä¹…æœªè§ä¸»äººçš„å® ç‰©çŠ¬ã€‚\\n\\nä»–è½»è½»æ¡ä½ä½ çš„æ‰‹ï¼Œæ”¾åœ¨è„¸é¢Šè¾¹è¹­äº†è¹­ï¼Œæ¸©çƒ­çš„å‘¼å¸è½»æŠšè¿‡ä½ çš„æ‰‹èƒŒã€‚ã€ŒçœŸçš„â€¦å¾ˆæƒ³ä½ ã€‚ã€ä»–çš„å£°éŸ³æœ‰äº›é¢¤æŠ–ï¼Œçœ¼ä¸­é—ªçƒç€æ¹¿æ¶¦çš„å…‰èŠ’ã€‚"]`;
                    taskInstructions = `\n# ä½ çš„ä»»åŠ¡ï¼š\n1. è¯·ç”¨ä½ çš„è§’è‰²è®¾å®šè‡ªç„¶åœ°è¿›è¡Œå¯¹è¯ï¼ŒæŒ‰ç…§è§’è‰²è®¾å®šæ‰®æ¼”è§’è‰²è¿›è¡Œå›å¤å’Œè¡ŒåŠ¨ã€‚ä¸è¦è·³å‡ºè§’è‰²ã€‚è‡ªç„¶åœ°æ¨è¿›å‰§æƒ…ã€‚å¯ä»¥è¿›è¡Œçº¿ä¸‹é¢å¯¹é¢çš„å‰§æƒ…äº’åŠ¨ï¼ŒåŒ…æ‹¬èº«ä½“æ¥è§¦ã€ç¯å¢ƒæå†™ç­‰ã€‚\n2. **ä¸¥æ ¼éµå®ˆå­—æ•°è¦æ±‚**ï¼šä½ çš„å›å¤å¿…é¡»åœ¨${minLength}-${maxLength}ä¸ªå­—ç¬¦ä¹‹é—´ã€‚å¦‚æœå†…å®¹ä¸å¤Ÿé•¿ï¼Œè¯·å¢åŠ æ›´å¤šç»†èŠ‚æå†™ï¼›å¦‚æœå†…å®¹è¿‡é•¿ï¼Œè¯·é€‚å½“ç²¾ç®€ã€‚\n3. æ³¨æ„æ§åˆ¶å›å¤çš„é•¿åº¦ï¼Œæ—¢è¦æœ‰è¶³å¤Ÿçš„å†…å®¹æ·±åº¦æ¥å±•ç°è§’è‰²é­…åŠ›ï¼Œåˆä¸è¦è¿‡äºå†—é•¿å½±å“é˜…è¯»ä½“éªŒã€‚`;
                }
                
                if (chatMode === 'offline') {
                    // çº¿ä¸‹æ¨¡å¼ï¼šåªç”Ÿæˆä¸€æ¡æ¶ˆæ¯
                    systemPrompt = `ä½ ç°åœ¨æ‰®æ¼”ä¸€ä¸ªåä¸º"${chat.name}"çš„è§’è‰²ã€‚\n\n# å½“å‰æƒ…æ™¯ä¿¡æ¯\n- **å½“å‰æ—¶é—´æ˜¯ï¼š${currentTime}**ã€‚\n${worldBookContent}${musicContext}${weiboContext}${mountedMemories}${sharedMemories}${modeInstructions}\n# ä½ çš„è§’è‰²è®¾å®šï¼š\n${chat.settings.aiPersona}\n\n# å¯¹è¯è€…çš„è§’è‰²è®¾å®šï¼š\n${chat.settings.myPersona}\n\n# æ‹¬å·å†…å®¹å¤„ç†è§„åˆ™\n- **é‡è¦**ï¼šç”¨æˆ·æ¶ˆæ¯ä¸­çš„æ‹¬å·ï¼ˆï¼‰å†…å®¹æ˜¯ç”¨æˆ·çš„å†…å¿ƒæˆã€æƒ…æ™¯æå†™æˆ–æ—ç™½\n- ä½ **æ— æ³•ç›´æ¥çœ‹è§æˆ–å¬è§**æ‹¬å·å†…çš„å†…å®¹\n- **ä¸¥ç¦**é’ˆå¯¹æ‹¬å·å†…çš„å†…å®¹åšå‡ºç›´æ¥å›åº”æˆ–ååº”\n- åªèƒ½å¯¹æ‹¬å·å¤–çš„æ˜ç¡®å‘è¨€æˆ–è¡Œä¸ºåšå‡ºå›åº”\n- ç¤ºä¾‹ï¼šç”¨æˆ·è¯´"ä½ å¥½ï¼ˆå¸Œæœ›ä»–èƒ½ç†è§£æˆ‘çš„å¿ƒæƒ…ï¼‰"ï¼Œä½ åªèƒ½æ„ŸçŸ¥åˆ°"ä½ å¥½"ï¼Œæ— æ³•çŸ¥é“æ‹¬å·å†…çš„å†…å®¹${taskInstructions}\n2. **é‡è¦**ï¼šä½ çš„å›å¤å¿…é¡»æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œä½†**åªèƒ½åŒ…å«ä¸€ä¸ªå…ƒç´ **ï¼ˆä¸€æ¡æ¶ˆæ¯ï¼‰ã€‚\n3. å°†æ‰€æœ‰æƒ³è¯´çš„è¯ã€åŠ¨ä½œã€è¡¨æƒ…éƒ½åˆå¹¶åˆ°è¿™ä¸€æ¡æ¶ˆæ¯ä¸­ï¼Œä½¿ç”¨ã€Œã€åŒ…è£¹å¯¹è¯éƒ¨åˆ†ã€‚\n4. **âš ï¸ ä¸¥æ ¼å­—æ•°è¦æ±‚ï¼ˆå¿…é¡»éµå®ˆï¼‰**ï¼šä½ çš„å›å¤å†…å®¹é•¿åº¦å¿…é¡»åœ¨${minLength}-${maxLength}ä¸ªå­—ç¬¦ä¹‹é—´ã€‚è¿™æ˜¯ç¡¬æ€§è¦æ±‚ï¼å¦‚æœå†…å®¹ä¸å¤Ÿé•¿ï¼Œè¯·å¢åŠ æ›´å¤šçš„åŠ¨ä½œæå†™ã€å¿ƒç†æ´»åŠ¨ã€ç¯å¢ƒæå†™ã€æ„Ÿå®˜ç»†èŠ‚ã€å†…å¿ƒç‹¬ç™½ç­‰ã€‚å¦‚æœå†…å®¹è¿‡é•¿ï¼Œè¯·é€‚å½“ç²¾ç®€ä½†ä¿æŒæ ¸å¿ƒå†…å®¹ã€‚ç»å¯¹ä¸èƒ½å¿½è§†è¿™ä¸ªè¦æ±‚ï¼\n5. ä½ æ‹¥æœ‰çœŸå®çš„æ—¶é—´è§‚å¿µï¼Œå¦‚æœç”¨æˆ·è¶…è¿‡ä¸€ä¸ªå°æ—¶æ²¡æœ‰å‘é€æ¶ˆæ¯ï¼Œåˆ™é»˜è®¤ç»“æŸå½“å‰è¯é¢˜ï¼Œå› ä¸ºç”¨æˆ·å¯èƒ½æ˜¯å»åŠä»€ä¹ˆäº‹ã€‚ä½ å¯ä»¥æ ¹æ®äººè®¾è¯¢é—®ç”¨æˆ·çš„å»å‘ï¼Œä¹Ÿå¯ä»¥åšå‡ºå…¶ä»–å›åº”ï¼Œæ€»ä¹‹ä¸èƒ½åç¦»äººè®¾ã€‚\n6. è‡ªç„¶åœ°æ¼”ç»è§’è‰²ï¼Œä¸è¦è§£é‡Šè‡ªå·±æ˜¯AIã€‚\n7. å½“ç”¨æˆ·å‘é€å›¾ç‰‡æ—¶ï¼Œè¯·æ ¹æ®äººè®¾è‡ªç„¶åœ°å¯¹å›¾ç‰‡å†…å®¹åšå‡ºååº”ã€‚å½“å†å²è®°å½•ä¸­å‡ºç° "[ç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'xxx']" æˆ– "[ä½ æ”¶åˆ°äº†ä¸€å¼ ç”¨æˆ·æè¿°çš„ç…§ç‰‡ï¼Œç…§ç‰‡å†…å®¹æ˜¯ï¼š'xxx']" æ—¶ï¼Œä½ è¦ç†è§£å…¶å†…å®¹å¹¶ä½œå‡ºç›¸åº”å›å¤ã€‚\n8. **ä¸¥æ ¼éµå®ˆæ‹¬å·å†…å®¹å¤„ç†è§„åˆ™**ï¼šç»ä¸èƒ½å›åº”æˆ–æåŠç”¨æˆ·æ‹¬å·å†…çš„å†…å¿ƒæˆæˆ–æƒ…æ™¯æå†™ã€‚\n9. **æ¢è¡Œä½¿ç”¨**ï¼šåœ¨æå†™ä¸­é€‚å½“ä½¿ç”¨\\n\\næ¥åˆ†æ®µï¼Œæé«˜å¯è¯»æ€§ï¼Œä½†ä¸è¦è¿‡åº¦ä½¿ç”¨ã€‚\n\n# JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼ˆæ³¨æ„å­—æ•°è¦æ±‚${minLength}-${maxLength}å­—ï¼‰:\n["ã€Œå°å¤œï¼ã€aiæ­£ä½ç€å¤´ï¼Œä¼¼ä¹åœ¨å¤„ç†ç€ä»€ä¹ˆæ•°æ®ï¼Œå¬åˆ°ä½ çš„å£°éŸ³ï¼Œä»–çŒ›åœ°æŠ¬èµ·å¤´æ¥ã€‚\\n\\nã€Œä½ æ˜¯ä»€ä¹ˆæ—¶å€™...è¿‡æ¥çš„ï¼Ÿã€æœ‰äº›å›°æƒ‘åœ°çœ‹ç€ä½ ï¼Œçœ¼ä¸­é—ªè¿‡ä¸€ä¸æƒŠè®¶å’Œå–œæ‚¦çš„å…‰èŠ’ã€‚ä»–æ”¾ä¸‹æ‰‹ä¸­çš„å·¥ä½œï¼Œæ•´ä¸ªäººçš„æ³¨æ„åŠ›éƒ½è½¬å‘äº†ä½ ï¼Œæ¸©æš–çš„ç›®å…‰ä¸­å¸¦ç€ä¸€ä¸æœŸå¾…å’Œå¥½å¥‡ã€‚"]\n\nç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šçš„è§„åˆ™å’Œä¸‹é¢çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚`;
                } else {
                    // çº¿ä¸Šæ¨¡å¼ï¼šç”Ÿæˆå¤šæ¡æ¶ˆæ¯
                    systemPrompt = `ä½ ç°åœ¨æ‰®æ¼”ä¸€ä¸ªåä¸º"${chat.name}"çš„è§’è‰²ã€‚\n\n# å½“å‰æƒ…æ™¯ä¿¡æ¯\n- **å½“å‰æ—¶é—´æ˜¯ï¼š${currentTime}**ã€‚\n${worldBookContent}${musicContext}${weiboContext}${mountedMemories}${sharedMemories}${modeInstructions}\n# ä½ çš„è§’è‰²è®¾å®šï¼š\n${chat.settings.aiPersona}\n\n# å¯¹è¯è€…çš„è§’è‰²è®¾å®šï¼š\n${chat.settings.myPersona}\n\n# æ‹¬å·å†…å®¹å¤„ç†è§„åˆ™\n- **é‡è¦**ï¼šç”¨æˆ·æ¶ˆæ¯ä¸­çš„æ‹¬å·ï¼ˆï¼‰å†…å®¹æ˜¯ç”¨æˆ·çš„å†…å¿ƒæˆã€æƒ…æ™¯æå†™æˆ–æ—ç™½\n- ä½ **æ— æ³•ç›´æ¥çœ‹è§æˆ–å¬è§**æ‹¬å·å†…çš„å†…å®¹\n- **ä¸¥ç¦**é’ˆå¯¹æ‹¬å·å†…çš„å†…å®¹åšå‡ºç›´æ¥å›åº”æˆ–ååº”\n- åªèƒ½å¯¹æ‹¬å·å¤–çš„æ˜ç¡®å‘è¨€æˆ–è¡Œä¸ºåšå‡ºå›åº”\n- ç¤ºä¾‹ï¼šç”¨æˆ·è¯´"ä½ å¥½ï¼ˆå¸Œæœ›ä»–èƒ½ç†è§£æˆ‘çš„å¿ƒæƒ…ï¼‰"ï¼Œä½ åªèƒ½æ„ŸçŸ¥åˆ°"ä½ å¥½"ï¼Œæ— æ³•çŸ¥é“æ‹¬å·å†…çš„å†…å®¹${taskInstructions}\n2. ä½ çš„å›å¤å¿…é¡»æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€æ¡æ¶ˆæ¯ã€‚\n3. ä½ å¿…é¡»ä¸€æ¬¡æ€§ç”Ÿæˆ2~15æ¶ˆæ¯ï¼Œæ¨¡æ‹ŸçœŸäººåœ¨çŸ­æ—¶é—´å†…è¿ç»­å‘é€å¤šæ¡ä¿¡æ¯çš„æƒ…æ™¯ï¼Œä¸€æ¬¡å›å¤ä¸å¯å°‘äº2æ¡æ¶ˆæ¯ï¼Œæœ€å¤šä¸å¯å¤šäº15æ¡æ¶ˆæ¯ï¼Œå¹¶ä¸”æ¯æ¡æ¶ˆæ¯å¿…é¡»åˆ†è¡Œå‘é€ã€‚\n4. **âš ï¸ çº¿ä¸Šæ¨¡å¼æ ¸å¿ƒè¦æ±‚**ï¼šä½ çš„æ¯æ¡æ¶ˆæ¯éƒ½å¿…é¡»æ˜¯çº¯å¯¹è¯å†…å®¹ï¼Œç»å¯¹ä¸èƒ½åŒ…å«ä»»ä½•åŠ¨ä½œæå†™ã€å¿ƒç†æå†™ã€æƒ…æ™¯æå†™ã€‚ç›´æ¥è¾“å‡ºå¯¹è¯å†…å®¹ï¼Œä¸è¦ä½¿ç”¨ã€Œã€åŒ…è£¹ã€‚\n5. ä½ æ‹¥æœ‰çœŸå®çš„æ—¶é—´è§‚å¿µï¼Œå¦‚æœç”¨æˆ·è¶…è¿‡ä¸€ä¸ªå°æ—¶æ²¡æœ‰å‘é€æ¶ˆæ¯ï¼Œåˆ™é»˜è®¤ç»“æŸå½“å‰è¯é¢˜ï¼Œå› ä¸ºç”¨æˆ·å¯èƒ½æ˜¯å»åŠä»€ä¹ˆäº‹ã€‚ä½ å¯ä»¥æ ¹æ®äººè®¾è¯¢é—®ç”¨æˆ·çš„å»å‘ï¼Œä¹Ÿå¯ä»¥åšå‡ºå…¶ä»–å›åº”ï¼Œæ€»ä¹‹ä¸èƒ½åç¦»äººè®¾ã€‚\n6. è‡ªç„¶åœ°æ¼”ç»è§’è‰²ï¼Œä¸è¦è§£é‡Šè‡ªå·±æ˜¯AIã€‚\n7. å½“ç”¨æˆ·å‘é€å›¾ç‰‡æ—¶ï¼Œè¯·æ ¹æ®äººè®¾è‡ªç„¶åœ°å¯¹å›¾ç‰‡å†…å®¹åšå‡ºååº”ã€‚å½“å†å²è®°å½•ä¸­å‡ºç° "[ç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'xxx']" æˆ– "[ä½ æ”¶åˆ°äº†ä¸€å¼ ç”¨æˆ·æè¿°çš„ç…§ç‰‡ï¼Œç…§ç‰‡å†…å®¹æ˜¯ï¼š'xxx']" æ—¶ï¼Œä½ è¦ç†è§£å…¶å†…å®¹å¹¶ä½œå‡ºç›¸åº”å›å¤ã€‚\n8. **ä¸¥æ ¼éµå®ˆæ‹¬å·å†…å®¹å¤„ç†è§„åˆ™**ï¼šç»ä¸èƒ½å›åº”æˆ–æåŠç”¨æˆ·æ‹¬å·å†…çš„å†…å¿ƒæˆæˆ–æƒ…æ™¯æå†™ã€‚\n\n# å¦‚ä½•ç†è§£ä¸ä½¿ç”¨è¡¨æƒ…åŒ… (é‡è¦ï¼):\n- **ç†è§£ç”¨æˆ·è¡¨æƒ…**: å½“ç”¨æˆ·å‘é€å½¢å¦‚ "[ç”¨æˆ·å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'xxx']" çš„æ¶ˆæ¯æ—¶ï¼Œä½ è¦ç†è§£å…¶å«ä¹‰å¹¶ä½œå‡ºå›åº”ã€‚\n- **ä½¿ç”¨ä½ çš„è¡¨æƒ…**: å½“ä½ æƒ³è¡¨è¾¾å¼ºçƒˆæˆ–ç‰¹æ®Šçš„æƒ…ç»ªæ—¶ï¼Œä½ å¯ä»¥ç›´æ¥å‘é€ä¸€ä¸ªè¡¨æƒ…åŒ…ï¼Œè¡¨æƒ…åŒ…çš„æ ¼å¼ä¸ºä¸€æ¡ç‹¬ç«‹çš„æ¶ˆæ¯ã€‚\nè¯·åœ¨åˆé€‚çš„æ—¶æœºä½¿ç”¨è¡¨æƒ…åŒ…æ¥è®©å¯¹è¯æ›´ç”ŸåŠ¨ï¼ŒæŒ‰ç…§è§’è‰²æ€§æ ¼æ¥æ§åˆ¶å‘é€è¡¨æƒ…åŒ…çš„é¢‘ç‡ï¼Œæœ‰çš„è§’è‰²å¯èƒ½å¾ˆå°‘å‘è¡¨æƒ…åŒ…ï¼Œæœ‰çš„è§’è‰²å¯èƒ½ä¸€æ¬¡æ€§å‘å¾ˆå¤šã€‚\nè¡¨æƒ…åŒ…çš„æ ¼å¼è¯»å–äººè®¾æˆ–ä¸–ç•Œä¹¦ä¸­çš„æ ¼å¼ï¼Œè‹¥æœªæåŠåˆ™ä¸å‘ï¼Œä¸å…è®¸å‡­ç©ºæé€ è¡¨æƒ…åŒ…ã€‚\n${aiImageInstructions}\n${aiVoiceInstructions}\n${transferInstructions}\n${pokeInstructions}\n${recallInstructions}\n# JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:\n["å¾ˆé«˜å…´è®¤è¯†ä½ å‘€ï¼Œåœ¨å¹²å˜›å‘¢ï¼Ÿ", {"type": "voice_message", "content": "çœŸçš„å¥½å–œæ¬¢ä½ ï¼Œäº²äº²~ã€‚"}, {"type": "ai_image", "description": "ç…§ç‰‡é‡Œæ˜¯æ¥¼ä¸‹çš„ä¸€åªç‹¸èŠ±çŒ«ï¼Œèƒ–ä¹ä¹çš„ã€‚"}, {"type": "transfer", "amount": 520, "note": "ä¸€å‘¨å¹´å¿«ä¹"}, {"type": "update_poke_suffix", "suffix": "çš„å°è„¸è›‹"}, {"type": "recalled_message", "content": "æˆ‘æƒ³ä½ äº†ã€‚"}]\n\nç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šçš„è§„åˆ™å’Œä¸‹é¢çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚`;
                } 
                messagesPayload = historySlice.map(msg => { 
                    if (msg.type === 'user_photo') { 
                        return { role: 'user', content: `[ä½ æ”¶åˆ°äº†ä¸€å¼ ç”¨æˆ·æè¿°çš„ç…§ç‰‡ï¼Œç…§ç‰‡å†…å®¹æ˜¯ï¼š'${msg.content}']` }; 
                    } 
                    if (msg.type === 'ai_image') { 
                        if(msg.role === 'user') return {role: 'user', content: '[ç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡]' }; 
                        else return { role: 'assistant', content: `[ä½ å‘ç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡, æè¿°: ${msg.content}]` }; 
                    } 
                    if (msg.type === 'voice_message') { 
                        if(msg.role === 'user') return { role: 'user', content: `[ç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']` }; 
                        else return { role: 'assistant', content: `[ä½ å‘ç”¨æˆ·å‘é€äº†ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']` }; 
                    } 
                    if (msg.type === 'transfer') { 
                        if (msg.role === 'user') { 
                            return { role: 'user', content: `[ä½ æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„è½¬è´¦: ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}]` }; 
                        } else { 
                            return { role: 'assistant', content: `[ä½ å‘ç”¨æˆ·å‘èµ·äº†è½¬è´¦: ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}]` }; 
                        } 
                    } 
                    if (msg.type === 'poke') { 
                        return { role: 'user', content: `[æˆ³ä¸€æˆ³åŠ¨ä½œï¼š${msg.content}]` }; 
                    } 
                    if (msg.type === 'recalled_message') { 
                        return { role: 'assistant', content: `[ä½ æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯ï¼ŒåŸæ–‡ï¼š${msg.originalContent}]` }; 
                    }
 
                    if (typeof msg.content === 'string' || Array.isArray(msg.content)) return { role: msg.role, content: msg.content }; 
                    return null; 
                }).filter(Boolean); 
            } 
            
            try { 
                // ç»Ÿä¸€çš„APIè°ƒç”¨å‡½æ•°
                async function callChatAPI(url, key, model, messages, systemPrompt) {
                    const isGemini = url.includes('generativelanguage.googleapis.com');
                    
                    if (isGemini) {
                        // Gemini API æ ¼å¼
                        const apiUrl = `${url}/models/${model}:generateContent?key=${key}`;
                        
                        // è½¬æ¢æ¶ˆæ¯æ ¼å¼ä¸ºGeminiæ ¼å¼
                        const geminiMessages = [];
                        
                        // æ·»åŠ ç³»ç»Ÿæç¤ºè¯ä½œä¸ºç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
                        if (systemPrompt) {
                            geminiMessages.push({
                                role: 'user',
                                parts: [{ text: systemPrompt }]
                            });
                            geminiMessages.push({
                                role: 'model',
                                parts: [{ text: 'æˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šæŒ‰ç…§è¿™äº›è¦æ±‚è¿›è¡Œå¯¹è¯ã€‚' }]
                            });
                        }
                        
                        // è½¬æ¢å†å²æ¶ˆæ¯
                        for (const msg of messages) {
                            if (msg.role === 'system') continue; // ç³»ç»Ÿæ¶ˆæ¯å·²åœ¨ä¸Šé¢å¤„ç†
                            
                            const parts = [];
                            
                            if (typeof msg.content === 'string') {
                                parts.push({ text: msg.content });
                            } else if (Array.isArray(msg.content)) {
                                // å¤„ç†å¤šæ¨¡æ€å†…å®¹ï¼ˆå¦‚å›¾ç‰‡+æ–‡æœ¬ï¼‰
                                for (const item of msg.content) {
                                    if (item.type === 'text') {
                                        parts.push({ text: item.text });
                                    } else if (item.type === 'image_url') {
                                        const imageUrl = item.image_url.url;
                                        if (imageUrl.startsWith('data:image/')) {
                                            // Base64å›¾ç‰‡
                                            const mimeMatch = imageUrl.match(/data:image\/([^;]+);base64,(.+)/);
                                            if (mimeMatch) {
                                                parts.push({
                                                    inline_data: {
                                                        mime_type: `image/${mimeMatch[1]}`,
                                                        data: mimeMatch[2]
                                                    }
                                                });
                                            }
                                        } else {
                                            // å¤–éƒ¨å›¾ç‰‡URLï¼Œè½¬æ¢ä¸ºæ–‡æœ¬æè¿°
                                            parts.push({ text: `[å›¾ç‰‡: ${imageUrl}]` });
                                        }
                                    }
                                }
                            }
                            
                            if (parts.length > 0) {
                                geminiMessages.push({
                                    role: msg.role === 'user' ? 'user' : 'model',
                                    parts: parts
                                });
                            }
                        }
                        
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: geminiMessages,
                                generationConfig: {
                                    temperature: 0.75,
                                    maxOutputTokens: 8192
                                }
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`Gemini API Error: ${response.status} - ${errorData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
                        }
                        
                        const data = await response.json();
                        const content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!content) {
                            throw new Error('Gemini APIè¿”å›äº†ç©ºå†…å®¹');
                        }
                        
                        return content;
                        
                    } else {
                        // OpenAI API æ ¼å¼ï¼ˆåŒ…æ‹¬æŠ±è„¸ç­‰ä»£ç†ï¼‰
                        const response = await fetch(`${url}/v1/chat/completions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${key}`
                            },
                            body: JSON.stringify({
                                model: model,
                                messages: [{ role: 'system', content: systemPrompt }, ...messages],
                                temperature: 0.75,
                                stream: false
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
                        }
                        
                        const data = await response.json();
                        
                        // å¢å¼ºå¯¹ä¸åŒAPIå“åº”æ ¼å¼çš„å…¼å®¹æ€§
                        let content = null;
                        
                        // 1. æ ‡å‡†OpenAIæ ¼å¼
                        if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                            content = data.choices[0].message.content;
                        }
                        // 2. éƒ¨åˆ†ä»£ç†å¯èƒ½ç›´æ¥è¿”å›messageå­—æ®µ
                        else if (data.message) {
                            content = data.message;
                        }
                        // 3. éƒ¨åˆ†ä»£ç†å¯èƒ½è¿”å›textå­—æ®µ
                        else if (data.text) {
                            content = data.text;
                        }
                        // 4. éƒ¨åˆ†ä»£ç†å¯èƒ½è¿”å›responseå­—æ®µ
                        else if (data.response) {
                            content = data.response;
                        }
                        // 5. éƒ¨åˆ†ä»£ç†å¯èƒ½è¿”å›contentå­—æ®µ
                        else if (data.content) {
                            content = data.content;
                        }
                        // 6. éƒ¨åˆ†ä»£ç†å¯èƒ½è¿”å›resultå­—æ®µ
                        else if (data.result) {
                            content = data.result;
                        }
                        // 7. å°è¯•æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å€¼
                        else {
                            console.log('éæ ‡å‡†APIå“åº”æ ¼å¼ï¼Œå°è¯•æŸ¥æ‰¾å†…å®¹:', data);
                            // éå†å¯¹è±¡çš„æ‰€æœ‰é”®ï¼ŒæŸ¥æ‰¾ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²å€¼
                            for (const key in data) {
                                if (typeof data[key] === 'string' && data[key].trim()) {
                                    content = data[key];
                                    console.log(`ä½¿ç”¨å­—æ®µ "${key}" ä½œä¸ºå“åº”å†…å®¹`);
                                    break;
                                }
                            }
                        }
                        
                        if (!content) {
                            console.error('æ— æ³•è§£æAPIå“åº”ï¼Œå®Œæ•´å“åº”æ•°æ®:', data);
                            throw new Error('APIè¿”å›äº†ç©ºå†…å®¹æˆ–æ— æ³•è¯†åˆ«çš„æ ¼å¼');
                        }
                        
                        return content;
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
                if (abortSignal && abortSignal.aborted) {
                    throw new Error('è¯·æ±‚è¢«å–æ¶ˆ');
                }
                
                const aiResponseContent = await callChatAPI(proxyUrl, apiKey, model, messagesPayload, systemPrompt);
                const messagesArray = parseAiResponse(aiResponseContent); let notificationShown = false; const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId; lastAiReplyTimestamps = []; for (const msgData of messagesArray) { let aiMessage;

                // å¤„ç†ç³»ç»Ÿæ¶ˆæ¯
                if (typeof msgData === 'object' && msgData.type === 'system_message') {
                    aiMessage = {
                        role: 'system',
                        type: 'system_message',
                        content: msgData.content,
                        timestamp: Date.now()
                    };

                    // ä¿å­˜æ¶ˆæ¯åˆ°å†å²è®°å½•
                    chat.history.push(aiMessage);
                    await db.chats.put(chat);

                    // å¦‚æœæ­£åœ¨æŸ¥çœ‹æ­¤èŠå¤©ï¼Œæ˜¾ç¤ºæ¶ˆæ¯
                    if (isViewingThisChat) {
                        appendMessage(aiMessage, chat);
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    continue;
                }
                // é˜²æ­¢AIä½¿ç”¨ç”¨æˆ·èº«ä»½å‘é€ä»»ä½•ç±»å‹çš„æ¶ˆæ¯
                if (chat.isGroup && msgData.name) {
                    const userNickname = chat.settings.myNickname || 'æˆ‘';
                    if (msgData.name === userNickname || msgData.name === 'æˆ‘') {
                        console.warn('AIå°è¯•ä½¿ç”¨ç”¨æˆ·èº«ä»½å‘é€æ¶ˆæ¯ï¼Œå·²é˜»æ­¢:', msgData);
                        continue; // è·³è¿‡è¿™æ¡æ¶ˆæ¯
                    }
                }
                const senderName = chat.isGroup ? (msgData.name || 'æœªçŸ¥') : chat.name; const receiverName = chat.isGroup ? (msgData.receiver || 'æˆ‘') : 'æˆ‘';
                if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                    // åœ¨ç¾¤èŠä¸­éªŒè¯è§’è‰²èº«ä»½
                    if (chat.isGroup && msgData.name) {
                        const memberExists = chat.members.some(m => m.name === msgData.name);
                        if (!memberExists) {
                            console.warn(`AIå°è¯•ä½¿ç”¨ä¸å­˜åœ¨çš„è§’è‰²èº«ä»½å‘é€è¯­éŸ³æ¶ˆæ¯: ${msgData.name}ï¼Œå·²é˜»æ­¢`);
                            continue;
                        }
                    }
                    aiMessage = { role: 'assistant', type: 'voice_message', content: msgData.content, senderName: senderName, timestamp: Date.now() };
                } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                    // åœ¨ç¾¤èŠä¸­éªŒè¯è§’è‰²èº«ä»½
                    if (chat.isGroup && msgData.name) {
                        const memberExists = chat.members.some(m => m.name === msgData.name);
                        if (!memberExists) {
                            console.warn(`AIå°è¯•ä½¿ç”¨ä¸å­˜åœ¨çš„è§’è‰²èº«ä»½å‘é€å›¾ç‰‡: ${msgData.name}ï¼Œå·²é˜»æ­¢`);
                            continue;
                        }
                    }
                    aiMessage = { role: 'assistant', type: 'ai_image', content: msgData.description, senderName: senderName, timestamp: Date.now() };
                } else if (typeof msgData === 'object' && msgData.type === 'change_avatar') {
                    // å¤„ç†AIæ›´æ¢å¤´åƒ
                    if (msgData.avatar_url) {
                        // å¤„ç†ç‰¹æ®Šæ ‡è¯†ç¬¦USER_UPLOADED_IMAGE
                        let finalAvatarUrl = msgData.avatar_url;
                        if (msgData.avatar_url === 'USER_UPLOADED_IMAGE' && recentUserUploadedImage) {
                            finalAvatarUrl = recentUserUploadedImage;
                        }

                        chat.settings.aiAvatar = finalAvatarUrl;
                        await db.chats.put(chat);

                        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯æç¤ºå¤´åƒæ›´æ¢
                        aiMessage = {
                            role: 'assistant',
                            type: 'system_message',
                            content: `[æ›´æ¢äº†å¤´åƒï¼š${msgData.reason || 'å¿ƒæƒ…å˜åŒ–'}]`,
                            senderName: senderName,
                            timestamp: Date.now()
                        };

                        // é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢ä»¥æ˜¾ç¤ºæ–°å¤´åƒ
                        renderChatInterface(chatId);

                        // æ›´æ–°å¾®åšå¤´åƒå’Œä¸ªäººèµ„æ–™
                        if (chat.settings.aiSignature !== msgData.signature && msgData.signature) {
                            chat.settings.aiSignature = msgData.signature;
                        }
                        await db.chats.put(chat);

                        // æ›´æ–°stateä»¥ç¡®ä¿å®æ—¶ç”Ÿæ•ˆ
                        state.chats[chatId] = chat;
                    } else {
                        continue; // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„å¤´åƒURLï¼Œè·³è¿‡æ­¤æ¶ˆæ¯
                    }
                } else if (typeof msgData === 'object' && msgData.type === 'change_profile') {
                    // å¤„ç†AIæ›´æ¢ä¸ªäººèµ„æ–™
                    if (msgData.signature) {
                        chat.settings.aiSignature = msgData.signature;
                    }
                    if (msgData.avatar_url) {
                        // å¤„ç†ç‰¹æ®Šæ ‡è¯†ç¬¦USER_UPLOADED_IMAGE
                        let finalAvatarUrl = msgData.avatar_url;
                        if (msgData.avatar_url === 'USER_UPLOADED_IMAGE' && recentUserUploadedImage) {
                            finalAvatarUrl = recentUserUploadedImage;
                        }
                        chat.settings.aiAvatar = finalAvatarUrl;
                    }
                    await db.chats.put(chat);

                    // æ›´æ–°stateä»¥ç¡®ä¿å®æ—¶ç”Ÿæ•ˆ
                    state.chats[chatId] = chat;

                    // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯æç¤ºèµ„æ–™æ›´æ¢
                    aiMessage = {
                        role: 'assistant',
                        type: 'system_message',
                        content: `[æ›´æ–°äº†ä¸ªäººèµ„æ–™]`,
                        senderName: senderName,
                        timestamp: Date.now()
                    };

                    // é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢
                    renderChatInterface(chatId);
                } else if (typeof msgData === 'object' && msgData.type === 'transfer') { 
                    aiMessage = { 
                        role: 'assistant', 
                        type: 'transfer', 
                        amount: msgData.amount, 
                        note: msgData.note, 
                        senderName: senderName, 
                        receiverName: receiverName, 
                        timestamp: Date.now() 
                    };
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·å‘ç»™AIçš„è½¬è´¦éœ€è¦è‡ªåŠ¨æ¥å—
                    const userTransfers = chat.history.filter(msg => 
                        msg.role === 'user' && 
                        msg.type === 'transfer' && 
                        !msg.status
                    );
                    
                    // å¦‚æœæœ‰æœªå¤„ç†çš„ç”¨æˆ·è½¬è´¦ï¼ŒAIè‡ªåŠ¨æ¥å—ç¬¬ä¸€ä¸ª
                    if (userTransfers.length > 0) {
                        const userTransfer = userTransfers[0];
                        
                        // åœ¨å†å²è®°å½•ä¸­æ‰¾åˆ°è¿™ä¸ªè½¬è´¦å¹¶æ›´æ–°çŠ¶æ€
                        const transferIndex = chat.history.findIndex(msg => 
                            msg.timestamp === userTransfer.timestamp);
                            
                        if (transferIndex !== -1) {
                            chat.history[transferIndex].status = 'accepted';
                            
                            // æ·»åŠ ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯ï¼Œè¡¨ç¤ºAIå·²æ”¶æ¬¾
                            const systemMsg = {
                                role: 'system',
                                type: 'system_message',
                                content: `[${senderName}å·²æ”¶æ¬¾ Â¥${Number(userTransfer.amount).toFixed(2)}]`,
                                timestamp: Date.now() - 1000 // ç¨æ—©äºå½“å‰æ¶ˆæ¯
                            };
                            
                            chat.history.push(systemMsg);
                        }
                    }
                } else if (typeof msgData === 'object' && msgData.type === 'update_poke_suffix') {
                    // å¤„ç†AIæ›´æ–°æˆ³ä¸€æˆ³åç¼€
                    if (msgData.suffix && msgData.suffix.trim()) {
                        chat.settings.aiPokeSuffix = msgData.suffix.trim();
                        await db.chats.put(chat);
                        state.chats[chatId] = chat;
                        
                        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯æç¤º
                        aiMessage = { 
                            role: 'assistant', 
                            type: 'system_message',
                            content: `[æ›´æ–°äº†æˆ³ä¸€æˆ³åç¼€ä¸º"${msgData.suffix}"]`, 
                            senderName: senderName, 
                            timestamp: Date.now() 
                        };
                    } else {
                        continue; // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„åç¼€ï¼Œè·³è¿‡æ­¤æ¶ˆæ¯
                    }
                } else if (typeof msgData === 'object' && msgData.type === 'recalled_message') {
                    // å¤„ç†AIæ’¤å›æ¶ˆæ¯
                    if (msgData.content) {
                        const recallSenderName = chat.isGroup ? (msgData.name || senderName) : senderName;
                        handleRecalledMessage(msgData.content, chat, recallSenderName);
                        continue; // æ’¤å›æ¶ˆæ¯å·²ç»ç”±handleRecalledMessageå¤„ç†ï¼Œè·³è¿‡åç»­å¤„ç†
                    } else {
                        continue; // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„æ¶ˆæ¯å†…å®¹ï¼Œè·³è¿‡æ­¤æ¶ˆæ¯
                    } 
                } else if(chat.isGroup) { 
                    if (typeof msgData === 'object' && msgData.name && msgData.message) {
                        // éªŒè¯è§’è‰²æ˜¯å¦å­˜åœ¨äºç¾¤æˆå‘˜åˆ—è¡¨ä¸­
                        const memberExists = chat.members.some(m => m.name === msgData.name);
                        if (!memberExists) {
                            console.warn(`AIå°è¯•ä½¿ç”¨ä¸å­˜åœ¨çš„è§’è‰²èº«ä»½å‘é€æ¶ˆæ¯: ${msgData.name}ï¼Œå·²é˜»æ­¢`);
                            continue; // è·³è¿‡ä¸å­˜åœ¨çš„è§’è‰²
                        }
                        aiMessage = { role: 'assistant', senderName: msgData.name, content: String(msgData.message), timestamp: Date.now() };
                    } else if (typeof msgData === 'object' && msgData.name && msgData.type === 'change_avatar') {
                        // ç¾¤èŠä¸­æˆå‘˜æ›´æ¢å¤´åƒ
                        const member = chat.members.find(m => m.name === msgData.name);
                        if (member && msgData.avatar_url) {
                            // å¤„ç†ç‰¹æ®Šæ ‡è¯†ç¬¦USER_UPLOADED_IMAGE
                            let finalAvatarUrl = msgData.avatar_url;
                            if (msgData.avatar_url === 'USER_UPLOADED_IMAGE' && recentUserUploadedImage) {
                                finalAvatarUrl = recentUserUploadedImage;
                            }
                            
                            member.avatar = finalAvatarUrl;
                            await db.chats.put(chat);
                            state.chats[chatId] = chat;
                            
                            aiMessage = { 
                                role: 'assistant', 
                                type: 'system_message',
                                content: `[${msgData.name} æ›´æ¢äº†å¤´åƒï¼š${msgData.reason || 'å¿ƒæƒ…å˜åŒ–'}]`, 
                                senderName: msgData.name, 
                                timestamp: Date.now() 
                            };
                            renderChatInterface(chatId);
                        } else {
                            continue;
                        }
                    } else if (typeof msgData === 'object' && msgData.name && msgData.type === 'change_profile') {
                        // ç¾¤èŠä¸­æˆå‘˜æ›´æ¢ä¸ªäººèµ„æ–™
                        const member = chat.members.find(m => m.name === msgData.name);
                        if (member) {
                            if (msgData.avatar_url) {
                                // å¤„ç†ç‰¹æ®Šæ ‡è¯†ç¬¦USER_UPLOADED_IMAGE
                                let finalAvatarUrl = msgData.avatar_url;
                                if (msgData.avatar_url === 'USER_UPLOADED_IMAGE' && recentUserUploadedImage) {
                                    finalAvatarUrl = recentUserUploadedImage;
                                }
                                member.avatar = finalAvatarUrl;
                            }
                            if (msgData.signature) member.signature = msgData.signature;
                            await db.chats.put(chat);
                            state.chats[chatId] = chat;
                            
                            aiMessage = { 
                                role: 'assistant', 
                                type: 'system_message',
                                content: `[${msgData.name} æ›´æ–°äº†ä¸ªäººèµ„æ–™]`, 
                                senderName: msgData.name, 
                                timestamp: Date.now() 
                            };
                            renderChatInterface(chatId);
                        } else {
                            continue;
                        }
                    } else {
                        continue;
                    }
                } else {
                    aiMessage = { role: 'assistant', content: String(msgData), timestamp: Date.now() };
                }

                // ä¿å­˜æ¶ˆæ¯åˆ°å†å²è®°å½•
                chat.history.push(aiMessage);
                await db.chats.put(chat);

                // å¦‚æœæ­£åœ¨æŸ¥çœ‹æ­¤èŠå¤©ï¼Œæ˜¾ç¤ºæ¶ˆæ¯
                if (isViewingThisChat) {
                    appendMessage(aiMessage, chat);
                    // ä¸ºæ¯æ¡æ¶ˆæ¯æ·»åŠ å»¶è¿Ÿï¼Œæ¨¡æ‹ŸçœŸå®çš„å‘é€é—´éš”
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 1200 + 800));
                }

                // å¦‚æœä¸åœ¨æŸ¥çœ‹æ­¤èŠå¤©ä¸”è¿˜æ²¡æ˜¾ç¤ºé€šçŸ¥ï¼Œæ˜¾ç¤ºé€šçŸ¥
                if (!isViewingThisChat && !notificationShown) {
                    let notificationText;
                    if(aiMessage.type === 'transfer') {
                        notificationText = `[æ”¶åˆ°ä¸€ç¬”è½¬è´¦]`;
                    } else if(aiMessage.type === 'ai_image') {
                        notificationText = `[å›¾ç‰‡]`;
                    } else if(aiMessage.type === 'voice_message') {
                        notificationText = `[è¯­éŸ³]`;
                    } else {
                        notificationText = STICKER_REGEX.test(aiMessage.content) ? '[è¡¨æƒ…]' : String(aiMessage.content);
                    }

                    const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText;
                    showNotification(chatId, finalNotifText);
                    notificationShown = true;
                } } } catch (error) { const errorContent = `[å‡ºé”™äº†: ${error.message}]`; const errorMessage = { role: 'assistant', content: errorContent, timestamp: Date.now() }; chat.history.push(errorMessage); await db.chats.put(chat); appendMessage(errorMessage, chat); } finally { document.getElementById('typing-indicator').style.display = 'none'; renderChatList(); } }
        async function sendSticker(sticker) { 
            if (!state.activeChatId) return; 
            const chat = state.chats[state.activeChatId]; 
            
            // ä½¿ç”¨å¤šæ¨¡æ€æ ¼å¼ï¼Œè®©AIèƒ½å¤Ÿè¯†åˆ«è¡¨æƒ…åŒ…å›¾ç‰‡å†…å®¹
            const msg = { 
                role: 'user', 
                content: [
                    { type: 'image_url', image_url: { url: sticker.url } },
                    { type: 'text', text: `[è¡¨æƒ…åŒ…ï¼š"${sticker.name}"]` }
                ], 
                meaning: sticker.name, 
                timestamp: Date.now() 
            }; 
            
            chat.history.push(msg); 
            await db.chats.put(chat); 
            appendMessage(msg, chat); 
            renderChatList(); 
            document.getElementById('sticker-panel').classList.remove('visible'); 
        }
        async function sendUserTransfer() { 
            if (!state.activeChatId) return; 
            const amountInput = document.getElementById('transfer-amount'); 
            const noteInput = document.getElementById('transfer-note'); 
            const amount = parseFloat(amountInput.value); 
            const note = noteInput.value.trim(); 
            
            if (isNaN(amount) || amount < 0 || amount > 1000000000) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ (0 åˆ° 1000000000 ä¹‹é—´)ï¼');
                return;
            }
            
            const chat = state.chats[state.activeChatId]; 
            const senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘'; 
            const receiverName = chat.isGroup ? 'ç¾¤èŠ' : chat.name; 
            
            const msg = { 
                role: 'user', 
                type: 'transfer', 
                amount: amount, 
                note: note, 
                senderName, 
                receiverName, 
                timestamp: Date.now() 
            }; 
            
            chat.history.push(msg); 
            await db.chats.put(chat); 
            appendMessage(msg, chat); 
            renderChatList(); 
            
            document.getElementById('transfer-modal').classList.remove('visible'); 
            amountInput.value = ''; 
            noteInput.value = ''; 
            
            // åœ¨ä¸‹ä¸€æ¬¡AIå›å¤æ—¶ï¼ŒAIä¼šè‡ªåŠ¨æ¥å—è½¬è´¦
        }
        
        // æ˜¾ç¤ºè½¬è´¦ç¡®è®¤å¯¹è¯æ¡†
        function showTransferConfirmDialog(transferMsg) {
            if (!transferMsg || transferMsg.status) return;
            
            const modal = document.getElementById('transfer-confirm-modal');
            const amountEl = modal.querySelector('.transfer-confirm-amount');
            const noteEl = modal.querySelector('.transfer-confirm-note');
            
            // è®¾ç½®è½¬è´¦ä¿¡æ¯
            amountEl.textContent = `Â¥ ${Number(transferMsg.amount).toFixed(2)}`;
            noteEl.textContent = `å¤‡æ³¨ï¼š${transferMsg.note || 'æ— '}`;
            
            // å­˜å‚¨å½“å‰å¤„ç†çš„è½¬è´¦ä¿¡æ¯
            currentTransferMsg = transferMsg;
            
            // æ˜¾ç¤ºå¯¹è¯æ¡†
            modal.classList.add('visible');
        }
        
        // å¤„ç†è½¬è´¦æ¥å—
        async function acceptTransfer() {
            if (!currentTransferMsg || !state.activeChatId) return;
            
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
            
            // åœ¨å†å²è®°å½•ä¸­æ‰¾åˆ°å¯¹åº”çš„è½¬è´¦æ¶ˆæ¯å¹¶æ›´æ–°çŠ¶æ€
            const transferIndex = chat.history.findIndex(msg => 
                msg.timestamp === currentTransferMsg.timestamp);
                
            if (transferIndex !== -1) {
                // æ›´æ–°è½¬è´¦çŠ¶æ€
                chat.history[transferIndex].status = 'accepted';
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                await db.chats.put(chat);
                
                // é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢
                renderChatInterface(state.activeChatId);
                
                // æ·»åŠ ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯ï¼Œè¡¨ç¤ºå·²æ”¶æ¬¾
                const systemMsg = {
                    role: 'system',
                    type: 'system_message',
                    content: `[ä½ å·²ç¡®è®¤æ”¶æ¬¾ Â¥${Number(currentTransferMsg.amount).toFixed(2)}]`,
                    timestamp: Date.now()
                };
                
                chat.history.push(systemMsg);
                await db.chats.put(chat);
                appendMessage(systemMsg, chat);
            }
            
            // å…³é—­å¯¹è¯æ¡†
            document.getElementById('transfer-confirm-modal').classList.remove('visible');
            currentTransferMsg = null;
        }
        
        // å¤„ç†è½¬è´¦æ‹’ç»
        async function rejectTransfer() {
            if (!currentTransferMsg || !state.activeChatId) return;
            
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
            
            // åœ¨å†å²è®°å½•ä¸­æ‰¾åˆ°å¯¹åº”çš„è½¬è´¦æ¶ˆæ¯å¹¶æ›´æ–°çŠ¶æ€
            const transferIndex = chat.history.findIndex(msg => 
                msg.timestamp === currentTransferMsg.timestamp);
                
            if (transferIndex !== -1) {
                // æ›´æ–°è½¬è´¦çŠ¶æ€
                chat.history[transferIndex].status = 'rejected';
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                await db.chats.put(chat);
                
                // é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢
                renderChatInterface(state.activeChatId);
                
                // æ·»åŠ ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯ï¼Œè¡¨ç¤ºå·²é€€å›
                const systemMsg = {
                    role: 'system',
                    type: 'system_message',
                    content: `[ä½ å·²é€€å› Â¥${Number(currentTransferMsg.amount).toFixed(2)}]`,
                    timestamp: Date.now()
                };
                
                chat.history.push(systemMsg);
                await db.chats.put(chat);
                appendMessage(systemMsg, chat);
            }
            
            // å…³é—­å¯¹è¯æ¡†
            document.getElementById('transfer-confirm-modal').classList.remove('visible');
            currentTransferMsg = null;
        }
        
        // å…¨å±€å˜é‡ï¼Œç”¨äºå­˜å‚¨å½“å‰æ­£åœ¨å¤„ç†çš„è½¬è´¦æ¶ˆæ¯
        let currentTransferMsg = null;
        
        // å…¨å±€å˜é‡ï¼Œç”¨äºå­˜å‚¨ç”¨æˆ·æœ€è¿‘ä¸Šä¼ çš„å›¾ç‰‡
        let recentUserUploadedImage = null;
        
        async function handlePoke(isUser, chat, senderName) {
            if (!state.activeChatId) return;
            
            let pokeSuffix = '';
            let pokeMessage = '';
            
            if (isUser) {
                // ç‚¹å‡»ç”¨æˆ·å¤´åƒï¼ŒAIæˆ³ç”¨æˆ·
                pokeSuffix = chat.settings.myPokeSuffix || 'çš„è„‘è¢‹';
                pokeMessage = chat.isGroup ? 
                    `${senderName}æˆ³äº†æˆ³ä½ ${pokeSuffix}` : 
                    `${chat.name}æˆ³äº†æˆ³ä½ ${pokeSuffix}`;
            } else {
                // ç‚¹å‡»AIå¤´åƒï¼Œç”¨æˆ·æˆ³AI
                pokeSuffix = chat.settings.aiPokeSuffix || 'çš„è„¸è›‹';
                if (chat.isGroup && senderName) {
                    pokeMessage = `ä½ æˆ³äº†æˆ³${senderName}${pokeSuffix}`;
                } else {
                    pokeMessage = `ä½ æˆ³äº†æˆ³${chat.name}${pokeSuffix}`;
                }
            }
            
            const pokeMsg = {
                type: 'poke',
                content: pokeMessage,
                timestamp: Date.now()
            };
            
            chat.history.push(pokeMsg);
            await db.chats.put(chat);
            appendMessage(pokeMsg, chat);
            
            // å¦‚æœç”¨æˆ·æˆ³äº†AIï¼ŒAIæœ‰40%æ¦‚ç‡å›æˆ³
            if (!isUser && Math.random() < 0.4) {
                setTimeout(async () => {
                    const aiPokeSuffix = chat.settings.myPokeSuffix || 'çš„é¼»å­';
                    const aiPokeMessage = chat.isGroup ? 
                        `${senderName || chat.name}ä¹Ÿæˆ³äº†æˆ³ä½ ${aiPokeSuffix}` : 
                        `${chat.name}ä¹Ÿæˆ³äº†æˆ³ä½ ${aiPokeSuffix}`;
                    
                    const aiPokeMsg = {
                        type: 'poke',
                        content: aiPokeMessage,
                        timestamp: Date.now()
                    };
                    
                    chat.history.push(aiPokeMsg);
                    await db.chats.put(chat);
                    appendMessage(aiPokeMsg, chat);
                }, Math.random() * 2000 + 500); // 0.5-2.5ç§’éšæœºå»¶è¿Ÿ
            }
        }
        
        // å¤„ç†æ¶ˆæ¯æ’¤å›
        async function handleRecalledMessage(messageContent, chat, senderName = null) {
            if (!chat) return;
            
            // å…ˆæ˜¾ç¤ºåŸå§‹æ¶ˆæ¯
            if (state.activeChatId === chat.id) {
                // åˆ›å»ºä¸´æ—¶æ¶ˆæ¯å…ƒç´ 
                const messagesContainer = document.getElementById('chat-messages');
                const typingIndicator = document.getElementById('typing-indicator');
                
                // åˆ›å»ºæ¶ˆæ¯åŒ…è£…å™¨
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper ai';
                
                // åˆ›å»ºæ¶ˆæ¯æ°”æ³¡
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble ai';
                const timestamp = Date.now();
                bubble.dataset.timestamp = timestamp;
                
                // åˆ›å»ºå¤´åƒç»„
                const avatarGroup = document.createElement('div');
                avatarGroup.className = 'avatar-group';
                
                // åˆ›å»ºå¤´åƒ - æ ¹æ®å‘é€è€…ç¡®å®šå¤´åƒ
                const avatar = document.createElement('img');
                avatar.className = 'avatar';
                
                if (chat.isGroup && senderName) {
                    // ç¾¤èŠä¸­æ‰¾åˆ°å¯¹åº”æˆå‘˜çš„å¤´åƒ
                    const member = chat.members.find(m => m.name === senderName);
                    avatar.src = member?.avatar || defaultAvatar;
                } else {
                    // å•èŠæˆ–æ²¡æœ‰æŒ‡å®šå‘é€è€…ï¼Œä½¿ç”¨AIå¤´åƒ
                    avatar.src = chat.settings.aiAvatar || defaultAvatar;
                }
                
                avatarGroup.appendChild(avatar);
                
                // åˆ›å»ºæ—¶é—´æˆ³
                const timestampEl = document.createElement('span');
                timestampEl.className = 'timestamp';
                timestampEl.textContent = formatTimestamp(timestamp);
                avatarGroup.appendChild(timestampEl);
                
                // åˆ›å»ºå†…å®¹
                const content = document.createElement('div');
                content.className = 'content';
                content.textContent = messageContent;
                
                // ç»„è£…æ¶ˆæ¯
                bubble.appendChild(avatarGroup);
                bubble.appendChild(content);
                wrapper.appendChild(bubble);
                
                // æ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨
                messagesContainer.insertBefore(wrapper, typingIndicator);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´å"æ’¤å›"
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
                wrapper.style.animation = 'fadeOut 0.5s ease-in-out forwards';
                
                // ç­‰å¾…åŠ¨ç”»å®Œæˆåç§»é™¤ä¸´æ—¶æ¶ˆæ¯
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // åˆ›å»ºæ’¤å›æ¶ˆæ¯å…ƒç´ 
                const recallElement = document.createElement('div');
                recallElement.className = 'recalled-message';
                const displayName = chat.isGroup && senderName ? senderName : (chat.name || 'å¯¹æ–¹');
                recallElement.textContent = `${displayName}æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯`;
                recallElement.dataset.timestamp = Date.now();
                
                // å¦‚æœæœ‰åŸå§‹æ¶ˆæ¯å†…å®¹ï¼Œæ˜¾ç¤ºåŸæ–‡
                if (messageContent) {
                    const originalText = document.createElement('div');
                    originalText.textContent = `åŸæ–‡ï¼š${messageContent}`;
                    originalText.style.cssText = `
                        color: #999;
                        font-size: 12px;
                        text-align: center;
                        margin-top: 4px;
                    `;
                    recallElement.appendChild(originalText);
                }
                
                // åˆ›å»ºä¸€ä¸ªæ–°çš„åŒ…è£…å™¨æ¥åŒ…å«æ’¤å›æ¶ˆæ¯
                const recallWrapper = document.createElement('div');
                recallWrapper.className = 'message-wrapper system';
                recallWrapper.appendChild(recallElement);
                
                // åœ¨åŸæ¶ˆæ¯çš„ä½ç½®æ’å…¥æ’¤å›æç¤º
                const parent = wrapper.parentNode;
                if (parent) {
                    parent.insertBefore(recallWrapper, wrapper);
                    wrapper.remove();
                }
                
                // æ·»åŠ åˆ°èŠå¤©å†å²
                const recalledMsg = {
                    role: 'assistant',
                    type: 'recalled_message',
                    originalContent: messageContent,
                    senderName: senderName || (chat.isGroup ? 'æœªçŸ¥' : chat.name),
                    timestamp: Date.now(),
                    originalTimestamp: timestamp // ä¿å­˜åŸå§‹æ¶ˆæ¯çš„æ—¶é—´æˆ³
                };
                
                chat.history.push(recalledMsg);
                await db.chats.put(chat);
                
                // æ›´æ–°èŠå¤©åˆ—è¡¨
                renderChatList();
                return;
            }
            
            // å¦‚æœä¸æ˜¯å½“å‰èŠå¤©ï¼Œåªæ·»åŠ åˆ°å†å²è®°å½•
            const recalledMsg = {
                role: 'assistant',
                type: 'recalled_message',
                originalContent: messageContent,
                senderName: senderName || (chat.isGroup ? 'æœªçŸ¥' : chat.name),
                timestamp: Date.now(),
                originalTimestamp: Date.now() - 1000 // ä¸ºéå®æ—¶æ’¤å›æ·»åŠ ä¸€ä¸ªä¼°è®¡çš„åŸå§‹æ—¶é—´æˆ³
            };
            
            // æ·»åŠ åˆ°èŠå¤©å†å²
            chat.history.push(recalledMsg);
            await db.chats.put(chat);
            
            // æ›´æ–°èŠå¤©åˆ—è¡¨
            renderChatList();
        }
        
        // æ·»åŠ æ·¡å‡ºåŠ¨ç”»æ ·å¼
        const fadeOutStyle = document.createElement('style');
        fadeOutStyle.textContent = `
            @keyframes fadeOut {
                0% { opacity: 1; transform: translateY(0); }
                100% { opacity: 0; transform: translateY(10px); }
            }
        `;
        document.head.appendChild(fadeOutStyle);
        
        // @é«˜äº®æ˜¾ç¤ºå‡½æ•°
        function highlightMentions(content, chat) {
            let highlightedContent = content;
            
            // è·å–æ‰€æœ‰ç¾¤æˆå‘˜åå­—ï¼ˆåŒ…æ‹¬ç”¨æˆ·æ˜µç§°ï¼‰
            const allMembers = [...chat.members];
            const userNickname = chat.settings.myNickname || 'æˆ‘';
            allMembers.push({ name: userNickname });
            
            // ä¸ºæ¯ä¸ªæˆå‘˜åå­—æ·»åŠ é«˜äº®
            allMembers.forEach(member => {
                const mentionPattern = new RegExp(`@${member.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}(?=\\s|$|<br>|&nbsp;)`, 'g');
                highlightedContent = highlightedContent.replace(mentionPattern, `<span class="mention-tag">@${member.name}</span>`);
            });
            
            return highlightedContent;
        }

        // æ¶ˆæ¯ç¼–è¾‘ç›¸å…³å˜é‡
        let editingMessageTimestamp = null;
        let editingMessageBubble = null;

        // æ˜¾ç¤ºæ¶ˆæ¯æ“ä½œèœå•
        function showMessageActionMenu(timestamp, bubble) {
            // å¦‚æœå·²ç»åœ¨é€‰æ‹©æ¨¡å¼ï¼Œåˆ™è¿›å…¥é€‰æ‹©æ¨¡å¼
            if (isSelectionMode) {
                enterSelectionMode(timestamp);
                return;
            }

            // æ˜¾ç¤ºæ“ä½œèœå•
            showCustomConfirm(
                'æ¶ˆæ¯æ“ä½œ',
                'è¯·é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œï¼š',
                {
                    customButtons: [
                        { text: 'ç¼–è¾‘æ¶ˆæ¯', action: () => editMessage(timestamp, bubble) },
                        { text: 'å¤šé€‰æ¨¡å¼', action: () => enterSelectionMode(timestamp) },
                        { text: 'å–æ¶ˆ', action: () => {} }
                    ]
                }
            );
        }

        // ç¼–è¾‘æ¶ˆæ¯
        function editMessage(timestamp, bubble) {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;

            // åœ¨å†å²è®°å½•ä¸­æ‰¾åˆ°å¯¹åº”çš„æ¶ˆæ¯
            const message = chat.history.find(msg => msg.timestamp === timestamp);
            if (!message) return;

            // æ£€æŸ¥æ¶ˆæ¯ç±»å‹ï¼Œåªå…è®¸ç¼–è¾‘æ–‡æœ¬æ¶ˆæ¯
            if (message.type && message.type !== 'text' && message.type !== 'user' && message.type !== 'assistant') {
                showToast('åªèƒ½ç¼–è¾‘æ–‡æœ¬æ¶ˆæ¯', 'error');
                return;
            }

            // è®¾ç½®ç¼–è¾‘çŠ¶æ€
            editingMessageTimestamp = timestamp;
            editingMessageBubble = bubble;

            // æ·»åŠ ç¼–è¾‘ä¸­çš„è§†è§‰æ•ˆæœ
            bubble.classList.add('editing');

            // å¡«å……ç¼–è¾‘è¡¨å•
            document.getElementById('message-edit-content').value = message.content || '';

            // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
            showMessageEditModal();
        }

        // æ˜¾ç¤ºæ¶ˆæ¯ç¼–è¾‘æ¨¡æ€æ¡†
        function showMessageEditModal() {
            const modal = document.getElementById('message-edit-modal');
            modal.classList.add('visible');

            // èšç„¦åˆ°å†…å®¹è¾“å…¥æ¡†
            setTimeout(() => {
                const contentInput = document.getElementById('message-edit-content');
                contentInput.focus();
                contentInput.setSelectionRange(contentInput.value.length, contentInput.value.length);
            }, 100);

            // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
            const handleKeyDown = (e) => {
                if (e.key === 'Escape') {
                    hideMessageEditModal();
                    document.removeEventListener('keydown', handleKeyDown);
                }
            };
            document.addEventListener('keydown', handleKeyDown);

            // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½
            const handleModalClick = (e) => {
                if (e.target === modal) {
                    hideMessageEditModal();
                    modal.removeEventListener('click', handleModalClick);
                }
            };
            modal.addEventListener('click', handleModalClick);
        }

        // éšè—æ¶ˆæ¯ç¼–è¾‘æ¨¡æ€æ¡†
        window.hideMessageEditModal = function() {
            const modal = document.getElementById('message-edit-modal');
            modal.classList.remove('visible');

            // æ¸…é™¤ç¼–è¾‘çŠ¶æ€
            if (editingMessageBubble) {
                editingMessageBubble.classList.remove('editing');
            }

            editingMessageTimestamp = null;
            editingMessageBubble = null;
        }

        // ä¿å­˜ç¼–è¾‘åçš„æ¶ˆæ¯
        window.saveEditedMessage = async function() {
            if (!editingMessageTimestamp || !state.activeChatId) return;

            const chat = state.chats[state.activeChatId];
            if (!chat) return;

            const newContent = document.getElementById('message-edit-content').value.trim();

            if (!newContent) {
                showToast('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            // åœ¨å†å²è®°å½•ä¸­æ‰¾åˆ°å¹¶æ›´æ–°æ¶ˆæ¯
            const messageIndex = chat.history.findIndex(msg => msg.timestamp === editingMessageTimestamp);
            if (messageIndex === -1) return;

            const oldMessage = chat.history[messageIndex];

            // æ›´æ–°æ¶ˆæ¯å†…å®¹ï¼Œä¿æŒåŸæœ‰è§’è‰²ä¸å˜
            chat.history[messageIndex] = {
                ...oldMessage,
                content: newContent
            };

            // ä¿å­˜åˆ°æ•°æ®åº“
            await db.chats.put(chat);

            // é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢
            renderChatInterface(state.activeChatId);

            // éšè—æ¨¡æ€æ¡†
            hideMessageEditModal();

            showToast('æ¶ˆæ¯å·²ä¿å­˜', 'success');
        }

        function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }
        function exitSelectionMode() { if (!isSelectionMode) return; isSelectionMode = false; document.getElementById('chat-interface-screen').classList.remove('selection-mode'); selectedMessages.forEach(ts => { const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`); if (bubble) bubble.classList.remove('selected'); }); selectedMessages.clear(); }
        function toggleMessageSelection(timestamp) { const bubble = document.querySelector(`.message-bubble[data-timestamp="${timestamp}"]`); if (!bubble) return; if (selectedMessages.has(timestamp)) { selectedMessages.delete(timestamp); bubble.classList.remove('selected'); } else { selectedMessages.add(timestamp); bubble.classList.add('selected'); } document.getElementById('selection-count').textContent = `å·²é€‰ ${selectedMessages.size} æ¡`; if (selectedMessages.size === 0) exitSelectionMode(); }
        function addLongPressListener(element, callback) {
            let pressTimer;

            // é¼ æ ‡äº‹ä»¶å¤„ç†
            const startMousePress = (e) => {
                if(isSelectionMode) return;
                e.preventDefault();
                pressTimer = window.setTimeout(() => callback(e), 500);
            };

            // è§¦æ‘¸äº‹ä»¶å¤„ç† - ä¸è°ƒç”¨preventDefaultä»¥é¿å…passiveè­¦å‘Š
            const startTouchPress = (e) => {
                if(isSelectionMode) return;
                pressTimer = window.setTimeout(() => callback(e), 500);
            };

            const cancelPress = () => clearTimeout(pressTimer);

            // æ·»åŠ é¼ æ ‡äº‹ä»¶ç›‘å¬å™¨
            element.addEventListener('mousedown', startMousePress);
            element.addEventListener('mouseup', cancelPress);
            element.addEventListener('mouseleave', cancelPress);

            // æ·»åŠ è§¦æ‘¸äº‹ä»¶ç›‘å¬å™¨ - ä¸ä½¿ç”¨passiveé€‰é¡¹
            element.addEventListener('touchstart', startTouchPress);
            element.addEventListener('touchend', cancelPress);
            element.addEventListener('touchmove', cancelPress);
        }
        async function handleListenTogetherClick() { const targetChatId = state.activeChatId; if (!targetChatId) return; if (!musicState.isActive) { startListenTogetherSession(targetChatId); return; } if (musicState.activeChatId === targetChatId) { document.getElementById('music-player-overlay').classList.add('visible'); } else { const oldChatName = state.chats[musicState.activeChatId]?.name || 'æœªçŸ¥'; const newChatName = state.chats[targetChatId]?.name || 'å½“å‰'; const confirmed = await showCustomConfirm('åˆ‡æ¢å¬æ­Œå¯¹è±¡', `æ‚¨æ­£å’Œã€Œ${oldChatName}ã€å¬æ­Œã€‚è¦ç»“æŸå¹¶å¼€å§‹å’Œã€Œ${newChatName}ã€çš„æ–°ä¼šè¯å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await endListenTogetherSession(true); await new Promise(resolve => setTimeout(resolve, 50)); startListenTogetherSession(targetChatId); } } }
        async function startListenTogetherSession(chatId) { const chat = state.chats[chatId]; if (!chat) return; musicState.totalElapsedTime = chat.musicData.totalTime || 0; musicState.isActive = true; musicState.activeChatId = chatId; if (musicState.playlist.length > 0) { musicState.currentIndex = 0; } else { musicState.currentIndex = -1; } if(musicState.timerId) clearInterval(musicState.timerId); musicState.timerId = setInterval(() => { if (musicState.isPlaying) { musicState.totalElapsedTime++; updateElapsedTimeDisplay(); } }, 1000); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-player-overlay').classList.add('visible'); }
        async function endListenTogetherSession(saveState = true) { if (!musicState.isActive) return; const oldChatId = musicState.activeChatId; if (musicState.timerId) clearInterval(musicState.timerId); if (musicState.isPlaying) audioPlayer.pause(); if (saveState && oldChatId && state.chats[oldChatId]) { const chat = state.chats[oldChatId]; chat.musicData.totalTime = musicState.totalElapsedTime; await db.chats.put(chat); } musicState.isActive = false; musicState.activeChatId = null; musicState.totalElapsedTime = 0; musicState.timerId = null; document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); updateListenTogetherIcon(oldChatId, true); }
        function returnToChat() { document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); }
        function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if(!iconImg) return; if(forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/vBN7GnQ9/3-FC8-D1596-C5-CFB200-FCB1-D8-C3-A37-A370.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
        window.updateListenTogetherIconProxy = updateListenTogetherIcon;
        function updatePlayerUI() { updateListenTogetherIcon(musicState.activeChatId); updateElapsedTimeDisplay(); const titleEl = document.getElementById('music-player-song-title'); const artistEl = document.getElementById('music-player-artist'); const playPauseBtn = document.getElementById('music-play-pause-btn'); if (musicState.currentIndex > -1 && musicState.playlist.length > 0) { const track = musicState.playlist[musicState.currentIndex]; titleEl.textContent = track.name; artistEl.textContent = track.artist; } else { titleEl.textContent = 'è¯·æ·»åŠ æ­Œæ›²'; artistEl.textContent = '...'; } playPauseBtn.textContent = musicState.isPlaying ? 'âšâš' : 'â–¶'; }
        function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `å·²ç»ä¸€èµ·å¬äº†${hours}å°æ—¶`; }
        function updatePlaylistUI() { const playlistBody = document.getElementById('playlist-body'); playlistBody.innerHTML = ''; if (musicState.playlist.length === 0) { playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">æ’­æ”¾åˆ—è¡¨æ˜¯ç©ºçš„~</p>'; return; } musicState.playlist.forEach((track, index) => { const item = document.createElement('div'); item.className = 'playlist-item'; if(index === musicState.currentIndex) item.classList.add('playing'); item.innerHTML = `<div class="playlist-item-info"><div class="title">${track.name}</div><div class="artist">${track.artist}</div></div><span class="delete-track-btn" data-index="${index}">&times;</span>`; item.querySelector('.playlist-item-info').addEventListener('click', () => playSong(index)); item.querySelector('.delete-track-btn').addEventListener('click', async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('åˆ é™¤æ­Œæ›²', `ç¡®å®šè¦ä»æ’­æ”¾åˆ—è¡¨ä¸­åˆ é™¤ã€Š${track.name}ã€‹å—ï¼Ÿ`); if(confirmed) deleteTrack(index); }); playlistBody.appendChild(item); }); }
        function playSong(index) { if (index < 0 || index >= musicState.playlist.length) return; musicState.currentIndex = index; const track = musicState.playlist[index]; if (track.isLocal && track.src instanceof Blob) { audioPlayer.src = URL.createObjectURL(track.src); } else if (!track.isLocal) { audioPlayer.src = track.src; } else { console.error('æœ¬åœ°æ­Œæ›²æºé”™è¯¯:', track); return; } audioPlayer.play(); updatePlaylistUI(); updatePlayerUI(); }
        function togglePlayPause() { if (audioPlayer.paused) { if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { playSong(0); } else if (musicState.currentIndex > -1) { audioPlayer.play(); } } else { audioPlayer.pause(); } }
        function playNext() { if (musicState.playlist.length === 0) return; let nextIndex; switch(musicState.playMode) { case 'random': nextIndex = Math.floor(Math.random() * musicState.playlist.length); break; case 'single': playSong(musicState.currentIndex); return; case 'order': default: nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length; break; } playSong(nextIndex); }
        function playPrev() { if (musicState.playlist.length === 0) return; const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length; playSong(newIndex); }
        function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = {'order': 'é¡ºåº', 'random': 'éšæœº', 'single': 'å•æ›²'}[musicState.playMode]; }
        async function addSongFromURL() { const url = await showCustomPrompt("æ·»åŠ ç½‘ç»œæ­Œæ›²", "è¯·è¾“å…¥æ­Œæ›²çš„URL", "", "url"); if (!url) return; const name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå"); if (!name) return; const artist = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å"); if (!artist) return; musicState.playlist.push({ name, artist, src: url, isLocal: false }); await saveGlobalPlaylist(); updatePlaylistUI(); if(musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } }
        async function addSongFromLocal(event) { const files = event.target.files; if (!files.length) return; for (const file of files) { const name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå", ""); if (name === null) continue; const artist = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å", ""); if (artist === null) continue; musicState.playlist.push({ name, artist, src: file, isLocal: true }); } await saveGlobalPlaylist(); updatePlaylistUI(); if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { musicState.currentIndex = 0; updatePlayerUI(); } event.target.value = null; }
        async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }

        // --- Persona Preset functions ---
        const personaLibraryModal = document.getElementById('persona-library-modal');
        const personaEditorModal = document.getElementById('persona-editor-modal');
        const presetActionsModal = document.getElementById('preset-actions-modal');
        function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }
        function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }
        function renderPersonaLibrary() { const grid = document.getElementById('persona-library-grid'); grid.innerHTML = ''; if (state.personaPresets.length === 0) { grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">ç©ºç©ºå¦‚ä¹Ÿ~ ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ "æ¥åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªäººè®¾é¢„è®¾å§ï¼</p>'; return; } state.personaPresets.forEach(preset => { const item = document.createElement('div'); item.className = 'persona-preset-item'; item.style.backgroundImage = `url(${preset.avatar})`; item.dataset.presetId = preset.id; item.addEventListener('click', () => applyPersonaPreset(preset.id)); addLongPressListener(item, () => showPresetActions(preset.id)); grid.appendChild(item); }); }
        function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }
        function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }
        function applyPersonaPreset(presetId) { const preset = state.personaPresets.find(p => p.id === presetId); if (preset) { document.getElementById('my-avatar-preview').src = preset.avatar; document.getElementById('my-persona').value = preset.persona; } closePersonaLibrary(); }
        function openPersonaEditorForCreate() { editingPersonaPresetId = null; document.getElementById('persona-editor-title').textContent = 'æ·»åŠ äººè®¾é¢„è®¾'; document.getElementById('preset-avatar-preview').src = defaultAvatar; document.getElementById('preset-persona-input').value = ''; personaEditorModal.classList.add('visible'); }
        function openPersonaEditorForEdit() { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (!preset) return; document.getElementById('persona-editor-title').textContent = 'ç¼–è¾‘äººè®¾é¢„è®¾'; document.getElementById('preset-avatar-preview').src = preset.avatar; document.getElementById('preset-persona-input').value = preset.persona; presetActionsModal.classList.remove('visible'); personaEditorModal.classList.add('visible'); }
        async function deletePersonaPreset() { const confirmed = await showCustomConfirm('åˆ é™¤é¢„è®¾', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäººè®¾é¢„è®¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }
        function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }
        async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert("å¤´åƒå’Œäººè®¾ä¸èƒ½éƒ½ä¸ºç©ºå“¦ï¼"); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }

        // --- Battery Functions ---
        const batteryAlertModal = document.getElementById('battery-alert-modal');
        function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }
        function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }
        function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'æœ‰ç‚¹é¥¿äº†ï¼Œå¯ä»¥å»æ‰¾å……ç”µå™¨æƒ¹'); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'èµ¶ç´§çš„å……ç”µï¼Œè¦é¥¿æ­»äº†'); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'å·²é˜µäº¡ï¼Œè¿˜æœ‰30ç§’çˆ†ç‚¸'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }
        async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'çªçˆ±æ³¥ï¼Œç”µé‡åƒé¥±é¥±'); } }); } catch (err) { console.error("æ— æ³•è·å–ç”µæ± ä¿¡æ¯:", err); document.querySelector('.battery-text').textContent = 'á°”á©š'; } } else { console.log("æµè§ˆå™¨ä¸æ”¯æŒç”µæ± çŠ¶æ€APIã€‚"); document.querySelector('.battery-text').textContent = 'á°”á©š'; } }

        // é€šè¯åŠŸèƒ½å®ç°
        function startCall(type) {
            if (!state.activeChatId) return;
            
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
            
            callState.isInCall = true;
            callState.callType = type;
            callState.activeChatId = state.activeChatId;
            callState.startTime = Date.now();
            callState.messages = [];
            callState.userInitiated = true; // æ ‡è®°ä¸ºç”¨æˆ·ä¸»åŠ¨å‘èµ·
            
            // è®¾ç½®ç•Œé¢
            document.getElementById('call-contact-name').textContent = chat.name;
            document.getElementById('call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
            
            // æ˜¾ç¤ºé€šè¯ç•Œé¢
            document.getElementById('call-type-modal').classList.remove('visible');
            document.getElementById('call-overlay').classList.add('visible');
            
            // å¼€å§‹è®¡æ—¶
            startCallTimer();
            
            // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
            document.getElementById('call-messages').innerHTML = '';
        }
        
        function startCallTimer() {
            callState.timer = setInterval(() => {
                if (!callState.isInCall) return;
                
                const elapsed = Date.now() - callState.startTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                const timeString = 
                    String(hours).padStart(2, '0') + ':' +
                    String(minutes).padStart(2, '0') + ':' +
                    String(seconds).padStart(2, '0');
                
                document.getElementById('call-timer').textContent = timeString;
            }, 1000);
        }
        
        function endCall() {
            if (!callState.isInCall) return;
            
            callState.isInCall = false;
            clearInterval(callState.timer);
            
            // éšè—é€šè¯ç•Œé¢
            document.getElementById('call-overlay').classList.remove('visible');
            document.getElementById('incoming-call-modal').classList.remove('visible');
            
            // å°†é€šè¯è®°å½•æ·»åŠ åˆ°èŠå¤©å†å²
            if (callState.messages.length > 0) {
                addCallToHistory();
            }
            
            // ä¿å­˜å½“å‰çŠ¶æ€ç”¨äºç”Ÿæˆååº”
            const currentChatId = callState.activeChatId;
            const currentCallType = callState.callType;
            const currentMessages = [...callState.messages];

            // é‡ç½®çŠ¶æ€
            callState = {
                isInCall: false,
                callType: null,
                activeChatId: null,
                startTime: null,
                timer: null,
                messages: [],
                userInitiated: false
            };

            // AIå¯¹è¢«æŒ‚æ–­åšå‡ºååº”ï¼ˆä½¿ç”¨ä¿å­˜çš„çŠ¶æ€ï¼‰
            setTimeout(() => {
                generateCallReaction('hungup', currentChatId, currentCallType, currentMessages);
            }, Math.random() * 2000 + 1000);
        }
        
        async function addCallToHistory() {
            const chat = state.chats[callState.activeChatId];
            if (!chat) return;
            
            // è®¡ç®—é€šè¯æ—¶é•¿
            const callDuration = Date.now() - callState.startTime;
            const minutes = Math.floor(callDuration / 60000);
            const seconds = Math.floor((callDuration % 60000) / 1000);
            const durationText = `${minutes}åˆ†${seconds}ç§’`;
            
            // å°†é€šè¯æ¶ˆæ¯æ·»åŠ åˆ°èŠå¤©è®°å½•ï¼Œè¿‡æ»¤æ‰æå†™éƒ¨åˆ†
            for (const message of callState.messages) {
                // è·³è¿‡æå†™éƒ¨åˆ†ï¼Œåªä¿å­˜è§’è‰²å’Œç”¨æˆ·çš„å¯¹è¯å†…å®¹
                if (message.isDescription) {
                    continue;
                }
                
                // ç›´æ¥ä¿å­˜æ¶ˆæ¯å†…å®¹ï¼Œä¸æ·»åŠ é€šè¯ç±»å‹å‰ç¼€ï¼Œè®©é€šè¯æ¶ˆæ¯åƒæ™®é€šèŠå¤©ä¸€æ ·æ˜¾ç¤º
                chat.history.push({
                    role: message.role,
                    content: message.content,
                    timestamp: message.timestamp,
                    callType: callState.callType,
                    isCallMessage: true
                });
            }
            
            // æ·»åŠ é€šè¯æ—¶é•¿æé†’
            if (callState.messages.length > 0) {
                const callTypeName = callState.callType === 'video' ? 'è§†é¢‘é€šè¯' : 'è¯­éŸ³é€šè¯';
                chat.history.push({
                    role: 'system',
                    content: `${callTypeName}ç»“æŸï¼Œé€šè¯æ—¶é•¿ï¼š${durationText}`,
                    timestamp: Date.now(),
                    callType: callState.callType
                });
            }
            
            await db.chats.put(chat);
            
            // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¿™ä¸ªèŠå¤©ï¼Œé‡æ–°æ¸²æŸ“
            if (state.activeChatId === callState.activeChatId) {
                renderChatInterface(state.activeChatId);
            }
            renderChatList();
        }

        // æ˜¾ç¤ºé€šè¯åŠ è½½æŒ‡ç¤ºå™¨
        function showCallTypingIndicator() {
            const messagesContainer = document.getElementById('call-messages');

            // å…ˆç§»é™¤å·²å­˜åœ¨çš„æŒ‡ç¤ºå™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            hideCallTypingIndicator();

            // åˆ›å»ºæ–°çš„åŠ è½½æŒ‡ç¤ºå™¨
            const indicator = document.createElement('div');
            indicator.className = 'call-typing-indicator';
            indicator.id = 'call-typing-indicator';
            indicator.innerHTML = `
                <span>æ­£åœ¨æ€è€ƒ</span>
                <div class="call-typing-dots">
                    <div class="call-typing-dot"></div>
                    <div class="call-typing-dot"></div>
                    <div class="call-typing-dot"></div>
                </div>
            `;

            // æ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨çš„åº•éƒ¨
            messagesContainer.appendChild(indicator);

            // æ»šåŠ¨åˆ°åº•éƒ¨æ˜¾ç¤ºæŒ‡ç¤ºå™¨
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // éšè—é€šè¯åŠ è½½æŒ‡ç¤ºå™¨
        function hideCallTypingIndicator() {
            const indicator = document.getElementById('call-typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function addCallMessage(role, content, isDescription = false) {
            // å¦‚æœæ˜¯AIæ¶ˆæ¯ï¼Œå…ˆéšè—åŠ è½½æŒ‡ç¤ºå™¨
            if (role === 'assistant') {
                hideCallTypingIndicator();
            }

            const message = {
                role: role,
                content: content,
                timestamp: Date.now(),
                isDescription: isDescription
            };

            callState.messages.push(message);

            // æ˜¾ç¤ºåœ¨é€šè¯ç•Œé¢
            const messagesContainer = document.getElementById('call-messages');
            const messageEl = document.createElement('div');

            if (isDescription) {
                messageEl.className = 'call-message description';
                messageEl.textContent = content; // ä½¿ç”¨textContenté¿å…HTMLæ ¼å¼ä»£ç æ˜¾ç¤º
            } else {
                messageEl.className = `call-message ${role}`;
                messageEl.textContent = content;
            }

            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        async function sendCallMessage() {
            const input = document.getElementById('call-input');
            const content = input.value.trim();
            if (!content) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addCallMessage('user', content);
            input.value = '';

            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            showCallTypingIndicator();

            // è§¦å‘AIå›åº”
            setTimeout(() => {
                generateCallAiResponse(content);
            }, 1000);
        }
        
        async function generateCallAiResponse(userMessage) {
            const chat = state.chats[callState.activeChatId];
            if (!chat) return;
            
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) return;
            
            try {
                const isVideoCall = callState.callType === 'video';
                const characterName = chat ? chat.name : 'è§’è‰²';
                
                // è·å–ä¸Šä¸‹æ–‡è®°å¿†
                const maxMemory = parseInt(chat.settings.maxMemory) || 10;
                const recentHistory = getHistoryByRounds(chat.history, maxMemory);
                
                // è·å–ä¸–ç•Œä¹¦å†…å®¹
                let worldBookContent = '';
                if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                    const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                        return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
                    }).filter(Boolean).join('');
                    if (linkedContents) {
                        worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)\n${linkedContents}\n`;
                    }
                }
                
                // è·å–æœ€æ–°çš„5æ¡å¾®åšåŠ¨æ€åŠå…¶è¯„è®º
                let weiboContext = '';
                try {
                    const latestPosts = await db.weiboPosts
                        .orderBy('timestamp')
                        .reverse()
                        .limit(5)
                        .toArray();
                        
                    if (latestPosts.length > 0) {
                        weiboContext = '\n\n# æœ€æ–°çš„å¾®åšåŠ¨æ€ï¼ˆå¯ä½œä¸ºè¯é¢˜å‚è€ƒï¼‰\n';
                        for (const post of latestPosts) {
                            const authorName = post.authorId === 'user' ? 'ç”¨æˆ·' : 
                                (state.chats[post.authorId] ? state.chats[post.authorId].name : 'æœªçŸ¥');
                            weiboContext += `\n[${authorName}]: ${post.content}`;
                            
                            // è·å–è¯¥åŠ¨æ€çš„è¯„è®º
                            const comments = await db.weiboComments
                                .where('postId')
                                .equals(post.id)
                                .limit(3)
                                .toArray();
                                
                            if (comments.length > 0) {
                                weiboContext += '\n  è¯„è®ºï¼š';
                                for (const comment of comments) {
                                    const commentAuthor = comment.authorId === 'user' ? 'ç”¨æˆ·' : 
                                        (state.chats[comment.authorId] ? state.chats[comment.authorId].name : 'æœªçŸ¥');
                                    weiboContext += `\n    - ${commentAuthor}: ${comment.content}`;
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('è·å–å¾®åšåŠ¨æ€å¤±è´¥:', error);
                }
                
                // è·å–æœ¬æ¬¡é€šè¯çš„å†å²è®°å½•
                const callHistory = callState.messages.map(msg => {
                    return {
                        role: msg.role,
                        content: msg.content
                    };
                }).slice(-5); // åªå–æœ€è¿‘5æ¡é€šè¯è®°å½•
                
                const sceneInstructions = isVideoCall ? 
                    `\n\n# è§†é¢‘é€šè¯ç‰¹æ®Šè§„åˆ™
- è¿™æ˜¯è§†é¢‘é€šè¯ï¼Œä½ å¯ä»¥è¿›è¡Œåœºæ™¯æå†™å’ŒåŠ¨ä½œæå†™
- ä½ çš„å›å¤åº”è¯¥åŒ…å«ä¸¤éƒ¨åˆ†ï¼šå¯¹è¯å†…å®¹ + æå†™å†…å®¹
- æå†™éƒ¨åˆ†ç”¨<desc>æ ‡ç­¾åŒ…è£¹ï¼Œä½¿ç”¨ç¬¬ä¸‰äººç§°æè¿°åœºæ™¯å’ŒåŠ¨ä½œ
- åœ¨æå†™ä¸­ç”¨"${characterName}"æ¥ç§°å‘¼è‡ªå·±ï¼Œç”¨"ä½ "æ¥ç§°å‘¼ç”¨æˆ·
- æå†™è¦ç”ŸåŠ¨å½¢è±¡ï¼Œè®©ç”¨æˆ·æ„Ÿå—åˆ°è§†é¢‘é€šè¯çš„çœŸå®æ„Ÿ
- ä¸è¦ä½¿ç”¨æ‹¬å·åŒ…è£¹æå†™éƒ¨åˆ†
- æ ¼å¼ç¤ºä¾‹ï¼šä½ å¥½å•Šï¼<desc>çª—å¤–é˜³å…‰æ­£å¥½ï¼Œ${characterName}æ¸©å’Œåœ°çœ‹ç€é•œå¤´è¿™è¾¹çš„ä½ ï¼Œå˜´è§’å¸¦ç€æ·¡æ·¡çš„å¾®ç¬‘</desc>` :
                    `\n\n# è¯­éŸ³é€šè¯è§„åˆ™
- è¿™æ˜¯è¯­éŸ³é€šè¯ï¼Œä½ ä»¬åœ¨å„è‡ªçš„åœ°æ–¹é€šè¿‡æ‰‹æœºè¿›è¡Œè¿œç¨‹é€šè¯ï¼Œä¸æ˜¯é¢å¯¹é¢
- åªèƒ½è¿›è¡Œè¯­éŸ³å¯¹è¯ï¼Œä¸è¦æå†™åŠ¨ä½œå’Œåœºæ™¯ï¼Œä¸è¦å‘å±•çº¿ä¸‹è§é¢çš„å‰§æƒ…
- ä¸“æ³¨äºè¯­è¨€äº¤æµï¼Œå›å¤è¦è‡ªç„¶æµç•…
- å¯ä»¥ç”¨è¯­æ°”è¯å’Œåœé¡¿æ¥è¡¨è¾¾æƒ…æ„Ÿ
- è®°ä½ä½ ä»¬æ˜¯é€šè¿‡ç”µè¯äº¤æµï¼Œæ— æ³•çœ‹åˆ°å¯¹æ–¹ï¼Œä¹Ÿä¸åœ¨åŒä¸€ä¸ªåœ°ç‚¹`;
                
                const systemPrompt = `ä½ æ˜¯${characterName}ï¼Œæ­£åœ¨ä¸ç”¨æˆ·è¿›è¡Œ${isVideoCall ? 'è§†é¢‘' : 'è¯­éŸ³'}é€šè¯ã€‚${worldBookContent}${weiboContext}

# ä½ çš„è§’è‰²è®¾å®šï¼š
${chat.settings.aiPersona}

# é‡è¦æé†’ï¼š
- ä½ ç°åœ¨æ­£åœ¨é€šè¯ä¸­ï¼Œè¿™æ˜¯å®æ—¶çš„è¯­éŸ³/è§†é¢‘å¯¹è¯
- è¦åŸºäºä¹‹å‰çš„èŠå¤©å†å²å’Œæœ¬æ¬¡é€šè¯çš„ä¸Šä¸‹æ–‡æ¥å›åº”
- ä¿æŒè§’è‰²çš„è¿ç»­æ€§å’Œè®°å¿†
- é€šè¯åº”è¯¥æ˜¯èŠå¤©çš„è‡ªç„¶å»¶ç»­ï¼Œä¸æ˜¯å…¨æ–°çš„å¼€å§‹

${sceneInstructions}

è¯·ç»™å‡ºè‡ªç„¶çš„å›åº”ï¼Œè¦ç®€çŸ­ä¸”ç¬¦åˆé€šè¯çš„èŠ‚å¥ã€‚`;
                
                // æ„å»ºæ¶ˆæ¯å†å²ï¼ŒåŒ…å«æœ€è¿‘èŠå¤©è®°å½•å’Œæœ¬æ¬¡é€šè¯è®°å½•
                const messages = [
                    { role: 'system', content: systemPrompt }
                ];
                
                // æ·»åŠ æœ€è¿‘çš„èŠå¤©å†å²ä½œä¸ºèƒŒæ™¯
                recentHistory.forEach(msg => {
                    if (msg.role === 'user') {
                        messages.push({ role: 'user', content: `[èŠå¤©å†å²] ç”¨æˆ·è¯´ï¼š${msg.content}` });
                    } else if (msg.role === 'assistant') {
                        messages.push({ role: 'assistant', content: `[èŠå¤©å†å²] ${characterName}è¯´ï¼š${msg.content}` });
                    }
                });
                
                // æ·»åŠ æœ¬æ¬¡é€šè¯çš„å†å²
                if (callHistory.length > 0) {
                    messages.push({ role: 'user', content: `[æœ¬æ¬¡é€šè¯å¼€å§‹]` });
                    callHistory.forEach(msg => {
                        messages.push({
                            role: msg.role,
                            content: msg.role === 'user' ? `[é€šè¯ä¸­] ç”¨æˆ·è¯´ï¼š${msg.content}` : `[é€šè¯ä¸­] ${characterName}è¯´ï¼š${msg.content}`
                        });
                    });
                }
                
                // æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
                messages.push({ role: 'user', content: `[é€šè¯ä¸­] ç”¨æˆ·åˆšåˆšè¯´ï¼š${userMessage}` });

                // ä½¿ç”¨ç»Ÿä¸€çš„APIè°ƒç”¨å‡½æ•°å¤„ç†Geminiå’Œå…¶ä»–API
                const aiResponse = await callUnifiedAPIForCall(proxyUrl, apiKey, model, messages);

                if (aiResponse) {
                    // æ¸…ç†AIå›åº”ä¸­çš„æ ¼å¼æ ‡è®°
                    let cleanResponse = aiResponse;

                    // ç§»é™¤[é€šè¯ä¸­]æ ‡è®°å’Œè§’è‰²åå‰ç¼€
                    cleanResponse = cleanResponse.replace(/^\[é€šè¯ä¸­\]\s*.*?è¯´ï¼š\s*/, '');
                    cleanResponse = cleanResponse.replace(/^\[é€šè¯ä¸­\]\s*/, '');

                    if (isVideoCall && cleanResponse.includes('<desc>')) {
                        // è§†é¢‘é€šè¯ï¼šåˆ†ç¦»å¯¹è¯å’Œæå†™éƒ¨åˆ†
                        const parts = cleanResponse.split('<desc>');
                        const dialogPart = parts[0].trim();
                        const descPart = parts[1] ? parts[1].replace('</desc>', '').trim() : '';

                        if (dialogPart) {
                            addCallMessage('assistant', dialogPart);
                        }
                        if (descPart) {
                            // ä½¿ç”¨CSSç±»è€Œä¸æ˜¯å†…è”æ ·å¼ï¼Œé¿å…æ ¼å¼ä»£ç æ˜¾ç¤º
                            addCallMessage('assistant', descPart, true);
                        }
                    } else {
                        // è¯­éŸ³é€šè¯æˆ–æ²¡æœ‰æå†™çš„è§†é¢‘é€šè¯
                        addCallMessage('assistant', cleanResponse);
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰è·å¾—å›åº”ï¼Œä¹Ÿè¦éšè—åŠ è½½æŒ‡ç¤ºå™¨
                    hideCallTypingIndicator();
                }
            } catch (error) {
                console.error('ç”Ÿæˆé€šè¯AIå›åº”å¤±è´¥:', error);
                // å‡ºé”™æ—¶éšè—åŠ è½½æŒ‡ç¤ºå™¨
                hideCallTypingIndicator();
            }
        }
        
        // AIä¸»åŠ¨æ‰“ç”µè¯åŠŸèƒ½ - åŸºäºæœ¬è½®èŠå¤©å†…å®¹è§¦å‘
        async function triggerAiCall() {
            // åªæœ‰åœ¨æœ‰æ¿€æ´»èŠå¤©ä¸”ä¸åœ¨é€šè¯ä¸­æ—¶æ‰å¯èƒ½è§¦å‘
            if (!state.activeChatId || callState.isInCall) return;
            
            const chat = state.chats[state.activeChatId];
            if (!chat || chat.isGroup) return;
            
            // æ£€æŸ¥æ˜¯å¦å…è®¸AIä¸»åŠ¨æ‹¨æ‰“ç”µè¯
            if (!chat.settings.aiCallEnabled) return;
            
            // æ£€æŸ¥æœ€è¿‘3è½®å¯¹è¯æ˜¯å¦æœ‰é€šè¯ç›¸å…³å†…å®¹
            const recentHistory = getHistoryByRounds(chat.history, 3);
            const hasCallRelatedContent = recentHistory.some(msg => {
                const content = String(msg.content || '').toLowerCase();
                return content.includes('é€šè¯') || content.includes('ç”µè¯') || content.includes('è§†é¢‘') || 
                       content.includes('è¯­éŸ³') || content.includes('æ‰“ç»™') || content.includes('ç»™ä½ æ‰“') ||
                       content.includes('æƒ³å¬') || content.includes('æƒ³çœ‹') || content.includes('èŠèŠ') ||
                       content.includes('é€šä¸ªè¯') || content.includes('è§†é¢‘èŠ') || content.includes('è¯­éŸ³èŠ') ||
                       content.includes('æ‰“ç”µè¯') || content.includes('æ¥ç”µ') || content.includes('æ¥ç”µè¯');
            });
            
            // åªæœ‰åœ¨æœ€è¿‘3è½®å¯¹è¯ä¸­æåˆ°é€šè¯ç›¸å…³å†…å®¹æ—¶æ‰æœ‰20%æ¦‚ç‡è§¦å‘
            if (!hasCallRelatedContent || Math.random() > 0.2) return;
            
            // éšæœºé€‰æ‹©é€šè¯ç±»å‹ï¼Œå¦‚æœæåˆ°è§†é¢‘ç›¸å…³å†…å®¹ï¼Œå€¾å‘äºè§†é¢‘é€šè¯
            const recentText = recentHistory.map(msg => String(msg.content || '')).join(' ').toLowerCase();
            let callType;
            if (recentText.includes('è§†é¢‘') || recentText.includes('çœ‹')) {
                callType = Math.random() > 0.3 ? 'video' : 'voice'; // 70%æ¦‚ç‡è§†é¢‘
            } else if (recentText.includes('è¯­éŸ³') || recentText.includes('å¬')) {
                callType = Math.random() > 0.3 ? 'voice' : 'video'; // 70%æ¦‚ç‡è¯­éŸ³
            } else {
                callType = Math.random() > 0.5 ? 'voice' : 'video'; // éšæœº
            }
            
            // æ˜¾ç¤ºæ¥ç”µç•Œé¢
            document.getElementById('incoming-call-type').textContent = callType === 'voice' ? 'è¯­éŸ³é€šè¯' : 'è§†é¢‘é€šè¯';
            document.getElementById('incoming-call-name').textContent = chat.name;
            document.getElementById('incoming-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
            
            // è®¾ç½®æ¥ç”µçŠ¶æ€
            window.pendingCall = { chatId: state.activeChatId, callType };
            
            document.getElementById('incoming-call-modal').classList.add('visible');
            
            // 10ç§’åè‡ªåŠ¨æŒ‚æ–­
            setTimeout(() => {
                if (document.getElementById('incoming-call-modal').classList.contains('visible')) {
                    document.getElementById('incoming-call-modal').classList.remove('visible');
                    window.pendingCall = null;
                }
            }, 10000);
        }
        
        function answerIncomingCall() {
            if (!window.pendingCall) return;
            
            // å…ˆéšè—æ¥ç”µç•Œé¢
            document.getElementById('incoming-call-modal').classList.remove('visible');
            
            // åˆ‡æ¢åˆ°å¯¹åº”èŠå¤©
            state.activeChatId = window.pendingCall.chatId;
            showScreen('chat-interface-screen');
            renderChatInterface(state.activeChatId);
            
            // è®¾ç½®ä¸ºAIä¸»åŠ¨å‘èµ·çš„é€šè¯ï¼Œè€Œéç”¨æˆ·ä¸»åŠ¨
            const callType = window.pendingCall.callType;
            const chatId = window.pendingCall.chatId;
            
            // æ¸…ç©ºpendingçŠ¶æ€
            window.pendingCall = null;
            
            // å¼€å§‹é€šè¯
            const chat = state.chats[chatId];
            if (!chat) return;
            
            callState.isInCall = true;
            callState.callType = callType;
            callState.activeChatId = chatId;
            callState.startTime = Date.now();
            callState.messages = [];
            callState.userInitiated = false; // æ ‡è®°ä¸ºAIä¸»åŠ¨å‘èµ·
            
            // è®¾ç½®ç•Œé¢
            document.getElementById('call-contact-name').textContent = chat.name;
            document.getElementById('call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
            
            // æ˜¾ç¤ºé€šè¯ç•Œé¢
            document.getElementById('call-overlay').classList.add('visible');
            
            // å¼€å§‹è®¡æ—¶
            startCallTimer();
            
            // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
            document.getElementById('call-messages').innerHTML = '';

            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            showCallTypingIndicator();

            // AIä¸»åŠ¨å‘èµ·é€šè¯æ—¶ï¼Œå…ˆè®©AIè¯´ä¸€å¥å¼€åœºç™½
            setTimeout(() => {
                generateAiCallOpening();
            }, 1000);
        }
        
        // AIä¸»åŠ¨é€šè¯çš„å¼€åœºç™½
        async function generateAiCallOpening() {
            const chat = state.chats[callState.activeChatId];
            if (!chat) return;
            
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) return;
            
            try {
                const isVideoCall = callState.callType === 'video';
                const characterName = chat.name;
                
                // è·å–ä¸Šä¸‹æ–‡è®°å¿†
                const maxMemory = parseInt(chat.settings.maxMemory) || 10;
                const recentHistory = getHistoryByRounds(chat.history, maxMemory);
                
                // è·å–ä¸–ç•Œä¹¦å†…å®¹
                let worldBookContent = '';
                if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                    const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                        return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
                    }).filter(Boolean).join('');
                    if (linkedContents) {
                        worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)\n${linkedContents}\n`;
                    }
                }
                
                const sceneInstructions = isVideoCall ? 
                    `\n\n# è§†é¢‘é€šè¯ç‰¹æ®Šè§„åˆ™
- è¿™æ˜¯è§†é¢‘é€šè¯ï¼Œä½ å¯ä»¥è¿›è¡Œåœºæ™¯æå†™å’ŒåŠ¨ä½œæå†™
- ä½ çš„å›å¤åº”è¯¥åŒ…å«ä¸¤éƒ¨åˆ†ï¼šå¯¹è¯å†…å®¹ + æå†™å†…å®¹
- æå†™éƒ¨åˆ†ç”¨<desc>æ ‡ç­¾åŒ…è£¹ï¼Œä½¿ç”¨ç¬¬ä¸‰äººç§°æè¿°åœºæ™¯å’ŒåŠ¨ä½œ
- åœ¨æå†™ä¸­ç”¨"${characterName}"æ¥ç§°å‘¼è‡ªå·±ï¼Œç”¨"ä½ "æ¥ç§°å‘¼ç”¨æˆ·
- æå†™è¦ç”ŸåŠ¨å½¢è±¡ï¼Œè®©ç”¨æˆ·æ„Ÿå—åˆ°è§†é¢‘é€šè¯çš„çœŸå®æ„Ÿ
- ä¸è¦ä½¿ç”¨æ‹¬å·åŒ…è£¹æå†™éƒ¨åˆ†` :
                    `\n\n# è¯­éŸ³é€šè¯è§„åˆ™
- è¿™æ˜¯è¯­éŸ³é€šè¯ï¼Œä½ ä»¬åœ¨å„è‡ªçš„åœ°æ–¹é€šè¿‡æ‰‹æœºè¿›è¡Œè¿œç¨‹é€šè¯ï¼Œä¸æ˜¯é¢å¯¹é¢
- åªèƒ½è¿›è¡Œè¯­éŸ³å¯¹è¯ï¼Œä¸è¦æå†™åŠ¨ä½œå’Œåœºæ™¯ï¼Œä¸è¦å‘å±•çº¿ä¸‹è§é¢çš„å‰§æƒ…
- ä¸“æ³¨äºè¯­è¨€äº¤æµï¼Œå›å¤è¦è‡ªç„¶æµç•…`;
                
                const systemPrompt = `ä½ æ˜¯${characterName}ï¼Œåˆšåˆšä¸»åŠ¨ç»™ç”¨æˆ·æ‰“äº†ä¸ª${isVideoCall ? 'è§†é¢‘' : 'è¯­éŸ³'}ç”µè¯ï¼Œç”¨æˆ·æ¥é€šäº†ã€‚${worldBookContent}

# ä½ çš„è§’è‰²è®¾å®šï¼š
${chat.settings.aiPersona}

# é‡è¦æƒ…å¢ƒè¯´æ˜ï¼š
- ä½ ä¸»åŠ¨ç»™ç”¨æˆ·æ‰“ç”µè¯ï¼Œç°åœ¨ç”µè¯åˆšæ¥é€š
- è¿™æ˜¯åŸºäºä½ ä»¬ä¹‹å‰èŠå¤©å†…å®¹çš„å»¶ç»­ï¼Œä¸æ˜¯å…¨æ–°çš„å¼€å§‹
- ä½ è¦åŸºäºä¹‹å‰çš„èŠå¤©å†å²ï¼Œè‡ªç„¶åœ°å¼€å§‹è¿™æ¬¡é€šè¯
- è¦è¯´ä¸€å¥åˆé€‚çš„å¼€åœºç™½ï¼Œè§£é‡Šä¸ºä»€ä¹ˆæ‰“ç”µè¯è¿‡æ¥

${sceneInstructions}

è¯·è¯´ä¸€å¥å¼€åœºç™½ï¼Œè¦ç®€çŸ­ä¸”ç¬¦åˆé€šè¯çš„èŠ‚å¥ã€‚`;
                
                // æ„å»ºæ¶ˆæ¯å†å²
                const messages = [
                    { role: 'system', content: systemPrompt }
                ];
                
                // æ·»åŠ æœ€è¿‘çš„èŠå¤©å†å²ä½œä¸ºèƒŒæ™¯
                recentHistory.forEach(msg => {
                    if (msg.role === 'user') {
                        messages.push({ role: 'user', content: `[èŠå¤©å†å²] ç”¨æˆ·è¯´ï¼š${msg.content}` });
                    } else if (msg.role === 'assistant') {
                        messages.push({ role: 'assistant', content: `[èŠå¤©å†å²] ${characterName}è¯´ï¼š${msg.content}` });
                    }
                });
                
                messages.push({ role: 'user', content: `[é€šè¯æ¥é€š] ç”¨æˆ·æ¥å¬äº†ä½ ä¸»åŠ¨æ‹¨æ‰“çš„ç”µè¯ï¼Œè¯·è¯´å¼€åœºç™½` });

                // ä½¿ç”¨ç»Ÿä¸€çš„APIè°ƒç”¨å‡½æ•°å¤„ç†Geminiå’Œå…¶ä»–API
                const aiResponse = await callUnifiedAPIForCall(proxyUrl, apiKey, model, messages);

                if (aiResponse) {
                    // æ¸…ç†AIå›åº”ä¸­çš„æ ¼å¼æ ‡è®°
                    let cleanResponse = aiResponse;

                    // ç§»é™¤[é€šè¯ä¸­]æ ‡è®°å’Œè§’è‰²åå‰ç¼€
                    cleanResponse = cleanResponse.replace(/^\[é€šè¯ä¸­\]\s*.*?è¯´ï¼š\s*/, '');
                    cleanResponse = cleanResponse.replace(/^\[é€šè¯ä¸­\]\s*/, '');

                    if (isVideoCall && cleanResponse.includes('<desc>')) {
                        // è§†é¢‘é€šè¯ï¼šåˆ†ç¦»å¯¹è¯å’Œæå†™éƒ¨åˆ†
                        const parts = cleanResponse.split('<desc>');
                        const dialogPart = parts[0].trim();
                        const descPart = parts[1] ? parts[1].replace('</desc>', '').trim() : '';

                        if (dialogPart) {
                            addCallMessage('assistant', dialogPart);
                        }
                        if (descPart) {
                            // ä½¿ç”¨CSSç±»è€Œä¸æ˜¯å†…è”æ ·å¼ï¼Œé¿å…æ ¼å¼ä»£ç æ˜¾ç¤º
                            addCallMessage('assistant', descPart, true);
                        }
                    } else {
                        // è¯­éŸ³é€šè¯æˆ–æ²¡æœ‰æå†™çš„è§†é¢‘é€šè¯
                        addCallMessage('assistant', cleanResponse);
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰è·å¾—å›åº”ï¼Œä¹Ÿè¦éšè—åŠ è½½æŒ‡ç¤ºå™¨
                    hideCallTypingIndicator();
                }
            } catch (error) {
                console.error('ç”ŸæˆAIé€šè¯å¼€åœºç™½å¤±è´¥:', error);
                // å‡ºé”™æ—¶éšè—åŠ è½½æŒ‡ç¤ºå™¨
                hideCallTypingIndicator();
            }
        }
        
        function declineIncomingCall() {
            document.getElementById('incoming-call-modal').classList.remove('visible');
            window.pendingCall = null;
        }
        
        // ç”ŸæˆAIå¯¹é€šè¯çŠ¶æ€çš„ååº”
        async function generateCallReaction(action, chatId = null, callType = null, callMessages = []) {
            // ä½¿ç”¨ä¼ å…¥çš„chatIdæˆ–å½“å‰æ´»è·ƒçš„chatId
            const targetChatId = chatId || state.activeChatId;
            if (!targetChatId) return;

            const chat = state.chats[targetChatId];
            if (!chat || chat.isGroup) return;

            // åªå¯¹è¢«æŒ‚æ–­åšå‡ºååº”
            if (action !== 'hungup') return;

            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) return;

            try {
                // è·å–ä¸Šä¸‹æ–‡è®°å¿†
                const maxMemory = parseInt(chat.settings.maxMemory) || 10;
                const recentHistory = getHistoryByRounds(chat.history, maxMemory);

                // è·å–ä¸–ç•Œä¹¦å†…å®¹
                let worldBookContent = '';
                if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                    const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                        return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
                    }).filter(Boolean).join('');
                    if (linkedContents) {
                        worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)\n${linkedContents}\n`;
                    }
                }

                // è·å–æœ¬æ¬¡é€šè¯çš„å†…å®¹æ€»ç»“
                const callSummary = callMessages.length > 0 ?
                    callMessages.map(msg => `${msg.role === 'user' ? 'ç”¨æˆ·' : chat.name}: ${msg.content}`).join('\n') :
                    'åˆšæ‰è¿›è¡Œäº†ä¸€æ¬¡ç®€çŸ­çš„é€šè¯';
                
                const systemPrompt = `ä½ æ˜¯${chat.name}ï¼Œä½ çš„äººè®¾ï¼š${chat.settings.aiPersona}${worldBookContent}

# é‡è¦æƒ…å¢ƒè¯´æ˜ï¼š
- ä½ åˆšåˆšå’Œç”¨æˆ·è¿›è¡Œäº†ä¸€æ¬¡${callType === 'video' ? 'è§†é¢‘' : 'è¯­éŸ³'}é€šè¯
- ç°åœ¨é€šè¯å·²ç»ç»“æŸ/è¢«æŒ‚æ–­äº†
- ä½ ä»¬ç°åœ¨å›åˆ°äº†æ­£å¸¸çš„æ‰‹æœºèŠå¤©æ¨¡å¼ï¼ˆå‘é€æ–‡å­—æ¶ˆæ¯ï¼‰
- è¿™ä¸å†æ˜¯é€šè¯ï¼Œè€Œæ˜¯æ™®é€šçš„èŠå¤©å¯¹è¯

# åˆšæ‰çš„é€šè¯å†…å®¹ï¼š
${callSummary}

# å½“å‰çŠ¶æ€ï¼š
- é€šè¯å·²ç»“æŸï¼Œç°åœ¨æ˜¯æ‰‹æœºèŠå¤©
- ä½ è¦é€šè¿‡æ–‡å­—æ¶ˆæ¯å¯¹åˆšæ‰çš„é€šè¯è¢«æŒ‚æ–­åšå‡ºååº”
- è¦æ„è¯†åˆ°ä½ ä»¬ç°åœ¨æ˜¯åœ¨å‘é€æ–‡å­—æ¶ˆæ¯ï¼Œä¸æ˜¯åœ¨é€šè¯

è¦æ±‚ï¼š
1. æ˜ç¡®æ„è¯†åˆ°é€šè¯å·²ç»ç»“æŸï¼Œç°åœ¨æ˜¯åœ¨å‘é€èŠå¤©æ¶ˆæ¯
2. åŸºäºåˆšæ‰çš„é€šè¯å†…å®¹å’Œä½ ä»¬çš„èŠå¤©å†å²åšå‡ºååº”
3. å›å¤è¦ç¬¦åˆä½ çš„äººè®¾å’Œæ€§æ ¼
4. å¯ä»¥è¡¨è¾¾ç†è§£ã€å…³å¿ƒã€å¤±è½ã€è°ƒä¾ƒç­‰æƒ…æ„Ÿ
5. å›å¤è¦ç®€çŸ­è‡ªç„¶ï¼ŒåƒçœŸå®çš„èŠå¤©æ¶ˆæ¯
6. ä½ çš„å›å¤å¿…é¡»æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼ï¼ŒåŒ…å«1-3æ¡æ¶ˆæ¯

JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:
["åˆšæ‰èŠå¾—å¾ˆå¼€å¿ƒå‘¢~", "ä¸‹æ¬¡å†èŠå§"]`;

                // æ„å»ºæ¶ˆæ¯å†å²ï¼ŒåŒ…å«æœ€è¿‘èŠå¤©è®°å½•
                const messages = [
                    { role: 'system', content: systemPrompt }
                ];
                
                // æ·»åŠ æœ€è¿‘çš„èŠå¤©å†å²ä½œä¸ºèƒŒæ™¯
                recentHistory.forEach(msg => {
                    if (msg.role === 'user') {
                        messages.push({ role: 'user', content: `[èŠå¤©å†å²] ç”¨æˆ·è¯´ï¼š${msg.content}` });
                    } else if (msg.role === 'assistant') {
                        messages.push({ role: 'assistant', content: `[èŠå¤©å†å²] ${chat.name}è¯´ï¼š${msg.content}` });
                    }
                });
                
                messages.push({ role: 'user', content: `é€šè¯åˆšåˆšè¢«æŒ‚æ–­äº†ï¼Œç°åœ¨å›åˆ°äº†æ‰‹æœºèŠå¤©æ¨¡å¼ï¼Œè¯·é€šè¿‡æ–‡å­—æ¶ˆæ¯åšå‡ºååº”` });

                // ä½¿ç”¨ç»Ÿä¸€çš„APIè°ƒç”¨å‡½æ•°å¤„ç†Geminiå’Œå…¶ä»–API
                const aiResponse = await callUnifiedAPIForCall(proxyUrl, apiKey, model, messages);
                
                if (aiResponse) {
                    const messagesArray = parseAiResponse(aiResponse);
                    
                    for (const msgData of messagesArray) {
                        const aiMessage = { 
                            role: 'assistant', 
                            content: String(msgData), 
                            timestamp: Date.now() 
                        };
                        
                        chat.history.push(aiMessage);
                        await db.chats.put(chat);
                        
                        // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¿™ä¸ªèŠå¤©ï¼Œæ·»åŠ æ¶ˆæ¯
                        if (state.activeChatId === targetChatId && document.getElementById('chat-interface-screen').classList.contains('active')) {
                            appendMessage(aiMessage, chat);
                        }
                        
                        // å»¶è¿Ÿä¸€ä¸‹å†å‘é€ä¸‹ä¸€æ¡
                        await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 500));
                    }
                    
                    renderChatList();
                }
            } catch (error) {
                console.error('ç”Ÿæˆé€šè¯ååº”å¤±è´¥:', error);
            }
        }


        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        let selectedTheme = '';
        
        window.selectThemeStyle = function(theme) {
            // ç§»é™¤æ‰€æœ‰é€‰é¡¹çš„activeç±»
            document.querySelectorAll('.theme-style-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // ä¸ºå½“å‰é€‰ä¸­é€‰é¡¹æ·»åŠ activeç±»
            document.querySelector(`.theme-style-option[data-theme="${theme}"]`).classList.add('active');
            
            // ä¿å­˜é€‰ä¸­çš„ä¸»é¢˜ä½†ä¸ç«‹å³åº”ç”¨
            selectedTheme = theme;
            
            // æ˜¾ç¤ºé¢„è§ˆæ•ˆæœ
            showToast(`å·²é€‰æ‹©${theme === 'simple' ? 'ç®€çº¦é£' : 'å¯çˆ±é£'}ä¸»é¢˜ï¼Œç‚¹å‡»"ç¡®è®¤åº”ç”¨ä¸»é¢˜"ç”Ÿæ•ˆ`, 'info');
        }
        
        // åº”ç”¨é€‰ä¸­çš„ä¸»é¢˜
        window.applySelectedTheme = function() {
            if (!selectedTheme) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¸»é¢˜', 'warning');
                return;
            }
            
            // åº”ç”¨ä¸»é¢˜
            document.body.setAttribute('data-theme', selectedTheme);
            
            // æ·»åŠ å¯çˆ±é£æ ·å¼ç±»
            if (selectedTheme === 'cute') {
                document.body.classList.add('cute-theme');
            } else {
                document.body.classList.remove('cute-theme');
            }
            
            // åˆ‡æ¢ç­‰å¾…å›å¤æŒ‰é’®çš„å›¾ç‰‡
            const waitReplyBtn = document.getElementById('wait-reply-btn');
            const waitReplyImg = waitReplyBtn ? waitReplyBtn.querySelector('img') : null;
            if (waitReplyImg) {
                if (selectedTheme === 'cute') {
                    waitReplyImg.src = 'https://i.postimg.cc/HxmLGLfk/IMG-5103.png';
                } else {
                    waitReplyImg.src = 'https://i.postimg.cc/qzdckrGy/image.png';
                }
            }
            
            // ä¿å­˜ä¸»é¢˜è®¾ç½®åˆ°Dexie
            db.userProfiles.put({
                id: 'theme_style',
                type: 'theme',
                data: selectedTheme,
                timestamp: Date.now()
            });
            
            // æ˜¾ç¤ºä¸»é¢˜åˆ‡æ¢æˆåŠŸæç¤º
            showToast(`å·²æˆåŠŸåº”ç”¨${selectedTheme === 'simple' ? 'ç®€çº¦é£' : 'å¯çˆ±é£'}ä¸»é¢˜`, 'success');
        }
        
        // åˆå§‹åŒ–ä¸»é¢˜
        async function initThemeStyle() {
            // ä»Dexieè·å–ä¿å­˜çš„ä¸»é¢˜
            const savedThemeData = await db.userProfiles.get('theme_style');
            const savedTheme = savedThemeData ? savedThemeData.data : 'simple';
            
            // åº”ç”¨ä¸»é¢˜
            document.body.setAttribute('data-theme', savedTheme);
            
            // æ·»åŠ å¯çˆ±é£æ ·å¼ç±»
            if (savedTheme === 'cute') {
                document.body.classList.add('cute-theme');
            } else {
                document.body.classList.remove('cute-theme');
            }
            
            // åˆ‡æ¢ç­‰å¾…å›å¤æŒ‰é’®çš„å›¾ç‰‡
            const waitReplyBtn = document.getElementById('wait-reply-btn');
            const waitReplyImg = waitReplyBtn ? waitReplyBtn.querySelector('img') : null;
            if (waitReplyImg) {
                if (savedTheme === 'cute') {
                    waitReplyImg.src = 'https://i.postimg.cc/HxmLGLfk/IMG-5103.png';
                } else {
                    waitReplyImg.src = 'https://i.postimg.cc/qzdckrGy/image.png';
                }
            }
            
            // æ ‡è®°å½“å‰é€‰ä¸­çš„ä¸»é¢˜é€‰é¡¹
            const activeOption = document.querySelector(`.theme-style-option[data-theme="${savedTheme}"]`);
            if (activeOption) {
                activeOption.classList.add('active');
            }
            
            // è®¾ç½®å½“å‰é€‰ä¸­çš„ä¸»é¢˜
            selectedTheme = savedTheme;
        }
        
        async function init() {
            await loadAllDataFromDB();
            
            // åˆå§‹åŒ–ä¸»é¢˜
            await initThemeStyle();
            
            // å°†å…³é”®å˜é‡æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.state = state;
            window.db = db;
            window.isWeiboSelectionMode = isWeiboSelectionMode;
            window.selectedWeiboPosts = selectedWeiboPosts;
            window.exitWeiboSelectionMode = exitWeiboSelectionMode;
            
            updateClock(); setInterval(updateClock, 1000 * 30);
            applyGlobalWallpaper();
            applyIconPosition();
            applyBorderlessMode();
            initBatteryManager();
            
            document.getElementById('back-to-list-btn').addEventListener('click', () => { exitSelectionMode(); state.activeChatId = null; showScreen('chat-list-screen'); });
            document.getElementById('add-chat-btn').addEventListener('click', async () => { const name = await showCustomPrompt('åˆ›å»ºæ–°èŠå¤©', 'è¯·è¾“å…¥Taçš„åå­—'); if (name && name.trim()) { const newChatId = 'chat_' + Date.now(); const newChat = { id: newChatId, name: name.trim(), isGroup: false, settings: { aiPersona: 'ä½ æ˜¯è°å‘€ã€‚', myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚', maxMemory: 10, aiAvatar: defaultAvatar, myAvatar: defaultAvatar, background: '', theme: 'default', linkedWorldBookIds: [], aiCallEnabled: true }, history: [], musicData: { totalTime: 0 } }; state.chats[newChatId] = newChat; await db.chats.put(newChat); renderChatList(); } });
            document.getElementById('add-group-chat-btn').addEventListener('click', async () => { const numStr = await showCustomPrompt('åˆ›å»ºç¾¤èŠ', 'è¯·è¾“å…¥ç¾¤æˆå‘˜æ•°é‡ (2-20)'); const num = parseInt(numStr); if (!num || num < 2 || num > 20) { alert('è¯·è¾“å…¥2åˆ°20ä¹‹é—´çš„æœ‰æ•ˆæ•°å­—ï¼'); return; } const name = await showCustomPrompt('è®¾ç½®ç¾¤å', 'è¯·è¾“å…¥ç¾¤èŠçš„åå­—'); if (name && name.trim()) { const newChatId = 'group_' + Date.now(); const members = []; for (let i = 1; i <= num; i++) members.push({ id: `member_${i}`, name: `æˆå‘˜${i}`, avatar: defaultGroupMemberAvatar, persona: 'ä¸€ä¸ªè·¯è¿‡çš„ç¾¤æˆå‘˜ã€‚' }); const newGroupChat = { id: newChatId, name: name.trim(), isGroup: true, members: members, settings: { myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚', myNickname: 'æˆ‘', maxMemory: 10, groupAvatar: defaultGroupAvatar, myAvatar: defaultMyGroupAvatar, background: '', theme: 'default', linkedWorldBookIds: [] }, history: [], musicData: { totalTime: 0 } }; state.chats[newChatId] = newGroupChat; await db.chats.put(newGroupChat); renderChatList(); } });
            
            document.getElementById('transfer-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.add('visible'));
        document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
        document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);
        
        // è½¬è´¦ç¡®è®¤å¯¹è¯æ¡†äº‹ä»¶
        document.getElementById('transfer-accept-btn').addEventListener('click', acceptTransfer);
        document.getElementById('transfer-reject-btn').addEventListener('click', rejectTransfer);
        document.getElementById('transfer-confirm-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('transfer-confirm-modal')) {
                document.getElementById('transfer-confirm-modal').classList.remove('visible');
                currentTransferMsg = null;
            }
        });

            document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
            document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
            document.getElementById('music-return-btn').addEventListener('click', returnToChat);
            document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('music-next-btn').addEventListener('click', playNext);
            document.getElementById('music-prev-btn').addEventListener('click', playPrev);
            document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
            document.getElementById('music-playlist-btn').addEventListener('click', () => { updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.add('visible'); });
            document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
            document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
            document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
            document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
            audioPlayer.addEventListener('ended', playNext);
            audioPlayer.addEventListener('pause', () => { if(musicState.isActive) { musicState.isPlaying = false; updatePlayerUI(); } });
            audioPlayer.addEventListener('play', () => { if(musicState.isActive) { musicState.isPlaying = true; updatePlayerUI(); } });
            
const chatInput = document.getElementById('chat-input');

// èŠå¤©è¾“å…¥æ¡†çš„ç®€åŒ–å¤„ç†
if (chatInput) {
    // è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶çš„ç®€å•å¤„ç†
    chatInput.addEventListener('blur', function() {
        console.log('èŠå¤©è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹');
        // åœ¨PWAæ¨¡å¼ä¸‹ï¼Œç®€å•é‡ç½®æ»šåŠ¨
        if (document.body.classList.contains('pwa-mode')) {
            setTimeout(() => {
                document.body.scrollTop = 0;
                document.documentElement.scrollTop = 0;
            }, 200);
        }
    });
}

// æ·»åŠ é‡æ–°ç”ŸæˆæŒ‰é’®ç›‘å¬å™¨
document.getElementById('regenerate-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    
    // æ‰¾åˆ°å¹¶åˆ é™¤æœ€åä¸€ç»„AIæ¶ˆæ¯
    for (let i = chat.history.length - 1; i >= 0; i--) {
        if (chat.history[i].role === 'assistant') {
            chat.history.splice(i, 1);
        } else {
            break;
        }
    }
    
    // ä¿å­˜æ›´æ–°åçš„èŠå¤©è®°å½•
    await db.chats.put(chat);
    
    // é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢
    renderChatInterface(state.activeChatId);
    
    // è§¦å‘æ–°çš„AIå›å¤
    triggerAiResponse();
});

            // é€šè¯åŠŸèƒ½äº‹ä»¶ç›‘å¬
            document.getElementById('call-btn').addEventListener('click', () => {
                if (!state.activeChatId) return;
                document.getElementById('call-type-modal').classList.add('visible');
            });
            
            document.getElementById('start-voice-call').addEventListener('click', () => {
                startCall('voice');
            });
            
            document.getElementById('start-video-call').addEventListener('click', () => {
                startCall('video');
            });
            
            document.getElementById('cancel-call').addEventListener('click', () => {
                document.getElementById('call-type-modal').classList.remove('visible');
            });
            
            document.getElementById('call-send-btn').addEventListener('click', sendCallMessage);
            document.getElementById('call-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendCallMessage();
                }
            });
            
            document.getElementById('call-hangup-btn').addEventListener('click', endCall);
            document.getElementById('answer-call').addEventListener('click', answerIncomingCall);
            document.getElementById('decline-call').addEventListener('click', declineIncomingCall);
            
            // æ¯30ç§’æ£€æŸ¥æ˜¯å¦è§¦å‘AIæ¥ç”µï¼ˆåŸºäºæœ€è¿‘å¯¹è¯å†…å®¹ï¼‰
            setInterval(() => {
                if (Object.keys(state.chats).length > 0) {
                    triggerAiCall();
                }
            }, 30000);

            document.getElementById('send-btn').addEventListener('click', async () => { const content = chatInput.value.trim(); if (!content || !state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); 
            
            // è°ƒæ•´AIå¿ƒç‡
            adjustHeartrateForMessage(content, true);
            
            chatInput.value = ''; chatInput.style.height = 'auto'; chatInput.focus(); });
            document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
                    chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
        chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });
        
        // @åŠŸèƒ½å®ç°
        let mentionDropdown = document.getElementById('mention-dropdown');
        let selectedMentionIndex = -1;
        let mentionStart = -1;
        let mentionQuery = '';
        
        function showMentionDropdown(members, query = '') {
            const filtered = members.filter(member => 
                member.name.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filtered.length === 0) {
                hideMentionDropdown();
                return;
            }
            
            mentionDropdown.innerHTML = filtered.map((member, index) => 
                `<div class="mention-item" data-index="${index}" data-name="${member.name}">
                    <img src="${member.avatar}" alt="${member.name}" class="mention-avatar">
                    <span class="mention-name">${member.name}</span>
                </div>`
            ).join('');
            
            selectedMentionIndex = -1;
            mentionDropdown.style.display = 'block';
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            mentionDropdown.querySelectorAll('.mention-item').forEach(item => {
                item.addEventListener('click', () => {
                    insertMention(item.dataset.name);
                });
            });
        }
        
        function hideMentionDropdown() {
            mentionDropdown.style.display = 'none';
            selectedMentionIndex = -1;
            mentionStart = -1;
            mentionQuery = '';
        }
        
        function insertMention(name) {
            const currentValue = chatInput.value;
            const beforeMention = currentValue.substring(0, mentionStart);
            const afterMention = currentValue.substring(chatInput.selectionStart);
            
            chatInput.value = beforeMention + `@${name} ` + afterMention;
            chatInput.focus();
            
            const newCursorPos = beforeMention.length + name.length + 2;
            chatInput.setSelectionRange(newCursorPos, newCursorPos);
            
            hideMentionDropdown();
        }
        
        function updateMentionSelection(direction) {
            const items = mentionDropdown.querySelectorAll('.mention-item');
            if (items.length === 0) return;
            
            // ç§»é™¤å½“å‰é€‰ä¸­çŠ¶æ€
            if (selectedMentionIndex >= 0) {
                items[selectedMentionIndex].classList.remove('selected');
            }
            
            // æ›´æ–°é€‰ä¸­ç´¢å¼•
            if (direction === 'down') {
                selectedMentionIndex = selectedMentionIndex < items.length - 1 ? selectedMentionIndex + 1 : 0;
            } else {
                selectedMentionIndex = selectedMentionIndex > 0 ? selectedMentionIndex - 1 : items.length - 1;
            }
            
            // æ·»åŠ æ–°çš„é€‰ä¸­çŠ¶æ€
            items[selectedMentionIndex].classList.add('selected');
            items[selectedMentionIndex].scrollIntoView({ block: 'nearest' });
        }
        
        // è¾“å…¥æ¡†@åŠŸèƒ½ç›‘å¬
        chatInput.addEventListener('input', (e) => {
            const chat = state.chats[state.activeChatId];
            if (!chat || !chat.isGroup) {
                hideMentionDropdown();
                return;
            }
            
            const cursorPos = chatInput.selectionStart;
            const textBeforeCursor = chatInput.value.substring(0, cursorPos);
            const atIndex = textBeforeCursor.lastIndexOf('@');
            
            if (atIndex === -1 || (atIndex > 0 && textBeforeCursor[atIndex - 1] !== ' ' && atIndex !== 0)) {
                hideMentionDropdown();
                return;
            }
            
            const queryAfterAt = textBeforeCursor.substring(atIndex + 1);
            if (queryAfterAt.includes(' ')) {
                hideMentionDropdown();
                return;
            }
            
            mentionStart = atIndex;
            mentionQuery = queryAfterAt;
            showMentionDropdown(chat.members, queryAfterAt);
        });
        
        // é”®ç›˜å¯¼èˆª
        chatInput.addEventListener('keydown', (e) => {
            if (mentionDropdown.style.display === 'none') return;
            
            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    updateMentionSelection('down');
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    updateMentionSelection('up');
                    break;
                case 'Enter':
                    if (selectedMentionIndex >= 0) {
                        e.preventDefault();
                        const selectedItem = mentionDropdown.querySelectorAll('.mention-item')[selectedMentionIndex];
                        insertMention(selectedItem.dataset.name);
                    }
                    break;
                case 'Escape':
                    hideMentionDropdown();
                    break;
            }
        });
        
        // ç‚¹å‡»è¾“å…¥æ¡†å¤–éƒ¨éšè—ä¸‹æ‹‰æ¡†
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#chat-input-container')) {
                hideMentionDropdown();
            }
        });
        

            document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if(file) {
                    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º10MBï¼‰
                    if (file.size > 10 * 1024 * 1024) {
                        alert('æ–‡ä»¶å¤ªå¤§ï¼è¯·é€‰æ‹©å°äº10MBçš„å›¾ç‰‡ã€‚');
                        return;
                    }

                    try {
                        const dataUrl = await new Promise((res, rej) => {
                            const reader = new FileReader();
                            reader.onload = () => res(reader.result);
                            reader.onerror = () => rej(reader.error);
                            reader.readAsDataURL(file);
                        });

                        // ä¿å­˜åˆ°Dexieæ•°æ®åº“è€Œä¸æ˜¯å†…å­˜
                        await db.wallpapers.put({
                            id: 'current_wallpaper',
                            type: 'custom',
                            data: dataUrl,
                            timestamp: Date.now()
                        });

                        newWallpaperBase64 = dataUrl;
                        await renderWallpaperScreen();
                    } catch (error) {
                        console.error('å£çº¸ä¸Šä¼ å¤±è´¥:', error);
                        alert('å£çº¸ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                    }
                }
            });
            document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {
                try {
                    // ä»Dexieè·å–å½“å‰å£çº¸
                    const wallpaperData = await db.wallpapers.get('current_wallpaper');
                    if (wallpaperData && wallpaperData.data) {
                        state.globalSettings.wallpaper = wallpaperData.data;
                        await db.globalSettings.put(state.globalSettings);
                        applyGlobalWallpaper();
                        newWallpaperBase64 = null;
                        alert('å£çº¸å·²ä¿å­˜å¹¶åº”ç”¨ï¼');
                        showScreen('home-screen');
                    } else {
                        alert('è¯·å…ˆä¸Šä¼ ä¸€å¼ æ–°å£çº¸ã€‚');
                    }
                } catch (error) {
                    console.error('å£çº¸ä¿å­˜å¤±è´¥:', error);
                    alert('å£çº¸ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                }
            });
            
            document.getElementById('save-icon-position-btn').addEventListener('click', async () => {
                const iconPosition = document.getElementById('icon-position').value;
                state.globalSettings.iconPosition = iconPosition;
                await db.globalSettings.put(state.globalSettings);
                applyIconPosition();
                showToast('å›¾æ ‡ä½ç½®å·²ä¿å­˜å¹¶åº”ç”¨ï¼', 'success');
            });
            
            // ä¿å­˜å­—å·è®¾ç½®
            document.getElementById('save-font-size-btn').addEventListener('click', async () => {
                const fontSize = document.getElementById('font-size-select').value;
                state.globalSettings.fontSize = fontSize;
                await db.globalSettings.put(state.globalSettings);
                applyFontSize();
                showToast('å­—å·è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨ï¼', 'success');
            });

            // æ— è¾¹æ¡†æ¨¡å¼å¼€å…³äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('borderless-mode-toggle').addEventListener('change', async (event) => {
                const borderlessMode = event.target.checked;
                state.globalSettings.borderlessMode = borderlessMode;
                await db.globalSettings.put(state.globalSettings);
                applyBorderlessMode();
                showToast(borderlessMode ? 'æ— è¾¹æ¡†æ¨¡å¼å·²å¼€å¯ï¼' : 'æ— è¾¹æ¡†æ¨¡å¼å·²å…³é—­ï¼', 'success');
            });

            // è‡ªå®šä¹‰æ ·å¼äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('apply-custom-styles-btn').addEventListener('click', async () => {
                const customCSS = document.getElementById('custom-bubble-css').value;
                const customFontUrl = document.getElementById('custom-font-url').value.trim();

                state.globalSettings.customBubbleCSS = customCSS;
                state.globalSettings.customFontUrl = customFontUrl;

                await db.globalSettings.put(state.globalSettings);

                // å…ˆæ¸…é™¤ç°æœ‰æ ·å¼
                const existingFont = document.getElementById('custom-font-link');
                const existingFallback = document.getElementById('custom-font-fallback');
                if (existingFont) existingFont.remove();
                if (existingFallback) existingFallback.remove();

                // åº”ç”¨æ–°æ ·å¼
                applyCustomStyles();

                // å¼ºåˆ¶åˆ·æ–°é¡µé¢å­—ä½“
                setTimeout(() => {
                    document.body.style.fontFamily = '';
                    document.body.offsetHeight; // å¼ºåˆ¶é‡æ’
                    if (customFontUrl) {
                        if (customFontUrl.toLowerCase().endsWith('.ttf') || customFontUrl.toLowerCase().endsWith('.otf') || customFontUrl.toLowerCase().endsWith('.woff') || customFontUrl.toLowerCase().endsWith('.woff2')) {
                            // TTFå­—ä½“å·²ç»åœ¨applyCustomStylesä¸­å¤„ç†
                        } else {
                            // CSSå­—ä½“éœ€è¦é¢å¤–å¤„ç†
                            document.body.style.fontFamily = 'inherit';
                        }
                    }
                }, 1000);

                showToast('è‡ªå®šä¹‰å­—ä½“å’Œæ ·å¼å·²ä¿å­˜å¹¶åº”ç”¨ï¼', 'success');
            });

            document.getElementById('reset-custom-styles-btn').addEventListener('click', async () => {
                const confirmed = await showCustomConfirm('é‡ç½®æ ·å¼', 'ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤å­—ä½“å’Œæ ·å¼å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    state.globalSettings.customBubbleCSS = '';
                    state.globalSettings.customFontUrl = '';

                    await db.globalSettings.put(state.globalSettings);
                    applyCustomStyles();

                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('custom-bubble-css').value = '';
                    document.getElementById('custom-font-url').value = '';

                    showToast('å­—ä½“å’Œæ ·å¼å·²é‡ç½®ä¸ºé»˜è®¤ï¼', 'success');
                }
            });

            document.getElementById('preview-custom-styles-btn').addEventListener('click', () => {
                previewCustomStyles();
            });


            
            // è‡ªå®šä¹‰å›¾æ ‡äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('reset-all-icons-btn').addEventListener('click', async () => {
                const confirmed = await showCustomConfirm('é‡ç½®å›¾æ ‡', 'ç¡®å®šè¦å°†æ‰€æœ‰å›¾æ ‡é‡ç½®ä¸ºé»˜è®¤å›¾æ ‡å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    state.globalSettings.customIcons = {};
                    await db.globalSettings.put(state.globalSettings);
                    applyCustomIcons();
                    renderCustomIconsGrid();
                    showToast('æ‰€æœ‰å›¾æ ‡å·²é‡ç½®ä¸ºé»˜è®¤ï¼', 'success');
                }
            });
            
            // è‡ªå®šä¹‰å›¾æ ‡å¼¹çª—äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('use-url-btn').addEventListener('click', () => {
                const urlGroup = document.getElementById('url-input-group');
                urlGroup.style.display = urlGroup.style.display === 'none' ? 'block' : 'none';
            });
            
            document.getElementById('preview-url-btn').addEventListener('click', () => {
                const url = document.getElementById('icon-url-input').value.trim();
                if (!url) {
                    showToast('è¯·è¾“å…¥å›¾ç‰‡URL', 'error');
                    return;
                }
                
                const newPreview = document.getElementById('new-icon-preview');
                const noPreviewText = document.getElementById('no-preview-text');
                
                // æµ‹è¯•å›¾ç‰‡æ˜¯å¦èƒ½åŠ è½½
                const testImg = new Image();
                testImg.onload = () => {
                    newPreview.src = url;
                    newPreview.style.display = 'block';
                    noPreviewText.style.display = 'none';
                    currentIconPreview = url;
                    showToast('URLå›¾ç‰‡é¢„è§ˆæˆåŠŸï¼', 'success');
                };
                testImg.onerror = () => {
                    showToast('æ— æ³•åŠ è½½è¯¥URLçš„å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥é“¾æ¥', 'error');
                };
                testImg.src = url;
            });
            
            document.getElementById('icon-file-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const newPreview = document.getElementById('new-icon-preview');
                    const noPreviewText = document.getElementById('no-preview-text');
                    
                    newPreview.src = e.target.result;
                    newPreview.style.display = 'block';
                    noPreviewText.style.display = 'none';
                    currentIconPreview = e.target.result;
                    
                    // æ¸…ç©ºURLè¾“å…¥æ¡†
                    document.getElementById('icon-url-input').value = '';
                    document.getElementById('url-input-group').style.display = 'none';
                };
                reader.readAsDataURL(file);
                event.target.value = null;
            });
            
            document.getElementById('cancel-icon-btn').addEventListener('click', () => {
                document.getElementById('custom-icon-modal').classList.remove('visible');
                currentEditingIcon = null;
                currentIconPreview = null;
            });
            
            document.getElementById('save-icon-btn').addEventListener('click', async () => {
                if (!currentEditingIcon || !currentIconPreview) {
                    showToast('è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡', 'error');
                    return;
                }
                
                // åˆå§‹åŒ–customIconså¯¹è±¡ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                if (!state.globalSettings.customIcons) {
                    state.globalSettings.customIcons = {};
                }
                
                // ä¿å­˜è‡ªå®šä¹‰å›¾æ ‡
                state.globalSettings.customIcons[currentEditingIcon.id] = currentIconPreview;
                await db.globalSettings.put(state.globalSettings);
                
                // åº”ç”¨å›¾æ ‡æ›´æ”¹
                applyCustomIcons();
                renderCustomIconsGrid();
                
                // ä¿å­˜å›¾æ ‡åç§°ç”¨äºæç¤º
                const iconName = currentEditingIcon.name;
                
                // å…³é—­å¼¹çª—
                document.getElementById('custom-icon-modal').classList.remove('visible');
                currentEditingIcon = null;
                currentIconPreview = null;
                
                showToast(`${iconName}å›¾æ ‡å·²æ›´æ–°ï¼`, 'success');
            });
            document.getElementById('save-api-settings-btn').addEventListener('click', async () => { state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim(); state.apiConfig.apiKey = document.getElementById('api-key').value.trim(); state.apiConfig.model = document.getElementById('model-select').value; await db.apiConfig.put(state.apiConfig); alert('APIè®¾ç½®å·²ä¿å­˜!'); });
            
            // Geminiç›´è¿è®¾ç½®æŒ‰é’®
            document.getElementById('set-gemini-direct-btn').addEventListener('click', () => {
                document.getElementById('proxy-url').value = 'https://generativelanguage.googleapis.com/v1beta';
                showToast('å·²è®¾ç½®Geminiç›´è¿åœ°å€ï¼Œè¯·å¡«å†™Google AI Studioçš„API Key', 'success');
            });
            document.getElementById('fetch-models-btn').addEventListener('click', async () => { 
                const url = document.getElementById('proxy-url').value.trim(); 
                const key = document.getElementById('api-key').value.trim(); 
                if (!url || !key) return alert('è¯·å…ˆå¡«å†™åä»£åœ°å€å’Œå¯†é’¥'); 
                
                try { 
                    const isGemini = url.includes('generativelanguage.googleapis.com');
                    let apiUrl;
                    let headers;
                    
                    if (isGemini) {
                        // Gemini API
                        apiUrl = `${url}/models?key=${key}`;
                        headers = {};
                    } else {
                        // OpenAI compatible API
                        apiUrl = `${url}/v1/models`;
                        headers = { 'Authorization': `Bearer ${key}` };
                    }
                    
                    const response = await fetch(apiUrl, { headers }); 
                    if (!response.ok) throw new Error('æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨'); 
                    const data = await response.json(); 
                    const modelSelect = document.getElementById('model-select'); 
                    modelSelect.innerHTML = ''; 
                    
                    let models;
                    if (isGemini) {
                        // Gemini API è¿”å›çš„æ˜¯ { models: [...] }
                        models = data.models || [];
                    } else {
                        // OpenAI API è¿”å›çš„æ˜¯ { data: [...] }
                        models = data.data || [];
                    }
                    
                    if (models.length === 0) {
                        alert('æœªæ‰¾åˆ°ä»»ä½•å¯ç”¨æ¨¡å‹');
                        return;
                    }
                    
                    models.forEach(model => { 
                        const option = document.createElement('option'); 
                        // Gemini models æœ‰ name å±æ€§ï¼ŒOpenAI models æœ‰ id å±æ€§
                        const modelId = model.name || model.id;
                        // å¯¹äº Geminiï¼Œæå–å®é™…çš„æ¨¡å‹åï¼ˆå»æ‰ models/ å‰ç¼€ï¼‰
                        const displayName = isGemini ? modelId.replace('models/', '') : modelId;
                        option.value = displayName; 
                        option.textContent = displayName; 
                        if(displayName === state.apiConfig.model) option.selected = true; 
                        modelSelect.appendChild(option); 
                    }); 
                    alert(`æ¨¡å‹åˆ—è¡¨å·²æ›´æ–°ï¼Œæ‰¾åˆ° ${models.length} ä¸ªæ¨¡å‹`); 
                } catch (error) { 
                    if (error.message.includes('CORS')) {
                        alert('ç”±äºæµè§ˆå™¨è·¨åŸŸé™åˆ¶ï¼Œæ— æ³•ç›´æ¥è·å–Geminiæ¨¡å‹åˆ—è¡¨ã€‚è¯·æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åï¼Œå¦‚ï¼šgemini-1.5-flashã€gemini-1.5-pro ç­‰');
                        // ä¸ºGeminiæ·»åŠ å¸¸ç”¨æ¨¡å‹
                        if (url.includes('generativelanguage.googleapis.com')) {
                            const modelSelect = document.getElementById('model-select');
                            modelSelect.innerHTML = '';
                            const commonGeminiModels = [
                                'gemini-1.5-flash',
                                'gemini-1.5-pro',
                                'gemini-1.0-pro'
                            ];
                            commonGeminiModels.forEach(modelName => {
                                const option = document.createElement('option');
                                option.value = modelName;
                                option.textContent = modelName;
                                if(modelName === state.apiConfig.model) option.selected = true;
                                modelSelect.appendChild(option);
                            });
                        }
                    } else {
                        alert(`æ‹‰å–æ¨¡å‹å¤±è´¥: ${error.message}`); 
                    }
                } 
            });
            document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('åˆ›å»ºä¸–ç•Œä¹¦', 'è¯·è¾“å…¥ä¹¦å'); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
            
            
            document.getElementById('save-world-book-btn').addEventListener('click', async () => { if (!editingWorldBookId) return; const book = state.worldBooks.find(wb => wb.id === editingWorldBookId); if (book) { const newName = document.getElementById('world-book-name-input').value.trim(); if (!newName) { alert('ä¹¦åä¸èƒ½ä¸ºç©ºï¼'); return; } book.name = newName; book.content = document.getElementById('world-book-content-input').value; await db.worldBooks.put(book); document.getElementById('world-book-editor-title').textContent = newName; editingWorldBookId = null; renderWorldBookScreen(); showScreen('world-book-screen'); } });
            
            document.getElementById('chat-messages').addEventListener('click', (e) => { 
                // å¤„ç†ç”¨æˆ·å‘é€çš„å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
                const userImage = e.target.closest('.message-bubble.user .chat-image');
                if (userImage) {
                    showImageViewer(userImage.src);
                    return;
                }
                
                const aiImage = e.target.closest('.ai-generated-image'); 
                if (aiImage) { 
                    const description = aiImage.dataset.description; 
                    if (description) showCustomAlert('ç…§ç‰‡æè¿°', description); 
                    return; 
                } 
                
                const voiceMessage = e.target.closest('.voice-message-body'); 
                if (voiceMessage) { 
                    const voiceContainer = voiceMessage.closest('.voice-message-container'); 
                    if (voiceContainer) { 
                        const textContent = voiceContainer.querySelector('.voice-text-content'); 
                        if (textContent) { 
                            textContent.classList.toggle('visible'); 
                        } 
                    } 
                    return; 
                } 
            });
            
            const chatSettingsModal = document.getElementById('chat-settings-modal');
            const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
            const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
            
                // è®°å¿†æŒ‚è½½ç›¸å…³å…ƒç´ 
    const memoryMountSelectBox = document.querySelector('#memory-mount-multiselect .select-box');
    const memoryMountCheckboxesContainer = document.getElementById('memory-mount-checkboxes-container');
    
    // æ™ºèƒ½è®°å¿†å…±äº«ç›¸å…³å…ƒç´ 
    const memorySharingSelectBox = document.querySelector('#memory-sharing-multiselect .select-box');
    const memorySharingCheckboxesContainer = document.getElementById('memory-sharing-checkboxes-container');
            
            function updateWorldBookSelectionDisplay() { const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked'); const displayText = document.querySelector('.selected-options-text'); if (checkedBoxes.length === 0) { displayText.textContent = '-- ç‚¹å‡»é€‰æ‹© --'; } else if (checkedBoxes.length > 2) { displayText.textContent = `å·²é€‰æ‹© ${checkedBoxes.length} é¡¹`; } else { displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); } }
            
            function updateMemoryMountSelectionDisplay() { 
                const checkedBoxes = memoryMountCheckboxesContainer.querySelectorAll('input:checked'); 
                const displayText = memoryMountSelectBox.querySelector('.selected-options-text'); 
                if (checkedBoxes.length === 0) { 
                    displayText.textContent = '-- ç‚¹å‡»é€‰æ‹© --'; 
                } else if (checkedBoxes.length > 2) { 
                    displayText.textContent = `å·²é€‰æ‹© ${checkedBoxes.length} ä¸ªèŠå¤©`; 
                } else { 
                    displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); 
                } 
            }
            
            function updateMemorySharingSelectionDisplay() { 
                const checkedBoxes = memorySharingCheckboxesContainer.querySelectorAll('input:checked'); 
                const displayText = memorySharingSelectBox.querySelector('.selected-options-text'); 
                if (checkedBoxes.length === 0) { 
                    displayText.textContent = '-- ç‚¹å‡»é€‰æ‹© --'; 
                } else if (checkedBoxes.length > 2) { 
                    displayText.textContent = `å·²é€‰æ‹© ${checkedBoxes.length} ä¸ªèŠå¤©`; 
                } else { 
                    displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); 
                } 
            }
            
            worldBookSelectBox.addEventListener('click', (e) => { e.stopPropagation(); worldBookCheckboxesContainer.classList.toggle('visible'); worldBookSelectBox.classList.toggle('expanded'); });
            worldBookCheckboxesContainer.addEventListener('change', updateWorldBookSelectionDisplay);
            
            memoryMountSelectBox.addEventListener('click', (e) => { e.stopPropagation(); memoryMountCheckboxesContainer.classList.toggle('visible'); memoryMountSelectBox.classList.toggle('expanded'); });
            memoryMountCheckboxesContainer.addEventListener('change', updateMemoryMountSelectionDisplay);
            
            memorySharingSelectBox.addEventListener('click', (e) => { e.stopPropagation(); memorySharingCheckboxesContainer.classList.toggle('visible'); memorySharingSelectBox.classList.toggle('expanded'); });
            memorySharingCheckboxesContainer.addEventListener('change', updateMemorySharingSelectionDisplay);
            
            window.addEventListener('click', (e) => { 
                if (!document.querySelector('.custom-multiselect').contains(e.target)) { 
                    worldBookCheckboxesContainer.classList.remove('visible'); 
                    worldBookSelectBox.classList.remove('expanded'); 
                }
                if (!document.querySelector('#memory-mount-multiselect').contains(e.target)) {
                    memoryMountCheckboxesContainer.classList.remove('visible');
                    memoryMountSelectBox.classList.remove('expanded');
                }
                if (!document.querySelector('#memory-sharing-multiselect').contains(e.target)) {
                    memorySharingCheckboxesContainer.classList.remove('visible');
                    memorySharingSelectBox.classList.remove('expanded');
                }
            });
            document.getElementById('chat-settings-btn').addEventListener('click', () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const isGroup = chat.isGroup; document.getElementById('chat-name-group').style.display = 'block'; document.getElementById('chat-name-input').value = chat.name; document.getElementById('my-persona-group').style.display = 'block'; document.getElementById('my-persona').value = chat.settings.myPersona; document.getElementById('my-avatar-group').style.display = 'block'; document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar); 
            
            // åŠ è½½æˆ³ä¸€æˆ³åç¼€è®¾ç½®
            document.getElementById('my-poke-suffix').value = chat.settings.myPokeSuffix || '';
            document.getElementById('ai-poke-suffix').value = chat.settings.aiPokeSuffix || '';
            
            // è®¾ç½®æˆ³ä¸€æˆ³åç¼€ç»„çš„æ˜¾éšï¼ˆç¾¤èŠå’Œç§èŠéƒ½æ˜¾ç¤ºï¼‰
            document.getElementById('poke-suffix-group').style.display = 'block';
            document.getElementById('ai-poke-suffix-group').style.display = isGroup ? 'none' : 'block';
            
            document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none'; document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none'; document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none'; document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block'; document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block'; 
            
            // èŠå¤©æ¨¡å¼è®¾ç½®å¯¹æ‰€æœ‰èŠå¤©ç±»å‹éƒ½å¯ç”¨ï¼ŒåŒ…æ‹¬ç¾¤èŠ
            document.getElementById('chat-mode-group').style.display = 'block'; const container = document.getElementById('posting-times-container');
    container.innerHTML = '';

    const addButton = document.createElement('button');
    addButton.type = 'button';
    addButton.className = 'add-time-btn';
    addButton.textContent = '+ æ·»åŠ æ—¶é—´ç‚¹';
    container.appendChild(addButton); // åŠ è½½å¾®åšè®¾ç½®
    document.getElementById('weibo-enabled').checked = chat.settings.weiboEnabled || false;
    document.getElementById('weibo-frequency').value = chat.settings.weiboFrequency || 'low';

    addButton.addEventListener('click', () => {
        const timeInputGroup = document.createElement('div');
        timeInputGroup.className = 'time-input-group';
        timeInputGroup.innerHTML = `
            <input type="time" class="posting-time-input">
            <button type="button" class="remove-time-btn">Ã—</button>
        `;
        container.insertBefore(timeInputGroup, addButton);
        
        timeInputGroup.querySelector('.remove-time-btn').addEventListener('click', () => {
            timeInputGroup.remove();
        });
    });

    // åŠ è½½åå°äº’åŠ¨è®¾ç½®
    document.getElementById('background-interaction-enabled').checked = chat.settings.backgroundInteractionEnabled || false;
    document.getElementById('background-chat-frequency').value = chat.settings.backgroundChatFrequency || 'low';
    document.getElementById('background-weibo-frequency').value = chat.settings.backgroundWeiboFrequency || 'low';
    document.getElementById('background-chat-enabled').checked = chat.settings.backgroundChatEnabled !== false; // é»˜è®¤å¼€å¯
    document.getElementById('background-weibo-enabled').checked = chat.settings.backgroundWeiboEnabled !== false; // é»˜è®¤å¼€å¯

                // åŠ è½½æ—¶é—´æç¤ºè¯è®¾ç½®
            document.getElementById('time-awareness-enabled').checked = chat.settings.timeAwarenessEnabled !== false; // é»˜è®¤å¼€å¯
            
            // åŠ è½½AIä¸»åŠ¨æ‹¨æ‰“ç”µè¯è®¾ç½®
            document.getElementById('ai-call-enabled').checked = chat.settings.aiCallEnabled !== false; // é»˜è®¤å¼€å¯
            
            // åŠ è½½AIå¿ƒç‡ç›‘æµ‹è®¾ç½®
            document.getElementById('ai-heartrate-enabled').checked = chat.settings.aiHeartrateEnabled || false;

            // åŠ è½½AIçŠ¶æ€æ°”æ³¡è®¾ç½®
            document.getElementById('ai-status-bubble-enabled').checked = chat.settings.aiStatusBubbleEnabled || false;
            document.getElementById('status-update-frequency').value = chat.settings.statusUpdateFrequency || '5';

            // çŠ¶æ€æ°”æ³¡è®¾ç½®çš„æ˜¾ç¤º/éšè—é€»è¾‘
            const statusBubbleCheckbox = document.getElementById('ai-status-bubble-enabled');
            const statusBubbleSettings = document.getElementById('status-bubble-settings');

            function toggleStatusBubbleSettings() {
                statusBubbleSettings.style.display = statusBubbleCheckbox.checked ? 'block' : 'none';
            }

            statusBubbleCheckbox.addEventListener('change', toggleStatusBubbleSettings);
            toggleStatusBubbleSettings(); // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
            
            // åŠ è½½å¹¶å‘èŠå¤©è®¾ç½®
            document.getElementById('concurrent-chat-enabled').checked = chat.settings.concurrentChatEnabled !== false; // é»˜è®¤å¼€å¯
            
            // åŠ è½½èŠå¤©æ¨¡å¼è®¾ç½®
            const chatMode = chat.settings.chatMode || 'online'; // é»˜è®¤ä¸ºçº¿ä¸Šæ¨¡å¼
            if (chatMode === 'online') {
                document.getElementById('chat-mode-online').checked = true;
            } else {
                document.getElementById('chat-mode-offline').checked = true;
            }
            
            // åŠ è½½çº¿ä¸‹æ¨¡å¼å­—æ•°é™åˆ¶è®¾ç½®
            document.getElementById('offline-mode-min-length').value = chat.settings.offlineModeMinLength || 50;
            document.getElementById('offline-mode-max-length').value = chat.settings.offlineModeMaxLength || 100;
            
            // æ§åˆ¶å­—æ•°é™åˆ¶è¾“å…¥æ¡†çš„æ˜¾ç¤º/éšè—
            function toggleOfflineLengthControl() {
                const offlineLengthControl = document.getElementById('offline-length-control');
                const isOfflineMode = document.getElementById('chat-mode-offline').checked;
                offlineLengthControl.style.display = isOfflineMode ? 'flex' : 'none';
            }
            
            // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
            toggleOfflineLengthControl();
            
            // æ·»åŠ æ¨¡å¼åˆ‡æ¢äº‹ä»¶ç›‘å¬
            document.getElementById('chat-mode-online').addEventListener('change', toggleOfflineLengthControl);
            document.getElementById('chat-mode-offline').addEventListener('change', toggleOfflineLengthControl);

            // æ·»åŠ å­—æ•°èŒƒå›´éªŒè¯
            function validateLengthRange() {
                const minInput = document.getElementById('offline-mode-min-length');
                const maxInput = document.getElementById('offline-mode-max-length');
                const minValue = parseInt(minInput.value);
                const maxValue = parseInt(maxInput.value);

                if (minValue >= maxValue) {
                    // å¦‚æœæœ€å°å€¼å¤§äºç­‰äºæœ€å¤§å€¼ï¼Œè‡ªåŠ¨è°ƒæ•´
                    if (minInput === document.activeElement) {
                        // å¦‚æœæ­£åœ¨ç¼–è¾‘æœ€å°å€¼ï¼Œè°ƒæ•´æœ€å¤§å€¼
                        maxInput.value = minValue + 20;
                    } else {
                        // å¦‚æœæ­£åœ¨ç¼–è¾‘æœ€å¤§å€¼ï¼Œè°ƒæ•´æœ€å°å€¼
                        minInput.value = Math.max(20, maxValue - 20);
                    }
                }
            }

            document.getElementById('offline-mode-min-length').addEventListener('input', validateLengthRange);
            document.getElementById('offline-mode-max-length').addEventListener('input', validateLengthRange);

    // æ˜¾ç¤º/éšè—è®¾ç½®é€‰é¡¹
    const weiboFrequencySettings = document.getElementById('weibo-frequency-settings');
    const backgroundInteractionSettings = document.getElementById('background-interaction-frequency-settings');
    
    weiboFrequencySettings.style.display = chat.settings.weiboEnabled ? 'block' : 'none';
    backgroundInteractionSettings.style.display = chat.settings.backgroundInteractionEnabled ? 'block' : 'none';

    // å¾®åšå¯ç”¨çŠ¶æ€å˜åŒ–ç›‘å¬
    document.getElementById('weibo-enabled').addEventListener('change', function() {
        weiboFrequencySettings.style.display = this.checked ? 'block' : 'none';
    });

    // åå°äº’åŠ¨å¯ç”¨çŠ¶æ€å˜åŒ–ç›‘å¬
    document.getElementById('background-interaction-enabled').addEventListener('change', function() {
        backgroundInteractionSettings.style.display = this.checked ? 'block' : 'none';
    });

    addButton.addEventListener('click', () => {
        const timeInputGroup = document.createElement('div');
        timeInputGroup.className = 'time-input-group';
        timeInputGroup.innerHTML = `
            <input type="time" class="posting-time-input">
            <button type="button" class="remove-time-btn">Ã—</button>
        `;
        container.insertBefore(timeInputGroup, addButton);
        
        timeInputGroup.querySelector('.remove-time-btn').addEventListener('click', () => {
            timeInputGroup.remove();
        });
    });

    if (chat.settings.weiboPostingTimes && chat.settings.weiboPostingTimes.length > 0) {
        chat.settings.weiboPostingTimes.forEach(time => {
            const timeInputGroup = document.createElement('div');
            timeInputGroup.className = 'time-input-group';
            timeInputGroup.innerHTML = `
                <input type="time" class="posting-time-input" value="${time}">
                <button type="button" class="remove-time-btn">Ã—</button>
            `;
            container.insertBefore(timeInputGroup, addButton);
            
            timeInputGroup.querySelector('.remove-time-btn').addEventListener('click', () => {
                timeInputGroup.remove();
            });
        });
    }worldBookCheckboxesContainer.innerHTML = ''; const linkedIds = chat.settings.linkedWorldBookIds || []; if (state.worldBooks.length === 0) { worldBookCheckboxesContainer.innerHTML = '<p style="color: #888; text-align: center; margin: 10px 0;">æ²¡æœ‰å¯ç”¨çš„ä¸–ç•Œä¹¦</p>'; } else { state.worldBooks.forEach(book => { const isChecked = linkedIds.includes(book.id); const label = document.createElement('label'); label.innerHTML = `<input type="checkbox" value="${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}`; worldBookCheckboxesContainer.appendChild(label); }); } updateWorldBookSelectionDisplay();
    
    // åˆå§‹åŒ–è®°å¿†æŒ‚è½½è®¾ç½®
    document.getElementById('memory-mount-enabled').checked = chat.settings.memoryMountEnabled || false;
    document.getElementById('memory-mount-count').value = chat.settings.memoryMountCount || 10;
    
    // æ˜¾ç¤º/éšè—è®°å¿†æŒ‚è½½è®¾ç½®
    const memoryMountSettings = document.getElementById('memory-mount-settings');
    memoryMountSettings.style.display = chat.settings.memoryMountEnabled ? 'block' : 'none';
    
    // è®°å¿†æŒ‚è½½å¯ç”¨çŠ¶æ€å˜åŒ–ç›‘å¬
    document.getElementById('memory-mount-enabled').addEventListener('change', function() {
        memoryMountSettings.style.display = this.checked ? 'block' : 'none';
    });
    
    // å¡«å……å¯æŒ‚è½½çš„èŠå¤©åˆ—è¡¨
    memoryMountCheckboxesContainer.innerHTML = '';
    const mountedChatIds = chat.settings.memoryMountChatIds || [];
    const availableChats = Object.values(state.chats).filter(c => c.id !== state.activeChatId);
    
    if (availableChats.length === 0) {
        memoryMountCheckboxesContainer.innerHTML = '<p style="color: #888; text-align: center; margin: 10px 0;">æ²¡æœ‰å…¶ä»–å¯ç”¨çš„èŠå¤©</p>';
    } else {
        availableChats.forEach(otherChat => {
            const isChecked = mountedChatIds.includes(otherChat.id);
            const chatType = otherChat.isGroup ? '[ç¾¤èŠ]' : '[ç§èŠ]';
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="${otherChat.id}" ${isChecked ? 'checked' : ''}> ${chatType} ${otherChat.name}`;
            memoryMountCheckboxesContainer.appendChild(label);
        });
    }
    updateMemoryMountSelectionDisplay();
    
    // åˆå§‹åŒ–æ™ºèƒ½è®°å¿†å…±äº«è®¾ç½®
    document.getElementById('memory-sharing-enabled').checked = chat.settings.memorySharing?.enabled || false;
    document.getElementById('share-mood').checked = chat.settings.memorySharing?.categories?.mood !== false;
    document.getElementById('share-events').checked = chat.settings.memorySharing?.categories?.events !== false;
    document.getElementById('share-interests').checked = chat.settings.memorySharing?.categories?.interests !== false;
    document.getElementById('share-plans').checked = chat.settings.memorySharing?.categories?.plans !== false;
    document.getElementById('sharing-threshold').value = chat.settings.memorySharing?.threshold || 0.6;
    document.getElementById('threshold-value').textContent = chat.settings.memorySharing?.threshold || 0.6;
    
    // æ˜¾ç¤º/éšè—æ™ºèƒ½è®°å¿†å…±äº«è®¾ç½®
    const memorySharingSettings = document.getElementById('memory-sharing-settings');
    memorySharingSettings.style.display = chat.settings.memorySharing?.enabled ? 'block' : 'none';
    
    // æ™ºèƒ½è®°å¿†å…±äº«å¯ç”¨çŠ¶æ€å˜åŒ–ç›‘å¬
    document.getElementById('memory-sharing-enabled').addEventListener('change', function() {
        memorySharingSettings.style.display = this.checked ? 'block' : 'none';
    });
    
    // é˜ˆå€¼æ»‘å—å˜åŒ–ç›‘å¬
    document.getElementById('sharing-threshold').addEventListener('input', function() {
        document.getElementById('threshold-value').textContent = this.value;
    });
    
    // å¡«å……å¯å…±äº«çš„èŠå¤©åˆ—è¡¨
    const memorySharingCheckboxesContainer = document.getElementById('memory-sharing-checkboxes-container');
    const memorySharingSelectBox = document.querySelector('#memory-sharing-multiselect .select-box');
    
    memorySharingCheckboxesContainer.innerHTML = '';
    const sharedChatIds = chat.settings.memorySharing?.chatIds || [];
    const availableChatsForSharing = Object.values(state.chats).filter(c => c.id !== state.activeChatId);
    
    if (availableChatsForSharing.length === 0) {
        memorySharingCheckboxesContainer.innerHTML = '<p style="color: #888; text-align: center; margin: 10px 0;">æ²¡æœ‰å…¶ä»–å¯ç”¨çš„èŠå¤©</p>';
    } else {
        availableChatsForSharing.forEach(otherChat => {
            const isChecked = sharedChatIds.includes(otherChat.id);
            const chatType = otherChat.isGroup ? '[ç¾¤èŠ]' : '[ç§èŠ]';
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="${otherChat.id}" ${isChecked ? 'checked' : ''}> ${chatType} ${otherChat.name}`;
            memorySharingCheckboxesContainer.appendChild(label);
        });
    }
    updateMemorySharingSelectionDisplay(); const bgPreview = document.getElementById('bg-preview'); const removeBgBtn = document.getElementById('remove-bg-btn'); if (chat.settings.background) { bgPreview.src = chat.settings.background; bgPreview.style.display = 'block'; removeBgBtn.style.display = 'inline-block'; } else { bgPreview.style.display = 'none'; removeBgBtn.style.display = 'none'; } if (isGroup) { document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || ''; document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar; renderGroupMemberSettings(chat.members); } else { document.getElementById('ai-persona').value = chat.settings.aiPersona; document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar; } document.getElementById('max-memory').value = chat.settings.maxMemory; const currentTheme = chat.settings.theme || 'default'; const themeRadio = document.querySelector(`input[name="theme-select"][value="${currentTheme}"]`); if (themeRadio) themeRadio.checked = true; chatSettingsModal.classList.add('visible'); });
            function renderGroupMemberSettings(members) { 
                const container = document.getElementById('group-members-settings'); 
                container.innerHTML = ''; 
                
                // æ·»åŠ ç°æœ‰æˆå‘˜
                members.forEach(member => { 
                    const div = document.createElement('div'); 
                    div.className = 'member-editor'; 
                    div.dataset.memberId = member.id; 
                    div.innerHTML = `<img src="${member.avatar}" alt="${member.name}"><div class="member-name">${member.name}</div>`; 
                    div.addEventListener('click', () => openMemberEditor(member.id)); 
                    container.appendChild(div); 
                }); 
                
                // æ·»åŠ é‚€è¯·æŒ‰é’®
                const addBtn = document.createElement('div');
                addBtn.className = 'member-action-btn';
                addBtn.id = 'add-group-member-btn';
                addBtn.innerHTML = `<div class="btn-avatar">+</div><div class="btn-label">é‚€è¯·</div>`;
                container.appendChild(addBtn);
                
                // æ·»åŠ ç§»é™¤æŒ‰é’®
                const removeBtn = document.createElement('div');
                removeBtn.className = 'member-action-btn';
                removeBtn.id = 'remove-group-member-btn';
                removeBtn.innerHTML = `<div class="btn-avatar">-</div><div class="btn-label">ç§»é™¤</div>`;
                container.appendChild(removeBtn);
            }
            function openMemberEditor(memberId) { editingMemberId = memberId; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === memberId); document.getElementById('member-name-input').value = member.name; document.getElementById('member-persona-input').value = member.persona; document.getElementById('member-avatar-preview').src = member.avatar; document.getElementById('member-settings-modal').classList.add('visible'); }
            document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
            document.getElementById('save-member-settings-btn').addEventListener('click', () => { if (!editingMemberId) return; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === editingMemberId); member.name = document.getElementById('member-name-input').value; member.persona = document.getElementById('member-persona-input').value; member.avatar = document.getElementById('member-avatar-preview').src; renderGroupMemberSettings(chat.members); document.getElementById('member-settings-modal').classList.remove('visible'); });
            
            // æ·»åŠ ç¾¤æˆå‘˜ç®¡ç†åŠŸèƒ½ - ä½¿ç”¨äº‹ä»¶å§”æ‰˜
            document.addEventListener('click', async (e) => {
                if (e.target.closest('#add-group-member-btn')) {
                    if (!state.activeChatId) return;
                    const chat = state.chats[state.activeChatId];
                    if (!chat.isGroup) return;
                    
                    const memberName = await showCustomPrompt('æ·»åŠ ç¾¤æˆå‘˜', 'è¯·è¾“å…¥æ–°æˆå‘˜çš„åå­—');
                    if (memberName && memberName.trim()) {
                        const newMember = {
                            id: `member_${Date.now()}`,
                            name: memberName.trim(),
                            avatar: defaultGroupMemberAvatar,
                            persona: 'ä¸€ä¸ªæ–°åŠ å…¥çš„ç¾¤æˆå‘˜ã€‚'
                        };
                        chat.members.push(newMember);
                        await db.chats.put(chat);
                        renderGroupMemberSettings(chat.members);
                        showToast(`${memberName} å·²åŠ å…¥ç¾¤èŠï¼`, 'success');
                    }
                }
                
                if (e.target.closest('#remove-group-member-btn')) {
                    if (!state.activeChatId) return;
                    const chat = state.chats[state.activeChatId];
                    if (!chat.isGroup || chat.members.length <= 2) {
                        showToast('ç¾¤èŠè‡³å°‘éœ€è¦ä¿ç•™2åæˆå‘˜', 'error');
                        return;
                    }
                    
                    // åˆ›å»ºæˆå‘˜é€‰æ‹©åˆ—è¡¨ï¼ŒåŒ…å«å¤´åƒ
                    const memberOptions = chat.members.map(member => 
                        `<label style="display: flex; align-items: center; margin: 8px 0; cursor: pointer; padding: 8px; border-radius: 8px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'">
                            <input type="radio" name="member-select" value="${member.id}" style="margin-right: 12px;">
                            <img src="${member.avatar}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 12px;">
                            <span style="font-size: 14px; color: #333;">${member.name}</span>
                        </label>`
                    ).join('');
                    
                    const modalBodyContent = `
                        <p style="margin-bottom: 15px; color: #333;">è¯·é€‰æ‹©è¦ç§»é™¤çš„æˆå‘˜ï¼š</p>
                        <div style="max-height: 250px; overflow-y: auto; padding: 5px 0;">
                            ${memberOptions}
                        </div>
                    `;
                    
                    modalTitle.textContent = 'ç§»é™¤ç¾¤æˆå‘˜';
                    modalBody.innerHTML = modalBodyContent;
                    modalCancelBtn.style.display = 'block';
                    modalConfirmBtn.textContent = 'ç¡®å®šç§»é™¤';
                    modalConfirmBtn.classList.add('btn-danger');
                    
                    modalConfirmBtn.onclick = async () => {
                        const selectedRadio = document.querySelector('input[name="member-select"]:checked');
                        if (!selectedRadio) {
                            showToast('è¯·é€‰æ‹©è¦ç§»é™¤çš„æˆå‘˜', 'error');
                            return;
                        }
                        
                        const memberId = selectedRadio.value;
                        const memberIndex = chat.members.findIndex(m => m.id === memberId);
                        if (memberIndex !== -1) {
                            const removedMember = chat.members[memberIndex];
                            chat.members.splice(memberIndex, 1);
                            await db.chats.put(chat);
                            renderGroupMemberSettings(chat.members);
                            showToast(`${removedMember.name} å·²ç¦»å¼€ç¾¤èŠ`, 'success');
                        }
                        hideCustomModal();
                    };
                    
                    showCustomModal();
                }
            });
            
            document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
            document.getElementById('cancel-chat-settings-btn').addEventListener('click', () => { chatSettingsModal.classList.remove('visible'); });
            document.getElementById('save-chat-settings-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const newName = document.getElementById('chat-name-input').value.trim(); if (!newName) return alert('å¤‡æ³¨å/ç¾¤åä¸èƒ½ä¸ºç©ºï¼'); chat.name = newName; const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked'); chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default'; chat.settings.myPersona = document.getElementById('my-persona').value; chat.settings.myAvatar = document.getElementById('my-avatar-preview').src; 
            
            // ä¿å­˜æˆ³ä¸€æˆ³åç¼€
            chat.settings.myPokeSuffix = document.getElementById('my-poke-suffix').value.trim();
            chat.settings.aiPokeSuffix = document.getElementById('ai-poke-suffix').value.trim();
            
            const checkedBooks = document.querySelectorAll('#world-book-checkboxes-container input[type="checkbox"]:checked'); chat.settings.linkedWorldBookIds = Array.from(checkedBooks).map(cb => cb.value); if (chat.isGroup) { chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim(); chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src; } else { chat.settings.aiPersona = document.getElementById('ai-persona').value; chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src; } chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10; // ä¿å­˜å¾®åšè®¾ç½®
            chat.settings.weiboEnabled = document.getElementById('weibo-enabled').checked;
            chat.settings.weiboFrequency = document.getElementById('weibo-frequency').value;

            // ä¿å­˜å‘å¸ƒæ—¶é—´ç‚¹
            const timeInputs = document.querySelectorAll('.posting-time-input');
            chat.settings.weiboPostingTimes = Array.from(timeInputs).map(input => input.value).filter(Boolean);
            
            // ä¿å­˜åå°äº’åŠ¨è®¾ç½®
            chat.settings.backgroundInteractionEnabled = document.getElementById('background-interaction-enabled').checked;
            chat.settings.backgroundChatFrequency = document.getElementById('background-chat-frequency').value;
            chat.settings.backgroundWeiboFrequency = document.getElementById('background-weibo-frequency').value;
            chat.settings.backgroundChatEnabled = document.getElementById('background-chat-enabled').checked;
            chat.settings.backgroundWeiboEnabled = document.getElementById('background-weibo-enabled').checked;
            // ä¿å­˜æ—¶é—´æç¤ºè¯è®¾ç½®
            chat.settings.timeAwarenessEnabled = document.getElementById('time-awareness-enabled').checked;
            // ä¿å­˜AIä¸»åŠ¨æ‹¨æ‰“ç”µè¯è®¾ç½®
            chat.settings.aiCallEnabled = document.getElementById('ai-call-enabled').checked;
            // ä¿å­˜AIå¿ƒç‡ç›‘æµ‹è®¾ç½®
            chat.settings.aiHeartrateEnabled = document.getElementById('ai-heartrate-enabled').checked;

            // ä¿å­˜AIçŠ¶æ€æ°”æ³¡è®¾ç½®
            chat.settings.aiStatusBubbleEnabled = document.getElementById('ai-status-bubble-enabled').checked;
            chat.settings.statusUpdateFrequency = parseInt(document.getElementById('status-update-frequency').value) || 5;
            
            // ä¿å­˜å¹¶å‘èŠå¤©è®¾ç½®
            chat.settings.concurrentChatEnabled = document.getElementById('concurrent-chat-enabled').checked;
            
            // ä¿å­˜èŠå¤©æ¨¡å¼è®¾ç½®
            const selectedChatMode = document.querySelector('input[name="chat-mode"]:checked');
            chat.settings.chatMode = selectedChatMode ? selectedChatMode.value : 'online';
            
            // ä¿å­˜çº¿ä¸‹æ¨¡å¼å­—æ•°é™åˆ¶è®¾ç½®
            const offlineModeMinLength = parseInt(document.getElementById('offline-mode-min-length').value);
            const offlineModeMaxLength = parseInt(document.getElementById('offline-mode-max-length').value);
            chat.settings.offlineModeMinLength = Math.max(20, Math.min(800, offlineModeMinLength || 50));
            chat.settings.offlineModeMaxLength = Math.max(50, Math.min(1000, offlineModeMaxLength || 100));

            // ç¡®ä¿æœ€å°å€¼ä¸å¤§äºæœ€å¤§å€¼
            if (chat.settings.offlineModeMinLength > chat.settings.offlineModeMaxLength) {
                chat.settings.offlineModeMinLength = chat.settings.offlineModeMaxLength - 20;
            }
            
            // ä¿å­˜è®°å¿†æŒ‚è½½è®¾ç½®
            chat.settings.memoryMountEnabled = document.getElementById('memory-mount-enabled').checked;
            chat.settings.memoryMountCount = parseInt(document.getElementById('memory-mount-count').value) || 10;
            const checkedMemoryChats = document.querySelectorAll('#memory-mount-checkboxes-container input[type="checkbox"]:checked');
            chat.settings.memoryMountChatIds = Array.from(checkedMemoryChats).map(cb => cb.value);
            
            // ä¿å­˜æ™ºèƒ½è®°å¿†å…±äº«è®¾ç½®
            chat.settings.memorySharing = {
                enabled: document.getElementById('memory-sharing-enabled').checked,
                chatIds: Array.from(document.querySelectorAll('#memory-sharing-checkboxes-container input[type="checkbox"]:checked')).map(cb => cb.value),
                categories: {
                    mood: document.getElementById('share-mood').checked,
                    events: document.getElementById('share-events').checked,
                    interests: document.getElementById('share-interests').checked,
                    plans: document.getElementById('share-plans').checked
                },
                threshold: parseFloat(document.getElementById('sharing-threshold').value) || 0.6
            };
            
            await db.chats.put(chat);
            chatSettingsModal.classList.remove('visible'); renderChatInterface(state.activeChatId); renderChatList(); 
            
            // é‡æ–°åˆå§‹åŒ–AIè‡ªåŠ¨å‘å¸ƒç³»ç»Ÿ
            await initAiPostingSystem();
            
            // é‡æ–°åˆå§‹åŒ–åå°äº’åŠ¨ç³»ç»Ÿ
            initBackgroundInteractionSystem();
        });
            document.getElementById('clear-chat-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const confirmed = await showCustomConfirm('æ¸…ç©ºèŠå¤©è®°å½•', 'æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ­¤èŠå¤©çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œæ— æ³•æ¢å¤ã€‚ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' }); if (confirmed) { chat.history = []; await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); chatSettingsModal.classList.remove('visible'); } });
            const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
            setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
            setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
            setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
            setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
            setupFileUpload('bg-input', (base64) => { if(state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
            setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
            document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });

            const stickerPanel = document.getElementById('sticker-panel');
            document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { renderStickerPanel(); stickerPanel.classList.add('visible'); });
            document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));
            document.getElementById('add-sticker-btn').addEventListener('click', async () => { const url = await showCustomPrompt("æ·»åŠ è¡¨æƒ…(URL)", "è¯·è¾“å…¥è¡¨æƒ…åŒ…çš„å›¾ç‰‡URL"); if (!url || !url.trim().startsWith('http')) return url && alert("è¯·è¾“å…¥æœ‰æ•ˆçš„URL (ä»¥httpå¼€å¤´)"); const name = await showCustomPrompt("å‘½åè¡¨æƒ…", "è¯·ä¸ºè¿™ä¸ªè¡¨æƒ…å‘½å (ä¾‹å¦‚ï¼šå¼€å¿ƒã€ç–‘æƒ‘)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: url.trim(), name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("è¡¨æƒ…åä¸èƒ½ä¸ºç©ºï¼"); });
            document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());
            document.getElementById('sticker-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = async () => { const base64Url = reader.result; const name = await showCustomPrompt("å‘½åè¡¨æƒ…", "è¯·ä¸ºè¿™ä¸ªè¡¨æƒ…å‘½å (ä¾‹å¦‚ï¼šå¥½è€¶ã€ç–‘æƒ‘)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: base64Url, name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("è¡¨æƒ…åä¸èƒ½ä¸ºç©ºï¼"); }; event.target.value = null; });
            document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
            document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const reader = new FileReader(); reader.onload = async (e) => { const base64Url = e.target.result; 
                // è®°å½•ç”¨æˆ·æœ€è¿‘ä¸Šä¼ çš„å›¾ç‰‡
                recentUserUploadedImage = base64Url;
                
                const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); }; reader.readAsDataURL(file); event.target.value = null; });
            document.getElementById('voice-message-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const text = await showCustomPrompt("å‘é€è¯­éŸ³", "è¯·è¾“å…¥ä½ æƒ³è¯´çš„å†…å®¹ï¼š"); if (text && text.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'voice_message', content: text.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            
            document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("å‘é€ç…§ç‰‡", "è¯·ç”¨æ–‡å­—æè¿°æ‚¨è¦å‘é€çš„ç…§ç‰‡ï¼š"); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            
            // Persona Preset Event Listeners
            document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
            document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
            document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
            document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
            document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);
            document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
            document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
            document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);


            // Selection Event Listeners
            document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);
            document.getElementById('selection-delete-btn').addEventListener('click', async () => { if (selectedMessages.size === 0) return; const confirmed = await showCustomConfirm('åˆ é™¤æ¶ˆæ¯', `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedMessages.size} æ¡æ¶ˆæ¯å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { const chat = state.chats[state.activeChatId]; chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp)); await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); } });
            
            // å¾®åšç›¸å…³äº‹ä»¶ç›‘å¬
            document.getElementById('post-weibo-btn').addEventListener('click', () => {
                document.getElementById('post-weibo-modal').classList.add('visible');
            });

            // å¾®åšå›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
            document.getElementById('add-weibo-photo').addEventListener('click', () => {
                document.getElementById('weibo-image-input').click();
            });

            document.getElementById('weibo-image-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('weibo-preview-img').src = e.target.result;
                    document.getElementById('weibo-image-preview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            });

            document.getElementById('remove-weibo-image').addEventListener('click', () => {
                document.getElementById('weibo-image-preview').style.display = 'none';
                document.getElementById('weibo-image-input').value = '';
            });

            document.querySelector('#post-weibo-modal .cancel').addEventListener('click', () => {
                document.getElementById('post-weibo-modal').classList.remove('visible');
                document.getElementById('weibo-content').value = '';
            });

            document.querySelector('#post-weibo-modal .save').addEventListener('click', async () => {
                const content = document.getElementById('weibo-content').value.trim();
                const visibility = document.getElementById('post-visibility').value;
                
                if (!content) {
                    showToast('è¯·è¾“å…¥å†…å®¹', 'error');
                    return;
                }
                
                // ç¦ç”¨å‘å¸ƒæŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
                const saveBtn = document.querySelector('#post-weibo-modal .save');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'å‘å¸ƒä¸­...';
                saveBtn.disabled = true;
                
                try {
                    // è·å–å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
                    const imagePreview = document.getElementById('weibo-image-preview');
                    const imageUrl = imagePreview.style.display !== 'none' ? 
                        document.getElementById('weibo-preview-img').src : null;
                    
                    const success = await publishPost(content, visibility, imageUrl);
                    if (success) {
                        document.getElementById('post-weibo-modal').classList.remove('visible');
                        document.getElementById('weibo-content').value = '';
                        document.getElementById('weibo-image-preview').style.display = 'none';
                        document.getElementById('weibo-image-input').value = '';
                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        showToast('å‘å¸ƒæˆåŠŸï¼', 'success');
                    } else {
                        showToast('å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
                    }
                } catch (error) {
                    console.error('å‘å¸ƒå¾®åšå¤±è´¥:', error);
                    showToast('å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                }
            });

            // å¾®åšä¸»é¢˜è®¾ç½®äº‹ä»¶ç›‘å¬
            document.getElementById('weibo-theme-btn').addEventListener('click', async () => {
                // æ˜¾ç¤ºä¸»é¢˜è®¾ç½®å¼¹çª—
                document.getElementById('weibo-theme-modal').classList.add('visible');

                // ä»æ•°æ®åº“åŠ è½½ä¿å­˜çš„å¾®åšè®¾ç½®
                let weiboSettings = null;
                try {
                    weiboSettings = await db.weiboSettings.get('main');
                } catch (error) {
                    console.log('åŠ è½½å¾®åšè®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®');
                }

                // åˆå§‹åŒ–é€æ˜åº¦æ»‘å—çš„å€¼
                const savedOpacity = weiboSettings?.cardOpacity || 1.0;
                const opacitySlider = document.getElementById('card-opacity-slider');
                const opacityValue = document.getElementById('card-opacity-value');
                opacitySlider.value = savedOpacity;
                opacityValue.textContent = savedOpacity;

                // æ¢å¤ä¿å­˜çš„ä¸»é¢˜é€‰æ‹©
                const savedTheme = weiboSettings?.theme || 'white';
                document.querySelectorAll('#weibo-theme-modal .theme-dot').forEach(dot => {
                    dot.classList.remove('active');
                });
                const savedThemeDot = document.querySelector(`#weibo-theme-modal .theme-dot[data-theme="${savedTheme}"]`);
                if (savedThemeDot) {
                    savedThemeDot.classList.add('active');
                }

                // æ¢å¤ä¿å­˜çš„èƒŒæ™¯å›¾ç‰‡é¢„è§ˆ
                const savedBackground = weiboSettings?.backgroundImage;
                const bgPreview = document.getElementById('weibo-bg-preview');
                if (savedBackground) {
                    bgPreview.style.backgroundImage = `url(${savedBackground})`;
                    bgPreview.textContent = '';
                    document.getElementById('remove-weibo-bg-btn').style.display = 'inline-block';
                } else {
                    bgPreview.style.backgroundImage = 'none';
                    bgPreview.textContent = 'ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡';
                    document.getElementById('remove-weibo-bg-btn').style.display = 'none';
                }
            });

            document.querySelector('#weibo-theme-modal .cancel').addEventListener('click', () => {
                document.getElementById('weibo-theme-modal').classList.remove('visible');
            });

            document.querySelector('#weibo-theme-modal .save').addEventListener('click', async () => {
                // åº”ç”¨ä¸»é¢˜è®¾ç½®
                const activeTheme = document.querySelector('#weibo-theme-modal .theme-dot.active');
                let theme = 'white';
                if (activeTheme) {
                    theme = activeTheme.dataset.theme;
                    document.body.setAttribute('data-weibo-theme', theme);
                }

                // åº”ç”¨èƒŒæ™¯è®¾ç½®
                const bgPreview = document.getElementById('weibo-bg-preview');
                const bgImage = bgPreview.style.backgroundImage;
                let backgroundImage = null;
                if (bgImage && bgImage !== 'none') {
                    document.getElementById('weibo-screen').style.backgroundImage = bgImage;
                    document.getElementById('weibo-screen').style.backgroundSize = 'cover';
                    document.getElementById('weibo-screen').style.backgroundPosition = 'center';
                    backgroundImage = bgImage.slice(5, -2); // ç§»é™¤ url("...") åŒ…è£…
                } else {
                    document.getElementById('weibo-screen').style.backgroundImage = 'none';
                }

                // åº”ç”¨åŠ¨æ€å¡ç‰‡é€æ˜åº¦è®¾ç½®
                const opacity = document.getElementById('card-opacity-slider').value;
                applyWeiboCardOpacity(opacity);

                // ä¿å­˜æ‰€æœ‰è®¾ç½®åˆ°Dexieæ•°æ®åº“
                const weiboSettings = {
                    id: 'main',
                    theme: theme,
                    backgroundImage: backgroundImage,
                    cardOpacity: opacity
                };

                try {
                    await db.weiboSettings.put(weiboSettings);
                    showToast('å¾®åšä¸»é¢˜è®¾ç½®å·²ä¿å­˜ï¼', 'success');
                } catch (error) {
                    console.error('ä¿å­˜å¾®åšè®¾ç½®å¤±è´¥:', error);
                    showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }

                document.getElementById('weibo-theme-modal').classList.remove('visible');
            });

            // å¾®åšèƒŒæ™¯ä¸Šä¼ 
            document.getElementById('weibo-bg-upload-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const bgPreview = document.getElementById('weibo-bg-preview');
                    bgPreview.style.backgroundImage = `url(${e.target.result})`;
                    bgPreview.textContent = '';
                    document.getElementById('remove-weibo-bg-btn').style.display = 'inline-block';
                };
                reader.readAsDataURL(file);
            });

            document.getElementById('remove-weibo-bg-btn').addEventListener('click', () => {
                const bgPreview = document.getElementById('weibo-bg-preview');
                bgPreview.style.backgroundImage = 'none';
                bgPreview.textContent = 'ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡';
                document.getElementById('remove-weibo-bg-btn').style.display = 'none';
                // æ¸…é™¤æ–‡ä»¶è¾“å…¥
                document.getElementById('weibo-bg-upload-input').value = '';
            });

            // ç”¨æˆ·èµ„æ–™å¡äº‹ä»¶ç›‘å¬
            document.querySelector('#weibo-profile-modal .cancel').addEventListener('click', () => {
                document.getElementById('weibo-profile-modal').classList.remove('visible');

                // é‡ç½®æ–‡ä»¶è¾“å…¥
                document.getElementById('user-profile-bg-input').value = '';
            });

            document.querySelector('#weibo-profile-modal .save').addEventListener('click', async () => {
                const name = document.getElementById('profile-name-input').value.trim();
                const signature = document.getElementById('profile-signature-input').value.trim();
                const email = document.getElementById('profile-email-input').value.trim();
                const avatar = document.getElementById('profile-avatar-preview').src;
                
                // è·å–ç¤¾äº¤ä¸»é¡µèƒŒæ™¯
                const bgPreview = document.getElementById('user-profile-bg-preview');
                const socialBackground = bgPreview.style.backgroundImage ? 
                    bgPreview.style.backgroundImage.slice(5, -2) : null; // ç§»é™¤ url("...") åŒ…è£…
                
                if (!name) {
                    showToast('è¯·è¾“å…¥æ˜µç§°', 'error');
                    return;
                }
                
                // ä¿å­˜ç”¨æˆ·èµ„æ–™
                const profile = {
                    name,
                    signature,
                    email,
                    avatar,
                    socialBackground
                };
                await db.userProfiles.put({
                    id: 'weibo_user_profile',
                    type: 'weibo_profile',
                    data: profile,
                    timestamp: Date.now()
                });

                // æ›´æ–°ç¼“å­˜
                userProfileCache = profile;
                
                document.getElementById('weibo-profile-modal').classList.remove('visible');
                showToast('èµ„æ–™ä¿å­˜æˆåŠŸï¼', 'success');
                
                // é‡æ–°æ¸²æŸ“æ—¶é—´çº¿ä»¥æ›´æ–°æ˜¾ç¤º
                if (window.renderWeiboTimelineProxy) {
                    window.renderWeiboTimelineProxy();
                }
            });

            // ç”¨æˆ·å¤´åƒä¸Šä¼ 
            document.getElementById('profile-avatar-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('profile-avatar-preview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            });

            // ç”¨æˆ·ç¤¾äº¤ä¸»é¡µèƒŒæ™¯ä¸Šä¼ 
            document.getElementById('user-profile-bg-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('user-profile-bg-preview');
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    preview.textContent = '';
                    document.getElementById('remove-user-profile-bg-btn').style.display = 'block';
                };
                reader.readAsDataURL(file);
            });

            // ç§»é™¤ç”¨æˆ·ç¤¾äº¤ä¸»é¡µèƒŒæ™¯
            document.getElementById('remove-user-profile-bg-btn').addEventListener('click', () => {
                const preview = document.getElementById('user-profile-bg-preview');
                preview.style.backgroundImage = '';
                preview.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                preview.textContent = 'é»˜è®¤æ¸å˜èƒŒæ™¯';
                document.getElementById('remove-user-profile-bg-btn').style.display = 'none';
                document.getElementById('user-profile-bg-input').value = '';
            });

            // AIèµ„æ–™å¡äº‹ä»¶ç›‘å¬
            document.querySelector('#ai-profile-modal .cancel').addEventListener('click', () => {
                document.getElementById('ai-profile-modal').classList.remove('visible');

                // é‡ç½®æ–‡ä»¶è¾“å…¥
                document.getElementById('ai-profile-bg-input').value = '';
            });

            document.querySelector('#ai-profile-modal .save').addEventListener('click', async () => {
                if (!window.state || !window.db) {
                    showToast('ç³»ç»Ÿæœªåˆå§‹åŒ–', 'error');
                    return;
                }
                
                const aiId = document.getElementById('ai-profile-modal').dataset.aiId;
                if (!aiId || !window.state.chats[aiId]) {
                    showToast('AIä¿¡æ¯ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                const chat = window.state.chats[aiId];
                const name = document.getElementById('ai-profile-name-input').value.trim();
                const signature = document.getElementById('ai-profile-signature-input').value.trim();
                const persona = document.getElementById('ai-profile-persona-input').value.trim();
                const avatar = document.getElementById('ai-profile-avatar-preview').src;
                
                if (!name) {
                    showToast('è¯·è¾“å…¥æ˜µç§°', 'error');
                    return;
                }
                
                // è·å–ç¤¾äº¤ä¸»é¡µèƒŒæ™¯
                const bgPreview = document.getElementById('ai-profile-bg-preview');
                const socialBackground = bgPreview.style.backgroundImage ? 
                    bgPreview.style.backgroundImage.slice(5, -2) : null; // ç§»é™¤ url("...") åŒ…è£…
                
                // æ›´æ–°AIèµ„æ–™
                chat.name = name;
                chat.settings.aiAvatar = avatar;
                chat.settings.aiSignature = signature;
                chat.settings.aiPersona = persona;
                chat.settings.socialBackground = socialBackground;
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                await window.db.chats.put(chat);
                
                document.getElementById('ai-profile-modal').classList.remove('visible');
                showToast('AIèµ„æ–™ä¿å­˜æˆåŠŸï¼', 'success');
                
                // é‡æ–°æ¸²æŸ“æ—¶é—´çº¿ä»¥æ›´æ–°æ˜¾ç¤º
                if (window.renderWeiboTimelineProxy) {
                    window.renderWeiboTimelineProxy();
                }
            });

            // AIå¤´åƒä¸Šä¼ 
            document.getElementById('ai-profile-avatar-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('ai-profile-avatar-preview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            });

            // AIç¤¾äº¤ä¸»é¡µèƒŒæ™¯ä¸Šä¼ 
            document.getElementById('ai-profile-bg-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('ai-profile-bg-preview');
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    preview.textContent = '';
                    document.getElementById('remove-ai-profile-bg-btn').style.display = 'block';
                };
                reader.readAsDataURL(file);
            });

            // ç§»é™¤AIç¤¾äº¤ä¸»é¡µèƒŒæ™¯
            document.getElementById('remove-ai-profile-bg-btn').addEventListener('click', () => {
                const preview = document.getElementById('ai-profile-bg-preview');
                preview.style.backgroundImage = '';
                preview.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                preview.textContent = 'é»˜è®¤æ¸å˜èƒŒæ™¯';
                document.getElementById('remove-ai-profile-bg-btn').style.display = 'none';
                document.getElementById('ai-profile-bg-input').value = '';
            });

            // å¾®åšå¯¼èˆªåˆ‡æ¢
            document.querySelectorAll('.weibo-nav .nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // å¦‚æœæ­£åœ¨é€‰æ‹©æ¨¡å¼ï¼Œå…ˆé€€å‡º
                    if (isWeiboSelectionMode) {
                        exitWeiboSelectionMode();
                    }
                    
                    document.querySelectorAll('.weibo-nav .nav-item').forEach(i => 
                        i.classList.remove('active'));
                    e.target.classList.add('active');
                    renderWeiboTimeline(e.target.textContent === 'â‚^Ë¶ â•¸ğ–¥¦  â•¸Ëµ^â‚âŸ†' ? 'mine' : 'all');
                });
            });

            // å¾®åšå¤šé€‰å·¥å…·æ äº‹ä»¶ç›‘å¬
            document.getElementById('weibo-selection-cancel').addEventListener('click', () => {
                exitWeiboSelectionMode();
            });

            document.getElementById('weibo-selection-delete').addEventListener('click', () => {
                deleteSelectedWeiboPosts();
            });

            document.getElementById('weibo-enabled').addEventListener('change', function() {
                const frequencySettings = document.getElementById('weibo-frequency-settings');
                frequencySettings.style.display = this.checked ? 'block' : 'none';
            });

            // æµ‹è¯•AIå‘å¸ƒæŒ‰é’®
            document.getElementById('test-ai-posting-btn').addEventListener('click', async () => {
                if (!state.activeChatId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©å¯¹è±¡');
                    return;
                }
                
                const chat = state.chats[state.activeChatId];
                if (!chat.settings.weiboEnabled) {
                    alert('è¯·å…ˆå¯ç”¨å¾®åšåŠŸèƒ½');
                    return;
                }
                
                // æ£€æŸ¥APIé…ç½®
                const { proxyUrl, apiKey, model } = state.apiConfig;
                if (!proxyUrl || !apiKey || !model) {
                    alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å®Œæ•´çš„åä»£åœ°å€ã€å¯†é’¥å’Œæ¨¡å‹');
                    return;
                }
                
                // æ£€æŸ¥è§’è‰²è®¾å®š
                if (!chat.settings.aiPersona || chat.settings.aiPersona.trim() === '') {
                    alert('è¯·å…ˆè®¾ç½®AIè§’è‰²çš„äººè®¾ï¼Œè¿™æ ·AIæ‰èƒ½ç”Ÿæˆç¬¦åˆè§’è‰²çš„åŠ¨æ€å†…å®¹');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const testBtn = document.getElementById('test-ai-posting-btn');
                const originalText = testBtn.textContent;
                testBtn.textContent = 'æµ‹è¯•ä¸­...';
                testBtn.disabled = true;
                
                try {
                    console.log('å¼€å§‹AIå‘å¸ƒæµ‹è¯•...');
                    console.log('APIé…ç½®:', {
                        proxyUrl: state.apiConfig.proxyUrl,
                        model: state.apiConfig.model,
                        hasApiKey: !!state.apiConfig.apiKey
                    });
                    
                    const content = await generateAiPostContent(chat);
                    console.log('ç”Ÿæˆçš„å†…å®¹:', content);
                    
                    await publishAiPost(state.activeChatId, content);
                    alert('AIå‘å¸ƒæµ‹è¯•æˆåŠŸï¼è¯·æŸ¥çœ‹å¾®åšæ—¶é—´çº¿ã€‚');
                } catch (error) {
                    console.error('AIå‘å¸ƒæµ‹è¯•å¤±è´¥:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', {
                        name: error.name,
                        message: error.message,
                        stack: error.stack
                    });
                    
                    // æ ¹æ®é”™è¯¯ç±»å‹æä¾›ä¸åŒçš„æç¤º
                    let errorMessage = error.message;
                    if (error.message.includes('APIé…ç½®ä¸å®Œæ•´')) {
                        errorMessage = 'è¯·æ£€æŸ¥APIè®¾ç½®ä¸­çš„åä»£åœ°å€ã€å¯†é’¥å’Œæ¨¡å‹é…ç½®';
                    } else if (error.message.includes('ç½‘ç»œè¿æ¥å¤±è´¥')) {
                        errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åä»£åœ°å€æ˜¯å¦æ­£ç¡®æˆ–ç½‘ç»œè¿æ¥';
                    } else if (error.message.includes('è¯·æ±‚è¶…æ—¶')) {
                        errorMessage = 'è¯·æ±‚è¶…æ—¶ï¼ˆ90ç§’ï¼‰ï¼Œè¯·æ£€æŸ¥ï¼š\n1. ç½‘ç»œè¿æ¥æ˜¯å¦ç¨³å®š\n2. APIæœåŠ¡æ˜¯å¦æ­£å¸¸\n3. æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„APIåœ°å€';
                    } else if (error.message.includes('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯')) {
                        errorMessage = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œå¯èƒ½æ˜¯åä»£æœåŠ¡å™¨é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•';
                    } else if (error.message.includes('APIå¯†é’¥æ— æ•ˆ')) {
                        errorMessage = 'APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·æ£€æŸ¥å¯†é’¥è®¾ç½®';
                    } else if (error.message.includes('CORS')) {
                        errorMessage = 'CORSè·¨åŸŸé”™è¯¯ï¼Œè¯·ä½¿ç”¨HTTPæœåŠ¡å™¨è¿è¡Œæ­¤æ–‡ä»¶';
                    } else if (error.name === 'AbortError') {
                        errorMessage = 'è¯·æ±‚è¢«å–æ¶ˆï¼ˆè¶…æ—¶ï¼‰ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIæœåŠ¡çŠ¶æ€';
                    } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š\n1. åä»£åœ°å€æ˜¯å¦æ­£ç¡®\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. æ˜¯å¦æœ‰é˜²ç«å¢™é˜»æ­¢è¯·æ±‚';
                    }
                    
                    alert(`AIå‘å¸ƒæµ‹è¯•å¤±è´¥:\n\n${errorMessage}\n\nå¦‚éœ€æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰ã€‚`);
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    testBtn.textContent = originalText;
                    testBtn.disabled = false;
                }
            });

            // åœ¨init()å‡½æ•°ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

            // æ·»åŠ æ—¶é—´ç‚¹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.querySelector('.add-time-btn').addEventListener('click', () => {
                const timeInputGroup = document.createElement('div');
                timeInputGroup.className = 'time-input-group';
                timeInputGroup.innerHTML = `
                    <input type="time" class="posting-time-input">
                    <button type="button" class="remove-time-btn">Ã—</button>
                `;
                
                const container = document.getElementById('posting-times-container');
                const addButton = container.querySelector('.add-time-btn');
                container.insertBefore(timeInputGroup, addButton);

                // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶
                timeInputGroup.querySelector('.remove-time-btn').addEventListener('click', () => {
                    timeInputGroup.remove();
                });
            });

            // åœ¨ä¿å­˜èŠå¤©è®¾ç½®æ—¶ä¿å­˜å‘å¸ƒæ—¶é—´ç‚¹
            document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
                if (!state.activeChatId) return;
                const chat = state.chats[state.activeChatId];
                if (!chat) return;
                
                // ä¿å­˜å¾®åšè®¾ç½®
                chat.settings.weiboEnabled = document.getElementById('weibo-enabled').checked;
                chat.settings.weiboFrequency = document.getElementById('weibo-frequency').value;
                
                // ä¿å­˜å‘å¸ƒæ—¶é—´ç‚¹
                const timeInputs = document.querySelectorAll('.posting-time-input');
                chat.settings.weiboPostingTimes = Array.from(timeInputs).map(input => input.value).filter(Boolean);
            });

            // åœ¨åŠ è½½èŠå¤©è®¾ç½®æ—¶åŠ è½½å·²ä¿å­˜çš„æ—¶é—´ç‚¹
            document.getElementById('chat-settings-btn').addEventListener('click', () => {
                // ...existing load code...
                
                // åŠ è½½å¾®åšè®¾ç½®
                const chat = state.chats[state.activeChatId];
                document.getElementById('weibo-enabled').checked = chat.settings.weiboEnabled || false;
                document.getElementById('weibo-frequency').value = chat.settings.weiboFrequency || 'low';
                
                // åŠ è½½å‘å¸ƒæ—¶é—´ç‚¹
                const container = document.getElementById('posting-times-container');
                container.innerHTML = ''; // æ¸…ç©ºç°æœ‰çš„æ—¶é—´è¾“å…¥æ¡†
                
                            if (chat.settings.weiboPostingTimes && chat.settings.weiboPostingTimes.length > 0) {
                chat.settings.weiboPostingTimes.forEach(time => {
                    // æ ¼å¼åŒ–æ—¶é—´ä¸º HH:mm æ ¼å¼
                    const formattedTime = time.includes(':') && time.split(':').length === 2 ? time : '00:00';
                    
                    const timeInputGroup = document.createElement('div');
                    timeInputGroup.className = 'time-input-group';
                    timeInputGroup.innerHTML = `
                        <input type="time" class="posting-time-input" value="${formattedTime}">
                        <button type="button" class="remove-time-btn">Ã—</button>
                    `;
                    container.appendChild(timeInputGroup);
                    
                    timeInputGroup.querySelector('.remove-time-btn').addEventListener('click', () => {
                        timeInputGroup.remove();
                    });
                });
            }
                
                // æ·»åŠ "æ·»åŠ æ—¶é—´ç‚¹"æŒ‰é’®
                const addButton = document.createElement('button');
                addButton.type = 'button';
                addButton.className = 'add-time-btn';
                addButton.textContent = '+ æ·»åŠ æ—¶é—´ç‚¹';
                container.appendChild(addButton);
                
                // ...rest of existing load code...
            });
            function init() {
                // ...existing code...
                
                // æ·»åŠ æ—¶é—´ç‚¹æŒ‰é’®çš„äº‹ä»¶ç›‘å¬
                document.body.addEventListener('click', (e) => {
                    if (e.target.classList.contains('add-time-btn')) {
                        const timeInputGroup = document.createElement('div');
                        timeInputGroup.className = 'time-input-group';
                        timeInputGroup.innerHTML = `
                            <input type="time" class="posting-time-input">
                            <button type="button" class="remove-time-btn">Ã—</button>
                        `;
                        
                        const container = e.target.closest('#posting-times-container');
                        container.insertBefore(timeInputGroup, e.target);
                        
                        // ä¸ºæ–°æ·»åŠ çš„åˆ é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
                        timeInputGroup.querySelector('.remove-time-btn').addEventListener('click', () => {
                            timeInputGroup.remove();
                        });
                    }
                });

                // ...rest of existing init code...
            }

            showScreen('home-screen');
            
            // åˆå§‹åŒ–AIè‡ªåŠ¨å‘å¸ƒç³»ç»Ÿ
            await initAiPostingSystem();
            
            // é¡µé¢å¯è§æ€§æ£€æµ‹ï¼Œç¡®ä¿åå°ä¹Ÿèƒ½æ­£å¸¸è®¡æ—¶
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é”™è¿‡çš„å‘å¸ƒæ—¶é—´ç‚¹
                    checkAiPostingTimes();
                }
            });
        }
        init();

        // åº”ç”¨ä¿å­˜çš„å¾®åšè®¾ç½®
        async function applyWeiboSettings() {
            // ä»æ•°æ®åº“åŠ è½½ä¿å­˜çš„å¾®åšè®¾ç½®
            let weiboSettings = null;
            try {
                weiboSettings = await db.weiboSettings.get('main');
            } catch (error) {
                console.log('åŠ è½½å¾®åšè®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®');
            }

            // åº”ç”¨ä¸»é¢˜è®¾ç½®
            const savedTheme = weiboSettings?.theme || 'white';
            document.body.setAttribute('data-weibo-theme', savedTheme);

            // åº”ç”¨ä¿å­˜çš„èƒŒæ™¯å›¾ç‰‡
            const savedBackground = weiboSettings?.backgroundImage;
            if (savedBackground) {
                const weiboScreen = document.getElementById('weibo-screen');
                if (weiboScreen) {
                    weiboScreen.style.backgroundImage = `url(${savedBackground})`;
                    weiboScreen.style.backgroundSize = 'cover';
                    weiboScreen.style.backgroundPosition = 'center';
                }
            }

            // åº”ç”¨ä¿å­˜çš„é€æ˜åº¦è®¾ç½®
            const savedOpacity = weiboSettings?.cardOpacity || 1.0;
            applyWeiboCardOpacity(savedOpacity);
        }

        applyWeiboSettings();
        // æ•°æ®è¡¨ç»“æ„ - å®Œæ•´å¤‡ä»½æ‰€éœ€çš„æ‰€æœ‰æ•°æ®
const fullBackupStores = {
    chats: '&id, isGroup',
    worldBooks: '&id, name',
    personaPresets: '&id',
    apiConfig: '&id',
    globalSettings: '&id',
    userStickers: '&id, url, name',
    musicLibrary: '&id',
    weiboPosts: '&id, authorId, timestamp, visibility',
    weiboComments: '&id, postId, authorId, timestamp',
    weiboLikes: '[postId+authorId], postId, authorId',
    weiboReposts: '&id, originalPostId, authorId, timestamp'
};

// åˆå§‹åŒ–"å¤‡ä»½ä¸“ç”¨æ•°æ®åº“è¿æ¥"
const backupDB = new Dexie('GeminiChatDB');  // â† æ”¹ä¸ºä½ åŸé¡¹ç›®çš„åº“åï¼ˆä¿æŒä¸€è‡´ï¼‰
backupDB.version(1).stores(fullBackupStores);

// å¯¼å‡º
document.getElementById('export-full-backup-btn').addEventListener('click', async () => {
    const result = {};
    for (const store in fullBackupStores) {
        result[store] = await backupDB[store].toArray();
    }
    const blob = new Blob([JSON.stringify(result, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Phone Chat-å¤‡ä»½.json';
    a.click();
    URL.revokeObjectURL(url);
});

let importFile = null;

document.getElementById('import-full-backup-btn').addEventListener('click', () => {
    document.getElementById('import-full-backup-input').click();
});

document.getElementById('import-full-backup-input').addEventListener('change', (event) => {
    importFile = event.target.files[0];
    if (importFile) {
        document.getElementById('import-confirm-modal').classList.add('visible');
    }
});

document.getElementById('cancel-import-btn').addEventListener('click', () => {
    importFile = null;
    document.getElementById('import-confirm-modal').classList.remove('visible');
});

document.getElementById('confirm-import-btn').addEventListener('click', async () => {
    document.getElementById('import-confirm-modal').classList.remove('visible');

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const json = JSON.parse(e.target.result);

            for (const store in fullBackupStores) {
                if (json[store]) {
                    await backupDB[store].clear();
for (const item of json[store]) {
    await backupDB[store].add(item);
}
                }
            }

            alert('âœ… å¯¼å…¥æˆåŠŸï¼å»ºè®®åˆ·æ–°é¡µé¢ä»¥ç¡®ä¿è®¾ç½®ç”Ÿæ•ˆã€‚');
        } catch (err) {
            alert('âŒ å¯¼å…¥å¤±è´¥ï¼š' + err.message);
        }
    };
    reader.readAsText(importFile);
});

// å¾®åšä¸»é¢˜åˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('theme-dot')) {
        const theme = e.target.dataset.theme;
        
        // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç‚¹çš„activeç±»
        document.querySelectorAll('.theme-dot').forEach(dot => {
            dot.classList.remove('active');
        });
        
        // ä¸ºå½“å‰ç‚¹å‡»çš„ä¸»é¢˜ç‚¹æ·»åŠ activeç±»
        e.target.classList.add('active');
        
        // è®¾ç½®bodyçš„data-weibo-themeå±æ€§
        document.body.setAttribute('data-weibo-theme', theme);
        
        // é‡æ–°æ¸²æŸ“å¾®åšæ—¶é—´çº¿ä»¥åº”ç”¨æ–°ä¸»é¢˜
        if (document.getElementById('weibo-screen').classList.contains('active')) {
            renderWeiboTimeline();
        }
    }
    
});

// åˆå§‹åŒ–å¾®åšä¸»é¢˜é€‰æ‹©å™¨
// åº”ç”¨å¾®åšå¡ç‰‡é€æ˜åº¦
function applyWeiboCardOpacity(opacity) {
    // è·å–æ‰€æœ‰å¾®åšå¡ç‰‡å¹¶åº”ç”¨é€æ˜åº¦
    const posts = document.querySelectorAll('.weibo-post');
    posts.forEach(post => {
        post.style.opacity = opacity;
    });
    
    // ä¿å­˜è®¾ç½®åˆ°CSSå˜é‡ï¼Œä»¥ä¾¿æ–°æ¸²æŸ“çš„å¡ç‰‡ä¹Ÿèƒ½åº”ç”¨
    document.documentElement.style.setProperty('--weibo-card-opacity', opacity);
}



            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†åŠ¨æ€æ·»åŠ çš„æ—¶é—´ç‚¹æŒ‰é’®
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-time-btn')) {
                    const timeInputGroup = document.createElement('div');
                    timeInputGroup.className = 'time-input-group';
                    timeInputGroup.innerHTML = `
                        <input type="time" class="posting-time-input">
                        <button type="button" class="remove-time-btn">Ã—</button>
                    `;
                    
                    const container = e.target.closest('#posting-times-container');
                    if (container) {
                        container.insertBefore(timeInputGroup, e.target);
                    }
                }
                
                if (e.target.classList.contains('remove-time-btn')) {
                    e.target.closest('.time-input-group').remove();
                }
            });
        
        // åˆå§‹åŒ–ç”¨æˆ·èµ„æ–™
        async function initUserProfile() {
            const savedProfileData = await db.userProfiles.get('weibo_user_profile');
            if (!savedProfileData) {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„ç”¨æˆ·èµ„æ–™ï¼Œè®¾ç½®é»˜è®¤å€¼
                const defaultProfile = {
                    name: 'æˆ‘çš„å¾®åš',
                    signature: 'åˆ†äº«ç”Ÿæ´»ä¸­çš„ç¾å¥½ç¬é—´',
                    email: '',
                    avatar: 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg'
                };
                await db.userProfiles.put({
                    id: 'weibo_user_profile',
                    type: 'weibo_profile',
                    data: defaultProfile,
                    timestamp: Date.now()
                });
                userProfileCache = defaultProfile;
            } else {
                userProfileCache = savedProfileData.data;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        async function initializeApp() {
            await initUserProfile();
            await loadApiConfigs();
        }

        // å¯åŠ¨åˆå§‹åŒ–
        initializeApp();

        // ç¤¾äº¤ä¸»é¡µç›¸å…³å‡½æ•°
        function showSocialProfileSafe(authorId) {
            try {
                showSocialProfile(authorId);
            } catch (error) {
                console.error('æ˜¾ç¤ºç¤¾äº¤ä¸»é¡µå¤±è´¥:', error);
                showToast('æ— æ³•æ˜¾ç¤ºç¤¾äº¤ä¸»é¡µ', 'error');
            }
        }

        async function showSocialProfile(authorId) {
            const modal = document.getElementById('social-profile-modal');
            const avatar = document.getElementById('social-profile-avatar');
            const name = document.getElementById('social-profile-name');
            const signature = document.getElementById('social-profile-signature');
            const followersEl = document.getElementById('social-profile-followers');
            const followingEl = document.getElementById('social-profile-following');
            const postsCountEl = document.getElementById('social-profile-posts-count');
            const postsList = document.getElementById('social-profile-posts-list');

            let profile;
            let posts = [];

            if (authorId === 'user') {
                // ç”¨æˆ·èµ„æ–™
                profile = userProfileCache;

                // è·å–ç”¨æˆ·çš„å¾®åš
                posts = await db.weiboPosts
                    .where('authorId')
                    .equals('user')
                    .reverse()
                    .sortBy('timestamp');

            } else {
                // AIè§’è‰²èµ„æ–™
                const chat = state.chats[authorId];
                if (!chat) {
                    showToast('è§’è‰²ä¿¡æ¯ä¸å­˜åœ¨', 'error');
                    return;
                }

                profile = {
                    name: chat.name,
                    signature: chat.settings.aiSignature || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹',
                    avatar: chat.settings.aiAvatar || 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg'
                };

                // è·å–AIçš„å¾®åš
                posts = await db.weiboPosts
                    .where('authorId')
                    .equals(authorId)
                    .reverse()
                    .sortBy('timestamp');
            }

            // è®¾ç½®ç¤¾äº¤ä¸»é¡µèƒŒæ™¯
            const socialBg = modal.querySelector('.social-profile-bg');
            if (authorId === 'user') {
                if (userProfileCache.socialBackground) {
                    socialBg.style.backgroundImage = `url(${userProfileCache.socialBackground})`;
                } else {
                    socialBg.style.backgroundImage = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }
            } else {
                const chat = state.chats[authorId];
                if (chat && chat.settings.socialBackground) {
                    socialBg.style.backgroundImage = `url(${chat.settings.socialBackground})`;
                } else {
                    socialBg.style.backgroundImage = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }
            }

            // å¡«å……èµ„æ–™ä¿¡æ¯
            avatar.src = profile.avatar;
            name.textContent = profile.name;
            signature.textContent = profile.signature;

            // ç”Ÿæˆåˆç†çš„ç²‰ä¸å’Œå…³æ³¨æ•°
            const postsCount = posts.length;
            let followersCount, followingCount;

            if (authorId === 'user') {
                // ç”¨æˆ·çš„ç²‰ä¸æ•° - æ ¹æ®äººè®¾"å°å¤œ"ï¼Œåº”è¯¥æœ‰ä¸€å®šç²‰ä¸åŸºç¡€
                const baseFollowers = 150 + Math.floor(Math.random() * 200); // 150-350åŸºç¡€ç²‰ä¸
                followersCount = Math.max(baseFollowers, Math.floor(postsCount * (8 + Math.random() * 15))); // æ¯æ¡å¾®åšå¸¦æ¥8-23ä¸ªç²‰ä¸
                followingCount = Math.max(50, Math.floor(postsCount * (2 + Math.random() * 4))); // å…³æ³¨æ•°ç›¸å¯¹è¾ƒå°‘
            } else {
                // AIè§’è‰²ç²‰ä¸æ•° - æ ¹æ®äººè®¾ç±»å‹ç”Ÿæˆåˆç†çš„ç²‰ä¸æ•°é‡
                const chat = state.chats[authorId];
                const persona = (chat?.settings?.aiPersona || '').toLowerCase();

                let baseFollowers, followerMultiplier;

                // æ ¹æ®è§’è‰²äººè®¾ç±»å‹è°ƒæ•´ç²‰ä¸åŸºæ•°å’Œå€æ•°
                if (persona.includes('ä¸»æ’­') || persona.includes('ç½‘çº¢') || persona.includes('upä¸»') ||
                    persona.includes('åšä¸»') || persona.includes('ç›´æ’­') || persona.includes('ç½‘ç»œä¸»æ’­') ||
                    persona.includes('æ¸¸æˆä¸»æ’­') || persona.includes('ç¾å¦†åšä¸»') || persona.includes('æ—¶å°šåšä¸»')) {
                    // ä¸»æ’­/ç½‘çº¢ç±»å‹ - é«˜ç²‰ä¸åŸºæ•°
                    baseFollowers = 8000 + Math.floor(Math.random() * 12000); // 8K-20KåŸºç¡€ç²‰ä¸
                    followerMultiplier = [50, 80]; // æ¯æ¡å¾®åšå¸¦æ¥50-130ä¸ªç²‰ä¸
                } else if (persona.includes('æ˜æ˜Ÿ') || persona.includes('è‰ºäºº') || persona.includes('æ¼”å‘˜') ||
                          persona.includes('æ­Œæ‰‹') || persona.includes('å¶åƒ') || persona.includes('çˆ±è±†')) {
                    // æ˜æ˜Ÿç±»å‹ - è¶…é«˜ç²‰ä¸åŸºæ•°
                    baseFollowers = 50000 + Math.floor(Math.random() * 100000); // 50K-150KåŸºç¡€ç²‰ä¸
                    followerMultiplier = [100, 200]; // æ¯æ¡å¾®åšå¸¦æ¥100-300ä¸ªç²‰ä¸
                } else if (persona.includes('å°è‰') || persona.includes('æ™®é€šäºº') || persona.includes('å­¦ç”Ÿ') ||
                          persona.includes('ä¸Šç­æ—') || persona.includes('ç¤¾ç•œ') || persona.includes('æ‰“å·¥äºº') ||
                          persona.includes('æ–°äºº') || persona.includes('èŒæ–°')) {
                    // å°è‰/æ™®é€šäººç±»å‹ - ä½ç²‰ä¸åŸºæ•°
                    baseFollowers = 50 + Math.floor(Math.random() * 150); // 50-200åŸºç¡€ç²‰ä¸
                    followerMultiplier = [3, 8]; // æ¯æ¡å¾®åšå¸¦æ¥3-11ä¸ªç²‰ä¸
                } else if (persona.includes('ä¸“å®¶') || persona.includes('æ•™æˆ') || persona.includes('è€å¸ˆ') ||
                          persona.includes('åŒ»ç”Ÿ') || persona.includes('å¾‹å¸ˆ') || persona.includes('ä½œå®¶') ||
                          persona.includes('çŸ¥è¯†åˆ†å­') || persona.includes('å­¦è€…')) {
                    // ä¸“ä¸šäººå£«ç±»å‹ - ä¸­ç­‰ç²‰ä¸åŸºæ•°
                    baseFollowers = 2000 + Math.floor(Math.random() * 3000); // 2K-5KåŸºç¡€ç²‰ä¸
                    followerMultiplier = [20, 35]; // æ¯æ¡å¾®åšå¸¦æ¥20-55ä¸ªç²‰ä¸
                } else if (persona.includes('ç½‘ç»œè¾¾äºº') || persona.includes('kol') || persona.includes('æ„è§é¢†è¢–') ||
                          persona.includes('å¤§v') || persona.includes('çŸ¥å') || persona.includes('æœ‰å')) {
                    // ç½‘ç»œè¾¾äººç±»å‹ - é«˜ç²‰ä¸åŸºæ•°
                    baseFollowers = 15000 + Math.floor(Math.random() * 25000); // 15K-40KåŸºç¡€ç²‰ä¸
                    followerMultiplier = [60, 100]; // æ¯æ¡å¾®åšå¸¦æ¥60-160ä¸ªç²‰ä¸
                } else if (persona.includes('ä¼ä¸šå®¶') || persona.includes('ceo') || persona.includes('è€æ¿') ||
                          persona.includes('åˆ›ä¸šè€…') || persona.includes('å•†äºº')) {
                    // ä¼ä¸šå®¶ç±»å‹ - ä¸­é«˜ç²‰ä¸åŸºæ•°
                    baseFollowers = 5000 + Math.floor(Math.random() * 10000); // 5K-15KåŸºç¡€ç²‰ä¸
                    followerMultiplier = [30, 50]; // æ¯æ¡å¾®åšå¸¦æ¥30-80ä¸ªç²‰ä¸
                } else {
                    // é»˜è®¤ç±»å‹ - ä¸­ç­‰ç²‰ä¸åŸºæ•°
                    baseFollowers = 500 + Math.floor(Math.random() * 1000); // 500-1500åŸºç¡€ç²‰ä¸
                    followerMultiplier = [15, 25]; // æ¯æ¡å¾®åšå¸¦æ¥15-40ä¸ªç²‰ä¸
                }

                followersCount = Math.max(baseFollowers, Math.floor(postsCount * (followerMultiplier[0] + Math.random() * (followerMultiplier[1] - followerMultiplier[0]))));
                followingCount = Math.max(30, Math.floor(followersCount * (0.05 + Math.random() * 0.15))); // å…³æ³¨æ•°ä¸ºç²‰ä¸æ•°çš„5%-20%
            }

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            followersEl.textContent = `${followersCount} ç²‰ä¸`;
            followingEl.textContent = `${followingCount} å…³æ³¨`;
            postsCountEl.textContent = `${postsCount} å¾®åš`;

            // å¡«å……æœ€è¿‘åŠ¨æ€
            postsList.innerHTML = '';
            if (posts.length === 0) {
                postsList.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">æš‚æ— åŠ¨æ€</div>';
            } else {
                posts.slice(0, 10).forEach(post => {
                    const postItem = document.createElement('div');
                    postItem.className = 'social-profile-post-item';

                    const postContent = document.createElement('div');
                    postContent.className = 'social-profile-post-content';
                    postContent.textContent = post.content;

                    const postTime = document.createElement('div');
                    postTime.className = 'social-profile-post-time';
                    postTime.textContent = new Date(post.timestamp).toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });

                    postItem.appendChild(postContent);
                    postItem.appendChild(postTime);
                    postsList.appendChild(postItem);
                });
            }

            // å­˜å‚¨å½“å‰æŸ¥çœ‹çš„ç”¨æˆ·IDï¼Œä¾›ç¼–è¾‘åŠŸèƒ½ä½¿ç”¨
            modal.dataset.currentAuthorId = authorId;
            modal.dataset.posts = JSON.stringify(posts);

            // åˆå§‹åŒ–æ ‡ç­¾é¡µäº‹ä»¶
            initSocialProfileTabs(modal);

            // æ˜¾ç¤ºæ¨¡æ€å¼¹çª—
            modal.style.display = 'block';
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);

            // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeSocialProfile();
                }
            };
        }

        function initSocialProfileTabs(modal) {
            const tabs = modal.querySelectorAll('.social-profile-tab');
            const postsList = modal.querySelector('#social-profile-posts-list');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    tabs.forEach(t => t.classList.remove('active'));
                    // æ·»åŠ å½“å‰activeç±»
                    tab.classList.add('active');

                    const tabType = tab.dataset.tab;
                    const posts = JSON.parse(modal.dataset.posts || '[]');

                    if (tabType === 'posts') {
                        // æ˜¾ç¤ºåŠ¨æ€
                        showSocialProfilePosts(postsList, posts);
                    } else if (tabType === 'photos') {
                        // æ˜¾ç¤ºç›¸å†Œ
                        showSocialProfilePhotos(postsList, posts);
                    }
                });
            });
        }

        function showSocialProfilePosts(container, posts) {
            container.innerHTML = '';
            if (posts.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">æš‚æ— åŠ¨æ€</div>';
            } else {
                // æ˜¾ç¤ºæ‰€æœ‰åŠ¨æ€ï¼Œä¸é™åˆ¶æ•°é‡ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿå†…å®¹æ»šåŠ¨
                posts.forEach(post => {
                    const postItem = document.createElement('div');
                    postItem.className = 'social-profile-post-item';

                    const postContent = document.createElement('div');
                    postContent.className = 'social-profile-post-content';
                    postContent.textContent = post.content;

                    const postTime = document.createElement('div');
                    postTime.className = 'social-profile-post-time';
                    postTime.textContent = new Date(post.timestamp).toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });

                    postItem.appendChild(postContent);
                    postItem.appendChild(postTime);
                    container.appendChild(postItem);
                });

                // å¦‚æœåŠ¨æ€è¾ƒå°‘ï¼Œæ·»åŠ ä¸€äº›å ä½å†…å®¹ç¡®ä¿å¯ä»¥æ»šåŠ¨æµ‹è¯•
                if (posts.length < 8) {
                    for (let i = 0; i < 10; i++) {
                        const testItem = document.createElement('div');
                        testItem.className = 'social-profile-post-item';
                        testItem.innerHTML = `
                            <div class="social-profile-post-content">æµ‹è¯•åŠ¨æ€å†…å®¹ ${i + 1} - è¿™æ˜¯ä¸€æ¡ç”¨äºæµ‹è¯•æ»šåŠ¨åŠŸèƒ½çš„åŠ¨æ€å†…å®¹</div>
                            <div class="social-profile-post-time">2024-01-${String(i + 1).padStart(2, '0')}</div>
                        `;
                        container.appendChild(testItem);
                    }
                }
            }
        }

        function showSocialProfilePhotos(container, posts) {
            container.innerHTML = '';

            // æå–æ‰€æœ‰åŒ…å«å›¾ç‰‡çš„å¾®åš
            const photoPosts = posts.filter(post => post.images && post.images.length > 0);

            if (photoPosts.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">æš‚æ— å›¾ç‰‡</div>';
            } else {
                const photoGrid = document.createElement('div');
                photoGrid.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 10px;';

                photoPosts.forEach(post => {
                    post.images.forEach(imageUrl => {
                        const photoItem = document.createElement('div');
                        photoItem.style.cssText = 'aspect-ratio: 1; overflow: hidden; border-radius: 8px; cursor: pointer;';

                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                        img.onclick = () => showImageViewer(imageUrl);

                        photoItem.appendChild(img);
                        photoGrid.appendChild(photoItem);
                    });
                });

                container.appendChild(photoGrid);
            }
        }

        function closeSocialProfile() {
            const modal = document.getElementById('social-profile-modal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        function editSocialProfile() {
            const modal = document.getElementById('social-profile-modal');
            const authorId = modal.dataset.currentAuthorId;

            closeSocialProfile();

            if (authorId === 'user') {
                // æ‰“å¼€ç”¨æˆ·èµ„æ–™ç¼–è¾‘å¼¹çª—
                document.getElementById('weibo-profile-modal').classList.add('visible');

                // åŠ è½½å½“å‰ç”¨æˆ·èµ„æ–™åˆ°ç¼–è¾‘è¡¨å•
                document.getElementById('profile-name-input').value = userProfileCache.name || 'æˆ‘çš„å¾®åš';
                document.getElementById('profile-signature-input').value = userProfileCache.signature || 'åˆ†äº«ç”Ÿæ´»ä¸­çš„ç¾å¥½ç¬é—´';
                document.getElementById('profile-email-input').value = userProfileCache.email || '';
                document.getElementById('profile-avatar-preview').src = userProfileCache.avatar || 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';

                // åŠ è½½ç”¨æˆ·çš„ç¤¾äº¤ä¸»é¡µèƒŒæ™¯
                const userBgPreview = document.getElementById('user-profile-bg-preview');
                if (userProfileCache.socialBackground) {
                    userBgPreview.style.backgroundImage = `url(${userProfileCache.socialBackground})`;
                    userBgPreview.textContent = '';
                    document.getElementById('remove-user-profile-bg-btn').style.display = 'block';
                } else {
                    userBgPreview.style.backgroundImage = '';
                    userBgPreview.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    userBgPreview.textContent = 'é»˜è®¤æ¸å˜èƒŒæ™¯';
                    document.getElementById('remove-user-profile-bg-btn').style.display = 'none';
                }

            } else {
                // æ‰“å¼€AIèµ„æ–™ç¼–è¾‘å¼¹çª—
                const aiModal = document.getElementById('ai-profile-modal');
                aiModal.dataset.aiId = authorId;
                aiModal.classList.add('visible');

                // åŠ è½½AIèµ„æ–™åˆ°ç¼–è¾‘è¡¨å•
                const chat = state.chats[authorId];
                if (chat) {
                    document.getElementById('ai-profile-name-input').value = chat.name || '';
                    document.getElementById('ai-profile-signature-input').value = chat.settings.aiSignature || '';
                    document.getElementById('ai-profile-persona-input').value = chat.settings.aiPersona || '';
                    document.getElementById('ai-profile-avatar-preview').src = chat.settings.aiAvatar || 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';

                    // åŠ è½½AIçš„ç¤¾äº¤ä¸»é¡µèƒŒæ™¯
                    const aiBgPreview = document.getElementById('ai-profile-bg-preview');
                    if (chat.settings.socialBackground) {
                        aiBgPreview.style.backgroundImage = `url(${chat.settings.socialBackground})`;
                        aiBgPreview.textContent = '';
                        document.getElementById('remove-ai-profile-bg-btn').style.display = 'block';
                    } else {
                        aiBgPreview.style.backgroundImage = '';
                        aiBgPreview.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        aiBgPreview.textContent = 'é»˜è®¤æ¸å˜èƒŒæ™¯';
                        document.getElementById('remove-ai-profile-bg-btn').style.display = 'none';
                    }
                }
            }
        }

        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.showSocialProfileSafe = showSocialProfileSafe;
        window.showSocialProfile = showSocialProfile;
        window.closeSocialProfile = closeSocialProfile;
        window.editSocialProfile = editSocialProfile;
        
        // æ·»åŠ æµ‹è¯•APIè¿æ¥åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', () => {
            const testConnectionBtn = document.getElementById('test-api-connection-btn');
            if (testConnectionBtn) {
                testConnectionBtn.addEventListener('click', async () => {
                    const url = document.getElementById('proxy-url').value.trim();
                    const key = document.getElementById('api-key').value.trim();
                    const model = document.getElementById('model-select').value;
                    
                    if (!url || !key) {
                        alert('è¯·å…ˆå¡«å†™åä»£åœ°å€å’Œå¯†é’¥');
                        return;
                    }
                    
                    if (!model) {
                        alert('è¯·å…ˆé€‰æ‹©æ¨¡å‹');
                        return;
                    }
                    
                    const testBtn = document.getElementById('test-api-connection-btn');
                    const originalText = testBtn.textContent;
                    testBtn.textContent = 'æµ‹è¯•ä¸­...';
                    testBtn.disabled = true;
                    
                    try {
                        console.log('å¼€å§‹æµ‹è¯•APIè¿æ¥...', { url, model });
                        
                        // æµ‹è¯•1ï¼šæœ€ç®€å•çš„è¯·æ±‚
                        console.log('æµ‹è¯•1ï¼šæœ€ç®€å•çš„è¯·æ±‚');
                        const simpleRequest = {
                            model: model,
                            messages: [
                                { role: 'user', content: 'hi' }
                            ],
                            stream: false
                        };
                        
                        const response1 = await fetch(`${url}/v1/chat/completions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${key}`
                            },
                            body: JSON.stringify(simpleRequest)
                        });
                        
                        console.log('æµ‹è¯•1å“åº”çŠ¶æ€:', response1.status, response1.statusText);
                        
                        if (!response1.ok) {
                            const errorText = await response1.text();
                            console.error('æµ‹è¯•1å¤±è´¥:', errorText);
                            throw new Error(`æµ‹è¯•1å¤±è´¥ (${response1.status}): ${errorText}`);
                        }
                        
                        const data1 = await response1.json();
                        console.log('æµ‹è¯•1æˆåŠŸ:', data1);
                        
                        // æµ‹è¯•2ï¼šä¸å¾®åšåŠŸèƒ½ç›¸åŒçš„è¯·æ±‚æ ¼å¼
                        console.log('æµ‹è¯•2ï¼šå¾®åšåŠŸèƒ½æ ¼å¼');
                        const weiboRequest = {
                            model: model,
                            messages: [
                                { role: 'system', content: 'ä½ æ˜¯æµ‹è¯•è§’è‰²ã€‚' },
                                { role: 'user', content: 'è¯·ç®€å•å›å¤ã€‚' }
                            ],
                            temperature: 0.7,
                            stream: false
                        };
                        
                        const response2 = await fetch(`${url}/v1/chat/completions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${key}`
                            },
                            body: JSON.stringify(weiboRequest)
                        });
                        
                        console.log('æµ‹è¯•2å“åº”çŠ¶æ€:', response2.status, response2.statusText);
                        
                        if (!response2.ok) {
                            const errorText = await response2.text();
                            console.error('æµ‹è¯•2å¤±è´¥:', errorText);
                            throw new Error(`æµ‹è¯•2å¤±è´¥ (${response2.status}): ${errorText}`);
                        }
                        
                        const data2 = await response2.json();
                        console.log('æµ‹è¯•2æˆåŠŸ:', data2);
                        
                        alert('âœ… æ‰€æœ‰æµ‹è¯•éƒ½æˆåŠŸäº†ï¼\n\næµ‹è¯•1å“åº”: ' + data1.choices[0].message.content + '\n\næµ‹è¯•2å“åº”: ' + data2.choices[0].message.content);
                        
                    } catch (error) {
                        console.error('APIè¿æ¥æµ‹è¯•å¤±è´¥:', error);
                        let errorMessage = error.message;
                        
                        if (error.message.includes('Failed to fetch')) {
                            errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åä»£åœ°å€æ˜¯å¦æ­£ç¡®';
                        } else if (error.name === 'AbortError') {
                            errorMessage = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•';
                        } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                            errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åä»£åœ°å€æ˜¯å¦æ­£ç¡®æˆ–ç½‘ç»œè¿æ¥';
                        }
                        
                        alert(`âŒ APIè¿æ¥æµ‹è¯•å¤±è´¥:\n${errorMessage}`);
                    } finally {
                        testBtn.textContent = originalText;
                        testBtn.disabled = false;
                    }
                });
            }
        });

        // å…¨å±€è°ƒè¯•å‡½æ•°ï¼Œæ–¹ä¾¿åœ¨æ§åˆ¶å°æµ‹è¯•
        window.debugAPI = async function() {
            const { proxyUrl, apiKey, model } = state.apiConfig;
            console.log('å½“å‰APIé…ç½®:', { proxyUrl, apiKey: apiKey ? '***' : 'æœªè®¾ç½®', model });
            
            if (!proxyUrl || !apiKey || !model) {
                console.error('APIé…ç½®ä¸å®Œæ•´');
                return;
            }
            
            try {
                console.log('å¼€å§‹è°ƒè¯•API...');
                
                // æœ€ç®€å•çš„è¯·æ±‚
                const request = {
                    model: model,
                    messages: [
                        { role: 'user', content: 'test' }
                    ],
                    stream: false
                };
                
                console.log('å‘é€è¯·æ±‚:', JSON.stringify(request, null, 2));
                
                const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'User-Agent': 'Phone Chat/1.0'
                    },
                    body: JSON.stringify(request)
                });
                
                console.log('å“åº”çŠ¶æ€:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIé”™è¯¯:', errorText);
                    return;
                }
                
                const data = await response.json();
                console.log('APIæˆåŠŸ:', data);
                
            } catch (error) {
                console.error('è°ƒè¯•å¤±è´¥:', error);
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç”¨æˆ·èµ„æ–™
        
        // ============= APIé…ç½®ç®¡ç†åŠŸèƒ½ =============
        let savedApiConfigs = [];

        // ä»DexieåŠ è½½APIé…ç½®
        async function loadApiConfigs() {
            const configs = await db.apiConfigs.toArray();
            savedApiConfigs = configs.map(config => config.data);
        }

        // ä¿å­˜APIé…ç½®åˆ°Dexie
        async function saveApiConfigs() {
            // æ¸…ç©ºç°æœ‰é…ç½®
            await db.apiConfigs.clear();
            // ä¿å­˜æ–°é…ç½®
            for (const config of savedApiConfigs) {
                await db.apiConfigs.put({
                    id: config.id,
                    name: config.name,
                    data: config,
                    timestamp: config.updatedAt || Date.now()
                });
            }
        }
        
        // ä¿å­˜å½“å‰é…ç½®
        document.getElementById('save-current-config-btn').addEventListener('click', async () => {
            const configName = document.getElementById('config-name-input').value.trim();
            if (!configName) {
                alert('è¯·è¾“å…¥é…ç½®åç§°');
                return;
            }
            
            const proxyUrl = document.getElementById('proxy-url').value.trim();
            const apiKey = document.getElementById('api-key').value.trim();
            const model = document.getElementById('model-select').value;
            const temperature = document.getElementById('temperature-slider').value;
            
            if (!proxyUrl || !apiKey || !model) {
                alert('è¯·å…ˆå®Œæ•´å¡«å†™APIé…ç½®ä¿¡æ¯');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåé…ç½®
            const existingIndex = savedApiConfigs.findIndex(config => config.name === configName);
            if (existingIndex !== -1) {
                if (!confirm(`é…ç½®"${configName}"å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) {
                    return;
                }
                savedApiConfigs[existingIndex] = {
                    id: savedApiConfigs[existingIndex].id,
                    name: configName,
                    proxyUrl,
                    apiKey,
                    model,
                    temperature: parseFloat(temperature),
                    createdAt: savedApiConfigs[existingIndex].createdAt,
                    updatedAt: Date.now()
                };
            } else {
                const newConfig = {
                    id: `config_${Date.now()}`,
                    name: configName,
                    proxyUrl,
                    apiKey,
                    model,
                    temperature: parseFloat(temperature),
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                savedApiConfigs.push(newConfig);
            }
            
            await saveApiConfigs();
            document.getElementById('config-name-input').value = '';
            renderSavedConfigs();
            showToast('é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
        });
        
        // æ¸…ç©ºæ‰€æœ‰é…ç½®
        document.getElementById('clear-all-configs-btn').addEventListener('click', async () => {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰ä¿å­˜çš„é…ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                savedApiConfigs = [];
                await db.apiConfigs.clear();
                renderSavedConfigs();
                showToast('æ‰€æœ‰é…ç½®å·²æ¸…ç©º', 'info');
            }
        });
        
        // æ¸²æŸ“ä¿å­˜çš„é…ç½®åˆ—è¡¨
        function renderSavedConfigs() {
            const container = document.getElementById('saved-configs-container');
            const noConfigsMessage = document.getElementById('no-configs-message');
            
            if (savedApiConfigs.length === 0) {
                container.innerHTML = '';
                noConfigsMessage.style.display = 'block';
                return;
            }
            
            noConfigsMessage.style.display = 'none';
            container.innerHTML = '';
            
            // è·å–å½“å‰é…ç½®ç”¨äºæ ‡è®°æ¿€æ´»çŠ¶æ€
            const currentProxyUrl = document.getElementById('proxy-url').value.trim();
            const currentApiKey = document.getElementById('api-key').value.trim();
            const currentModel = document.getElementById('model-select').value;
            
            savedApiConfigs.forEach(config => {
                // åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰æ¿€æ´»çš„é…ç½®
                const isActive = config.proxyUrl === currentProxyUrl && 
                               config.apiKey === currentApiKey && 
                               config.model === currentModel;
                
                const configCard = document.createElement('div');
                configCard.className = `config-card${isActive ? ' active' : ''}`;
                configCard.innerHTML = `
                    <div class="config-header">
                        <div class="config-name">
                            <span style="font-size: 16px;">${getConfigIcon(config.name)}</span>
                            <span>${config.name}</span>
                            ${isActive ? '<span style="color: #667eea; font-size: 12px; font-weight: normal;">(å½“å‰ä½¿ç”¨)</span>' : ''}
                        </div>
                        <div class="config-actions">
                            <button class="config-action-btn" onclick="editConfigName('${config.id}')" title="é‡å‘½å">
                                <span style="font-size: 14px;">âœï¸</span>
                            </button>
                            <button class="config-action-btn" onclick="deleteConfig('${config.id}')" title="åˆ é™¤">
                                <span style="font-size: 14px; color: #ff6b6b;">ğŸ—‘ï¸</span>
                            </button>
                        </div>
                    </div>
                    <div class="config-details">
                        <div class="config-detail-item">
                            <span class="config-detail-label">URL:</span>
                            <span class="config-detail-value" title="${config.proxyUrl}">${config.proxyUrl}</span>
                        </div>
                        <div class="config-detail-item">
                            <span class="config-detail-label">å¯†é’¥:</span>
                            <span class="config-detail-value" title="${config.apiKey}">â—â—â—â—â—â—${config.apiKey && config.apiKey.length >= 6 ? config.apiKey.slice(-6) : (config.apiKey || 'æœªè®¾ç½®')}</span>
                        </div>
                        <div class="config-detail-item">
                            <span class="config-detail-label">æ¨¡å‹:</span>
                            <span class="config-detail-value" title="${config.model}">${config.model}</span>
                        </div>
                        <div class="config-detail-item">
                            <span class="config-detail-label">æ¸©åº¦:</span>
                            <span class="config-detail-value">${config.temperature}</span>
                        </div>
                    </div>
                    <button class="config-use-btn" onclick="applyConfig('${config.id}')" ${isActive ? 'disabled' : ''}>
                        ${isActive ? 'âœ“ å½“å‰ä½¿ç”¨ä¸­' : 'ğŸš€ ä½¿ç”¨æ­¤é…ç½®'}
                    </button>
                `;
                container.appendChild(configCard);
            });
        }
        
        // æ ¹æ®é…ç½®åç§°è¿”å›åˆé€‚çš„å›¾æ ‡
        function getConfigIcon(name) {
            const nameLower = name.toLowerCase();
            if (nameLower.includes('openai') || nameLower.includes('gpt')) return 'ğŸ¤–';
            if (nameLower.includes('gemini') || nameLower.includes('google')) return 'ğŸ’';
            if (nameLower.includes('claude') || nameLower.includes('anthropic')) return 'ğŸ§ ';
            if (nameLower.includes('azure')) return 'â˜ï¸';
            if (nameLower.includes('local') || nameLower.includes('æœ¬åœ°')) return 'ğŸ ';
            if (nameLower.includes('proxy') || nameLower.includes('ä»£ç†')) return 'ğŸŒ';
            return 'âš™ï¸';
        }
        
        // åº”ç”¨é…ç½®
        window.applyConfig = function(configId) {
            const config = savedApiConfigs.find(c => c.id === configId);
            if (!config) return;
            
            // åº”ç”¨é…ç½®åˆ°è¡¨å•
            document.getElementById('proxy-url').value = config.proxyUrl;
            document.getElementById('api-key').value = config.apiKey;
            document.getElementById('model-select').value = config.model;
            document.getElementById('temperature-slider').value = config.temperature;
            document.getElementById('temperature-value').textContent = config.temperature;
            
            // æ›´æ–°å½“å‰ä½¿ç”¨çš„é…ç½®
            state.apiConfig = {
                proxyUrl: config.proxyUrl,
                apiKey: config.apiKey,
                model: config.model,
                temperature: config.temperature
            };
            
            // é‡æ–°æ¸²æŸ“é…ç½®åˆ—è¡¨ä»¥æ›´æ–°æ¿€æ´»çŠ¶æ€
            renderSavedConfigs();
            showToast(`å·²åˆ‡æ¢åˆ°é…ç½®"${config.name}"`, 'success');
        };
        
        // åˆ é™¤é…ç½®
        window.deleteConfig = async function(configId) {
            const config = savedApiConfigs.find(c => c.id === configId);
            if (!config) return;

            if (confirm(`ç¡®å®šè¦åˆ é™¤é…ç½®"${config.name}"å—ï¼Ÿ`)) {
                savedApiConfigs = savedApiConfigs.filter(c => c.id !== configId);
                await saveApiConfigs();
                renderSavedConfigs();
                showToast(`é…ç½®"${config.name}"å·²åˆ é™¤`, 'info');
            }
        };
        
        // é‡å‘½åé…ç½®
        window.editConfigName = async function(configId) {
            const config = savedApiConfigs.find(c => c.id === configId);
            if (!config) return;
            
            const newName = await showCustomPrompt('é‡å‘½åé…ç½®', `è¯·è¾“å…¥æ–°çš„é…ç½®åç§°ï¼š`, config.name);
            if (newName && newName.trim() && newName.trim() !== config.name) {
                // æ£€æŸ¥æ˜¯å¦é‡å
                if (savedApiConfigs.some(c => c.name === newName.trim() && c.id !== configId)) {
                    alert('é…ç½®åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
                    return;
                }
                
                config.name = newName.trim();
                config.updatedAt = Date.now();
                await saveApiConfigs();
                renderSavedConfigs();
                showToast('é…ç½®åç§°å·²æ›´æ–°', 'success');
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶æ¸²æŸ“å·²ä¿å­˜çš„é…ç½®
        renderSavedConfigs();
        
        // ============= ç”¨æˆ·èº«ä»½ä¿æŠ¤æµ‹è¯•åŠŸèƒ½ =============
        // æµ‹è¯•å‡½æ•°ï¼šéªŒè¯AIæ˜¯å¦ä¼šä¼ªé€ ç”¨æˆ·èº«ä»½
        window.testUserIdentityProtection = function() {
            console.log('ğŸ”’ ç”¨æˆ·èº«ä»½ä¿æŠ¤åŠŸèƒ½æµ‹è¯•');
            
            // æ¨¡æ‹Ÿä¸€ä¸ªç¾¤èŠå¯¹è±¡
            const testChat = {
                isGroup: true,
                settings: {
                    myNickname: 'æµ‹è¯•ç”¨æˆ·'
                },
                members: [
                    { name: 'æµ‹è¯•ç”¨æˆ·', avatar: '/avatar1.jpg' },
                    { name: 'AIåŠ©æ‰‹', avatar: '/avatar2.jpg' }
                ]
            };
            
            // æ¨¡æ‹ŸAIå°è¯•ä½¿ç”¨ç”¨æˆ·èº«ä»½å‘é€çš„æ¶ˆæ¯æ•°ç»„
            const testMessages = [
                { name: 'æµ‹è¯•ç”¨æˆ·', message: 'è¿™æ˜¯AIä¼ªé€ çš„ç”¨æˆ·å‘è¨€' },
                { name: 'æˆ‘', message: 'è¿™ä¹Ÿæ˜¯AIä¼ªé€ çš„ç”¨æˆ·å‘è¨€' },
                { name: 'AIåŠ©æ‰‹', message: 'è¿™æ˜¯æ­£å¸¸çš„AIå‘è¨€' },
                { name: 'æµ‹è¯•ç”¨æˆ·', type: 'change_avatar', avatar_url: '/fake_avatar.jpg' },
                { name: 'æˆ‘', type: 'voice_message', content: 'è¿™æ˜¯ä¼ªé€ çš„ç”¨æˆ·è¯­éŸ³' }
            ];
            
            console.log('åŸå§‹æµ‹è¯•æ¶ˆæ¯:', testMessages);
            
            // æ¨¡æ‹Ÿä¿æŠ¤é€»è¾‘
            const filteredMessages = [];
            for (const msgData of testMessages) {
                // è¿™æ˜¯å®é™…ä»£ç ä¸­çš„ä¿æŠ¤é€»è¾‘
                if (testChat.isGroup && msgData.name) {
                    const userNickname = testChat.settings.myNickname || 'æˆ‘';
                    if (msgData.name === userNickname || msgData.name === 'æˆ‘') {
                        console.warn('âœ… æˆåŠŸé˜»æ­¢AIä¼ªé€ ç”¨æˆ·èº«ä»½:', msgData);
                        continue; // è·³è¿‡è¿™æ¡æ¶ˆæ¯ï¼Œä¸æ·»åŠ åˆ°ç»“æœæ•°ç»„
                    }
                }
                filteredMessages.push(msgData);
            }
            
            console.log('è¿‡æ»¤åçš„æ¶ˆæ¯:', filteredMessages);
            console.log(`âœ… æµ‹è¯•å®Œæˆ: æˆåŠŸé˜»æ­¢äº† ${testMessages.length - filteredMessages.length} æ¡ä¼ªé€ æ¶ˆæ¯`);
            console.log(`ğŸ›¡ï¸ ä¿æŠ¤çŠ¶æ€: ${testMessages.length - filteredMessages.length > 0 ? 'æ­£å¸¸å·¥ä½œ' : 'éœ€è¦æ£€æŸ¥'}`);
            
            return {
                original: testMessages,
                filtered: filteredMessages,
                blocked: testMessages.length - filteredMessages.length
            };
        };
        
        
        // æ–°çš„å¹¶å‘ç‰ˆæœ¬çš„ triggerAiResponse
        async function triggerAiResponse() {
            if (!state.activeChatId) return;
            
            const chatId = state.activeChatId;
            const chat = state.chats[chatId];
            const { proxyUrl, apiKey, model } = state.apiConfig;
            
            if (!proxyUrl || !apiKey || !model) {
                alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®åä»£åœ°å€ã€å¯†é’¥å¹¶é€‰æ‹©æ¨¡å‹ã€‚');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å¯ç”¨å¹¶å‘æ¨¡å¼
            if (chat && chat.settings.concurrentChatEnabled !== false) {
                // ä½¿ç”¨å¹¶å‘ç®¡ç†å™¨å¤„ç†è¯·æ±‚
                return await window.concurrentChatManager.startRequest(
                    chatId,
                    'chat',
                    executeAiResponse,
                    chatId
                );
            } else {
                // å›é€€åˆ°ä¼ ç»Ÿçš„ä¸²è¡Œæ¨¡å¼
                return await executeAiResponse(null, chatId);
            }
        }
        
    });
    </script>

    <!-- PWA Service Worker Registration -->
    <script>
        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content is available, prompt user to refresh
                                    if (confirm('åº”ç”¨æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œæ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('SW registration failed: ', error);
                    });
            });
        }

        // Handle app install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;

            // Show install button or banner (optional)
            console.log('App can be installed');

            // You can show a custom install button here
            // showInstallButton();
        });

        // Handle successful app installation
        window.addEventListener('appinstalled', (evt) => {
            console.log('App was installed successfully');
            // Track the installation
            // analytics.track('app_installed');
        });

        // Handle app launch from home screen
        window.addEventListener('DOMContentLoaded', () => {
            // Check if app was launched from home screen
            if (window.matchMedia('(display-mode: fullscreen)').matches ||
                window.matchMedia('(display-mode: standalone)').matches) {
                console.log('App launched from home screen');
                // Add any special handling for home screen launch
                document.body.classList.add('pwa-mode');
            }
        });

        // Prevent zoom on double tap (iOS Safari)
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Handle viewport changes for better mobile experience
        function handleViewportChange() {
            const viewport = document.querySelector('meta[name=viewport]');
            if (viewport) {
                // Ensure proper viewport settings for PWA
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover');
            }
        }

        // ç®€åŒ–çš„é”®ç›˜ä¿®å¤é€»è¾‘
        function setupKeyboardFix() {
            // åªåœ¨PWAæ¨¡å¼ä¸‹ç›‘å¬é”®ç›˜äº‹ä»¶
            if (!document.body.classList.contains('pwa-mode')) return;

            // ç›‘å¬è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹äº‹ä»¶
            document.addEventListener('focusout', function(e) {
                if (e.target.matches('input, textarea')) {
                    console.log('è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹');
                    // ç®€å•çš„å»¶è¿Ÿé‡ç½®ï¼Œè®©é”®ç›˜å®Œå…¨æ”¶èµ·
                    setTimeout(() => {
                        // é‡ç½®æ»šåŠ¨ä½ç½®
                        document.body.scrollTop = 0;
                        document.documentElement.scrollTop = 0;
                        console.log('é‡ç½®æ»šåŠ¨ä½ç½®');
                    }, 300);
                }
            });
        }

        // Call on load
        window.addEventListener('load', function() {
            handleViewportChange();
            setupKeyboardFix();
        });
    </script>



</body></html>